<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¹­ ì œì¶œ | ë­˜ ì¢€ ì•„ëŠ” ì‚¬ëŒë“¤</title>
    <link href="https://cdn.jsdelivr.net/npm/pretendard@1.3.9/dist/web/variable/pretendardvariable.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #00E676;
            --primary-dark: #00C853;
            --bg: #0a0a0a;
            --card-bg: #141414;
            --border: #2a2a2a;
            --text: #fff;
            --text-muted: #888;
            --danger: #ff4757;
            --pink: #ff6b9d;
            --blue: #4a9eff;
        }
        body {
            font-family: 'Pretendard Variable', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 480px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 24px; padding-top: 20px; }
        .header-logo { font-size: 14px; color: var(--text-muted); margin-bottom: 12px; }
        .header h1 { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .header h1 span { color: var(--primary); }
        .header-desc { font-size: 14px; color: var(--text-muted); }
        .form-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }
        .form-group label .required { color: var(--danger); }
        .form-control {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .form-control:focus { outline: none; border-color: var(--primary); }
        .form-control::placeholder { color: var(--text-muted); }
        select.form-control {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }
        .radio-group { display: flex; gap: 12px; flex-wrap: wrap; }
        .radio-option {
            flex: 1;
            min-width: 80px;
            padding: 14px 12px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .radio-option:hover { border-color: #444; }
        .radio-option.selected {
            border-color: var(--primary);
            background: rgba(0, 230, 118, 0.1);
        }
        .radio-option.male.selected {
            border-color: var(--blue);
            background: rgba(74, 158, 255, 0.1);
        }
        .radio-option.female.selected {
            border-color: var(--pink);
            background: rgba(255, 107, 157, 0.1);
        }
        .number-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .number-input input {
            width: 70px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            padding: 12px 8px;
        }
        .number-input span {
            font-size: 16px;
            color: var(--text-muted);
        }
        .target-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .target-numbers input {
            width: 70px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            padding: 12px 8px;
        }
        .target-numbers .add-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--primary);
            border: none;
            color: #000;
            font-size: 20px;
            cursor: pointer;
        }
        .target-numbers .remove-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--danger);
            border: none;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            margin-left: -4px;
        }
        .selection-info {
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-muted);
        }
        .selection-info .count {
            color: var(--primary);
            font-weight: 700;
        }
        .none-btn {
            display: inline-block;
            padding: 10px 20px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }
        .none-btn:hover { border-color: #444; }
        .none-btn.selected {
            border-color: var(--text-muted);
            background: rgba(136, 136, 136, 0.2);
            color: var(--text);
        }
        .inputs-disabled {
            opacity: 0.3;
            pointer-events: none;
        }
        .manner-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), rgba(255, 165, 0, 0.04));
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
        }
        .manner-section label {
            color: #FFD700 !important;
        }
        .comment-box {
            width: 100%;
            min-height: 80px;
            padding: 14px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
        }
        .comment-box:focus { outline: none; border-color: var(--primary); }
        .comment-box::placeholder { color: var(--text-muted); }
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }
        .submit-btn:hover { background: var(--primary-dark); }
        .submit-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        .success-card {
            background: var(--card-bg);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 40px 24px;
            text-align: center;
            display: none;
        }
        .success-card.show { display: block; }
        .success-icon { font-size: 48px; margin-bottom: 16px; }
        .success-card h2 { font-size: 20px; margin-bottom: 12px; }
        .success-card p { color: var(--text-muted); font-size: 14px; line-height: 1.6; }
        .result-box {
            background: var(--bg);
            border-radius: 10px;
            padding: 16px;
            margin: 20px 0;
        }
        .result-box .label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .result-box .value { font-size: 18px; color: var(--primary); font-weight: 700; }
        .hidden { display: none !important; }
        .footer { text-align: center; margin-top: 24px; padding-bottom: 40px; }
        .footer a { color: var(--text-muted); text-decoration: none; font-size: 13px; }
        .footer a:hover { color: var(--primary); }
        .error-msg { color: var(--danger); font-size: 13px; margin-top: 8px; display: none; }
        .hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        .my-info-box {
            background: linear-gradient(135deg, rgba(0, 230, 118, 0.1), rgba(255, 215, 0, 0.05));
            border: 1px solid rgba(0, 230, 118, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .my-info-box .num {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            min-width: 60px;
        }
        .my-info-box .name { font-size: 18px; color: var(--text); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">ë­˜ ì¢€ ì•„ëŠ” ì‚¬ëŒë“¤</div>
            <h1><span>ë§¤ì¹­</span> ì œì¶œ</h1>
            <p class="header-desc">ë§ˆìŒì— ë“œëŠ” ìƒëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
        </div>

        <form id="matchForm" class="form-card">
            <!-- ë‚ ì§œ ì„ íƒ -->
            <div class="form-group">
                <label>íŒŒí‹° ë‚ ì§œ <span class="required">*</span></label>
                <select id="eventDate" class="form-control" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>

            <!-- ì„¸ì…˜ ì„ íƒ (ì‹œê°„ + íŒŒí‹°íƒ€ì…) -->
            <div class="form-group">
                <label>ì„¸ì…˜ <span class="required">*</span></label>
                <div class="radio-group" id="sessionGroup">
                    <div class="radio-option" style="color: var(--text-muted);">ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</div>
                </div>
            </div>

            <!-- ì„±ë³„ ì„ íƒ -->
            <div class="form-group">
                <label>ì„±ë³„ <span class="required">*</span></label>
                <div class="radio-group" id="genderGroup">
                    <div class="radio-option male" data-value="ë‚¨ì" onclick="selectGender('ë‚¨ì')">ë‚¨ì</div>
                    <div class="radio-option female" data-value="ì—¬ì" onclick="selectGender('ì—¬ì')">ì—¬ì</div>
                </div>
            </div>

            <!-- ë‚´ ë²ˆí˜¸ -->
            <div class="form-group">
                <label>ë‚´ ë²ˆí˜¸ <span class="required">*</span></label>
                <div class="number-input">
                    <input type="text" id="myNumber" class="form-control" placeholder="0" maxlength="2" inputmode="numeric">
                    <span>ë²ˆ</span>
                </div>
                <p class="hint">ëª…ì°°ì— ì íŒ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>

            <!-- ì´ë¦„ -->
            <div class="form-group">
                <label>ì´ë¦„ <span class="required">*</span></label>
                <input type="text" id="myName" class="form-control" placeholder="ë³¸ì¸ ì´ë¦„" required>
            </div>

            <!-- ì—°ë½ì²˜ íƒ€ì… -->
            <div class="form-group">
                <label>ì—°ë½ ë°©ë²• <span class="required">*</span></label>
                <div class="radio-group" id="contactTypeGroup">
                    <div class="radio-option" data-value="phone" onclick="selectContactType('phone')">ì „í™”</div>
                    <div class="radio-option" data-value="kakao" onclick="selectContactType('kakao')">ì¹´í†¡</div>
                    <div class="radio-option" data-value="instagram" onclick="selectContactType('instagram')">ì¸ìŠ¤íƒ€</div>
                </div>
            </div>

            <!-- ì—°ë½ì²˜ -->
            <div class="form-group">
                <label>ì—°ë½ì²˜ <span class="required">*</span></label>
                <input type="text" id="contactValue" class="form-control" placeholder="ì—°ë½ì²˜ ì…ë ¥" required>
            </div>

            <!-- ìƒëŒ€ ë²ˆí˜¸ ì„ íƒ -->
            <div class="form-group">
                <label>ë§ˆìŒì— ë“œëŠ” ìƒëŒ€ ë²ˆí˜¸</label>
                <p class="selection-info">ìµœëŒ€ <span class="count" id="maxCount">3</span>ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥</p>
                <div class="target-numbers" id="targetNumbersWrap">
                    <input type="text" class="form-control target-input" placeholder="0" maxlength="2" inputmode="numeric">
                    <input type="text" class="form-control target-input" placeholder="0" maxlength="2" inputmode="numeric">
                    <input type="text" class="form-control target-input" placeholder="0" maxlength="2" inputmode="numeric">
                </div>
                <button type="button" class="none-btn" id="noMatchBtn" onclick="toggleNoMatch()">ì—†ì–´ìš” ğŸ˜…</button>
            </div>

            <!-- ì˜¤ëŠ˜ì˜ ë§¤ë„ˆì¸ -->
            <div class="form-group">
                <div class="manner-section">
                    <label>â­ ì˜¤ëŠ˜ì˜ ë§¤ë„ˆì¸</label>
                    <p class="hint" style="margin-bottom: 12px;">ë§¤ì¹­ê³¼ ë³„ê°œë¡œ, ë§¤ë„ˆê°€ ì¢‹ì•˜ë˜ ë¶„ì´ ìˆë‹¤ë©´ ì•Œë ¤ì£¼ì„¸ìš”</p>
                    <div class="target-numbers" id="mannerNumbersWrap">
                        <input type="text" class="form-control manner-input" placeholder="0" maxlength="2" inputmode="numeric">
                    </div>
                    <button type="button" class="none-btn" id="noMannerBtn" onclick="toggleNoManner()">ì—†ì–´ìš”</button>
                </div>
            </div>

            <!-- í•˜ê³  ì‹¶ì€ ë§ -->
            <div class="form-group">
                <label>í•˜ê³  ì‹¶ì€ ë§ (ì„ íƒ)</label>
                <textarea id="comment" class="comment-box" placeholder="ìš´ì˜ì§„ì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ë§ì´ ìˆë‹¤ë©´ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”"></textarea>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">ì œì¶œí•˜ê¸°</button>
            <p class="error-msg" id="errorMsg"></p>
        </form>

        <div class="success-card" id="successCard">
            <div class="success-icon">âœ…</div>
            <h2>ì œì¶œ ì™„ë£Œ!</h2>
            <div class="result-box">
                <div class="label">ë§ˆìŒì— ë“œëŠ” ìƒëŒ€</div>
                <div class="value" id="submittedNumbers">-</div>
            </div>
            <div class="result-box" style="margin-top: 12px;">
                <div class="label">ì˜¤ëŠ˜ì˜ ë§¤ë„ˆì¸</div>
                <div class="value" id="submittedManner" style="color: #FFD700;">-</div>
            </div>
            <p style="margin-top: 16px;">ë§¤ì¹­ ê²°ê³¼ëŠ” íŒŒí‹° ì¢…ë£Œ í›„<br>ê´€ë¦¬ìê°€ ê°œë³„ ì—°ë½ë“œë¦½ë‹ˆë‹¤.</p>
            <button onclick="location.reload()" class="submit-btn" style="margin-top: 20px;">ë‹¤ì‹œ ì œì¶œí•˜ê¸°</button>
        </div>

        <div class="footer">
            <a href="https://instagram.com/svvy.s" target="_blank">@svvy.s</a>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bqpxdxsgxoapguknxwul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcHhkeHNneG9hcGd1a254d3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjUyNDAsImV4cCI6MjA4MzEwMTI0MH0.v_r3wIIIe024k-H-9dyHH-LJj73kP9iU_eYgHZX7CGA';
        const API_BASE = `${SUPABASE_URL}/rest/v1`;
        const HEADERS = {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
        };

        let allSchedules = [];
        let selectedDate = '';
        let selectedSession = null;  // { part, time, party_type }
        let selectedGender = '';
        let selectedContactType = '';
        let selectionLimit = 3;
        let noMatchSelected = false;
        let noMannerSelected = false;

        // í•œê¸€ ë‚ ì§œì—ì„œ ìš”ì¼ ê³„ì‚°
        function getWeekdayFromKoreanDate(koreanDate) {
            // "2026ë…„ 1ì›” 25ì¼" -> Date ê°ì²´
            const match = koreanDate.match(/(\d+)ë…„\s*(\d+)ì›”\s*(\d+)ì¼/);
            if (!match) return '';
            const year = parseInt(match[1]);
            const month = parseInt(match[2]) - 1;
            const day = parseInt(match[3]);
            const d = new Date(year, month, day);
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return weekdays[d.getDay()];
        }

        // íŒŒí‹° íƒ€ì… í•œê¸€
        function getPartyTypeName(type) {
            const map = { 'coffee': 'ì»¤í”¼', 'wine': 'ì™€ì¸', 'soju': 'ì†Œì£¼' };
            return map[type] || type;
        }

        // ì „í™”ë²ˆí˜¸ ì •ê·œí™” (010-0000-0000 í˜•ì‹ìœ¼ë¡œ í†µì¼)
        function normalizePhone(phone) {
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 11 && digits.startsWith('010')) {
                return `${digits.slice(0,3)}-${digits.slice(3,7)}-${digits.slice(7)}`;
            }
            if (digits.length === 10 && digits.startsWith('01')) {
                return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
            }
            return phone; // í˜•ì‹ ì•ˆ ë§ìœ¼ë©´ ì›ë³¸ ìœ ì§€
        }

        async function init() {
            await loadSchedules();

            // ìˆ«ìë§Œ ì…ë ¥
            document.getElementById('myNumber').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
            document.querySelectorAll('.target-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
            });
            document.querySelectorAll('.manner-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
            });

            document.getElementById('eventDate').addEventListener('change', onDateChange);
            document.getElementById('matchForm').addEventListener('submit', handleSubmit);
        }

        // ì—†ì–´ìš” í† ê¸€ - ë§ˆìŒì— ë“œëŠ” ìƒëŒ€
        function toggleNoMatch() {
            noMatchSelected = !noMatchSelected;
            const btn = document.getElementById('noMatchBtn');
            const wrap = document.getElementById('targetNumbersWrap');
            btn.classList.toggle('selected', noMatchSelected);
            wrap.classList.toggle('inputs-disabled', noMatchSelected);
            if (noMatchSelected) {
                document.querySelectorAll('.target-input').forEach(input => input.value = '');
            }
        }

        // ì—†ì–´ìš” í† ê¸€ - ë§¤ë„ˆì¸
        function toggleNoManner() {
            noMannerSelected = !noMannerSelected;
            const btn = document.getElementById('noMannerBtn');
            const wrap = document.getElementById('mannerNumbersWrap');
            btn.classList.toggle('selected', noMannerSelected);
            wrap.classList.toggle('inputs-disabled', noMannerSelected);
            if (noMannerSelected) {
                document.querySelectorAll('.manner-input').forEach(input => input.value = '');
            }
        }

        async function loadSchedules() {
            try {
                const res = await fetch(
                    `${API_BASE}/party_schedules?select=*&is_active=eq.true&order=date.asc,time.asc`,
                    { headers: HEADERS }
                );
                allSchedules = await res.json();

                // ë‚ ì§œ ë“œë¡­ë‹¤ìš´
                const dateSelect = document.getElementById('eventDate');
                const uniqueDates = [...new Set(allSchedules.map(s => s.date))];

                uniqueDates.forEach(date => {
                    const weekday = getWeekdayFromKoreanDate(date);
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = `${date} (${weekday})`;
                    dateSelect.appendChild(option);
                });
            } catch (e) {
                console.error('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }

        function onDateChange() {
            selectedDate = document.getElementById('eventDate').value;
            selectedSession = null;

            const sessionGroup = document.getElementById('sessionGroup');
            sessionGroup.innerHTML = '';

            if (!selectedDate) {
                sessionGroup.innerHTML = '<div class="radio-option" style="color: var(--text-muted);">ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</div>';
                return;
            }

            // í•´ë‹¹ ë‚ ì§œì˜ ì„¸ì…˜ë“¤
            const sessions = allSchedules.filter(s => s.date === selectedDate);

            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = 'radio-option';
                div.dataset.part = s.part;
                div.textContent = `${s.time} ${getPartyTypeName(s.party_type)}`;
                div.onclick = () => selectSession(s, div);
                sessionGroup.appendChild(div);
            });
        }

        function selectSession(session, el) {
            selectedSession = session;
            selectionLimit = selectedGender === 'ë‚¨ì'
                ? (session.male_selection_limit || 3)
                : (session.female_selection_limit || 3);
            document.getElementById('maxCount').textContent = selectionLimit;
            updateTargetInputs();

            document.querySelectorAll('#sessionGroup .radio-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }

        function selectGender(gender) {
            selectedGender = gender;
            document.querySelectorAll('#genderGroup .radio-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.value === gender);
            });

            if (selectedSession) {
                selectionLimit = gender === 'ë‚¨ì'
                    ? (selectedSession.male_selection_limit || 3)
                    : (selectedSession.female_selection_limit || 3);
                document.getElementById('maxCount').textContent = selectionLimit;
                updateTargetInputs();
            }
        }

        function updateTargetInputs() {
            const wrap = document.getElementById('targetNumbersWrap');
            wrap.innerHTML = '';
            for (let i = 0; i < selectionLimit; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control target-input';
                input.placeholder = '0';
                input.maxLength = 2;
                input.inputMode = 'numeric';
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
                wrap.appendChild(input);
            }
        }

        function selectContactType(type) {
            selectedContactType = type;
            document.querySelectorAll('#contactTypeGroup .radio-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.value === type);
            });

            const input = document.getElementById('contactValue');
            switch(type) {
                case 'phone': input.placeholder = '010-0000-0000'; break;
                case 'kakao': input.placeholder = 'ì¹´ì¹´ì˜¤í†¡ ID'; break;
                case 'instagram': input.placeholder = '@username'; break;
            }
        }

        function getSelectedTargets() {
            const inputs = document.querySelectorAll('.target-input');
            const numbers = [];
            inputs.forEach(input => {
                const val = parseInt(input.value);
                if (val > 0 && !numbers.includes(val)) {
                    numbers.push(val);
                }
            });
            return numbers;
        }

        function getMannerPersons() {
            const inputs = document.querySelectorAll('.manner-input');
            const numbers = [];
            inputs.forEach(input => {
                const val = parseInt(input.value);
                if (val > 0 && !numbers.includes(val)) {
                    numbers.push(val);
                }
            });
            return numbers;
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const myNumber = parseInt(document.getElementById('myNumber').value);
            const myName = document.getElementById('myName').value.trim();
            const contactValue = document.getElementById('contactValue').value.trim();
            const targets = getSelectedTargets();
            const mannerPersons = getMannerPersons();
            const comment = document.getElementById('comment').value.trim();

            // ê²€ì¦
            if (!selectedDate || !selectedSession) {
                alert('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            if (!selectedGender) {
                alert('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            if (!myNumber || myNumber < 1) {
                alert('ë‚´ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            if (!myName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            if (!selectedContactType || !contactValue) {
                alert('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            // ë§ˆìŒì— ë“œëŠ” ìƒëŒ€: ì—†ì–´ìš” ì„ íƒ ì•ˆ í–ˆìœ¼ë©´ ìµœì†Œ 1ëª… í•„ìš”
            if (!noMatchSelected && targets.length === 0) {
                alert('ë§ˆìŒì— ë“œëŠ” ìƒëŒ€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜, "ì—†ì–´ìš”"ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì œì¶œ ì¤‘...';

            try {
                // ê¸°ì¡´ ì œì¶œ ë¹„í™œì„±í™”
                await fetch(
                    `${API_BASE}/match_submissions?event_date=eq.${encodeURIComponent(selectedDate)}&event_part=eq.${encodeURIComponent(selectedSession.part)}&lineup_number=eq.${myNumber}&gender=eq.${encodeURIComponent(selectedGender)}`,
                    {
                        method: 'PATCH',
                        headers: { ...HEADERS, 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ is_latest: false })
                    }
                );

                // ìƒˆ ì œì¶œ (ì „í™”ë²ˆí˜¸ëŠ” ì •ê·œí™”)
                const normalizedContact = selectedContactType === 'phone'
                    ? normalizePhone(contactValue)
                    : contactValue;
                const submission = {
                    event_date: selectedDate,
                    event_part: selectedSession.part,
                    party_type: selectedSession.party_type,
                    gender: selectedGender,
                    lineup_number: myNumber,
                    name: myName,
                    contact_type: selectedContactType,
                    contact_value: normalizedContact,
                    selected_numbers: noMatchSelected ? [] : targets,
                    no_selection: noMatchSelected,
                    manner_persons: noMannerSelected ? [] : mannerPersons,
                    no_manner_person: noMannerSelected,
                    comment: comment || null,
                    is_latest: true
                };

                const res = await fetch(`${API_BASE}/match_submissions`, {
                    method: 'POST',
                    headers: { ...HEADERS, 'Prefer': 'return=minimal' },
                    body: JSON.stringify(submission)
                });

                if (!res.ok) throw new Error('ì œì¶œ ì‹¤íŒ¨');

                // ê²°ê³¼ í‘œì‹œ
                const matchResult = noMatchSelected ? 'ì—†ì–´ìš” ì„ íƒ' : (targets.join(', ') + 'ë²ˆ');
                document.getElementById('submittedNumbers').textContent = matchResult;

                const mannerResult = noMannerSelected ? 'ì—†ìŒ' : (mannerPersons.length > 0 ? mannerPersons.join(', ') + 'ë²ˆ' : 'ì—†ìŒ');
                document.getElementById('submittedManner').textContent = mannerResult;

                document.getElementById('matchForm').classList.add('hidden');
                document.getElementById('successCard').classList.add('show');

            } catch (error) {
                console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì œì¶œí•˜ê¸°';
            }
        }

        init();
    </script>
</body>
</html>
