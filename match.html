<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë­˜ ì¢€ ì•„ëŠ” ì‚¬ëŒë“¤ - ë§¤ì¹­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --accent: #a8e063;
            --accent-hover: #96cc54;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-accent {
            background-color: var(--accent);
            transition: background-color 0.2s;
        }
        .btn-accent:hover {
            background-color: var(--accent-hover);
        }
        .btn-accent:active {
            transform: scale(0.98);
        }
        .btn-accent:disabled {
            background-color: #4a4a4a;
            color: #888;
            cursor: not-allowed;
        }
        .number-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 2px solid #444;
            background: #1a1a1a;
            color: white;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }
        .number-btn:hover {
            border-color: var(--accent);
        }
        .number-btn.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: black;
        }
        .number-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .contact-option {
            padding: 16px;
            border: 2px solid #333;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .contact-option:hover {
            border-color: #555;
        }
        .contact-option.selected {
            border-color: var(--accent);
            background: rgba(168, 224, 99, 0.1);
        }
        input[type="text"], input[type="tel"] {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 16px;
            width: 100%;
        }
        input[type="text"]:focus, input[type="tel"]:focus {
            outline: none;
            border-color: var(--accent);
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }
        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
        }
        .step-dot.active {
            background: var(--accent);
        }
        .step-dot.done {
            background: #666;
        }
    </style>
</head>
<body class="bg-black min-h-screen">
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading" class="min-h-screen flex items-center justify-center">
        <div class="text-[#a8e063] text-xl">ë¡œë”© ì¤‘...</div>
    </div>

    <!-- Step 1: ë‚ ì§œ/ì„¸ì…˜ ì„ íƒ -->
    <div id="step1" class="min-h-screen flex-col px-6 py-10 hidden">
        <div class="w-full max-w-md mx-auto">
            <!-- ë¸Œëœë“œ -->
            <div class="text-center mb-8">
                <span class="text-[#a8e063] text-sm font-medium">ë­˜ ì¢€ ì•„ëŠ” ì‚¬ëŒë“¤</span>
                <h1 class="text-white text-2xl font-bold mt-2">ë§¤ì¹­ ì œì¶œ</h1>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-dot active"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
            </div>

            <div class="mb-6">
                <label class="block text-gray-400 text-sm mb-2">íŒŒí‹° ë‚ ì§œ</label>
                <select id="dateSelect" class="w-full bg-gray-800 text-white py-4 px-4 rounded-xl border-2 border-gray-700 focus:border-[#a8e063] outline-none">
                    <option value="">ë‚ ì§œ ì„ íƒ...</option>
                </select>
            </div>

            <div class="mb-8">
                <label class="block text-gray-400 text-sm mb-2">ì„¸ì…˜</label>
                <select id="partSelect" class="w-full bg-gray-800 text-white py-4 px-4 rounded-xl border-2 border-gray-700 focus:border-[#a8e063] outline-none">
                    <option value="">ì„¸ì…˜ ì„ íƒ...</option>
                    <option value="1ë¶€">1ë¶€ (ì»¤í”¼)</option>
                    <option value="2ë¶€">2ë¶€ (ì»¤í”¼)</option>
                    <option value="3ë¶€">3ë¶€ (ì™€ì¸)</option>
                </select>
            </div>

            <button onclick="goToStep2()" class="w-full btn-accent text-black font-bold py-4 rounded-xl" id="step1Next" disabled>
                ë‹¤ìŒ
            </button>
        </div>
    </div>

    <!-- Step 2: ë³¸ì¸ í™•ì¸ -->
    <div id="step2" class="min-h-screen flex-col px-6 py-10 hidden">
        <div class="w-full max-w-md mx-auto">
            <!-- ë¸Œëœë“œ -->
            <div class="text-center mb-8">
                <span class="text-[#a8e063] text-sm font-medium">ë­˜ ì¢€ ì•„ëŠ” ì‚¬ëŒë“¤</span>
                <h1 class="text-white text-2xl font-bold mt-2">ë³¸ì¸ í™•ì¸</h1>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-dot done"></div>
                <div class="step-dot active"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
            </div>

            <p class="text-gray-400 text-center mb-6">ì˜ˆì•½í•˜ì‹  ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>

            <div class="mb-8">
                <input type="tel" id="phoneLast4" placeholder="ì˜ˆ: 1234" maxlength="4" pattern="[0-9]*" inputmode="numeric"
                    class="text-center text-2xl tracking-widest">
            </div>

            <button onclick="verifyPhone()" class="w-full btn-accent text-black font-bold py-4 rounded-xl" id="step2Next" disabled>
                í™•ì¸
            </button>

            <button onclick="goBack(1)" class="w-full text-gray-500 py-4 mt-4 hover:text-white transition-colors">
                ì´ì „ìœ¼ë¡œ
            </button>

            <div id="verifyError" class="text-red-500 text-center mt-4 hidden"></div>
        </div>
    </div>

    <!-- Step 3: ì •ë³´ í™•ì¸ ë° ì—°ë½ì²˜ ì…ë ¥ -->
    <div id="step3" class="min-h-screen flex-col px-6 py-10 hidden">
        <div class="w-full max-w-md mx-auto">
            <!-- ë¸Œëœë“œ -->
            <div class="text-center mb-8">
                <span class="text-[#a8e063] text-sm font-medium">ë­˜ ì¢€ ì•„ëŠ” ì‚¬ëŒë“¤</span>
                <h1 class="text-white text-2xl font-bold mt-2">ë‚´ ì •ë³´</h1>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-dot done"></div>
                <div class="step-dot done"></div>
                <div class="step-dot active"></div>
                <div class="step-dot"></div>
            </div>

            <!-- ë³¸ì¸ ì •ë³´ ì¹´ë“œ -->
            <div class="bg-gray-800 rounded-2xl p-6 mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-[#a8e063] rounded-full flex items-center justify-center">
                        <span id="myNumber" class="text-3xl font-bold text-black">?</span>
                    </div>
                    <div>
                        <div id="myName" class="text-white text-xl font-bold">-</div>
                        <div id="myGender" class="text-gray-400">-</div>
                    </div>
                </div>
            </div>

            <p class="text-gray-400 mb-4">ìƒëŒ€ë°©ì—ê²Œ ì „ë‹¬í•  ì—°ë½ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>

            <!-- ì—°ë½ì²˜ íƒ€ì… ì„ íƒ -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="contact-option text-center" onclick="selectContactType('phone')">
                    <div class="text-2xl mb-1">ğŸ“±</div>
                    <div class="text-white text-sm">ì „í™”ë²ˆí˜¸</div>
                </div>
                <div class="contact-option text-center" onclick="selectContactType('kakao')">
                    <div class="text-2xl mb-1">ğŸ’¬</div>
                    <div class="text-white text-sm">ì¹´ì¹´ì˜¤í†¡</div>
                </div>
                <div class="contact-option text-center" onclick="selectContactType('instagram')">
                    <div class="text-2xl mb-1">ğŸ“·</div>
                    <div class="text-white text-sm">ì¸ìŠ¤íƒ€</div>
                </div>
            </div>

            <!-- ì—°ë½ì²˜ ê°’ ì…ë ¥ -->
            <div id="contactInputWrap" class="mb-8 hidden">
                <input type="text" id="contactValue" placeholder="ì—°ë½ì²˜ ì…ë ¥">
                <p id="contactHint" class="text-gray-500 text-sm mt-2"></p>
            </div>

            <button onclick="goToStep4()" class="w-full btn-accent text-black font-bold py-4 rounded-xl" id="step3Next" disabled>
                ë‹¤ìŒ
            </button>

            <button onclick="goBack(2)" class="w-full text-gray-500 py-4 mt-4 hover:text-white transition-colors">
                ì´ì „ìœ¼ë¡œ
            </button>
        </div>
    </div>

    <!-- Step 4: ìƒëŒ€ ì„ íƒ -->
    <div id="step4" class="min-h-screen flex-col px-6 py-10 hidden">
        <div class="w-full max-w-md mx-auto">
            <!-- ë¸Œëœë“œ -->
            <div class="text-center mb-8">
                <span class="text-[#a8e063] text-sm font-medium">ë­˜ ì¢€ ì•„ëŠ” ì‚¬ëŒë“¤</span>
                <h1 class="text-white text-2xl font-bold mt-2">ë§¤ì¹­ ì„ íƒ</h1>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-dot done"></div>
                <div class="step-dot done"></div>
                <div class="step-dot done"></div>
                <div class="step-dot active"></div>
            </div>

            <p class="text-gray-400 text-center mb-2">ë§ˆìŒì— ë“œëŠ” ìƒëŒ€ì˜ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            <p id="selectionLimitText" class="text-[#a8e063] text-center text-lg font-bold mb-6">ìµœëŒ€ 3ëª… ì„ íƒ ê°€ëŠ¥</p>

            <!-- ì„ íƒ ì¹´ìš´í„° -->
            <div class="text-center mb-6">
                <span class="text-white text-lg">ì„ íƒ: </span>
                <span id="selectedCount" class="text-[#a8e063] text-2xl font-bold">0</span>
                <span id="selectionMax" class="text-gray-500 text-lg"> / 3</span>
            </div>

            <!-- ë²ˆí˜¸ ê·¸ë¦¬ë“œ -->
            <div id="numberGrid" class="flex flex-wrap justify-center gap-3 mb-8">
                <!-- ë™ì  ìƒì„± -->
            </div>

            <button onclick="submitMatch()" class="w-full btn-accent text-black font-bold py-4 rounded-xl" id="submitBtn" disabled>
                ì œì¶œí•˜ê¸°
            </button>

            <button onclick="goBack(3)" class="w-full text-gray-500 py-4 mt-4 hover:text-white transition-colors">
                ì´ì „ìœ¼ë¡œ
            </button>
        </div>
    </div>

    <!-- Step 5: ì™„ë£Œ -->
    <div id="step5" class="min-h-screen flex-col items-center justify-center px-6 py-10 hidden">
        <div class="w-full max-w-md mx-auto text-center">
            <div class="text-6xl mb-6">âœ…</div>
            <h1 class="text-white text-2xl font-bold mb-4">ì œì¶œ ì™„ë£Œ!</h1>
            <p class="text-gray-400 mb-8">ë§¤ì¹­ ê²°ê³¼ëŠ” íŒŒí‹° ì¢…ë£Œ í›„<br>ê´€ë¦¬ìê°€ ì—°ë½ë“œë¦½ë‹ˆë‹¤.</p>

            <div class="bg-gray-800 rounded-2xl p-6 mb-8">
                <div class="text-gray-400 text-sm mb-2">ë‚´ê°€ ì„ íƒí•œ ë²ˆí˜¸</div>
                <div id="submittedNumbers" class="text-[#a8e063] text-2xl font-bold"></div>
            </div>

            <p class="text-gray-500 text-sm">
                ìˆ˜ì •ì´ í•„ìš”í•˜ì‹œë©´ ë‹¤ì‹œ ì œì¶œí•´ì£¼ì„¸ìš”.<br>
                ë§ˆì§€ë§‰ ì œì¶œë§Œ ìœ íš¨í•©ë‹ˆë‹¤.
            </p>

            <button onclick="location.reload()" class="w-full bg-gray-800 text-white font-bold py-4 rounded-xl mt-8 hover:bg-gray-700 transition-colors">
                ë‹¤ì‹œ ì œì¶œí•˜ê¸°
            </button>

            <a href="https://instagram.com/svvy.s" target="_blank" rel="noopener noreferrer"
               class="block mt-8 text-gray-500 text-sm hover:text-[#a8e063] transition-colors">
                @svvy.s
            </a>
        </div>
    </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://bqpxdxsgxoapguknxwul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcHhkeHNneG9hcGd1a254d3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjUyNDAsImV4cCI6MjA4MzEwMTI0MH0.v_r3wIIIe024k-H-9dyHH-LJj73kP9iU_eYgHZX7CGA';
        const API_BASE = `${SUPABASE_URL}/rest/v1`;

        // ìƒíƒœ
        let selectedDate = '';
        let selectedPart = '';
        let currentUser = null;  // { name, lineup_number, gender, reservation_id }
        let selectedContactType = '';
        let contactValue = '';
        let selectedNumbers = new Set();
        let selectionLimit = 3;
        let partyType = 'coffee';  // coffee or wine
        let oppositeGenderCount = 0;

        // DOM ìš”ì†Œ
        const loadingEl = document.getElementById('loading');
        const step1El = document.getElementById('step1');
        const step2El = document.getElementById('step2');
        const step3El = document.getElementById('step3');
        const step4El = document.getElementById('step4');
        const step5El = document.getElementById('step5');

        // ì´ˆê¸°í™”
        async function init() {
            // URL íŒŒë¼ë¯¸í„° í™•ì¸
            const params = new URLSearchParams(window.location.search);
            const dateParam = params.get('date');
            const partParam = params.get('part');

            // ë‚ ì§œ ì˜µì…˜ ë¡œë“œ
            await loadDateOptions();

            if (dateParam) {
                document.getElementById('dateSelect').value = dateParam;
                selectedDate = dateParam;
            }
            if (partParam) {
                document.getElementById('partSelect').value = partParam;
                selectedPart = partParam;
            }

            updateStep1Button();

            loadingEl.classList.add('hidden');
            step1El.classList.remove('hidden');
            step1El.classList.add('flex');

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('dateSelect').addEventListener('change', (e) => {
                selectedDate = e.target.value;
                updateStep1Button();
            });
            document.getElementById('partSelect').addEventListener('change', (e) => {
                selectedPart = e.target.value;
                updateStep1Button();
            });
            document.getElementById('phoneLast4').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
                document.getElementById('step2Next').disabled = e.target.value.length !== 4;
            });
            document.getElementById('contactValue').addEventListener('input', (e) => {
                contactValue = e.target.value.trim();
                updateStep3Button();
            });
        }

        // ë‚ ì§œ ì˜µì…˜ ë¡œë“œ
        async function loadDateOptions() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(
                    `${API_BASE}/party_schedules?select=date&date=gte.${today}&order=date.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const schedules = await response.json();
                    const uniqueDates = [...new Set(schedules.map(s => s.date))];
                    const dateSelect = document.getElementById('dateSelect');

                    uniqueDates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        const d = new Date(date);
                        option.textContent = `${d.getMonth() + 1}ì›” ${d.getDate()}ì¼ (${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()]})`;
                        dateSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ë‚ ì§œ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function updateStep1Button() {
            document.getElementById('step1Next').disabled = !selectedDate || !selectedPart;
        }

        function updateStep3Button() {
            document.getElementById('step3Next').disabled = !selectedContactType || !contactValue;
        }

        // í™”ë©´ ì „í™˜
        function showScreen(stepNum) {
            [step1El, step2El, step3El, step4El, step5El].forEach((el, idx) => {
                el.classList.add('hidden');
                el.classList.remove('flex');
                if (idx + 1 === stepNum) {
                    el.classList.remove('hidden');
                    el.classList.add('flex');
                }
            });
        }

        function goBack(toStep) {
            showScreen(toStep);
        }

        async function goToStep2() {
            // ìŠ¤ì¼€ì¤„ ì •ë³´ ë¡œë“œ
            try {
                const response = await fetch(
                    `${API_BASE}/party_schedules?date=eq.${selectedDate}&part=eq.${selectedPart}&select=*`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const schedules = await response.json();
                    if (schedules.length > 0) {
                        const schedule = schedules[0];
                        partyType = schedule.party_type || 'coffee';
                    }
                }
            } catch (error) {
                console.error('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }

            showScreen(2);
        }

        async function verifyPhone() {
            const phoneLast4 = document.getElementById('phoneLast4').value;
            const errorEl = document.getElementById('verifyError');
            errorEl.classList.add('hidden');

            try {
                // í•´ë‹¹ ë‚ ì§œ/ì„¸ì…˜ì˜ ì˜ˆì•½ì—ì„œ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ë¡œ ê²€ìƒ‰
                const response = await fetch(
                    `${API_BASE}/reservations?event_date=eq.${selectedDate}&event_part=eq.${selectedPart}&select=*,customers(name,gender)`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨');

                const reservations = await response.json();

                // ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ ë§¤ì¹­
                const matched = reservations.find(r => {
                    const phone = r.phone || '';
                    return phone.slice(-4) === phoneLast4;
                });

                if (matched) {
                    currentUser = {
                        name: matched.customers?.name || matched.name || 'ì°¸ê°€ì',
                        lineup_number: matched.lineup_number,
                        gender: matched.customers?.gender || matched.gender || '',
                        reservation_id: matched.id,
                        phone: matched.phone
                    };

                    // ì„ íƒ í•œë„ ê°€ì ¸ì˜¤ê¸°
                    await loadSelectionLimit();

                    // ìƒëŒ€ ì„±ë³„ ì¸ì›ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                    await loadOppositeGenderCount(reservations);

                    goToStep3();
                } else {
                    errorEl.textContent = 'ì¼ì¹˜í•˜ëŠ” ì˜ˆì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('í™•ì¸ ì˜¤ë¥˜:', error);
                errorEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                errorEl.classList.remove('hidden');
            }
        }

        async function loadSelectionLimit() {
            try {
                const response = await fetch(
                    `${API_BASE}/party_schedules?date=eq.${selectedDate}&part=eq.${selectedPart}&select=male_selection_limit,female_selection_limit`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const schedules = await response.json();
                    if (schedules.length > 0) {
                        const schedule = schedules[0];
                        if (currentUser.gender === 'ë‚¨ì') {
                            selectionLimit = schedule.male_selection_limit || 3;
                        } else {
                            selectionLimit = schedule.female_selection_limit || 3;
                        }
                    }
                }
            } catch (error) {
                console.error('í•œë„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function loadOppositeGenderCount(reservations) {
            const oppositeGender = currentUser.gender === 'ë‚¨ì' ? 'ì—¬ì' : 'ë‚¨ì';

            // ì‹¤ì œ ì˜ˆì•½ì ì¤‘ ìƒëŒ€ ì„±ë³„ ì¸ì› (lineup_numberê°€ ìˆëŠ”)
            const realOpposite = reservations.filter(r => {
                const gender = r.customers?.gender || r.gender;
                return gender === oppositeGender && r.lineup_number;
            });

            // ê°€ìƒ ì°¸ì—¬ìë„ í¬í•¨
            try {
                const response = await fetch(
                    `${API_BASE}/party_virtual_assignments?schedule_date=eq.${selectedDate}&schedule_part=eq.${selectedPart}&gender=eq.${oppositeGender}&lineup_number=not.is.null&select=lineup_number`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const virtuals = await response.json();
                    oppositeGenderCount = realOpposite.length + virtuals.length;
                } else {
                    oppositeGenderCount = realOpposite.length;
                }
            } catch (error) {
                oppositeGenderCount = realOpposite.length;
            }
        }

        function goToStep3() {
            // ë³¸ì¸ ì •ë³´ í‘œì‹œ
            document.getElementById('myNumber').textContent = currentUser.lineup_number || '?';
            document.getElementById('myName').textContent = currentUser.name;
            document.getElementById('myGender').textContent = currentUser.gender;

            showScreen(3);
        }

        function selectContactType(type) {
            selectedContactType = type;

            // UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('.contact-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // ì…ë ¥ í•„ë“œ í‘œì‹œ
            const inputWrap = document.getElementById('contactInputWrap');
            const input = document.getElementById('contactValue');
            const hint = document.getElementById('contactHint');

            inputWrap.classList.remove('hidden');

            switch(type) {
                case 'phone':
                    input.placeholder = '010-0000-0000';
                    input.type = 'tel';
                    hint.textContent = 'ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
                    // ì˜ˆì•½ ì „í™”ë²ˆí˜¸ë¡œ ìë™ ì±„ìš°ê¸°
                    if (currentUser.phone) {
                        input.value = currentUser.phone;
                        contactValue = currentUser.phone;
                    }
                    break;
                case 'kakao':
                    input.placeholder = 'ì¹´ì¹´ì˜¤í†¡ ID';
                    input.type = 'text';
                    hint.textContent = 'ì¹´ì¹´ì˜¤í†¡ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
                    input.value = '';
                    contactValue = '';
                    break;
                case 'instagram':
                    input.placeholder = '@username';
                    input.type = 'text';
                    hint.textContent = 'ì¸ìŠ¤íƒ€ê·¸ë¨ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
                    input.value = '';
                    contactValue = '';
                    break;
            }

            updateStep3Button();
        }

        function goToStep4() {
            // ì„ íƒ í•œë„ í‘œì‹œ
            document.getElementById('selectionLimitText').textContent = `ìµœëŒ€ ${selectionLimit}ëª… ì„ íƒ ê°€ëŠ¥`;
            document.getElementById('selectionMax').textContent = ` / ${selectionLimit}`;

            // ë²ˆí˜¸ ë²„íŠ¼ ìƒì„±
            const grid = document.getElementById('numberGrid');
            grid.innerHTML = '';

            for (let i = 1; i <= oppositeGenderCount; i++) {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = i;
                btn.onclick = () => toggleNumber(i, btn);
                grid.appendChild(btn);
            }

            if (oppositeGenderCount === 0) {
                grid.innerHTML = '<p class="text-gray-500">ì„ íƒ ê°€ëŠ¥í•œ ìƒëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            showScreen(4);
        }

        function toggleNumber(num, btn) {
            if (selectedNumbers.has(num)) {
                selectedNumbers.delete(num);
                btn.classList.remove('selected');
            } else {
                if (selectedNumbers.size >= selectionLimit) {
                    // í•œë„ ì´ˆê³¼ - ì²« ë²ˆì§¸ ì„ íƒ í•´ì œ
                    return;
                }
                selectedNumbers.add(num);
                btn.classList.add('selected');
            }

            document.getElementById('selectedCount').textContent = selectedNumbers.size;
            document.getElementById('submitBtn').disabled = selectedNumbers.size === 0;
        }

        async function submitMatch() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì œì¶œ ì¤‘...';

            try {
                // ê¸°ì¡´ ì œì¶œ ë¹„í™œì„±í™”
                await fetch(
                    `${API_BASE}/match_submissions?event_date=eq.${selectedDate}&event_part=eq.${selectedPart}&lineup_number=eq.${currentUser.lineup_number}&gender=eq.${currentUser.gender}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ is_latest: false })
                    }
                );

                // ìƒˆ ì œì¶œ
                const submission = {
                    event_date: selectedDate,
                    event_part: selectedPart,
                    party_type: partyType,
                    gender: currentUser.gender,
                    lineup_number: currentUser.lineup_number,
                    name: currentUser.name,
                    contact_type: selectedContactType,
                    contact_value: contactValue,
                    selected_numbers: Array.from(selectedNumbers),
                    reservation_id: currentUser.reservation_id,
                    is_latest: true
                };

                const response = await fetch(`${API_BASE}/match_submissions`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(submission)
                });

                if (!response.ok) throw new Error('ì œì¶œ ì‹¤íŒ¨');

                // ì™„ë£Œ í™”ë©´
                document.getElementById('submittedNumbers').textContent =
                    Array.from(selectedNumbers).sort((a,b) => a-b).join(', ') + 'ë²ˆ';

                showScreen(5);

            } catch (error) {
                console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì œì¶œí•˜ê¸°';
            }
        }

        // ì´ˆê¸°í™” ì‹¤í–‰
        init();
    </script>
</body>
</html>
