# 뭘 좀 아는 사람들 - 프리미엄 파티 관리 시스템

> 안정적이고 안전하며 장기적으로 유지 가능한 통합 운영 구조

---

## 🌐 배포 정보

| 항목 | 내용 |
|------|------|
| **프로덕션 URL** | https://svvys.com |
| **관리자 페이지** | https://svvys.com/adm_k8x2m.html |
| **호스팅** | Cloudflare Pages |
| **배포 방법** | `git push origin master` → **자동 배포** |
| **GitHub 저장소** | https://github.com/myeolkoreaseoul/svvys.git |
| **GitHub Token** | `.git_token` 파일 참조 (gitignore됨) |

### 배포 프로세스
```bash
# 1. 코드 수정 후 커밋
git add .
git commit -m "설명"

# 2. push하면 Cloudflare가 자동 배포
git push origin master

# 3. 1-2분 후 프로덕션 반영 확인
```

---

## 🚀 최신 업데이트 (2026-01-11)

### ✅ 2026-01-11 완료된 작업

**🏢 현장모드(Staff Mode) 구현**

파티 현장에서 스태프가 사용할 수 있는 간소화된 관리 화면.

**사용법:**
```
https://svvys.com/adm_k8x2m.html?mode=staff
```

**현장모드 기능:**
- 표시되는 탭: **라인업**, **매칭** (2개만)
- 숨겨지는 탭: 대시보드, 고객관리, 초대장신청, 예약관리, 가상참여자, 파티일정, 직업티어표, 블랙리스트, 설정
- 라인업 테이블에서 **티어/유형 컬럼 숨김** (민감정보 보호)
- 라인업 테이블에 **참석 체크 버튼** 추가 (클릭으로 참석/미참석 토글)
- 상단에 **참석 카운터** 표시 (예: "참석 체크: 5/12")
- 헤더 제목: "뭘좀**Staff** 현장관리"
- 가상참여자 관련 버튼 숨김 (랜덤추가, 번호부여 등)

**변경된 파일:**
- `adm_k8x2m.html`: 현장모드 감지 및 UI 분기 처리

---

**💕 매칭 폼 개선 (match.html)**

- "없어요" 버튼 추가 (마음에 드는 상대가 없을 때)
- "오늘의 매너인" 섹션 추가 (마음에 드는 상대와 중복 선택 가능)
- "하고 싶은 말" 코멘트 입력 추가
- 전화번호 자동 정규화 (01000000000 → 010-0000-0000)

**새 마이그레이션:**
```sql
-- migrations/002_match_extra_fields.sql 실행 필요
ALTER TABLE match_submissions ADD COLUMN IF NOT EXISTS no_selection BOOLEAN DEFAULT FALSE;
ALTER TABLE match_submissions ADD COLUMN IF NOT EXISTS manner_persons INTEGER[];
ALTER TABLE match_submissions ADD COLUMN IF NOT EXISTS no_manner_person BOOLEAN DEFAULT FALSE;
ALTER TABLE match_submissions ADD COLUMN IF NOT EXISTS comment TEXT;
```

---

**🐛 버그 수정**

| 문제 | 원인 | 해결 |
|------|------|------|
| `fetchSchedules is not defined` 에러 | 존재하지 않는 함수를 참조하는 코드가 있었음 | 해당 코드 제거 |
| `minDate is not defined` 에러 | 변수 정의 전에 사용 | `today` 변수로 대체, showPast 조건문 안에서 처리 |

---

### ⚠️ 장기적 유의사항

1. **배포 필수**: 코드 수정 후 반드시 `git push` 해야 Cloudflare에 반영됨
2. **함수/변수 참조**: 정의되지 않은 함수나 변수를 참조하면 페이지 전체가 동작 안함
3. **현장 운영**: 파티 현장에서는 반드시 `?mode=staff` URL로 접속
4. **티어 보안**: 현장모드에서 티어 정보가 노출되면 안됨 (직업은 OK)
5. **단일 코드베이스**: staff.html 별도 파일 대신 관리자 페이지에 모드 분기로 구현 (코드 중복 방지)

---

## 🚀 이전 업데이트 (2026-01-10)

### ✅ 2026-01-10 완료된 작업

**🔑 고객 ID 기반 시스템 도입 (전화번호 매칭 문제 근본 해결)**

기존 전화번호 의존 매칭 → `customer_id` 기반 매칭으로 전환

**문제였던 것:**
1. 블랙리스트 '안은환' → 정상고객만 필터 적용 안됨
2. 수기등록 '강인철'(010-0000-0000) → 예약관리에 안보임
3. 라인업 남자 7명 중 4명만 표시 (성별 미상 3명)

**해결책:**
- `customer_id` 고유 식별자 도입 (CUS-timestamp-random 형식)
- 모든 매칭 로직: customer_id > 전화번호 > 이름 순으로 시도
- 블랙리스트 필터링 개선

**변경된 파일:**
- `adm_k8x2m.html`: 고객/예약/라인업 매칭 로직 전면 개선
- `supabase_setup.sql`: customer_id 컬럼 추가

**DB 스키마 변경:**
```sql
-- customers, reservations, invitations, surveys에 customer_id 추가
ALTER TABLE customers ADD COLUMN IF NOT EXISTS customer_id TEXT UNIQUE;
ALTER TABLE reservations ADD COLUMN IF NOT EXISTS customer_id TEXT;
ALTER TABLE invitations ADD COLUMN IF NOT EXISTS customer_id TEXT;
ALTER TABLE surveys ADD COLUMN IF NOT EXISTS customer_id TEXT;
```

**마이그레이션:**
1. 설정 탭 → "customer_id 마이그레이션 실행" 버튼 클릭
2. 기존 고객에 자동으로 customer_id 부여
3. 연결된 예약에도 customer_id 연결

---

## 🚀 이전 업데이트 (2026-01-09)

### ✅ 2026-01-09 완료된 작업

**0. 정원 연동 및 고객 매칭 개선**
- 최종 라인업 정원: 스케줄 개별 정원 우선 적용 (예: 1/11 1부 7:7)
  - `schedule.maleCapacity` → `partyTypeInfo.maleCapacity` → 12 순으로 fallback
- 고객관리 기본 필터: '정상 고객만'으로 변경 (블랙리스트 기본 제외)
- 블랙리스트 라인업 필터: 로직 명확화 + 디버그 로그 추가
- 성별 '미상' 처리:
  - 라인업에 경고 표시 ("⚠️ 성별미상 N명")
  - 여자 테이블 하단에 미상 고객 목록 표시
- 이름 매칭 fallback 추가 (전화번호 불일치 시 crewName으로 검색)

**1. 고객 추가 시 예약 함께 생성 기능**
- 고객 추가/수정 폼에 "예약도 함께 생성" 체크박스 추가
- 날짜/세션/결제유형 선택 가능
- 초대장 고객이면 자동으로 INV로 표시

**2. 버그 수정: 날짜 중복, 인증단계, 예약 수정 에러**
- 날짜 드롭다운 중복: 날짜 정규화 후 Map으로 중복 제거
- 인증단계 변경 안됨: `manual_stage` 필드 사용, DB 스키마 추가
- 예약 수정 400 에러: `payment_type`, `payment_note` 컬럼 추가

**3. 블랙리스트 관리 기능**
- 블랙리스트 탭 추가: 목록 조회, 해제 기능
- 예약관리: 블랙리스트 고객 자동 숨김
- 고객관리: 블랙리스트 고객 빨간 배경 + ⛔ 아이콘 표시
- 라인업: 블랙리스트 고객 제외

**4. 대시보드 전면 수정**
- 전체 고객 수: `integratedCustomers` 기준 (고객관리와 일치)
- 다가오는 파티: `party_schedules` 기준으로 표시
- 비활성화(삭제)된 일정 제외
- 정원은 스케줄의 `maleCapacity`/`femaleCapacity` 사용

**5. 라인업 개선**
- 직업 상세(`job_detail`) 우선 표시, 없으면 대분류
- 날짜 정규화: 연도 없는 형식 ("1월 11일") 지원
- 블랙리스트 고객 제외

**6. Supabase 스키마 변경**
```sql
-- customers 테이블
ALTER TABLE customers ADD COLUMN IF NOT EXISTS manual_stage TEXT;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS nickname TEXT;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS is_blacklisted BOOLEAN DEFAULT FALSE;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS blacklist_reason TEXT;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS blacklisted_at TIMESTAMPTZ;

-- reservations 테이블
ALTER TABLE reservations ADD COLUMN IF NOT EXISTS payment_type TEXT;
ALTER TABLE reservations ADD COLUMN IF NOT EXISTS payment_note TEXT;
```

---

## 📋 이전 업데이트 (2026-01-08)

### ✅ 2026-01-08 완료된 작업

**1. 예약 현황 탭 개선**
- 파티일시 컬럼 추가 (날짜 + 시간 + 세션)
- 결제유형 컬럼 추가 (🅿️프립/💵현금/🎫면제/🎁보상)
- 파티 일정(schedules) 테이블과 연동하여 시간 자동 표시
- 일정에서 시간 변경 시 예약 현황에도 자동 반영

**2. 수동 단계 변경 기능 (고객 상세 모달)**
- 드롭다운으로 고객 단계 수동 변경 가능
  - 0 - 미분류
  - 1 - 초대장 신청
  - 2 - 프립 결제완료
  - 3 - 사전조사 완료
  - 4 - 참여 완료
  - 5 - 행사 불참
- 단계 변경 시 필요한 데이터 자동 생성 (초대장, 예약, 설문조사)
- 프립 결제 없이 온 사람도 "결제 완료" 단계로 등록 가능

**3. 예약 추가/수정 시 결제 유형 선택**
- 🅿️ 프립 결제 (기본)
- 💵 현금/계좌이체
- 🎫 결제 면제 (VIP/초청)
- 🎁 보상 무료
- 면제/보상 선택 시 사유 입력란 표시

**4. 고객 수정 버그 수정**
- DB 필드명(snake_case)과 프론트엔드 변수명(camelCase) 불일치 해결
- `birth_year`, `job_category`, `job_detail` 필드 호환 처리

---

## 📋 이전 업데이트 (2026-01-05)

### ✅ 완료된 기능

| 기능 | 상태 | 설명 |
|------|------|------|
| 프립 예약 → 사전조사 문자 | ✅ 작동 | GAS → Supabase 저장 + 솔라피 발송 |
| 설문 완료 → 확인 문자 | ✅ 작동 | survey.html 제출 시 자동 발송 |
| 파일 업로드 | ✅ 작동 | 구글 드라이브에 저장, URL만 DB에 |
| D-1 장소 안내 문자 | ✅ 작동 | 매일 오전 10~11시 자동 발송 (GAS 트리거) |
| Supabase RLS 권한 | ✅ 완료 | 모든 테이블 anon SELECT 권한 추가 |

### ⏳ 미구현

| 기능 | 우선순위 | 설명 |
|------|---------|------|
| 설문 미완료 리마인더 | 중간 | D-3 또는 D-2에 독촉 문자 |
| 초대장 신청 후 예약 미완료 안내 | 중간 | 프립 결제 안내 문자 |

### 🔑 Supabase API 키 가이드

**GAS에서 Supabase 연동 시 service_role 키 사용:**

1. Supabase 대시보드 → **Settings** → **API Keys**
2. 상단 탭에서 **"Legacy anon, service_role API keys"** 클릭
3. **service_role** 키 복사 (`eyJ...`로 시작하는 긴 키)
4. GAS 코드의 `SUPABASE_KEY`에 붙여넣기

> ⚠️ service_role 키는 RLS를 우회하므로 서버(GAS)에서만 사용!

### 📱 문자 발송 시스템 (GAS)

**GAS URL:** `https://script.google.com/macros/s/AKfycbzW9ts1S4krUi1FKW9mYCGbksIHv1MaqMlYNRa07dPy2887DLjOfcbmjZAsrARXj3X-/exec`

| Action | 기능 | 트리거 |
|--------|------|--------|
| fripSale | 프립 예약 → 사전조사 문자 | Tasker (카톡 감지) |
| fripCancel | 프립 취소 처리 | Tasker (카톡 감지) |
| sendSurveyConfirmSms | 설문 완료 확인 문자 | survey.html 제출 시 |
| uploadFiles | 파일 업로드 (구글 드라이브) | survey.html, verification.html |
| sendD1LocationSms | D-1 장소 안내 | GAS 트리거 (매일 10~11시) |

### 📂 파일 저장 위치

| 파일 종류 | 저장 위치 | 폴더명 |
|----------|----------|--------|
| 설문 첨부파일 | 구글 드라이브 | survey |
| 초대장 인증서류 | 구글 드라이브 | verification |

---

## ⚠️ 개발 작업 원칙 (절대 까먹지 말 것!)

### 🔴 0. Supabase 필드명 규칙 (snake_case ↔ camelCase)

**이 규칙을 어기면 400 Bad Request 에러 발생!**

| 위치 | 사용하는 케이스 | 예시 |
|------|----------------|------|
| Supabase 테이블 | **snake_case** | `schedule_date`, `age_range`, `is_revealed` |
| JavaScript 변수 | **camelCase** | `scheduleDate`, `ageRange`, `isRevealed` |

**필수 변환:**
```javascript
// 데이터 쓸 때 (POST/PUT) → snake_case로 변환
const postData = {
    schedule_date: scheduleDate,  // ✅ snake_case
    age_range: ageRange,
    is_revealed: isRevealed
};

// 데이터 읽을 때 (GET) → camelCase로 변환
const camelData = {
    scheduleDate: row.schedule_date,  // ✅ camelCase
    ageRange: row.age_range,
    isRevealed: row.is_revealed
};
```

**⚠️ 새 테이블/기능 추가 시 체크리스트:**
- [ ] POST/PUT 요청에서 snake_case 사용했는지?
- [ ] GET 응답에서 camelCase로 변환했는지?
- [ ] 기존 패턴과 동일하게 작성했는지?

---

### 1. 사전 검토 필수
모든 작업 전에 반드시 검토:
- **예상되는 장점**: 이 변경으로 얻는 이점
- **예상되는 단점**: 이 변경으로 발생할 수 있는 문제
- **문제점과 해결책**: 단점/문제를 어떻게 해결할지

### 2. QA 필수
"완료"라고 말하기 전에 반드시:
- Playwright 콘솔 오류 체크
- 주요 기능 동작 확인
- 데이터 연동 확인

### 3. 데이터 연동 원칙 (하드코딩 금지!)

**🚨 절대 하드코딩하지 말 것!**

| 잘못된 방식 (하드코딩) | 올바른 방식 (DB 연동) |
|----------------------|---------------------|
| `maleCapacity = 12` | `schedule?.maleCapacity ?? partyTypeInfo?.maleCapacity ?? 12` |
| 파티유형만 사용 | 스케줄 개별값 → 파티유형 기본값 → 하드코딩 순 |

**정원/시간 연동 우선순위:**
```javascript
// 정원: 스케줄 개별값 우선, 없으면 파티유형 기본값
const maleCapacity = schedule?.maleCapacity ?? schedule?.male_capacity ?? partyTypeInfo?.maleCapacity ?? 12;
const femaleCapacity = schedule?.femaleCapacity ?? schedule?.female_capacity ?? partyTypeInfo?.femaleCapacity ?? 12;
const minVacancy = schedule?.minVacancy ?? schedule?.min_vacancy ?? partyTypeInfo?.minVacancy ?? 2;
```

**원칙:**
1. **스케줄 개별 정원 우선**: 예약일정에서 특정 날짜/세션의 정원을 개별 설정 가능
2. **파티유형 기본값 fallback**: 개별 설정 없으면 파티유형(party_types) 기본값 사용
3. **모든 페이지 연동**: 스케줄 개별 정원 변경 시 라인업, 예약관리 등 모든 곳에 반영

**예시:**
- 1월 11일 1부: 스케줄에 7:7 설정 → 라인업에 7:7 표시
- 1월 11일 2부, 3부: 개별 설정 없음 → 파티유형 기본값(12:12) 사용

### 4. 테이블 헤더 소팅 기능
- **모든 테이블 헤더에 소팅(정렬) 기능 추가**
- 클릭 시 오름차순/내림차순 토글
- 예외: 정렬이 무의미한 경우만 제외 (예: 액션 버튼 컬럼)

### 5. 나이 표시 규칙
- **관리자용**: 연도 뒤 2자리만 표시 (예: 94, 87)
- **공개용 라인업**: 나이대로 표시 (초반/중반/후반)

**나이대 기준표:**
| 나이 | 표시 |
|------|------|
| 20~24세 | 20대 초반 |
| 25~27세 | 20대 중반 |
| 28~29세 | 20대 후반 |
| 30~34세 | 30대 초반 |
| 35~37세 | 30대 중반 |
| 38~39세 | 30대 후반 |
| 40~44세 | 40대 초반 |
| 45~47세 | 40대 중반 |
| 48~49세 | 40대 후반 |

**세션별 나이조건 (기본값):**
| 세션 | 출생연도 범위 | 비고 |
|------|-------------|------|
| 1부 | 1990~2002 | 젊은 층 |
| 2부 | 1987~1997 | 중간 층 |
| 3부 | 1987~2002 | 넓은 범위 |

> 세션별 나이조건은 session_templates에 기본값 저장, party_schedules에서 개별 오버라이드 가능

---

## 📋 시스템 개요

### 핵심 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                     통합 운영 구조                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  index.html │───▶│verification │───▶│ success.html│         │
│  │ (자격선택)  │    │   (인증)    │    │ (완료안내) │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│         │                 │                                     │
│         │     ┌───────────▼───────────┐                        │
│         │     │     RESTful API       │                        │
│         │     │  (이 프로젝트 DB)     │                        │
│         │     └───────────┬───────────┘                        │
│         │                 │                                     │
│         │   ┌─────────────┼─────────────┐                      │
│         │   │             │             │                      │
│         ▼   ▼             ▼             ▼                      │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │  customers   │ │ invitations  │ │ reservations │            │
│  │ (고객마스터) │ │ (초대장신청) │ │ (프립예약)   │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│                                                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │   surveys    │ │  attendance  │ │   coupons    │            │
│  │ (사전조사)   │ │ (참석관리)   │ │ (쿠폰관리)   │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│                                                                 │
│  ┌─────────────────────────────────────────────────┐           │
│  │          통합 뷰 (JavaScript JOIN)              │           │
│  │    customers + invitations + reservations       │           │
│  │         + surveys → 1예약 = 1행                 │           │
│  └─────────────────────────────────────────────────┘           │
│                                                                 │
│  ┌────────────────────┐    ┌────────────────────┐              │
│  │   GAS (파일만)     │    │      Tasker        │              │
│  │ → Google Drive     │    │ → RESTful API 호출 │              │
│  └────────────────────┘    └────────────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 데이터 저장 위치

| 항목 | 저장 위치 | 설명 |
|------|----------|------|
| 고객 정보 | 이 프로젝트 DB (`customers`) | 연락처 PK, 1인 1행 |
| 초대장 신청 | 이 프로젝트 DB (`invitations`) | 자격/인증 정보 |
| 프립 예약 | 이 프로젝트 DB (`reservations`) | 1예약 = 1행 |
| 사전조사 | 이 프로젝트 DB (`surveys`) | 설문 응답 |
| 참석 관리 | 이 프로젝트 DB (`attendance`) | 현장 운영 |
| 쿠폰 | 이 프로젝트 DB (`coupons`) | 쿠폰 검증 |
| 인증서류 파일 | Google Drive | GAS 파일업로드 전용 |

---

## 🗄️ 데이터 모델 (7개 테이블)

### 1. customers (고객마스터)
> **PK: id (전화번호)** - 1인 1행, 고객 기본 정보 통합 관리

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - 전화번호 (010-XXXX-XXXX) |
| name | text | 이름 |
| gender | text | 성별 (남자/여자) |
| birthYear | number | 출생연도 |
| height | number | 신장 (cm) |
| jobCategory | text | 직업분류 |
| jobDetail | text | 직업상세 |
| jobCertFile | text | 직업인증서류 URL |
| source | text | 유입경로 (invitation/organic) |
| marketingAgree | bool | 마케팅 동의 |
| memo | text | 관리자 메모 |
| createdAt | datetime | 최초 등록일시 |
| updatedAt | datetime | 최종 수정일시 |

### 2. invitations (초대장신청)
> **PK: id (UUID)** - 초대장 신청 정보

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - 신청ID |
| phone | text | FK - 연락처 |
| qualifications | text | 선택자격 (쉼표 구분) |
| groups | text | 선택그룹 (쉼표 구분) |
| wineBonus | bool | 와인보너스 |
| authType | text | 인증방법 (upload/onsite/coupon/host_referral) |
| snsLink | text | SNS 링크 |
| fileLinks | text | 항목별 업로드 데이터 (JSON) - `{자격: {필드id: {type, value/url}}}` |
| couponCode | text | 쿠폰 코드 |
| hostName | text | 호스트명 |
| referralReason | text | 추천경위 |
| distributor | text | 배포처 |
| approvalStatus | text | 승인상태 |
| appliedAt | datetime | 신청일시 |

### 3. reservations (프립예약)
> **PK: id (예약번호)** - 1예약 = 1행

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - 프립 예약번호 |
| phone | text | FK - 연락처 |
| crewName | text | 크루명 |
| eventDate | text | 진행일시 |
| eventPart | text | 부 (1부/2부/3부) - 시간 기반 |
| option | text | 옵션명 (프립 원본) |
| isInvitation | bool | 인비테이션 패스 여부 |
| status | text | 예약상태 |
| surveyDone | bool | 사전조사 완료 |
| surveyReminderSent | bool | 독촉 발송 |
| confirmationSent | bool | 확정 문자 발송 |
| registeredAt | datetime | 등록일시 |

### 4. surveys (사전조사)
> **PK: id (UUID)** - 사전조사 제출 기록

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - 제출ID |
| phone | text | 연락처 |
| name | text | 이름 |
| gender | text | 성별 |
| birthYear | number | 출생연도 |
| height | number | 신장 |
| jobCategory | text | 직업분류 |
| jobDetail | text | 직업상세 |
| jobCertFile | text | 직업인증서류 URL |
| termsAgreed | bool | 이용약관 동의 |
| marketingAgreed | bool | 마케팅 동의 |
| submittedAt | datetime | 제출일시 |

### 5. attendance (참석관리)
> **현장 운영용** - 참석/환급 관리

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - UUID |
| reservationId | text | FK - 프립예약 ID |
| phone | text | 연락처 |
| attended | bool | 참석 여부 |
| attendedAt | datetime | 참석 확인 시간 |
| refundEligible | bool | 환급 대상 |
| refundCompleted | bool | 환급 완료 |
| refundAmount | number | 환급 금액 |
| refundCompletedAt | datetime | 환급 완료 시간 |
| verificationMethod | text | 현장 인증 방법 |
| memo | text | 현장 메모 |

### 6. coupons (쿠폰관리)

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - 쿠폰코드 |
| isActive | bool | 활성 여부 |
| description | text | 설명 |

### 6-1. party_schedules (파티 일정)
> **NEW!** 파티 날짜/시간 중앙 관리 - 모든 탭에서 참조

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - UUID |
| date | text | 날짜 (예: "2026년 1월 11일") |
| part | text | 세션 (1부/2부/3부) |
| time | text | 시작 시간 (예: "12:00", "15:00", "19:00") |
| isActive | bool | 활성 여부 (비활성 시 날짜 필터에서 제외) |
| memo | text | 메모 (특이사항 등) |

**🎯 파티 일정 사용 목적:**
1. **날짜 필터 연동**: 라인업 탭, 가상참여자 탭의 날짜 선택이 모두 party_schedules 참조
2. **유연한 확장**: 토/일 기본 + 평일 추가 가능, 시간 변경 가능
3. **이력 관리**: 지난 파티 비활성화로 보존 (삭제 대신 비활성화 권장)
4. **자동 생성**: "다음 달 일정 생성" 버튼으로 토/일 일정 자동 생성

**기본 시간대:**
| 세션 | 시작 시간 |
|------|----------|
| 1부 | 12:00 |
| 2부 | 15:00 |
| 3부 | 19:00 |

### 7. job_tiers (직업티어표)
> ⚠️ **핵심 시스템**: 라인업 정렬의 기준이 되는 직업 등급표

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - UUID |
| gender | text | 성별 (남자/여자) |
| job | text | 직업명 |
| tier | text | 티어 등급 (S/A/B) |

**🎯 티어표 사용 목적:**
1. **라인업/예약관리 정렬**: S티어 직업이 테이블 상단에 표시됨
2. **고객 관리 정렬**: 직업 기준 정렬 시 티어 순서 적용
3. **가상참여자 생성**: 생성된 가상참여자도 티어에 따라 정렬

**티어 기준:**
- **S티어**: 프리미엄 직군 → 라인업 **상단** 배치, 파티 이미지 메이킹
- **A티어**: 우수 직군 → **중간** 배치
- **B티어**: 일반 직군 → **하단** 배치

**남자 티어 분류:**
| 티어 | 직업 |
|------|------|
| S | 전문직(문과계열), 전문직(이과계열), 금융권 |
| A | 대기업, 외국계, 공기업, IT/개발자, 연구직, 의료직 |
| B | 회사원, 공무원, 사무직, 자영업/사업가, 프리랜서, 디자이너, 마케팅/광고/미디어, 교육직, 대학원생, 예체능, 서비스/호텔, 피트니스, 기타 |

**여자 티어 분류:**
| 티어 | 직업 |
|------|------|
| S | 전문직(문과계열), 전문직(이과계열), 항공업(승무원 등), 피트니스(필라테스/요가 강사 등), 서비스/호텔 |
| A | 대기업, 외국계, 금융권, 디자이너, 마케팅/광고/미디어, IT/개발자, 공기업, 간호사, 의료직 |
| B | 회사원, 공무원, 사무직, 자영업/사업가, 프리랜서, 교육직, 연구직, 대학원생, 예체능, 기타 |

### 8. virtual_pool (가상참여자 풀)
> ⚠️ **핵심 시스템**: 미리 생성된 500명 가상참여자 풀에서 파티별로 배정

**🎯 가상참여자 풀 시스템 (NEW!):**
- **500명 풀**: 미리 생성된 가상참여자 500명 (남 250명, 여 250명)
- **파티별 배정**: 날짜/세션 선택 후 풀에서 N명 랜덤 배정
- **정보확인중 기능**: 신규 배정 시 "정보확인중"으로 표시, 이후 직업 공개 가능
- **일관성 보장**: 한번 공개된 정보는 변경 불가 (라인업 신뢰도 유지)

**풀 관리 기능:**
- ✅ N명 추가 생성: 필요시 풀에 가상참여자 추가
- ✅ 선택 삭제: 풀에서 불필요한 가상참여자 제거
- ✅ 목록 조회: 성별/티어/직업 필터로 풀 검색

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - UUID |
| gender | text | 성별 (남자/여자) |
| birthYear | number | 출생연도 |
| height | number | 키 (cm) |
| job | text | 직업명 |
| tier | text | 티어 (S/A/B) |
| isActive | bool | 활성 여부 |
| usageCount | number | 사용 횟수 |

### 9. party_virtual_assignments (파티별 가상참여자 배정)
> 파티 날짜/세션별로 가상참여자 배정 관리

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - UUID |
| scheduleDate | text | 파티 날짜 |
| schedulePart | text | 세션 (1부/2부/3부) |
| virtualId | text | FK - virtual_pool ID |
| gender | text | 성별 |
| birthYear | number | 출생연도 |
| height | number | 키 |
| job | text | 직업명 |
| tier | text | 티어 |
| isRevealed | bool | 직업 공개 여부 |
| revealedAt | datetime | 공개 시점 |
| assignedAt | datetime | 배정 시점 |
| displayOrder | number | 표시 순서 |

### 10. virtual_participants (가상참여자 생성 규칙)
> 가상참여자 풀 생성 시 사용되는 비율표

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - UUID |
| gender | text | 성별 (남자/여자) |
| job | text | 직업명 |
| ratio | number | 비율 (%) |
| minBirthYear | number | 최소 출생연도 |
| maxBirthYear | number | 최대 출생연도 |
| minHeight | number | 최소 키 (cm) |
| maxHeight | number | 최대 키 (cm) |

**🎯 "정보확인중" 표시 정책:**
- **신규 배정**: isRevealed = false → "정보확인중"으로 표시
- **직업 공개**: isRevealed = true → 실제 직업/나이/키 표시
- **일관성**: 공개된 정보는 영구 고정 (다시 숨기기 불가)
- **S티어 우선**: 정보확인중 3~4명은 S티어 위주로 남김 (후킹용)

### 11. public_lineup (공개용 라인업)
> **NEW!** 민감정보 없는 공개용 라인업 테이블

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - UUID |
| scheduleDate | text | 파티 날짜 |
| schedulePart | text | 세션 (1부/2부/3부) |
| gender | text | 성별 |
| ageRange | text | 나이대 (20대 초반, 30대 중반 등) |
| height | number | 키 |
| job | text | 직업 (미공개 시 "정보확인중") |
| displayOrder | number | 표시 순서 |
| isRevealed | bool | 공개 여부 |

**🔒 보안 특징:**
- 티어(S/A/B) 정보 없음
- 유형(실제/가상) 정보 없음
- 정확한 출생연도 없음 → 나이대로 변환
- 공개 페이지(lineup-public.html)는 이 테이블만 조회

### 12. party_types (파티 유형)
> 파티 유형별 정원 및 설정 관리

| 필드 | 타입 | 설명 |
|------|------|------|
| id | text | PK - 유형 ID (coffee, wine 등) |
| icon | text | 아이콘 (☕, 🍷 등) |
| name | text | 유형명 (커피파티, 와인파티 등) |
| maleCapacity | number | 남자 정원 |
| femaleCapacity | number | 여자 정원 |
| minVacancy | number | 최소 공석 유지 수 |
| isActive | bool | 활성 여부 |
| sortOrder | number | 표시 순서 |

**기본 파티 유형:**
| 파티 유형 | 남자 정원 | 여자 정원 | 최소 공석 |
|----------|----------|----------|----------|
| ☕ 커피파티 | 12명 | 12명 | 2명 |
| 🍷 와인파티 | 24명 | 24명 | 4명 |

---

## 📊 가상참여자 비율 기반 시스템 (NEW!)

### D-day 등차수열 비율

가상참여자 수는 파티까지 남은 일수에 따라 자동 계산됩니다:

**비율 공식:** `비율 = 30 + (14 - D-day) × 3.57%`

| D-day | 비율 | 커피 (12명) | 와인 (24명) |
|-------|------|------------|------------|
| D-14 | 30% | 4명 | 7명 |
| D-13 | 34% | 4명 | 8명 |
| D-12 | 37% | 4~5명 | 9명 |
| D-11 | 41% | 5명 | 10명 |
| D-10 | 44% | 5명 | 11명 |
| D-9 | 48% | 6명 | 12명 |
| D-8 | 51% | 6명 | 12명 |
| D-7 | 55% | 7명 | 13명 |
| D-6 | 59% | 7명 | 14명 |
| D-5 | 62% | 7~8명 | 15명 |
| D-4 | 66% | 8명 | 16명 |
| D-3 | 69% | 8명 | 17명 |
| D-2 | 73% | 9명 | 18명 |
| D-1 | 77% | 9명 | 18명 |
| D-0 | 80% | 10명 | 19명 |

### 핵심 제약

1. **최대 한도 80%**: 가상참여자는 절대 정원의 80%를 넘지 않음
2. **최소 공석 유지**: 커피 2명, 와인 4명의 공석을 항상 유지
3. **여자 +1~2명**: 여자가 항상 1~2명 더 많게 배정
4. **실시간 계산**: 실제 예약이 들어오면 가상참여자 수 자동 조정

### 가상참여자 계산 로직

```
목표 인원 = 정원 × 비율(D-day)
가상 필요 = MAX(0, 목표 인원 - 실제 예약)
최종 가상 = MIN(가상 필요, 정원×80% - 실제, 정원 - 최소공석 - 실제)
```

**예시 (커피파티, D-7, 정원 12명):**
- 비율: 55% → 목표 7명
- 실제 예약: 3명
- 가상 필요: 7 - 3 = 4명
- 최대 80%: 10 - 3 = 7명 (OK)
- 최소 공석: 12 - 2 - 3 = 7명 (OK)
- 최종: 4명 배정

> party_schedules에 partyType, maleCapacity, femaleCapacity, minVacancy로 저장됨

---

## 🔄 데이터 흐름

### 인바운드 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                     초대장 유입 (Invitation)                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  index.html ──▶ verification.html ──▶ success.html         │
│       │              │                                      │
│  자격선택       인증/제출                                   │
│  (8종 자격)     - 파일 업로드 (GAS → Drive)                │
│                 - 쿠폰 검증 (RESTful API)                  │
│                 - 호스트 추천                               │
│                 - 현장 인증 예정                            │
│                                                             │
│                      ▼                                      │
│            ┌─────────────────┐                              │
│            │  invitations    │                              │
│            │  + customers    │                              │
│            └────────┬────────┘                              │
│                     │                                       │
│                     ▼                                       │
│              Frip 예약 진행                                 │
│                     │                                       │
│                     ▼                                       │
│      ┌────────────────────────────┐                        │
│      │      Tasker (SMS 감지)     │                        │
│      │  → POST reservations API   │                        │
│      └────────────┬───────────────┘                        │
│                   │                                         │
│                   ▼                                         │
│            ┌─────────────────┐                              │
│            │  reservations   │                              │
│            └────────┬────────┘                              │
│                     │                                       │
│                     ▼                                       │
│             survey.html 제출                                │
│                     │                                       │
│                     ▼                                       │
│            ┌─────────────────┐                              │
│            │    surveys      │ + customers 업데이트         │
│            └────────┬────────┘                              │
│                     │                                       │
│                     ▼                                       │
│            ┌─────────────────────────────────┐              │
│            │ 통합 뷰: 현재단계 = 3.사전조사완료│              │
│            └─────────────────────────────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 일반 유입 (Organic)

```
Frip 직접 예약 → Tasker → reservations → survey.html → 참여확정
```

---

## 💰 인증/환급 로직

### 가격표

| 유형 | 1부/2부 커피 | 3부 와인 |
|------|-------------|---------|
| **인비테이션 패스** | 5,000원 (환급) | 10,000원 (환급) |
| **일반 참가** | 15,000원 | 25,000원 |

### 환급 조건
- ✅ 인비테이션 패스 소지자
- ✅ 현장 참석 확인
- ✅ 인증 완료 (사전 또는 현장)

### 인증 방법별 승인상태

| 인증방법 | 초기 승인상태 |
|---------|-------------|
| 파일 업로드 | 서류제출완료 |
| 쿠폰 | 쿠폰승인 |
| 호스트 추천 | 승인완료 |
| 현장 인증 | 현장인증예정 |

### 부 결정 로직 (시간 기반)

```javascript
// 진행일시 기준 부 결정
12시 (정오) → 1부 ☕
15시 (오후 3시) → 2부 ☕
19시 (저녁 7시) → 3부 🍷
```

---

## 🖥️ 페이지 구성

### 사용자용 페이지

| 페이지 | 경로 | 설명 |
|--------|------|------|
| 메인 | `/index.html` | 자격 선택, 실시간 라인업 |
| 인증 | `/verification.html` | 인증 방법별 제출 |
| 완료 | `/success.html` | 신청 완료 안내 |
| 사전조사 | `/survey.html` | 프로필 입력 |
| 약관 | `/terms.html` | 이용약관 |

### 관리자 페이지

| 페이지 | 경로 | 비밀번호 |
|--------|------|----------|
| 관리자 | `/svvys-mwol-crew.html` | `svvys2025` |

**관리자 탭 구성:**
- 📊 대시보드: 통계, 예정 파티
- 👥 고객 관리: 통합 뷰 (1예약=1행)
- 📩 초대장 신청: 신청 목록/승인
- 🎉 라인업: 파티별 참석자
- 👻 가상참여자: 테스트용
- ⚙️ 설정: 직업 티어 등

---

## 🔌 API 엔드포인트

### RESTful Table API (이 프로젝트)

```
기본 URL: tables/{table_name}

GET    /tables/customers         - 고객 목록
GET    /tables/customers/{id}    - 고객 상세
POST   /tables/customers         - 고객 생성
PATCH  /tables/customers/{id}    - 고객 수정
DELETE /tables/customers/{id}    - 고객 삭제

동일 패턴:
/tables/invitations
/tables/reservations
/tables/surveys
/tables/attendance
/tables/coupons
```

### GAS API (파일 업로드 전용)

```
URL: [GAS 웹앱 URL]

POST - 파일 업로드
{
  "action": "uploadFiles",
  "phone": "010-XXXX-XXXX",
  "files": [
    { "name": "file.jpg", "type": "image/jpeg", "data": "base64..." }
  ],
  "folder": "verification"
}

응답:
{
  "success": true,
  "message": "2개 파일 업로드 완료",
  "files": [
    { "name": "...", "url": "https://drive.google.com/...", "id": "..." }
  ]
}
```

---

## 📱 Tasker 연동

### ⚠️ 프립 SMS 형식 (절대 까먹지 말 것!)

**1. 판매 안내 SMS (새 예약)**
```
[프립 판매 안내]
은비까비 호스트님,
새로운 프립 판매 건이 있어요!

[사당]  프라이빗 라운지에서 커피 소개팅+와인파티 뭘 좀 아는 사람들
- 진행일시: 2026년 1월 11일 오후 19시 00분
- 옵션: [3부 와인] 인비테이션 패스 소지자
- 수량: 1개
- 크루: 조세목
- 크루 연락처: 01094739509
- 신청 마감 일시: 2026년 1월 11일 오후 19시 00분

<판매 내역 상세 보기>
https://new.frip.host/sales/detail/4457158

해당 프립은 최소 인원 충족 시 진행되며...
```

**파싱해야 할 필드:**
| SMS 필드 | DB 필드 | 예시 |
|----------|---------|------|
| 진행일시 | eventDate | "2026년 1월 11일 오후 19시 00분" |
| 옵션 | option, eventPart, isInvitation | "[3부 와인] 인비테이션 패스 소지자" → eventPart: "3부", isInvitation: true |
| 크루 | crewName | "조세목" |
| 크루 연락처 | phone | "01094739509" → "010-9473-9509" |

---

**2. 결제 취소 SMS (예약 취소)**
```
[프립 결제 취소 안내]
은비까비 호스트님,
크루님이 아래 프립을 취소하여 환불 처리되었습니다. 

[사당] 분위기 끝판왕🌿 프라이빗 라운지에서 커피+와인파티
- 진행일시: 2026년 1월 10일 오후 19시 00분
- 옵션: [3부 와인] (87년생 이하, 여자) 리뷰약속, 얼리버드
- 크루: 캐리온
- 구매 수량: 1개
- 취소 수량: 1개

<취소 내역 상세 보기>
https://new.frip.host/sales/detail/4453626
```

**취소 처리 로직:**
1. SMS에서 `크루 연락처` 또는 `크루` + `진행일시` 파싱
2. reservations 테이블에서 해당 예약 찾기
3. `status`를 `"취소"`로 업데이트 (DELETE 아님!)

---

### Tasker 설정

**기존 (GAS):**
```
URL: https://script.google.com/.../exec
```

**변경 후 (RESTful API):**

**새 예약 (POST):**
```
URL: [배포 사이트 URL]/tables/reservations
Method: POST
Content-Type: application/json
Body:
{
  "phone": "010-9473-9509",
  "crewName": "조세목",
  "eventDate": "2026년 1월 11일 오후 19시 00분",
  "eventPart": "3부",
  "option": "[3부 와인] 인비테이션 패스 소지자",
  "isInvitation": true,
  "status": "예약완료"
}
```

**취소 (PATCH):**
```
URL: [배포 사이트 URL]/tables/reservations/{id}
Method: PATCH
Content-Type: application/json
Body:
{
  "status": "취소"
}
```

---

## 🚀 실행 로드맵

### Phase 1: 즉시 실행 (D-Day)
- [x] 테이블 스키마 최종 확정 (5+1개)
- [x] 기존 데이터 마이그레이션
- [x] 관리자 페이지 RESTful API 연동
- [x] verification.html API 연동
- [x] survey.html API 연동
- [x] 파일 업로드 GAS 코드 준비

### Phase 2: 배포 및 테스트 (D+1~2)
- [ ] 사이트 배포 (Publish 탭)
- [ ] GAS 파일업로드 전용 코드 배포
- [ ] Tasker URL 변경
- [ ] End-to-End 테스트
  - 초대장 신청 → 프립 예약 → 사전조사 → 참석관리

### Phase 3: 운영 안정화 (D+3~7)
- [ ] 실사용 모니터링
- [ ] 버그 수정 및 피드백 반영
- [ ] 보안/접근 제어 강화
- [ ] 감사 로그 설계

### Phase 4: 고도화 (D+7~)
- [ ] 자동화 알림 (카카오톡/SMS)
- [ ] 참석 체크인 QR 코드
- [ ] 통계 대시보드 강화
- [ ] 문서화 완료 (운영 매뉴얼)

---

## 📁 파일 구조

```
project/
├── index.html              # 메인 페이지 (자격 선택)
├── verification.html       # 인증 페이지
├── success.html           # 완료 페이지
├── survey.html            # 사전조사 페이지
├── terms.html             # 이용약관
├── adm_k8x2m.html         # 관리자 페이지 (URL 난독화)
├── lineup-public.html     # 외부 공개용 라인업 페이지 (public_lineup 전용)
├── README.md              # 프로젝트 문서 (이 파일)
├── SPREADSHEET_SCHEMA.md  # 스프레드시트 스키마 (레거시)
├── GAS_FILE_UPLOAD_ONLY.js # 파일 업로드 전용 GAS
├── GAS_CODE_COPY_THIS.txt # 기존 GAS 코드 (레거시)
├── css/
│   └── style.css
├── js/
│   └── main.js
└── data/
    └── (데이터 파일)
```

> ⚠️ **svvys-mwol-crew.html은 삭제됨** - 관리자 페이지는 `adm_k8x2m.html`로 이동

---

## 🔒 개인정보 보호

### 수집 항목
- 필수: 이름, 연락처, 성별, 출생연도, 신장, 직업
- 선택: SNS, 마케팅 동의

### 보관 기간
- 행사 종료 후 **1개월** 보관 후 파기
- 마케팅 동의자: 동의 철회 시까지

### 접근 제어
- 관리자 페이지: 비밀번호 인증 + URL 난독화 (`adm_k8x2m.html`)
- 연락처 기반 식별
- 민감 정보 최소 수집

### 🔐 보안 강화 (v12)

**테이블명 난독화:**
| 원본 테이블명 | 난독화 테이블명 | 민감도 |
|-------------|---------------|-------|
| customers | cst_m4n7p2 | 높음 (개인정보) |
| virtual_pool | vp_a3b8c1w | 중간 (가상참여자 풀) |
| party_virtual_assignments | pva_x7k9m2q | 중간 (배정 정보) |

**공개용 테이블 분리:**
| 테이블명 | 용도 | 민감정보 |
|---------|-----|---------|
| public_lineup | 공개 라인업 | ❌ 없음 |

**보안 수준:**
- ✅ 일반 사용자: 민감 정보 접근 불가
- ✅ F12 개발자 도구: 민감 정보 노출 안됨
- ⚠️ 테이블명 추측 공격: 난독화로 어려움 (완전 차단 불가)

> **향후 고려:** Supabase Row Level Security로 완전한 API 수준 보안

---

## 📝 성공 지표

| 지표 | 목표 |
|------|------|
| 데이터 정확성 | 중복/누락 0건 |
| 운영 효율성 | 수동 작업 50% 감소 |
| 응답 시간 | API < 1초 |
| 시스템 가용성 | 99% 이상 |

---

## 📋 변경 내역

### 2026-01-04 (v12): 보안 강화 + 공개 라인업 시스템

**🔐 핵심 변경: B안(공개 테이블 분리) 적용**

**1. 테이블명 난독화:**
- `customers` → `cst_m4n7p2`
- `virtual_pool` → `vp_a3b8c1w`
- `party_virtual_assignments` → `pva_x7k9m2q`
- 관리자 페이지 URL: `svvys-mwol-crew.html` → `adm_k8x2m.html`

**2. 공개용 라인업 테이블 (`public_lineup`):**
- 민감정보(티어, 유형) 없음
- 정확한 출생연도 대신 나이대(20대 초반 등) 저장
- 관리자가 "공개 라인업 생성" 버튼으로 생성
- lineup-public.html은 이 테이블만 조회

**3. lineup-public.html 보안 개선:**
- 기존: party_virtual_assignments, customers, surveys 직접 조회 (민감정보 노출)
- 변경: public_lineup 테이블만 조회 (민감정보 없음)
- 텍스트 복사 기능 추가 (프립 상세페이지용)

**4. 관리자 페이지 공개 라인업 기능:**
- 라인업 탭에 "공개용 라인업" 섹션 추가
- 날짜/세션 선택 후 "공개 라인업 생성" 버튼
- 미리보기 및 기존 공개 라인업 목록 표시
- 삭제 기능 포함

**5. 날짜 정규화 전역 적용:**
- `normalizeDateStr()`: 다양한 날짜 형식을 통일
- `isSameDate()`: 정규화 후 비교
- 모든 날짜 비교 코드에 적용 (자동 배정, 라인업, 필터 등)

**보안 수준:**
| 접근자 | 민감정보 접근 |
|-------|-------------|
| 일반 사용자 | ❌ 불가능 |
| F12 개발자 도구 | ❌ 불가능 |
| API 직접 호출 (추측) | ⚠️ 어려움 (난독화) |

---

### 2026-01-04 (v11): 자동 배정 시스템 + 전체 라인업 보기

**🎯 핵심 변경: 운영 편의성 대폭 개선**

**1. 설정 탭 정리:**
- 설정 탭에서 직업티어표 섹션 제거 (중복 제거)
- 직업티어표는 별도 탭에서만 관리

**2. 향후 파티 자동 배정 시스템:**
- 가상참여자 탭 상단에 "향후 파티 자동 배정" 섹션 추가
- 시점별 가상참여자 비율 설정:
  - 3주 이상 전: 80%
  - 2주 전: 60%
  - 1주 전: 40%
  - 당일/직전: 20%
- 비율 조정 가능 (UI에서 직접 수정)
- "자동 배정 실행" 버튼으로 향후 N주 모든 파티에 일괄 배정
- 이미 배정된 파티는 부족분만 추가 배정

**3. 라인업 탭 전체 보기:**
- "향후 N주 전체 라인업 보기" 버튼 추가
- 향후 1~4주 선택 가능
- 모든 파티의 라인업을 카드 형태로 한눈에 표시
- D-day 뱃지로 긴급도 표시 (빨강: 3일 이내, 노랑: 7일 이내)
- 각 파티별 남녀 라인업, 실제/가상 비율 표시

**4. UI 개선:**
- "개별 파티 가상참여자 배정"으로 명칭 변경 (기존 수동 배정 유지)

---

### 2026-01-04 (v10): 직업 티어/규칙 통합 시스템

**🎯 핵심 변경: 직업 데이터 통일 및 자동화**

**1. 직업 티어표 UI 개선:**
- 남/여 탭 분리: 성별별로 직업 티어 확인/관리
- 추가/수정/삭제 기능: 직업 추가 시 생성 규칙에 자동 추가 (비율 0%, 조건 미설정)
- 삭제 시 영향도 표시: "풀 N명, 배정 N명 있음" 확인 후 삭제
- 직업명 긴 형태 통일: `전문직(문과계열 - 변호사,회계사,노무사 등)` 형태 사용

**2. 생성 규칙 비율 검증 시스템:**
- 비율 합계 실시간 표시: `남자 비율 합계: 100% / 100%`
- 100% 초과 시 빨간색 경고: `⚠️ 남자 비율 합계가 110%입니다. (초과: 10%)`
- 100% 미달 시 노란색 경고: `⚠️ 남자 비율 합계가 80%입니다. (부족: 20%)`
- 미설정 항목 표시: `⚠️미설정` 라벨로 확인 필요 항목 강조

**3. 풀 생성 로직 DB 규칙 연동:**
- 기존: 하드코딩된 maleJobTiers/femaleJobTiers 배열 사용
- 변경: DB virtual_participants 규칙 사용
- 비율 기반 직업 선택: 규칙의 ratio 비율대로 직업 배분
- 조건 적용: 규칙의 minBirthYear, maxBirthYear, minHeight, maxHeight 적용
- 폴백: 규칙에 조건 없으면 풀 생성 UI 입력값 사용

**4. 직업 datalist 동적 로딩:**
- 풀 수정 모달: 성별에 따라 해당 성별의 직업 목록만 표시
- 티어 추가 모달: 성별 변경 시 직업 목록 자동 업데이트

**5. 라인업 개별 공개 기능:**
- 라인업 탭에서 정보확인중인 가상참여자 개별 공개 가능
- 👁 공개 버튼 클릭 → 해당 인원만 공개
- 툴팁으로 직업/티어 미리 확인: `대기업, A티어`

**6. 배정된 가상참여자 교체 기능:**
- 🔄 교체 버튼으로 다른 가상참여자로 교체
- 교체 모달: 티어/직업 필터로 후보 검색
- 같은 성별 + 해당 파티에 미배정인 후보만 표시

**7. 배정 로직 개선 (티어 균형 + 직업 중복 방지):**
- 티어 비율 적용: S 20%, A 50%, B 30%
- 직업 중복 최대 2명까지만 허용
- 콘솔 로그: `배정 결과: S=1, A=3, B=1, 총=5`

**8. 기본 데이터 초기화:**
- 설정 탭 → "기본 데이터 초기화 (통일된 형태)" 버튼
- 남자 14개 직업, 여자 16개 직업 (긴 형태 직업명)
- 생성 규칙: 비율, 출생연도, 키 조건 포함

---

### 2026-01-04 (v9): 가상참여자 UI 개선 + 소팅 기능

**🎯 핵심 변경: 가상참여자 관리 페이지 개선**

**1. UI 글자 크기 복원:**
- 풀 통계 카드 (전체/남자/여자/S티어) 라벨 크기 확대
- font-size: 1.1rem, strong: 1.25rem 적용
- 간격 및 패딩 개선

**2. 풀 목록 창 높이 확대:**
- max-height: 600px → 800px 변경
- 더 많은 데이터를 한 화면에서 확인 가능

**3. 직업 편집 자유 입력 허용:**
- 기존: select 드롭다운 (대분류 직업만 선택 가능)
- 변경: input + datalist (선택하거나 직접 입력 가능)
- 사용자가 원하는 직업을 자유롭게 입력할 수 있음

**4. 모든 표에 소팅 기능 추가:**
- 가상참여자 풀 목록: 이름, 성별, 나이, 키, 직업, 티어, 사용횟수 컬럼별 정렬
- 배정된 가상참여자 목록: 날짜, 세션, 성별, 나이, 키, 직업, 티어, 상태 컬럼별 정렬
- 클릭 시 오름차순/내림차순 토글 (▲/▼ 아이콘 표시)
- 기존 생성 규칙 테이블은 이미 소팅 지원

**5. 개별 수정 기능 확인:**
- 풀 목록에서 연필 아이콘 클릭 → 수정 모달 열림
- 이름, 성별, 출생연도, 키, 직업, 티어 수정 가능
- PATCH API로 저장

---

### 2026-01-03 (v8): 세션별 나이조건 시스템

**🎯 핵심 변경: 세션별 참여 나이조건 관리**

**1. 나이조건 필드 추가:**
- `session_templates`: minBirthYear, maxBirthYear (기본값)
- `party_schedules`: minBirthYear, maxBirthYear (개별 오버라이드)

**2. 기본 세션별 나이조건:**
| 세션 | 출생연도 범위 | 2026년 기준 나이 |
|------|--------------|-----------------|
| 1부 | 1990~2002 | 24~36세 |
| 2부 | 1987~1997 | 29~39세 |
| 3부 | 1987~2002 | 24~39세 |

**3. 가상참여자 풀 나이 범위:**
- 기본 범위: 1987~2002년생
- UI에서 조정 가능 (풀 생성 시)

**4. 가상참여자 배정 시 나이 필터링:**
- 해당 세션의 나이조건에 맞는 풀 인원만 배정
- 인원 부족 시: "요청 N명 중 M명만 배정됨" 안내

**5. 나이 초과 경고:**
- 라인업/예약관리에서 세션 조건 불일치 시 ⚠️ 표시
- 경고만 표시, 삭제하지 않음 (실제 예약은 프립 접근 불가)

**6. 나이 표시 형식:**
- 관리자용: 연도 뒤 2자리 (예: 94, 87)
- 공개용 라인업: 나이대 (예: 20대 초반) - 추후 구현

---

### 2026-01-03 (v7): 세션 템플릿 + 완전한 유연성

**🎯 핵심 변경: 세션 마스터 테이블 추가**

| 테이블 | 용도 |
|--------|------|
| `session_templates` | 세션별 시간/타입 관리 (1부, 2부, 3부, 4부...) |

**세션 템플릿 기능:**
- 세션 추가/수정/삭제 (4부, 5부 등 추가 가능)
- 시간 변경 (1부를 12:00 → 12:30으로 변경 가능)
- 타입 설정 (커피/와인)
- **연동**: 세션 템플릿 변경 시 일정 생성에 자동 반영

**일정 생성 개선:**
- **모든 요일 선택 가능** (월~일 전체)
- **개월 수 직접 입력** (1~12개월)
- **확인 팝업** 추가 (생성 전 미리보기)
- **세션 체크박스 동적 생성** (세션 템플릿에서 가져옴)

**기본 세션 (자동 초기화):**
| 세션 | 시간 | 타입 |
|------|------|------|
| 1부 | 12:00 | 커피 |
| 2부 | 15:00 | 커피 |
| 3부 | 19:00 | 와인 |

---

### 2026-01-03 (v7): 가상참여자 풀 시스템 + 정보확인중 기능 + 직업 분류 개선

**🎯 핵심 변경: 가상참여자 관리 시스템 완전 개편**

**1. 가상참여자 풀 시스템 (NEW!):**
- **500명 풀 미리 생성**: 남자 250명 + 여자 250명 풀 DB에 저장
- **파티별 랜덤 배정**: 날짜/세션 선택 후 풀에서 N명 배정
- **풀 관리 UI**:
  - N명 추가 생성 (1~500명)
  - 선택 삭제 (체크박스로 여러 명 삭제)
  - 필터: 성별/티어/직업별 검색
  - 목록: 상위 100명 표시 (성능 최적화)

**2. 정보확인중 기능 (NEW!):**
- **초기 상태**: 신규 배정 시 "정보확인중"으로 표시
- **직업 공개**: 개별 공개 / 전체 공개 버튼
- **일관성 보장**: 한번 공개된 정보는 변경 불가
- **라인업 표시**: 직업 공개된 가상참여자만 실제 직업 표시

**3. 직업 분류 개선:**
- **변경된 항목**:
  - 승무원 → 항공업(승무원 등)
  - 필라테스/요가 강사 → 피트니스(필라테스/요가 강사 등)
  - 서비스/호텔 추가 (신규)
- **총 25개 직업 분류** (survey.html, 관리자페이지 동일)

**4. 권장 비율 가이드:**
| 남은 일수 | 권장 가상참여자 비율 |
|----------|---------------------|
| 14일 이상 | 10~20% |
| 7~14일 | 20~30% |
| 3~7일 | 30~40% |
| 1~3일 | 최대 50% |
| 당일 | 최소화 |

**5. 테이블 구조 추가:**
- `virtual_pool`: 가상참여자 풀 (500명)
- `party_virtual_assignments`: 파티별 배정 + 정보확인중 상태

---

### 2026-01-03 (v6): 탭 분리 + 일정 생성 개선 + 테이블 소팅

**변경 사항:**
- 파티일정, 직업티어표를 설정 탭에서 **독립 탭으로 분리**
- 일정 자동 생성 UI 개선
- **테이블 헤더 소팅 추가**

---

### 2026-01-03 (v5): 파티 일정 관리 + 날짜 연동 시스템

**🎯 핵심 변경: 파티 일정 중앙 관리**

기존 하드코딩된 날짜 → `party_schedules` 테이블로 일원화

**파티 일정 관리 기능 (설정 탭):**
| 기능 | 설명 |
|------|------|
| 일정 보기 | 날짜, 요일, 세션, 시간, 상태, 메모 표시 |
| 월 필터 | 특정 월의 일정만 보기 |
| 활성 필터 | 활성/비활성/전체 필터 |
| 일정 추가 | 날짜, 세션, 시간, 메모 입력 |
| 일정 수정 | 기존 일정 수정 |
| 활성/비활성 토글 | 클릭으로 상태 변경 (지난 파티 비활성화 권장) |
| 삭제 | 연결 데이터 있으면 경고 표시 |
| **앞으로 3개월/6개월 생성** | 빠른 버튼으로 현재월부터 N개월치 자동 생성 |
| **범위 지정 생성** | 시작월~종료월 선택해서 일정 생성 |
| **생성 옵션** | 요일(토/일/금) 및 세션(1부/2부/3부) 체크박스로 커스터마이징 |
| **테이블 헤더 소팅** | 날짜, 요일, 세션, 시간, 상태 클릭으로 정렬 |

**날짜 연동 범위:**
- ✅ 라인업 탭 날짜 필터
- ✅ 가상참여자 탭 날짜 필터
- ✅ 예약 관리 탭 (예약 데이터의 날짜도 포함)

**장기 운영 설계:**
- 기본: 토요일/일요일 (1부 12:00, 2부 15:00, 3부 19:00)
- 확장: 평일 파티 추가 가능
- 변경: 시간대 수정 가능 (예: 18:00 시작)
- 연동: 일정 변경 시 모든 탭에 자동 반영

**자동 초기화:**
- 첫 로딩 시 party_schedules가 비어있으면 2026년 1~2월 토/일 일정 자동 생성
- 티어표/비율표와 함께 자동 초기화

---

### 2026-01-03 (v4): 가상참여자 자동 생성 + 라인업(최종 포메이션) 탭 추가

**⚠️ 핵심 개념 (축구 비유):**
- **고객 관리** = 전체 선수 명단 (팀 로스터)
- **예약 관리** = 경기 출전 라인업 (실제 예약자)
- **가상참여자** = 용병 풀 (생성 규칙 + 생성된 가상인원)
- **라인업** = 최종 포메이션 (실제 예약자 + 가상참여자)

**관리자 페이지 탭 구조 (v6 업데이트):**
| 탭 | 기능 | 주요 정보 |
|---|---|---|
| 대시보드 | 전체 통계 & 다가오는 파티 | 참여 현황, 예약 대기 등 |
| 고객 관리 | 통합 고객 뷰 (1예약=1행) | customers + invitations + reservations + surveys 조인 |
| 초대장 신청 | 초대장 신청 목록 | 자격선택, 인증상태, 승인여부 |
| 예약 관리 | FM 엔트리 명단 | 현장 운영용 참석자 명단 |
| 라인업 | 최종 포메이션 | 실제 + 가상 합산, 티어순 정렬 |
| 가상참여자 | 자동 생성 + 규칙 관리 | 비율표 기반 자동 생성 |
| **파티일정** ⭐ | **파티 날짜/시간 관리** | **일정 자동 생성, 소팅** |
| **직업티어표** ⭐ | **직업별 등급 관리** | **S/A/B 티어 관리, 소팅** |
| 설정 | 데이터 관리 | 백업 복구, 초기화, 테스트 데이터 |

**라인업 탭 기능:**
- 날짜/세션 선택 → 실제 예약자 + 가상참여자 합산 표시
- **티어순 자동 정렬**: S티어 → A티어 → B티어 (좋은 직업이 상단)
- 남녀 분리 2컬럼 레이아웃
- 통계: 총 인원, 실제 참석, 가상 참여, 남자/여자
- CSV 내보내기, 텍스트 복사

**가상참여자 탭 기능:**
- **자동 생성 섹션**: 날짜/세션 선택 → 남자 N명/여자 N명 버튼 클릭 → 비율표대로 자동 생성
- **생성된 가상참여자 목록**: 날짜/세션/성별 필터, 개별 삭제
- **생성 규칙 테이블 (비율표)**: 성별별 직업/비율/출생연도/키 범위 - **수정 가능**

**직업 티어표 (설정 탭):**
- S/A/B 티어 분류 - **수정 가능**
- 라인업, 고객관리, 예약관리 정렬에 적용

---

### 2026-01-03 (v3): 탭 구조 정리 - 라인업→예약관리 통합

**예약 관리 탭 기능:**
- 날짜/세션/유형별 필터링
- 표시 컬럼: #, 유입(INV/ORG), 이름, 닉네임, 성별, 나이, 키, 직업, 자격유형, 현장확인, 와인, 조사완료, 연락처
- **현장확인 경고**: 현장 인증 선택 항목 ⚠️ 표시
- **조사완료 상태**: 사전조사 완료 여부 확인
- CSV 내보내기, 텍스트 복사 (현장용)
- 통계 요약: 총 인원, 남/녀, INV/일반, 조사완료, 와인보너스, 현장확인 필요

---

### 2026-01-03 (v2): 항목별 인증방법 선택 + FM 엔트리 명단

**핵심 변경 (verification.html):**
- **항목별 인증방법 선택**: 각 자격마다 "지금 첨부" / "현장 인증" 라디오 버튼
  - 예: 대학(지금첨부) + 연봉자산(현장인증) + 운동(지금첨부) 혼합 가능
  - 민감정보(연봉자산)는 기본값이 "현장 인증"
- **SNS 플랫폼 선택 복원**: Instagram/YouTube/TikTok/기타 버튼
  - Instagram/TikTok: 아이디만 입력 → 링크 자동 생성
  - YouTube/기타: 전체 링크 입력 필요

**데이터 저장 구조 (새 fileLinks 형식):**
```json
{
  "직업": {
    "authMethod": "upload",
    "onsiteDocs": "명함 또는 사원증",
    "fields": {
      "job_cert": { "type": "file", "url": "https://...", "name": "명함.jpg" }
    }
  },
  "연봉자산": {
    "authMethod": "onsite",
    "onsiteDocs": "소득/자산 증빙 서류",
    "fields": {}
  },
  "SNS": {
    "authMethod": "upload",
    "fields": {
      "sns_platform": { "type": "text", "value": "instagram" },
      "sns_account": { "type": "text", "value": "test_user", "link": "https://instagram.com/test_user" }
    }
  }
}
```

**고객 상세 팝업:**
- **현장 확인 필요 섹션 추가**: 주황색 경고 스타일로 현장 인증 항목 표시
- 제출 서류 섹션에 항목별 authMethod 반영

---

### 2026-01-03 (v1): 항목별 개별 서류 업로드 시스템

**주요 변경:**
- `verification.html` 완전 개편
  - 기존: 모든 서류를 한 번에 업로드 (어떤 자격에 어떤 서류인지 구분 불가)
  - 변경: 자격별/항목별 개별 파일 업로드 + 텍스트 입력
  
**자격별 필드 구조:**
| 자격 | 필드 | 타입 | 설명 |
|------|------|------|------|
| 직업 | job_cert | file | 명함/사원증/재직증명서 |
| 학력 | edu_cert | file | 졸업증명서/학생증 |
| 연봉자산 | asset_cert | file | 소득/자산 증빙 |
| SNS | sns_platform | select | 플랫폼 선택 (필수) |
| SNS | sns_account | text | 계정 정보 (필수) |
| SNS | sns_screenshot | file | 팔로워 스크린샷 |
| 운동 | fitness_cert | file | 완주 인증서/인바디 |
| 외모 | photo_1, photo_2 | file | 본인 사진 2장 |
| 득표3표 | party_name | text | 참석 파티 이름 (필수) |
| 득표3표 | vote_screenshot | file | 득표 인증 스크린샷 |

**UI 변경:**
- 각 자격 항목이 개별 섹션으로 표시
- 파일 업로드 시 즉시 피드백 (체크마크, 파일명)
- 필수 필드와 선택 필드 명확히 구분
- 고객 상세 팝업에서 항목별 서류 확인 가능

---

## ⚠️ 도메인 주의사항

| 환경 | 도메인 | 상태 |
|------|--------|------|
| 테스트 | `invite.svvys.com` | 현재 사용 중 |
| 프로덕션 | `svvys.com` | 최종 목표 |

> **중요:** 도메인 변경 시 Tasker URL도 함께 변경 필요

---

## 📞 문의

- Instagram: [@svvy.s](https://instagram.com/svvy.s)
- 관리자: svvys-mwol-crew.html (비밀번호: svvys2025)

---

## 📋 최근 업데이트 (v12)

### 2026-01-04 완료된 작업

1. **party_types 테이블 생성** ✅
   - 파티 유형 관리 (커피/와인/소주 등)
   - 정원, 최소 공석 설정 가능

2. **파티 유형 관리 UI** ✅
   - 파티 일정 탭 하단에 배치
   - CRUD 기능 완비

3. **세션 템플릿 동적 연동** ✅
   - 하드코딩 제거
   - 파티 유형 셀렉트 자동 업데이트

4. **일정 자동생성 파티 유형 연동** ✅
   - 세션 템플릿의 파티 유형/정원 정보 저장
   - 나이조건 연동

5. **자동 배정 로직 (비율 기반)** ✅
   - D-day 등차수열 30% → 80%
   - 여자 +1~2명 자동 배정
   - 최대 80% 한도, 최소 공석 유지
   - S티어 우선 정보확인중 3~4명

6. **라인업 실시간 정보 표시** ✅
   - D-day, 목표 비율, 정원, 공석 표시
   - 파티 유형 아이콘 표시

7. **외부 공개용 라인업 페이지** ✅
   - `lineup-public.html` 신규 생성
   - 실시간 비율 계산 적용
   - 나이대 표시 (초반/중반/후반)

### 다음 작업 예정

- 기존 가상참여자 배정 데이터 마이그레이션
- 라인업 실시간 재계산 트리거 개선
- invite.svvys.com 도메인 연동

---

## 🔑 Supabase API 키 가이드 (절대 까먹지 말 것!)

### API 키 종류

| 키 종류 | 용도 | 위치 |
|--------|------|------|
| **anon (public)** | 브라우저, 클라이언트용 | RLS 정책 적용됨 |
| **service_role** | 서버, GAS용 | RLS 무시 (관리자 권한) |

### ⚠️ 중요: Legacy 키 사용 필수!

Supabase가 새 API 키 체계를 도입했지만, **GAS에서는 Legacy 키만 작동합니다.**

**Legacy 키 찾는 방법:**
1. Supabase 대시보드 → **Settings** → **API Keys**
2. 상단 탭에서 **"Legacy anon, service_role API keys"** 클릭
3. **service_role** 키 복사 (`eyJ...`로 시작하는 긴 JWT 토큰)

**새 키 (sb_secret_xxx)는 GAS에서 작동하지 않습니다!**

### GAS에서 사용하는 키

```javascript
// GAS 코드 상단 설정
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Legacy service_role 키
```

**service_role 키를 사용하는 이유:**
- RLS 정책 무시 가능 (INSERT/UPDATE 권한 필요)
- GAS는 서버 환경이라 service_role 키 사용 안전
- anon 키로는 RLS 때문에 데이터 저장 실패

### 관리자 페이지에서 사용하는 키

```javascript
// 관리자 페이지는 로그인 후 authenticated 역할 사용
// anon 키로 시작 → 로그인 후 access_token으로 교체
```

---

**최종 수정일:** 2026-01-09 (v12.1)
**버전:** v12.1 (고질적 버그 해결 - 고객정보 표시/동명이인 처리)
**설계자:** Claude (AI Assistant)

---

© 2024-2026 뭘 좀 아는 사람들. All rights reserved.
