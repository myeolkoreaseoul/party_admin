<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë­˜ì¢€ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/pretendard@1.3.9/dist/web/variable/pretendardvariable.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #00E676;
            --primary-dark: #00C853;
            --bg: #0a0a0a;
            --card-bg: #141414;
            --border: #2a2a2a;
            --text: #fff;
            --text-muted: #888;
            --danger: #ff4757;
            --warning: #ffa502;
            --blue: #3b82f6;
            --purple: #8b5cf6;
        }
        
        body {
            font-family: 'Pretendard Variable', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 360px;
            text-align: center;
        }
        .login-box h2 { margin-bottom: 8px; font-size: 24px; }
        .login-box h2 span { color: var(--primary); }
        .login-box p { color: var(--text-muted); margin-bottom: 24px; font-size: 14px; }
        .login-box input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 16px;
            text-align: center;
            letter-spacing: 4px;
        }
        .login-box input:focus { outline: none; border-color: var(--primary); }
        .login-box button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }
        .login-error { color: var(--danger); font-size: 14px; margin-top: 12px; display: none; }
        .login-error.show { display: block; }
        
        /* í—¤ë” */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 18px; font-weight: 700; }
        .header h1 span { color: var(--primary); }
        .header-actions { display: flex; gap: 12px; }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 16px 24px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab:hover { border-color: var(--primary); color: var(--text); }
        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
        }
        .tab .badge {
            display: inline-block;
            background: var(--danger);
            color: #fff;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }
        .tab.active .badge { background: #000; color: var(--primary); }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        .main { padding: 24px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-card .label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .value.primary { color: var(--primary); }
        .stat-card .value.warning { color: var(--warning); }
        .stat-card .value.danger { color: var(--danger); }
        
        /* íˆ´ë°” */
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .filter-select {
            padding: 10px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
        }
        
        /* ë²„íŠ¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--primary); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-danger:hover { background: #c0392b; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* í…Œì´ë¸” */
        .table-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .table-scroll { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        th {
            background: var(--bg);
            font-weight: 600;
            color: var(--text-muted);
            font-size: 12px;
            text-transform: uppercase;
        }
        tr:hover { background: rgba(255,255,255,0.02); }
        tr:last-child td { border-bottom: none; }
        
        /* ìƒíƒœ ë±ƒì§€ */
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-success { background: rgba(0,230,118,0.15); color: var(--primary); }
        .status-warning { background: rgba(255,165,2,0.15); color: var(--warning); }
        .status-danger { background: rgba(255,71,87,0.15); color: var(--danger); }
        .status-info { background: rgba(59,130,246,0.15); color: var(--blue); }
        .status-purple { background: rgba(139,92,246,0.15); color: var(--purple); }
        .status-muted { background: rgba(136,136,136,0.15); color: var(--text-muted); }
        .status-coffee { background: rgba(139,69,19,0.15); color: #8B4513; }
        .status-wine { background: rgba(128,0,32,0.15); color: #800020; }
        
        /* í‹°ì–´ ë±ƒì§€ */
        .tier {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }
        .tier-S { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
        .tier-A { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: #000; }
        .tier-B { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }
        .tier-C { background: var(--border); color: var(--text-muted); }
        .tier-pending { background: var(--border); color: var(--text-muted); }
        
        /* ê°€ìƒì°¸ì—¬ì í–‰ ìŠ¤íƒ€ì¼ */
        .virtual-row { background: rgba(255, 193, 7, 0.1); }
        .virtual-row:hover { background: rgba(255, 193, 7, 0.2); }
        
        /* ì •ë³´í™•ì¸ì¤‘ í–‰ ìŠ¤íƒ€ì¼ */
        .pending-row { background: rgba(128, 128, 128, 0.1); }
        .pending-row:hover { background: rgba(128, 128, 128, 0.2); }
        
        /* ìƒíƒœ ë±ƒì§€ */
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .badge-success { background: rgba(40, 167, 69, 0.2); color: #28a745; }
        .badge-warning { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .badge-danger { background: rgba(220, 53, 69, 0.2); color: #dc3545; }
        .badge-info { background: rgba(23, 162, 184, 0.2); color: #17a2b8; }
        .badge-purple { background: rgba(102, 16, 242, 0.2); color: #6610f2; }
        
        /* ì˜ˆì•½ ìˆ˜ ë±ƒì§€ */
        .reservation-count {
            display: inline-block;
            background: var(--blue);
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* í†µí•© í…Œì´ë¸” */
        .integrated-table th { font-size: 11px; padding: 10px 12px; }
        .integrated-table td { padding: 10px 12px; font-size: 12px; }
        .integrated-table .col-stage { min-width: 100px; }
        .integrated-table .col-source { min-width: 60px; }
        .integrated-table .col-name { min-width: 70px; }
        .integrated-table .col-phone { min-width: 110px; }
        .integrated-table .col-gender { min-width: 50px; }
        .integrated-table .col-age { min-width: 50px; }
        .integrated-table .col-height { min-width: 50px; }
        .integrated-table .col-job { min-width: 80px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
        .integrated-table .col-date { min-width: 100px; }
        .integrated-table .col-program { min-width: 80px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
        .integrated-table .col-survey { min-width: 40px; text-align: center; }
        .integrated-table .col-wine { min-width: 30px; text-align: center; }
        .integrated-table .col-status { min-width: 80px; }
        
        /* ì •ë ¬ ê°€ëŠ¥í•œ í—¤ë” */
        .sortable-table th.sortable { cursor: pointer; user-select: none; }
        .sortable-table th.sortable:hover { background: var(--border); }
        .sortable-table th.sortable i { margin-left: 4px; font-size: 10px; opacity: 0.5; }
        .sortable-table th.sortable.asc i:before { content: "\f0de"; }
        .sortable-table th.sortable.desc i:before { content: "\f0dd"; }
        .sortable-table th.sortable.asc i, .sortable-table th.sortable.desc i { opacity: 1; color: var(--primary); }
        
        /* ì¼ë°˜ í…Œì´ë¸” í—¤ë” ì†ŒíŒ… */
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; }
        th.sortable:hover { background: var(--border); }
        th.sortable i { margin-left: 4px; font-size: 10px; opacity: 0.5; }
        
        /* ë‹¨ê³„ ë±ƒì§€ */
        .stage-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .stage-3 { background: rgba(0,230,118,0.2); color: var(--primary); }
        .stage-2 { background: rgba(59,130,246,0.2); color: var(--blue); }
        .stage-1 { background: rgba(255,165,2,0.2); color: var(--warning); }
        
        /* ê³ ê° ìˆ˜ í‘œì‹œ */
        .customer-count {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        /* í–‰ í´ë¦­ ê°€ëŠ¥ */
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background: rgba(0,230,118,0.05) !important; }
        
        /* ë¡œë”© */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 16px; margin-bottom: 8px; }
        
        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-color: var(--primary); }
        .toast.error { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); background: #3d2c00; }
        
        /* ëª¨ë‹¬ */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal.open { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { font-size: 18px; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
        }
        .modal-body { padding: 24px; }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* í¼ */
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* ì„±ë³„ ìƒ‰ìƒ */
        .gender-male { color: var(--blue); }
        .gender-female { color: #ec4899; }
        
        /* ìš”ì¼ ìƒ‰ìƒ */
        .text-blue { color: var(--blue); font-weight: 600; }
        .text-red { color: #ef4444; font-weight: 600; }
        
        /* ë¹„í™œì„± í–‰ */
        .row-inactive { 
            opacity: 0.5; 
            background: rgba(128, 128, 128, 0.1);
        }
        
        /* íŒŒí‹° ì¹´ë“œ */
        .party-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .party-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .party-card-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .party-card-header h3 { font-size: 15px; font-weight: 600; }
        .party-card-body { padding: 16px; }
        .party-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .party-stat:last-child { border-bottom: none; }
        
        /* ì„¹ì…˜ í—¤ë” */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .section-header h2 { font-size: 18px; font-weight: 600; }
        
        /* í´ë¦­ ê°€ëŠ¥ í–‰ */
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background: rgba(0,230,118,0.05) !important; }
        
        /* ì˜ˆì•½ ìƒì„¸ (ì¸ë¼ì¸) */
        .reservation-details {
            display: none;
            background: var(--bg);
            padding: 12px 16px;
        }
        .reservation-details.open { display: block; }
        .reservation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .reservation-item:last-child { margin-bottom: 0; }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h2><span>ë­˜ì¢€</span> ê´€ë¦¬ì</h2>
            <p>ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
            <input type="email" id="emailInput" placeholder="ì´ë©”ì¼" style="margin-bottom: 10px;">
            <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeypress="if(event.key==='Enter')login()">
            <button onclick="login()">ë¡œê·¸ì¸</button>
            <div class="login-error" id="loginError">ë¡œê·¸ì¸ ì‹¤íŒ¨</div>
        </div>
    </div>
    
    <!-- í—¤ë” -->
    <header class="header">
        <h1><span>ë­˜ì¢€</span> ê´€ë¦¬ì</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshAllData()">
                <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
            </button>
        </div>
    </header>
    
    <!-- íƒ­ -->
    <nav class="tabs">
        <div class="tab active" data-tab="dashboard">ëŒ€ì‹œë³´ë“œ</div>
        <div class="tab" data-tab="customers">ê³ ê° ê´€ë¦¬ <span class="badge" id="customerBadge">0</span></div>
        <div class="tab" data-tab="invitations">ì´ˆëŒ€ì¥ ì‹ ì²­</div>
        <div class="tab" data-tab="reservations">ì˜ˆì•½ ê´€ë¦¬</div>
        <div class="tab" data-tab="lineup">ë¼ì¸ì—…</div>
        <div class="tab" data-tab="virtual">ê°€ìƒì°¸ì—¬ì</div>
        <div class="tab" data-tab="schedules">íŒŒí‹°ì¼ì •</div>
        <div class="tab" data-tab="tiers">ì§ì—…í‹°ì–´í‘œ</div>
        <div class="tab" data-tab="settings">ì„¤ì •</div>
    </nav>
    
    <main class="main">
        <!-- ==================== ëŒ€ì‹œë³´ë“œ ==================== -->
        <div class="tab-content active" id="tab-dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">ì „ì²´ ê³ ê°</div>
                    <div class="value primary" id="stat-totalCustomers">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">ì°¸ì—¬ í™•ì •</div>
                    <div class="value" id="stat-confirmed">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">ì¡°ì‚¬ í•„ìš”</div>
                    <div class="value warning" id="stat-needSurvey">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">ì˜ˆì•½ ëŒ€ê¸°</div>
                    <div class="value danger" id="stat-waiting">-</div>
                </div>
            </div>
            
            <div class="section-header">
                <h2>ë‹¤ê°€ì˜¤ëŠ” íŒŒí‹°</h2>
            </div>
            <div class="party-grid" id="upcomingParties">
                <div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div>
            </div>
        </div>
        
        <!-- ==================== í†µí•© ê³ ê° ê´€ë¦¬ (1ì˜ˆì•½=1í–‰) ==================== -->
        <div class="tab-content" id="tab-customers">
            <div class="toolbar">
                <input type="text" class="search-input" id="customerSearch" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ì§ì—…ìœ¼ë¡œ ê²€ìƒ‰...">
                <select class="filter-select" id="customerStageFilter">
                    <option value="">ì „ì²´ ë‹¨ê³„</option>
                    <option value="6.ì˜ˆì•½ì·¨ì†Œ">6. ì˜ˆì•½ ì·¨ì†Œ</option>
                    <option value="5.í–‰ì‚¬ë¶ˆì°¸">5. í–‰ì‚¬ ë¶ˆì°¸</option>
                    <option value="4.ì°¸ì—¬ì™„ë£Œ">4. ì°¸ì—¬ ì™„ë£Œ</option>
                    <option value="3.ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ">3. ì‚¬ì „ì¡°ì‚¬ ì™„ë£Œ</option>
                    <option value="2.í”„ë¦½ì˜ˆì•½">2. í”„ë¦½ ê²°ì œì™„ë£Œ</option>
                    <option value="1.ì´ˆëŒ€ì¥ì‹ ì²­">1. ì´ˆëŒ€ì¥ ì‹ ì²­</option>
                </select>
                <select class="filter-select" id="customerSourceFilter">
                    <option value="">ì „ì²´ ìœ ì…</option>
                    <option value="invitation">ì´ˆëŒ€ì¥</option>
                    <option value="organic">ì¼ë°˜</option>
                </select>
                <select class="filter-select" id="customerBlacklistFilter" style="border-color: var(--danger);">
                    <option value="">ì „ì²´ ê³ ê°</option>
                    <option value="blacklist">â›” ë¸”ë™ë¦¬ìŠ¤íŠ¸ë§Œ</option>
                    <option value="normal">ì •ìƒ ê³ ê°ë§Œ</option>
                </select>
                <button class="btn btn-secondary" onclick="refreshIntegratedData()">
                    <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                </button>
                <button class="btn btn-primary" onclick="openCustomerForm()">
                    <i class="fas fa-plus"></i> ê³ ê° ì¶”ê°€
                </button>
            </div>
            
            <div class="customer-count" id="customerCount">ì´ 0ëª…</div>
            
            <div class="table-container">
                <div class="table-scroll">
                    <table id="customersTable" class="integrated-table sortable-table">
                        <thead>
                            <tr>
                                <th class="col-stage sortable" data-sort="ì¸ì¦ë‹¨ê³„" onclick="sortCustomers('ì¸ì¦ë‹¨ê³„')">ì¸ì¦ë‹¨ê³„ <i class="fas fa-sort"></i></th>
                                <th class="col-source sortable" data-sort="ìœ ì…ê²½ë¡œ" onclick="sortCustomers('ìœ ì…ê²½ë¡œ')">ìœ ì… <i class="fas fa-sort"></i></th>
                                <th class="col-name sortable" data-sort="í¬ë£¨ëª…" onclick="sortCustomers('í¬ë£¨ëª…')">ì´ë¦„ <i class="fas fa-sort"></i></th>
                                <th class="col-nickname sortable" data-sort="ë‹‰ë„¤ì„" onclick="sortCustomers('ë‹‰ë„¤ì„')">ë‹‰ë„¤ì„ <i class="fas fa-sort"></i></th>
                                <th class="col-phone">ì—°ë½ì²˜</th>
                                <th class="col-gender sortable" data-sort="ì„±ë³„" onclick="sortCustomers('ì„±ë³„')">ì„±ë³„ <i class="fas fa-sort"></i></th>
                                <th class="col-age sortable" data-sort="ì¶œìƒì—°ë„" onclick="sortCustomers('ì¶œìƒì—°ë„')">ë‚˜ì´ <i class="fas fa-sort"></i></th>
                                <th class="col-height sortable" data-sort="ì‹ ì¥" onclick="sortCustomers('ì‹ ì¥')">í‚¤ <i class="fas fa-sort"></i></th>
                                <th class="col-job sortable" data-sort="ì§ì—…" onclick="sortCustomers('ì§ì—…')">ì§ì—… <i class="fas fa-sort"></i></th>
                                <th class="col-survey sortable" data-sort="ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ" onclick="sortCustomers('ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ')">ì¡°ì‚¬ <i class="fas fa-sort"></i></th>
                                <th class="col-reserve sortable" data-sort="ì˜ˆì•½ê±´ìˆ˜" onclick="sortCustomers('ì˜ˆì•½ê±´ìˆ˜')">ì˜ˆì•½ <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="customersBody">
                            <tr><td colspan="11"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ==================== ì´ˆëŒ€ì¥ ì‹ ì²­ ==================== -->
        <div class="tab-content" id="tab-invitations">
            <div class="toolbar">
                <input type="text" class="search-input" id="invitationSearch" placeholder="ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰...">
                <select class="filter-select" id="invitationStatusFilter">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="ì¿ í°ìŠ¹ì¸">ì¿ í°ìŠ¹ì¸</option>
                    <option value="ìŠ¹ì¸ì™„ë£Œ">ìŠ¹ì¸ì™„ë£Œ</option>
                    <option value="ì„œë¥˜ì œì¶œì™„ë£Œ">ì„œë¥˜ì œì¶œì™„ë£Œ</option>
                    <option value="í˜„ì¥ì¸ì¦ì˜ˆì •">í˜„ì¥ì¸ì¦ì˜ˆì •</option>
                    <option value="ì¸ì¦ëŒ€ê¸°">ì¸ì¦ëŒ€ê¸°</option>
                </select>
            </div>
            
            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortInvitations('phone')">ì „í™”ë²ˆí˜¸ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortInvitations('qualifications')">ì„ íƒìê²© <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortInvitations('wineBonus')">ì™€ì¸ë³´ë„ˆìŠ¤ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortInvitations('authType')">ì¸ì¦ë°©ë²• <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortInvitations('approvalStatus')">ìŠ¹ì¸ìƒíƒœ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortInvitations('distributor')">ë°°í¬ì²˜ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortInvitations('hasReservation')">í”„ë¦½ì˜ˆì•½ <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="invitationsBody">
                            <tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ==================== ì˜ˆì•½ ê´€ë¦¬ (FM ì—”íŠ¸ë¦¬ ëª…ë‹¨ ìŠ¤íƒ€ì¼) ==================== -->
        <div class="tab-content" id="tab-reservations">
            <div class="toolbar" style="flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" class="search-input" id="reservationSearch" placeholder="ğŸ” ì´ë¦„, ì—°ë½ì²˜ ê²€ìƒ‰..." style="width: 180px;">
                    <select class="filter-select" id="reservationDateFilter" style="min-width: 180px;">
                        <option value="">ğŸ“… ì „ì²´ ë‚ ì§œ</option>
                    </select>
                    <select class="filter-select" id="reservationPartFilter" style="min-width: 140px;">
                        <option value="">ì „ì²´ ì„¸ì…˜</option>
                        <option value="1ë¶€">â˜• 1ë¶€ ì»¤í”¼</option>
                        <option value="2ë¶€">â˜• 2ë¶€ ì»¤í”¼</option>
                        <option value="3ë¶€">ğŸ· 3ë¶€ ì™€ì¸</option>
                    </select>
                    <select class="filter-select" id="reservationTypeFilter" style="min-width: 120px;">
                        <option value="">ì „ì²´ ìœ í˜•</option>
                        <option value="invitation">ğŸ« ì¸ë¹„í…Œì´ì…˜</option>
                        <option value="organic">ì¼ë°˜</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" onclick="openAddReservationModal()">
                        <i class="fas fa-plus"></i> ì˜ˆì•½ ì¶”ê°€
                    </button>
                    <button class="btn btn-secondary" onclick="refreshReservations()">
                        <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button class="btn btn-secondary" onclick="exportReservationsCSV()">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button class="btn btn-secondary" onclick="copyReservationsText()">
                        <i class="fas fa-copy"></i> ë³µì‚¬
                    </button>
                </div>
            </div>
            
            <!-- í†µê³„ ìš”ì•½ -->
            <div id="reservationSummary" style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;">
                <!-- JSë¡œ ë Œë”ë§ -->
            </div>
            
            <!-- FM ìŠ¤íƒ€ì¼ ì—”íŠ¸ë¦¬ í…Œì´ë¸” -->
            <div class="table-container">
                <div class="table-scroll">
                    <table id="reservationTable" style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 120px;" class="sortable" onclick="sortReservations('partyTime')">íŒŒí‹°ì¼ì‹œ <i class="fas fa-sort"></i></th>
                                <th style="width: 70px;" class="sortable" onclick="sortReservations('paymentType')">ê²°ì œ <i class="fas fa-sort"></i></th>
                                <th style="width: 55px;" class="sortable" onclick="sortReservations('source')">ìœ ì… <i class="fas fa-sort"></i></th>
                                <th style="width: 75px;" class="sortable" onclick="sortReservations('name')">ì´ë¦„ <i class="fas fa-sort"></i></th>
                                <th style="width: 70px;" class="sortable" onclick="sortReservations('nickname')">ë‹‰ë„¤ì„ <i class="fas fa-sort"></i></th>
                                <th style="width: 45px;" class="sortable" onclick="sortReservations('gender')">ì„±ë³„ <i class="fas fa-sort"></i></th>
                                <th style="width: 45px;" class="sortable" onclick="sortReservations('age')">ë‚˜ì´ <i class="fas fa-sort"></i></th>
                                <th style="width: 50px;" class="sortable" onclick="sortReservations('height')">í‚¤ <i class="fas fa-sort"></i></th>
                                <th style="width: 90px;" class="sortable" onclick="sortReservations('job')">ì§ì—… <i class="fas fa-sort"></i></th>
                                <th style="width: 80px;">ìê²©ìœ í˜•</th>
                                <th style="width: 100px;" class="sortable" onclick="sortReservations('onsite')">í˜„ì¥í™•ì¸ <i class="fas fa-sort"></i></th>
                                <th style="width: 45px;" class="sortable" onclick="sortReservations('wine')">ì™€ì¸ <i class="fas fa-sort"></i></th>
                                <th style="width: 55px;" class="sortable" onclick="sortReservations('survey')">ì¡°ì‚¬ <i class="fas fa-sort"></i></th>
                                <th style="width: 95px;">ì—°ë½ì²˜</th>
                                <th style="width: 80px;">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="reservationBody">
                            <tr><td colspan="16"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ==================== ë¼ì¸ì—… (ìµœì¢… í¬ë©”ì´ì…˜) ==================== -->
        <div class="tab-content" id="tab-lineup">
            <div class="section-header">
                <h2>ğŸ† ìµœì¢… ë¼ì¸ì—…</h2>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="refreshLineup()">
                        <i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button class="btn btn-secondary" onclick="exportLineupCSV()">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button class="btn btn-secondary" onclick="copyLineupText()">
                        <i class="fas fa-copy"></i> ë³µì‚¬
                    </button>
                </div>
            </div>
            
            <div class="toolbar" style="flex-wrap: wrap;">
                <select class="filter-select" id="lineupDateFilter">
                    <option value="">ë‚ ì§œ ì„ íƒ</option>
                </select>
                <select class="filter-select" id="lineupPartFilter">
                    <option value="">ì„¸ì…˜ ì„ íƒ</option>
                    <option value="1ë¶€">1ë¶€</option>
                    <option value="2ë¶€">2ë¶€</option>
                    <option value="3ë¶€">3ë¶€</option>
                </select>
                <div style="flex: 1;"></div>
                <select class="filter-select" id="allLineupWeeks" style="width: auto;">
                    <option value="1">í–¥í›„ 1ì£¼</option>
                    <option value="2" selected>í–¥í›„ 2ì£¼</option>
                    <option value="3">í–¥í›„ 3ì£¼</option>
                    <option value="4">í–¥í›„ 4ì£¼</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="showAllLineups()">
                    <i class="fas fa-calendar-week"></i> ì „ì²´ ë¼ì¸ì—… ë³´ê¸°
                </button>
            </div>
            
            <!-- ë¼ì¸ì—… ìš”ì•½ ì¹´ë“œ -->
            <div id="lineupSummaryCard" class="card" style="margin-bottom: 24px; padding: 20px;">
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted);">ì´ ì¸ì›</div>
                        <div style="font-size: 24px; font-weight: 600;" id="lineupTotalCount">-</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted);">ì‹¤ì œ ì°¸ì„</div>
                        <div style="font-size: 24px; font-weight: 600; color: var(--primary);" id="lineupRealCount">-</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted);">ê°€ìƒ ì°¸ì—¬</div>
                        <div style="font-size: 24px; font-weight: 600; color: var(--warning);" id="lineupVirtualCount">-</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted);">ë‚¨ì</div>
                        <div style="font-size: 24px; font-weight: 600; color: #4a9eff;" id="lineupMaleCount">-</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted);">ì—¬ì</div>
                        <div style="font-size: 24px; font-weight: 600; color: #ff6b9d;" id="lineupFemaleCount">-</div>
                    </div>
                </div>
                <!-- ë¹„ìœ¨ ê¸°ë°˜ ì •ë³´ í‘œì‹œ -->
                <div id="lineupRatioInfo" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); display: none;">
                    <div style="display: flex; gap: 24px; flex-wrap: wrap; font-size: 13px;">
                        <div><span style="color: var(--text-muted);">íŒŒí‹° ìœ í˜•:</span> <strong id="lineupPartyType">-</strong></div>
                        <div><span style="color: var(--text-muted);">D-day:</span> <strong id="lineupDday">-</strong></div>
                        <div><span style="color: var(--text-muted);">ëª©í‘œ ë¹„ìœ¨:</span> <strong id="lineupTargetRatio">-</strong></div>
                        <div><span style="color: var(--text-muted);">ì •ì›:</span> <strong id="lineupCapacity">-</strong></div>
                        <div><span style="color: var(--text-muted);">ê³µì„:</span> <strong id="lineupVacancy">-</strong></div>
                    </div>
                </div>
            </div>
            
            <!-- ë‚¨ë…€ ë¼ì¸ì—… 2ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <!-- ë‚¨ì ë¼ì¸ì—… -->
                <div class="card" style="padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: #4a9eff;">ğŸ‘¨ ë‚¨ì ë¼ì¸ì—… <span id="lineupMaleSubCount" style="font-size: 14px; color: var(--text-muted);"></span></h3>
                        <button class="btn btn-sm btn-primary" onclick="addRandomVirtualToLineup('ë‚¨ì')" title="ë‚¨ì ê°€ìƒì°¸ì—¬ì 1ëª… ëœë¤ ì¶”ê°€">
                            <i class="fas fa-plus"></i> ëœë¤ì¶”ê°€
                        </button>
                    </div>
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>í‹°ì–´</th>
                                    <th>ì´ë¦„</th>
                                    <th>ë‚˜ì´</th>
                                    <th>í‚¤</th>
                                    <th>ì§ì—…</th>
                                    <th>ìœ í˜•</th>
                                </tr>
                            </thead>
                            <tbody id="lineupMaleBody">
                                <tr><td colspan="7" class="empty-state">ë‚ ì§œ/ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ì—¬ì ë¼ì¸ì—… -->
                <div class="card" style="padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: #ff6b9d;">ğŸ‘© ì—¬ì ë¼ì¸ì—… <span id="lineupFemaleSubCount" style="font-size: 14px; color: var(--text-muted);"></span></h3>
                        <button class="btn btn-sm btn-primary" onclick="addRandomVirtualToLineup('ì—¬ì')" title="ì—¬ì ê°€ìƒì°¸ì—¬ì 1ëª… ëœë¤ ì¶”ê°€">
                            <i class="fas fa-plus"></i> ëœë¤ì¶”ê°€
                        </button>
                    </div>
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>í‹°ì–´</th>
                                    <th>ì´ë¦„</th>
                                    <th>ë‚˜ì´</th>
                                    <th>í‚¤</th>
                                    <th>ì§ì—…</th>
                                    <th>ìœ í˜•</th>
                                </tr>
                            </thead>
                            <tbody id="lineupFemaleBody">
                                <tr><td colspan="7" class="empty-state">ë‚ ì§œ/ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ì „ì²´ íŒŒí‹° ë¼ì¸ì—… ë³´ê¸° -->
            <div id="allLineupsSection" style="display: none; margin-top: 32px;">
                <div class="section-header">
                    <h2>ğŸ“… í–¥í›„ íŒŒí‹° ì „ì²´ ë¼ì¸ì—…</h2>
                    <button class="btn btn-secondary btn-sm" onclick="hideAllLineups()">
                        <i class="fas fa-times"></i> ë‹«ê¸°
                    </button>
                </div>
                <div id="allLineupsContainer"></div>
            </div>
            
            <!-- ==================== ê³µê°œìš© ë¼ì¸ì—… ìƒì„± ==================== -->
            <div class="section-header" style="margin-top: 32px;">
                <h2>ğŸ“¢ ê³µê°œìš© ë¼ì¸ì—…</h2>
            </div>
            <div class="card" style="padding: 20px; margin-bottom: 24px;">
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                    <i class="fas fa-shield-alt" style="color: var(--success);"></i>
                    ì´ ê¸°ëŠ¥ì€ ë¯¼ê°ì •ë³´(í‹°ì–´, ìœ í˜•) ì—†ì´ <strong>ê³µê°œ í…Œì´ë¸”</strong>ì— ì €ì¥í•©ë‹ˆë‹¤.<br>
                    invite.svvys.comê³¼ í”„ë¦½ ìƒì„¸í˜ì´ì§€ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 16px;">
                    <select class="filter-select" id="publicLineupDate">
                        <option value="">ë‚ ì§œ ì„ íƒ</option>
                    </select>
                    <select class="filter-select" id="publicLineupPart">
                        <option value="">ì„¸ì…˜ ì„ íƒ</option>
                        <option value="1ë¶€">1ë¶€</option>
                        <option value="2ë¶€">2ë¶€</option>
                        <option value="3ë¶€">3ë¶€</option>
                    </select>
                    <button class="btn btn-primary" onclick="generatePublicLineup()">
                        <i class="fas fa-upload"></i> ê³µê°œ ë¼ì¸ì—… ìƒì„±
                    </button>
                    <button class="btn btn-danger" onclick="clearPublicLineup()">
                        <i class="fas fa-trash"></i> ì‚­ì œ
                    </button>
                </div>
                
                <!-- ê³µê°œ ë¼ì¸ì—… ë¯¸ë¦¬ë³´ê¸° -->
                <div id="publicLineupPreview" style="background: var(--bg); border-radius: 8px; padding: 16px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0;"><i class="fas fa-eye"></i> ë¯¸ë¦¬ë³´ê¸° (ê³µê°œìš©)</h4>
                        <button class="btn btn-secondary btn-sm" onclick="copyPublicLineupText()">
                            <i class="fas fa-copy"></i> í…ìŠ¤íŠ¸ ë³µì‚¬ (í”„ë¦½ìš©)
                        </button>
                    </div>
                    <div id="publicLineupContent"></div>
                </div>
            </div>
            
            <!-- ì „ì²´ ê³µê°œ ë¼ì¸ì—… í˜„í™© -->
            <div class="card" style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h4 style="margin: 0;"><i class="fas fa-list"></i> ê³µê°œëœ ë¼ì¸ì—… í˜„í™©</h4>
                    <button class="btn btn-secondary btn-sm" onclick="refreshPublicLineupList()">
                        <i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ì„¸ì…˜</th>
                                <th>ë‚¨ì</th>
                                <th>ì—¬ì</th>
                                <th>ì´ì›</th>
                                <th>ìƒì„±ì¼</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="publicLineupTableBody">
                            <tr><td colspan="7" class="empty-state">ê³µê°œëœ ë¼ì¸ì—…ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ==================== ê°€ìƒì°¸ì—¬ì ==================== -->
        <div class="tab-content" id="tab-virtual">
            <!-- ê°€ìƒì°¸ì—¬ì í’€ ê´€ë¦¬ -->
            <div class="section-header">
                <h2>ğŸ‘¥ ê°€ìƒì°¸ì—¬ì í’€ <span id="poolCount" style="font-size: 14px; color: var(--text-muted);">(0ëª…)</span></h2>
            </div>
            <!-- í’€ í†µê³„ - ì „ê´‘íŒ ìŠ¤íƒ€ì¼ -->
            <div class="stats-grid" style="margin-bottom: 16px;">
                <div class="stat-card">
                    <div class="label">ì „ì²´</div>
                    <div class="value primary" id="poolTotalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">ë‚¨ì</div>
                    <div class="value" id="poolMaleCount" style="color: var(--blue);">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">ì—¬ì</div>
                    <div class="value danger" id="poolFemaleCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Sí‹°ì–´</div>
                    <div class="value warning" id="poolSTierCount">0</div>
                </div>
            </div>
            <!-- í’€ ìƒì„± ì»¨íŠ¸ë¡¤ - toolbar ìŠ¤íƒ€ì¼ -->
            <div class="toolbar">
                <input type="number" id="poolMinBirthYear" value="1987" min="1950" max="2010" class="filter-select" style="width: 80px;" title="ìµœì†Œ ì¶œìƒì—°ë„">
                <span style="color: var(--text-muted);">~</span>
                <input type="number" id="poolMaxBirthYear" value="2002" min="1950" max="2010" class="filter-select" style="width: 80px;" title="ìµœëŒ€ ì¶œìƒì—°ë„">
                <span style="color: var(--text-muted); font-size: 13px;">ë…„ìƒ</span>
                <input type="number" id="poolAddCount" value="200" min="1" max="1000" class="filter-select" style="width: 80px;" title="ìƒì„± ì¸ì›">
                <span style="color: var(--text-muted); font-size: 13px;">ëª…</span>
                <button class="btn btn-primary btn-sm" onclick="addToVirtualPool()">
                    <i class="fas fa-user-plus"></i> ì¶”ê°€ ìƒì„±
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteSelectedFromPool()">
                    <i class="fas fa-trash"></i> ì„ íƒ ì‚­ì œ
                </button>
                <button class="btn btn-secondary btn-sm" onclick="refreshVirtualPool()">
                    <i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
            
            <!-- ğŸš€ ìë™ ë°°ì • ì‹œìŠ¤í…œ -->
            <div class="section-header">
                <h2>ğŸš€ í–¥í›„ íŒŒí‹° ìë™ ë°°ì •</h2>
            </div>
            <div class="card" style="margin-bottom: 32px; padding: 20px; background: linear-gradient(135deg, var(--card-bg) 0%, rgba(139, 92, 246, 0.05) 100%);">
                <!-- íŒŒí‹° ìœ í˜•ë³„ ì •ì› -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 12px;"><i class="fas fa-users"></i> íŒŒí‹° ìœ í˜•ë³„ ì •ì›</h4>
                    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                        <div style="background: var(--bg); padding: 12px 20px; border-radius: 8px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">â˜• ì»¤í”¼íŒŒí‹°</div>
                            <div style="font-size: 14px;">ë‚¨ <strong>12</strong>ëª… / ì—¬ <strong>12</strong>ëª…</div>
                        </div>
                        <div style="background: var(--bg); padding: 12px 20px; border-radius: 8px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">ğŸ· ì™€ì¸íŒŒí‹°</div>
                            <div style="font-size: 14px;">ë‚¨ <strong>24</strong>ëª… / ì—¬ <strong>24</strong>ëª…</div>
                        </div>
                    </div>
                </div>
                
                <!-- ë¹„ìœ¨ ê¸°ë°˜ ê°€ìƒì°¸ì—¬ì ì‹œìŠ¤í…œ -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 12px;"><i class="fas fa-chart-line"></i> D-day ë¹„ìœ¨ ê¸°ë°˜ ì‹œìŠ¤í…œ</h4>
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                        íŒŒí‹°ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜ì— ë”°ë¼ <strong>ì •ì› ëŒ€ë¹„ ë¹„ìœ¨</strong>ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
                        <span style="color: var(--warning);">â€» ì—¬ìëŠ” í•­ìƒ 1~2ëª… ë” ë§ê²Œ ë°°ì •ë©ë‹ˆë‹¤.</span>
                    </p>
                    
                    <!-- ë¹„ìœ¨ ì„¤ì • -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 12px; color: var(--text-muted);">D-14 (2ì£¼ì „) ì‹œì‘ ë¹„ìœ¨</span>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="ratioStart" value="30" min="0" max="100" style="width: 60px; text-align: center;">
                                    <span>%</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: var(--text-muted);">D-0 (ë‹¹ì¼) ìµœëŒ€ ë¹„ìœ¨</span>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="ratioEnd" value="80" min="0" max="100" style="width: 60px; text-align: center;">
                                    <span>%</span>
                                </div>
                            </div>
                        </div>
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">ì˜ˆì‹œ (ì»¤í”¼ 12ëª… / ì™€ì¸ 24ëª…)</div>
                            <table style="width: 100%; font-size: 11px;">
                                <tr><td>D-14</td><td>30%</td><td>â†’ ì»¤í”¼ 4ëª…, ì™€ì¸ 7ëª…</td></tr>
                                <tr><td>D-7</td><td>55%</td><td>â†’ ì»¤í”¼ 7ëª…, ì™€ì¸ 13ëª…</td></tr>
                                <tr><td>D-0</td><td>80%</td><td>â†’ ì»¤í”¼ 10ëª…, ì™€ì¸ 19ëª…</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ì œì•½ ì¡°ê±´ -->
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <div style="background: var(--bg); padding: 10px 16px; border-radius: 8px; font-size: 12px;">
                            <i class="fas fa-shield-alt" style="color: var(--warning);"></i>
                            ìµœëŒ€ í•œë„: ì •ì›ì˜ <strong>80%</strong> ì´ˆê³¼ ë¶ˆê°€
                        </div>
                        <div style="background: var(--bg); padding: 10px 16px; border-radius: 8px; font-size: 12px;">
                            <i class="fas fa-door-open" style="color: var(--info);"></i>
                            ìµœì†Œ ê³µì„: ì»¤í”¼ <strong>2ëª…</strong>, ì™€ì¸ <strong>4ëª…</strong> ìœ ì§€
                        </div>
                    </div>
                </div>
                
                <!-- ì •ë³´í™•ì¸ì¤‘ ì„¤ì • -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;"><i class="fas fa-user-secret"></i> ì •ë³´í™•ì¸ì¤‘ ì„¤ì •</h4>
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                        ì„±ë³„ë³„ë¡œ ì „ì²´ ë¼ì¸ì—…ì˜ ì¼ì • ë¹„ìœ¨ê¹Œì§€ë§Œ "ì •ë³´í™•ì¸ì¤‘"ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
                    </p>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
                        <div style="background: var(--bg); padding: 10px 16px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 12px;">ì „ì²´ ë¼ì¸ì—…ì˜</span>
                            <input type="number" id="pendingRatio" value="30" min="0" max="100" style="width: 50px; text-align: center;">
                            <span style="font-size: 12px;">% ì´ë‚´</span>
                        </div>
                        <div style="background: var(--bg); padding: 10px 16px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 12px;">ìµœëŒ€</span>
                            <input type="number" id="pendingMax" value="3" min="0" max="10" style="width: 50px; text-align: center;">
                            <span style="font-size: 12px;">ëª…ê¹Œì§€</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            â†’ ëœë¤ ì„ íƒ (í‹°ì–´ ë¬´ê´€)
                        </div>
                    </div>
                </div>
                
                <!-- ìë™ ë°°ì • ì»¨íŠ¸ë¡¤ -->
                <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center; padding-top: 16px; border-top: 1px solid var(--border);">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>í–¥í›„</label>
                        <select id="autoAssignWeeks" class="filter-select" style="width: auto;">
                            <option value="1">1ì£¼</option>
                            <option value="2" selected>2ì£¼</option>
                            <option value="3">3ì£¼</option>
                            <option value="4">4ì£¼</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>íŒŒí‹° ìœ í˜•</label>
                        <select id="autoPartyType" class="filter-select" style="width: auto;">
                            <option value="wine">ğŸ· ì™€ì¸íŒŒí‹° (24:24)</option>
                            <option value="coffee">â˜• ì»¤í”¼íŒŒí‹° (12:12)</option>
                        </select>
                    </div>
                    <div style="flex: 1;"></div>
                    <button class="btn btn-primary" onclick="autoAssignAllParties()">
                        <i class="fas fa-magic"></i> ìë™ ë°°ì • ì‹¤í–‰
                    </button>
                </div>
            </div>
            
            <!-- íŒŒí‹°ë³„ ê°€ìƒì°¸ì—¬ì ë°°ì • (ê°œë³„) -->
            <div class="section-header">
                <h2>ğŸ¯ ê°œë³„ íŒŒí‹° ê°€ìƒì°¸ì—¬ì ë°°ì •</h2>
            </div>
            <div class="card" style="margin-bottom: 24px; padding: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label>íŒŒí‹° ë‚ ì§œ</label>
                        <select id="assignDate" class="filter-select" onchange="updateAssignmentStatus()">
                            <option value="">ë‚ ì§œ ì„ íƒ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì„¸ì…˜</label>
                        <select id="assignPart" class="filter-select" onchange="updateAssignmentStatus()">
                            <option value="">ì„¸ì…˜ ì„ íƒ</option>
                            <option value="1ë¶€">1ë¶€</option>
                            <option value="2ë¶€">2ë¶€</option>
                            <option value="3ë¶€">3ë¶€</option>
                        </select>
                    </div>
                </div>
                
                <!-- í˜„ì¬ ìƒíƒœ í‘œì‹œ -->
                <div id="assignmentStatusCard" style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="statusRealCount">0</div>
                            <div style="font-size: 11px; color: var(--text-muted);">ì‹¤ì œ ì˜ˆì•½</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: var(--purple);" id="statusVirtualCount">0</div>
                            <div style="font-size: 11px; color: var(--text-muted);">ê°€ìƒì°¸ì—¬ì</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: var(--primary);" id="statusTotalCount">0</div>
                            <div style="font-size: 11px; color: var(--text-muted);">ì´ ì¸ì›</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: var(--warning);" id="statusVirtualRatio">0%</div>
                            <div style="font-size: 11px; color: var(--text-muted);">ê°€ìƒ ë¹„ìœ¨</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: var(--info);" id="statusPendingCount">0</div>
                            <div style="font-size: 11px; color: var(--text-muted);">ì •ë³´í™•ì¸ì¤‘</div>
                        </div>
                    </div>
                    <div style="background: var(--card-bg); padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                            <i class="fas fa-lightbulb" style="color: var(--warning);"></i> ê¶Œì¥ ë¹„ìœ¨ ê°€ì´ë“œ (íŒŒí‹°ê¹Œì§€ <span id="daysUntilParty">?</span>ì¼)
                        </div>
                        <div id="recommendedRatioGuide" style="font-size: 13px;">-</div>
                    </div>
                </div>
                
                <!-- ë°°ì • ì»¨íŠ¸ë¡¤ -->
                <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>ë‚¨ì ë°°ì •</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="assignMaleCount" value="5" min="0" max="30" style="width: 70px;">
                            <span>ëª…</span>
                            <button class="btn btn-primary btn-sm" onclick="assignVirtualsToParty('ë‚¨ì')">
                                <i class="fas fa-user-plus"></i> ë°°ì •
                            </button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>ì—¬ì ë°°ì •</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="assignFemaleCount" value="5" min="0" max="30" style="width: 70px;">
                            <span>ëª…</span>
                            <button class="btn btn-primary btn-sm" onclick="assignVirtualsToParty('ì—¬ì')">
                                <i class="fas fa-user-plus"></i> ë°°ì •
                            </button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0; margin-left: auto;">
                        <button class="btn btn-info btn-sm" onclick="revealAllPending()">
                            <i class="fas fa-eye"></i> ì „ì²´ ê³µê°œ
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="clearPartyAssignments()">
                            <i class="fas fa-trash"></i> ì „ì²´ ì‚­ì œ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ë°°ì •ëœ ê°€ìƒì°¸ì—¬ì ëª©ë¡ -->
            <div class="section-header">
                <h2>ğŸ“‹ ë°°ì •ëœ ê°€ìƒì°¸ì—¬ì <span id="assignedCount" style="font-size: 14px; color: var(--text-muted);">(0ëª…)</span></h2>
            </div>
            <div class="toolbar">
                <select class="filter-select" id="assignedDateFilter" onchange="renderAssignments()">
                    <option value="">ì „ì²´ ë‚ ì§œ</option>
                </select>
                <select class="filter-select" id="assignedPartFilter" onchange="renderAssignments()">
                    <option value="">ì „ì²´ ì„¸ì…˜</option>
                    <option value="1ë¶€">1ë¶€</option>
                    <option value="2ë¶€">2ë¶€</option>
                    <option value="3ë¶€">3ë¶€</option>
                </select>
                <select class="filter-select" id="assignedGenderFilter" onchange="renderAssignments()">
                    <option value="">ì „ì²´ ì„±ë³„</option>
                    <option value="ë‚¨ì">ë‚¨ì</option>
                    <option value="ì—¬ì">ì—¬ì</option>
                </select>
                <select class="filter-select" id="assignedRevealFilter" onchange="renderAssignments()">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="revealed">ì§ì—… ê³µê°œë¨</option>
                    <option value="pending">ì •ë³´í™•ì¸ì¤‘</option>
                </select>
            </div>
            <div class="table-container" style="margin-bottom: 32px;">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortAssignedTable('scheduleDate')">ë‚ ì§œ <span id="assignSort_scheduleDate"></span></th>
                                <th class="sortable" onclick="sortAssignedTable('schedulePart')">ì„¸ì…˜ <span id="assignSort_schedulePart"></span></th>
                                <th class="sortable" onclick="sortAssignedTable('gender')">ì„±ë³„ <span id="assignSort_gender"></span></th>
                                <th class="sortable" onclick="sortAssignedTable('birthYear')">ë‚˜ì´ <span id="assignSort_birthYear"></span></th>
                                <th class="sortable" onclick="sortAssignedTable('height')">í‚¤ <span id="assignSort_height"></span></th>
                                <th class="sortable" onclick="sortAssignedTable('job')">ì§ì—… <span id="assignSort_job"></span></th>
                                <th class="sortable" onclick="sortAssignedTable('tier')">í‹°ì–´ <span id="assignSort_tier"></span></th>
                                <th class="sortable" onclick="sortAssignedTable('isRevealed')">ìƒíƒœ <span id="assignSort_isRevealed"></span></th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="assignedVirtualBody">
                            <tr><td colspan="9"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ê°€ìƒì°¸ì—¬ì í’€ ëª©ë¡ -->
            <div class="section-header">
                <h2>ğŸ“‹ ê°€ìƒì°¸ì—¬ì í’€ ëª©ë¡ <span id="poolListCount" style="font-size: 14px; color: var(--text-muted);">(0ëª…)</span></h2>
            </div>
            <div class="toolbar">
                <select class="filter-select" id="poolGenderFilter" onchange="renderVirtualPool()">
                    <option value="">ì „ì²´ ì„±ë³„</option>
                    <option value="ë‚¨ì">ë‚¨ì</option>
                    <option value="ì—¬ì">ì—¬ì</option>
                </select>
                <select class="filter-select" id="poolTierFilter" onchange="renderVirtualPool()">
                    <option value="">ì „ì²´ í‹°ì–´</option>
                    <option value="S">Sí‹°ì–´</option>
                    <option value="A">Aí‹°ì–´</option>
                    <option value="B">Bí‹°ì–´</option>
                </select>
                <select class="filter-select" id="poolJobFilter" onchange="renderVirtualPool()">
                    <option value="">ì „ì²´ ì§ì—…</option>
                </select>
                <button class="btn btn-sm btn-secondary" onclick="toggleSelectAllPool()">
                    <i class="fas fa-check-square"></i> ì „ì²´ì„ íƒ
                </button>
            </div>
            <div class="table-container" style="margin-bottom: 32px;">
                <div class="table-scroll" style="max-height: 800px; overflow-y: auto;">
                    <table>
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 1;">
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="poolSelectAll" onchange="toggleSelectAllPool()"></th>
                                <th class="sortable" onclick="sortPoolTable('name')">ì´ë¦„ <span id="poolSort_name"></span></th>
                                <th class="sortable" onclick="sortPoolTable('gender')">ì„±ë³„ <span id="poolSort_gender"></span></th>
                                <th class="sortable" onclick="sortPoolTable('birthYear')">ë‚˜ì´ <span id="poolSort_birthYear"></span></th>
                                <th class="sortable" onclick="sortPoolTable('height')">í‚¤ <span id="poolSort_height"></span></th>
                                <th class="sortable" onclick="sortPoolTable('job')">ì§ì—… <span id="poolSort_job"></span></th>
                                <th class="sortable" onclick="sortPoolTable('tier')">í‹°ì–´ <span id="poolSort_tier"></span></th>
                                <th class="sortable" onclick="sortPoolTable('usageCount')">ì‚¬ìš©íšŸìˆ˜ <span id="poolSort_usageCount"></span></th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="virtualPoolBody">
                            <tr><td colspan="9"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ìƒì„± ê·œì¹™ í…Œì´ë¸” (ë¹„ìœ¨í‘œ) -->
            <div class="section-header">
                <h2>âš™ï¸ ê°€ìƒì°¸ì—¬ì ìƒì„± ê·œì¹™ (ë¹„ìœ¨í‘œ)</h2>
                <button class="btn btn-primary" onclick="openAddVirtualRuleModal()">
                    <i class="fas fa-plus"></i> ê·œì¹™ ì¶”ê°€
                </button>
            </div>
            <div class="toolbar">
                <select class="filter-select" id="ruleGenderFilter">
                    <option value="">ì „ì²´ ì„±ë³„</option>
                    <option value="ë‚¨ì">ë‚¨ì</option>
                    <option value="ì—¬ì">ì—¬ì</option>
                </select>
            </div>
            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortVirtualRule('gender')">ì„±ë³„ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortVirtualRule('job')">ì§ì—… <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortVirtualRule('tier')">í‹°ì–´ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortVirtualRule('ratio')">ë¹„ìœ¨ <i class="fas fa-sort"></i></th>
                                <th>ì¶œìƒì—°ë„ ë²”ìœ„</th>
                                <th>í‚¤ ë²”ìœ„</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="virtualRuleBody">
                            <tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ==================== íŒŒí‹°ì¼ì • íƒ­ ==================== -->
        <div class="tab-content" id="tab-schedules">
            <div class="section-header">
                <h2>ğŸ“… íŒŒí‹° ì¼ì • ê´€ë¦¬</h2>
                <button class="btn btn-primary" onclick="openScheduleModal()">
                    <i class="fas fa-plus"></i> ì¼ì • ì¶”ê°€
                </button>
            </div>
            
            <!-- ì„¸ì…˜ í…œí”Œë¦¿ ê´€ë¦¬ -->
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h4 style="margin: 0;">â° ì„¸ì…˜ í…œí”Œë¦¿</h4>
                    <button class="btn btn-sm btn-secondary" onclick="openSessionModal()">
                        <i class="fas fa-plus"></i> ì„¸ì…˜ ì¶”ê°€
                    </button>
                </div>
                <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 12px;">
                    ì„¸ì…˜ë³„ ì‹œê°„/íƒ€ì…ì„ ì„¤ì •í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ë³€ê²½í•˜ë©´ ëª¨ë“  ì¼ì •ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.
                </p>
                <div class="table-container" style="max-height: 200px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ì„¸ì…˜ëª…</th>
                                <th>ì‹œê°„</th>
                                <th>íƒ€ì…</th>
                                <th>ë‚˜ì´ì¡°ê±´</th>
                                <th>ìˆœì„œ</th>
                                <th>ìƒíƒœ</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="sessionTemplateBody">
                            <tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- íŒŒí‹° ìœ í˜• ê´€ë¦¬ -->
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h4 style="margin: 0;">ğŸ‰ íŒŒí‹° ìœ í˜• ê´€ë¦¬</h4>
                    <button class="btn btn-sm btn-secondary" onclick="openPartyTypeModal()">
                        <i class="fas fa-plus"></i> ìœ í˜• ì¶”ê°€
                    </button>
                </div>
                <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 12px;">
                    íŒŒí‹° ìœ í˜•ë³„ ì •ì›ê³¼ ìµœì†Œ ê³µì„ì„ ì„¤ì •í•©ë‹ˆë‹¤. ì„¸ì…˜ í…œí”Œë¦¿ì—ì„œ ìœ í˜•ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="table-container" style="max-height: 200px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ì•„ì´ì½˜</th>
                                <th>ìœ í˜•ëª…</th>
                                <th>ë‚¨ì ì •ì›</th>
                                <th>ì—¬ì ì •ì›</th>
                                <th>ìµœì†Œ ê³µì„</th>
                                <th>ìƒíƒœ</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="partyTypeBody">
                            <tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ì¼ì • ìë™ ìƒì„± ì„¹ì…˜ -->
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <h4 style="margin-bottom: 16px;">ğŸ—“ï¸ ì¼ì • ìë™ ìƒì„±</h4>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 16px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px;">ì•ìœ¼ë¡œ</label>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <input type="number" id="quickMonths" value="3" min="1" max="12" style="width: 60px;" class="form-control">
                            <span>ê°œì›”</span>
                            <button class="btn btn-secondary" onclick="generateSchedulesQuick()">
                                <i class="fas fa-bolt"></i> ìƒì„±
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="border-top: 1px solid var(--border); padding-top: 16px; margin-top: 8px;">
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">ë˜ëŠ” ë²”ìœ„ ì§€ì •:</p>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">ì‹œì‘</label>
                            <div style="display: flex; gap: 4px;">
                                <select id="scheduleGenStartYear" class="filter-select" style="width: 90px;">
                                    <option value="2026">2026ë…„</option>
                                    <option value="2027">2027ë…„</option>
                                </select>
                                <select id="scheduleGenStartMonth" class="filter-select" style="width: 70px;">
                                    <option value="1">1ì›”</option><option value="2">2ì›”</option><option value="3">3ì›”</option>
                                    <option value="4">4ì›”</option><option value="5">5ì›”</option><option value="6">6ì›”</option>
                                    <option value="7">7ì›”</option><option value="8">8ì›”</option><option value="9">9ì›”</option>
                                    <option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option>
                                </select>
                            </div>
                        </div>
                        <span style="padding-bottom: 8px;">~</span>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">ì¢…ë£Œ</label>
                            <div style="display: flex; gap: 4px;">
                                <select id="scheduleGenEndYear" class="filter-select" style="width: 90px;">
                                    <option value="2026">2026ë…„</option>
                                    <option value="2027">2027ë…„</option>
                                </select>
                                <select id="scheduleGenEndMonth" class="filter-select" style="width: 70px;">
                                    <option value="1">1ì›”</option><option value="2">2ì›”</option><option value="3">3ì›”</option>
                                    <option value="4">4ì›”</option><option value="5">5ì›”</option><option value="6">6ì›”</option>
                                    <option value="7">7ì›”</option><option value="8">8ì›”</option><option value="9">9ì›”</option>
                                    <option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="generateSchedulesRange()">
                            <i class="fas fa-calendar-plus"></i> ë²”ìœ„ ì¼ì • ìƒì„±
                        </button>
                    </div>
                </div>
                
                <div style="border-top: 1px solid var(--border); padding-top: 16px; margin-top: 16px;">
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">âš™ï¸ ìƒì„± ì˜µì…˜:</p>
                    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                        <div>
                            <span style="font-size: 12px; color: var(--text-muted);">ìš”ì¼:</span>
                            <label style="margin-left: 8px;"><input type="checkbox" id="optMonday"> ì›”</label>
                            <label style="margin-left: 8px;"><input type="checkbox" id="optTuesday"> í™”</label>
                            <label style="margin-left: 8px;"><input type="checkbox" id="optWednesday"> ìˆ˜</label>
                            <label style="margin-left: 8px;"><input type="checkbox" id="optThursday"> ëª©</label>
                            <label style="margin-left: 8px;"><input type="checkbox" id="optFriday"> ê¸ˆ</label>
                            <label style="margin-left: 8px;"><input type="checkbox" id="optSaturday" checked> í† </label>
                            <label style="margin-left: 8px;"><input type="checkbox" id="optSunday" checked> ì¼</label>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <span style="font-size: 12px; color: var(--text-muted);">ì„¸ì…˜:</span>
                        <span id="sessionCheckboxes"><!-- ë™ì  ìƒì„± --></span>
                    </div>
                </div>
            </div>
            
            <div class="toolbar">
                <select class="filter-select" id="scheduleMonthFilter" onchange="renderSchedules()">
                    <option value="">ì „ì²´ ì›”</option>
                </select>
                <select class="filter-select" id="scheduleActiveFilter" onchange="renderSchedules()">
                    <option value="active">í™œì„± ì¼ì •ë§Œ</option>
                    <option value="">ì „ì²´</option>
                    <option value="inactive">ë¹„í™œì„±ë§Œ</option>
                </select>
            </div>
            
            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortSchedules('date')">ë‚ ì§œ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortSchedules('dayOfWeek')">ìš”ì¼ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortSchedules('partyType')">ìœ í˜• <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortSchedules('part')">ì„¸ì…˜ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortSchedules('time')">ì‹œê°„ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortSchedules('isActive')">ìƒíƒœ <i class="fas fa-sort"></i></th>
                                <th>ë©”ëª¨</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            <tr><td colspan="8"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ==================== ì§ì—…í‹°ì–´í‘œ íƒ­ ==================== -->
        <div class="tab-content" id="tab-tiers">
            <div class="section-header">
                <h2>ğŸ† ì§ì—… í‹°ì–´í‘œ</h2>
                <button class="btn btn-primary" onclick="openAddTierModal()">
                    <i class="fas fa-plus"></i> ì¶”ê°€
                </button>
            </div>
            
            <div class="toolbar">
                <select class="filter-select" id="tierGenderFilter">
                    <option value="">ì „ì²´ ì„±ë³„</option>
                    <option value="ë‚¨ì">ë‚¨ì</option>
                    <option value="ì—¬ì">ì—¬ì</option>
                </select>
                <select class="filter-select" id="tierFilter">
                    <option value="">ì „ì²´ í‹°ì–´</option>
                    <option value="S">Sí‹°ì–´</option>
                    <option value="A">Aí‹°ì–´</option>
                    <option value="B">Bí‹°ì–´</option>
                    <option value="C">Cí‹°ì–´</option>
                </select>
            </div>
            
            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTiers('gender')">ì„±ë³„ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTiers('job')">ì§ì—… <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTiers('tier')">í‹°ì–´ <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTiers('hasRule')">ìƒì„±ê·œì¹™ <i class="fas fa-sort"></i></th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="tierBody">
                            <tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ==================== ì„¤ì • íƒ­ ==================== -->
        <div class="tab-content" id="tab-settings">
            <!-- ë°ì´í„° ê´€ë¦¬ -->
            <div class="section-header">
                <h2>âš™ï¸ ë°ì´í„° ê´€ë¦¬</h2>
            </div>
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <h4 style="margin-bottom: 8px;">ğŸ“¦ ë°±ì—…ì—ì„œ ë³µêµ¬</h4>
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                        ë°°í¬ í›„ ë°ì´í„°ê°€ ì‚¬ë¼ì¡Œì„ ë•Œ, ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë°±ì—…ì—ì„œ ë³µêµ¬í•©ë‹ˆë‹¤.
                    </p>
                    <button class="btn btn-primary" onclick="restoreFromBackup()">
                        <i class="fas fa-undo"></i> ë°ì´í„° ë³µêµ¬
                    </button>
                    <span id="restoreStatus" style="margin-left: 12px; font-size: 13px;"></span>
                </div>
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                    <h4 style="margin-bottom: 8px;">ğŸ“‹ ì§ì—…í‹°ì–´ / ê°€ìƒì°¸ì—¬ì ê¸°ë³¸ ë°ì´í„°</h4>
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                        ì§ì—…í‹°ì–´í‘œì™€ ê°€ìƒì°¸ì—¬ì ìƒì„± ê·œì¹™ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (ê¸´ í˜•íƒœ ì§ì—…ëª… ì‚¬ìš©)
                    </p>
                    <button class="btn btn-primary" onclick="initializeUnifiedJobData()">
                        <i class="fas fa-sync"></i> ê¸°ë³¸ ë°ì´í„° ì´ˆê¸°í™” (í†µì¼ëœ í˜•íƒœ)
                    </button>
                    <span id="initStatus" style="margin-left: 12px; font-size: 13px;"></span>
                </div>
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                    <h4 style="margin-bottom: 8px;">ğŸ§ª í…ŒìŠ¤íŠ¸ ë°ì´í„°</h4>
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                        í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                    </p>
                    <button class="btn btn-secondary" onclick="createTestData()">
                        <i class="fas fa-database"></i> í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
                    </button>
                    <button class="btn btn-secondary" onclick="deleteTestData()" style="margin-left: 8px;">
                        <i class="fas fa-trash"></i> í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>
    
    <!-- ê°€ìƒì°¸ì—¬ì ìƒì„± ê·œì¹™ ëª¨ë‹¬ -->
    <div class="modal" id="virtualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="virtualModalTitle">ìƒì„± ê·œì¹™ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeModal('virtualModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="virtualRuleId">
                <div class="form-row">
                    <div class="form-group">
                        <label>ì„±ë³„</label>
                        <select id="virtualGender">
                            <option value="ë‚¨ì">ë‚¨ì</option>
                            <option value="ì—¬ì">ì—¬ì</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì§ì—…</label>
                        <input type="text" id="virtualJob" placeholder="ì˜ˆ: ëŒ€ê¸°ì—…">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë¹„ìœ¨ (%)</label>
                        <input type="number" id="virtualRatio" placeholder="ì˜ˆ: 20" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>ìµœì†Œ ì¶œìƒì—°ë„</label>
                        <input type="number" id="virtualMinYear" placeholder="ì˜ˆ: 1990">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ìµœëŒ€ ì¶œìƒì—°ë„</label>
                        <input type="number" id="virtualMaxYear" placeholder="ì˜ˆ: 2000">
                    </div>
                    <div class="form-group">
                        <label>ìµœì†Œ í‚¤ (cm)</label>
                        <input type="number" id="virtualMinHeight" placeholder="ì˜ˆ: 165">
                    </div>
                </div>
                <div class="form-group">
                    <label>ìµœëŒ€ í‚¤ (cm)</label>
                    <input type="number" id="virtualMaxHeight" placeholder="ì˜ˆ: 180">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('virtualModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveVirtualRule()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- í‹°ì–´ ëª¨ë‹¬ -->
    <div class="modal" id="tierModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="tierModalTitle">ì§ì—… ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeModal('tierModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="tierRuleId">
                <div class="form-group">
                    <label>ì„±ë³„</label>
                    <select id="tierGender" class="form-control">
                        <option value="ë‚¨ì">ë‚¨ì</option>
                        <option value="ì—¬ì">ì—¬ì</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì§ì—…ëª… <span style="font-size: 11px; color: var(--text-muted);">(ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥)</span></label>
                    <input type="text" id="tierJob" class="form-control" list="tierJobList" placeholder="ì˜ˆ: ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)">
                    <datalist id="tierJobList">
                        <option value="ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)">
                        <option value="ì „ë¬¸ì§(ì´ê³¼ê³„ì—´ - ì˜ì‚¬,ì•½ì‚¬,í•œì˜ì‚¬ ë“±)">
                        <option value="ê¸ˆìœµê¶Œ">
                        <option value="ëŒ€ê¸°ì—…">
                        <option value="ì™¸êµ­ê³„">
                        <option value="ê³µê¸°ì—…">
                        <option value="IT/ê°œë°œì">
                        <option value="ì—°êµ¬ì§">
                        <option value="íšŒì‚¬ì›">
                        <option value="ê³µë¬´ì›">
                        <option value="ìì˜ì—…/ì‚¬ì—…ê°€">
                        <option value="êµìœ¡ì§">
                        <option value="í”„ë¦¬ëœì„œ">
                        <option value="í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)">
                        <option value="í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)">
                        <option value="ë””ìì´ë„ˆ">
                        <option value="ê°„í˜¸ì‚¬">
                        <option value="ì„œë¹„ìŠ¤/í˜¸í…”">
                        <option value="ì˜ë£Œì§">
                        <option value="ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´">
                        <option value="ì‚¬ë¬´ì§">
                        <option value="ê¸°íƒ€">
                    </datalist>
                </div>
                <div class="form-group">
                    <label>í‹°ì–´</label>
                    <select id="tierLevel" class="form-control">
                        <option value="S">Sí‹°ì–´ (ìµœìƒìœ„)</option>
                        <option value="A">Aí‹°ì–´ (ìƒìœ„)</option>
                        <option value="B" selected>Bí‹°ì–´ (ì¼ë°˜)</option>
                    </select>
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                    ğŸ’¡ ì§ì—…ì„ ì¶”ê°€í•˜ë©´ <strong>ìƒì„± ê·œì¹™</strong>ì— ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. (ë¹„ìœ¨ 0%, ì¡°ê±´ ë¯¸ì„¤ì •)
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('tierModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveTierAndSync()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- íŒŒí‹° ì¼ì • ëª¨ë‹¬ -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="scheduleModalTitle">ì¼ì • ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="scheduleId">
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="scheduleDate" class="form-control">
                </div>
                <div class="form-group">
                    <label>íŒŒí‹° ìœ í˜•</label>
                    <select id="schedulePartyType" class="form-control" onchange="updateScheduleCapacityHint()">
                        <option value="coffee">â˜• ì»¤í”¼íŒŒí‹° (ë‚¨12/ì—¬12)</option>
                        <option value="wine">ğŸ· ì™€ì¸íŒŒí‹° (ë‚¨24/ì—¬24)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì •ì› ì˜¤ë²„ë¼ì´ë“œ (ë¹„ì›Œë‘ë©´ íŒŒí‹°ìœ í˜• ê¸°ë³¸ê°’ ì‚¬ìš©)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="font-size: 12px;">ë‚¨:</span>
                        <input type="number" id="scheduleMaleCapacity" placeholder="12" min="1" max="50" class="form-control" style="width: 70px;">
                        <span style="font-size: 12px;">ì—¬:</span>
                        <input type="number" id="scheduleFemaleCapacity" placeholder="12" min="1" max="50" class="form-control" style="width: 70px;">
                    </div>
                    <p style="font-size: 11px; color: var(--text-muted); margin-top: 4px;" id="scheduleCapacityHint">
                        íŒŒí‹°ìœ í˜• ê¸°ë³¸ê°’: ë‚¨12/ì—¬12
                    </p>
                </div>
                <div class="form-group">
                    <label>ì„¸ì…˜</label>
                    <select id="schedulePart">
                        <!-- ë™ì  ìƒì„± -->
                    </select>
                </div>
                <div class="form-group">
                    <label>ë©”ëª¨ (ì„ íƒ)</label>
                    <input type="text" id="scheduleMemo" placeholder="íŠ¹ì´ì‚¬í•­ ë“±">
                </div>
                <div class="form-group">
                    <label>ë‚˜ì´ì¡°ê±´ ì˜¤ë²„ë¼ì´ë“œ (ë¹„ì›Œë‘ë©´ ì„¸ì…˜ ê¸°ë³¸ê°’ ì‚¬ìš©)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="scheduleMinBirthYear" placeholder="ì˜ˆ: 1990" min="1950" max="2010" class="form-control" style="width: 100px;">
                        <span>~</span>
                        <input type="number" id="scheduleMaxBirthYear" placeholder="ì˜ˆ: 2002" min="1950" max="2010" class="form-control" style="width: 100px;">
                        <span style="font-size: 12px; color: var(--text-muted);">ë…„ìƒ</span>
                    </div>
                    <p style="font-size: 11px; color: var(--text-muted); margin-top: 4px;" id="scheduleAgeHint">
                        ì„¸ì…˜ ê¸°ë³¸ê°’: -
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('scheduleModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveSchedule()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- ì„¸ì…˜ í…œí”Œë¦¿ ëª¨ë‹¬ -->
    <div class="modal" id="sessionModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="sessionModalTitle">ì„¸ì…˜ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeModal('sessionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="sessionId">
                <div class="form-group">
                    <label>ì„¸ì…˜ëª…</label>
                    <input type="text" id="sessionName" placeholder="ì˜ˆ: 1ë¶€, 2ë¶€, íŠ¹ë³„ì„¸ì…˜" class="form-control">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹œì‘ ì‹œê°„</label>
                        <input type="time" id="sessionTime" class="form-control" value="12:00">
                    </div>
                    <div class="form-group">
                        <label>íŒŒí‹° ìœ í˜•</label>
                        <select id="sessionType" class="form-control">
                            <!-- ë™ì ìœ¼ë¡œ party_typesì—ì„œ ë¡œë“œ -->
                        </select>
                    </div>
                </div>
                <div id="sessionTypeInfo" style="background: var(--bg); padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; font-size: 12px; color: var(--text-muted);">
                    ì •ì›: - / ìµœì†Œê³µì„: -
                </div>
                <div class="form-group">
                    <label>ë‚˜ì´ì¡°ê±´ (ì¶œìƒì—°ë„)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="sessionMinBirthYear" placeholder="1990" min="1950" max="2010" class="form-control" style="width: 80px;">
                        <span>~</span>
                        <input type="number" id="sessionMaxBirthYear" placeholder="2002" min="1950" max="2010" class="form-control" style="width: 80px;">
                        <span style="font-size: 12px; color: var(--text-muted);">ë…„ìƒ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>ì •ë ¬ ìˆœì„œ</label>
                    <input type="number" id="sessionOrder" value="1" min="1" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('sessionModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveSession()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- íŒŒí‹° ìœ í˜• ëª¨ë‹¬ -->
    <div class="modal" id="partyTypeModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="partyTypeModalTitle">íŒŒí‹° ìœ í˜• ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeModal('partyTypeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="partyTypeId">
                <div class="form-row">
                    <div class="form-group" style="flex: 0 0 80px;">
                        <label>ì•„ì´ì½˜</label>
                        <select id="partyTypeIcon" class="form-control">
                            <option value="â˜•">â˜• ì»¤í”¼</option>
                            <option value="ğŸ·">ğŸ· ì™€ì¸</option>
                            <option value="ğŸ¶">ğŸ¶ ì†Œì£¼</option>
                            <option value="ğŸº">ğŸº ë§¥ì£¼</option>
                            <option value="ğŸ¸">ğŸ¸ ì¹µí…Œì¼</option>
                            <option value="ğŸ§ƒ">ğŸ§ƒ ìŒë£Œ</option>
                            <option value="ğŸ‰">ğŸ‰ íŒŒí‹°</option>
                            <option value="âœ¨">âœ¨ ìŠ¤í˜ì…œ</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>ìœ í˜•ëª…</label>
                        <input type="text" id="partyTypeName" placeholder="ì˜ˆ: ì»¤í”¼íŒŒí‹°, ì™€ì¸íŒŒí‹°" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë‚¨ì ì •ì›</label>
                        <input type="number" id="partyTypeMaleCapacity" value="12" min="1" max="100" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>ì—¬ì ì •ì›</label>
                        <input type="number" id="partyTypeFemaleCapacity" value="12" min="1" max="100" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>ìµœì†Œ ê³µì„ (ì„±ë³„ë‹¹)</label>
                    <input type="number" id="partyTypeMinVacancy" value="2" min="1" max="10" class="form-control">
                    <p style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        ê°€ìƒì°¸ì—¬ìê°€ ì´ ìë¦¬ë¥¼ ë„˜ê¸°ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì‹¤ì œ ì˜ˆì•½ìš© ì—¬ìœ ë¶„)
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('partyTypeModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="savePartyType()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- ê°€ìƒì°¸ì—¬ì í’€ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="poolEditModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>ê°€ìƒì°¸ì—¬ì ìˆ˜ì •</h3>
                <button class="modal-close" onclick="closeModal('poolEditModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="poolEditId">
                <div class="form-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="poolEditName" placeholder="ê°€ìƒì°¸ì—¬ì ì´ë¦„" class="form-control">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì„±ë³„</label>
                        <select id="poolEditGender" class="form-control">
                            <option value="ë‚¨ì">ë‚¨ì</option>
                            <option value="ì—¬ì">ì—¬ì</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì¶œìƒì—°ë„</label>
                        <input type="number" id="poolEditBirthYear" placeholder="1995" min="1950" max="2010" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>í‚¤ (cm)</label>
                        <input type="number" id="poolEditHeight" placeholder="170" min="140" max="200" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>í‹°ì–´</label>
                        <select id="poolEditTier" class="form-control">
                            <option value="S">S</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>ì§ì—… <span style="font-size: 11px; color: var(--text-muted);">(ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥)</span></label>
                    <input type="text" id="poolEditJob" class="form-control" list="jobList" placeholder="ì§ì—…ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”">
                    <datalist id="jobList">
                        <option value="ëŒ€ê¸°ì—…">
                        <option value="íšŒì‚¬ì›">
                        <option value="ê¸ˆìœµê¶Œ">
                        <option value="ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)">
                        <option value="ì „ë¬¸ì§(ì´ê³¼ê³„ì—´ - ì˜ì‚¬,ì•½ì‚¬,í•œì˜ì‚¬ ë“±)">
                        <option value="IT/ê°œë°œì">
                        <option value="ê³µê¸°ì—…">
                        <option value="ì™¸êµ­ê³„">
                        <option value="ì—°êµ¬ì§">
                        <option value="ê³µë¬´ì›">
                        <option value="ìì˜ì—…/ì‚¬ì—…ê°€">
                        <option value="í”„ë¦¬ëœì„œ">
                        <option value="ë””ìì´ë„ˆ">
                        <option value="ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´">
                        <option value="êµìœ¡ì§">
                        <option value="ê°„í˜¸ì‚¬">
                        <option value="ì˜ë£Œì§">
                        <option value="í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)">
                        <option value="í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)">
                        <option value="ì„œë¹„ìŠ¤/í˜¸í…”">
                        <option value="ì˜ˆì²´ëŠ¥">
                        <option value="ëŒ€í•™ì›ìƒ">
                        <option value="ì‚¬ë¬´ì§">
                        <option value="ê¸°íƒ€">
                    </datalist>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('poolEditModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="savePoolEdit()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- ê°€ìƒì°¸ì—¬ì êµì²´ ëª¨ë‹¬ -->
    <div class="modal" id="replaceModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ğŸ”„ ê°€ìƒì°¸ì—¬ì êµì²´</h3>
                <button class="modal-close" onclick="closeModal('replaceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="replaceAssignmentId">
                
                <!-- í˜„ì¬ ë°°ì •ëœ ì‚¬ëŒ ì •ë³´ -->
                <div class="card" style="margin-bottom: 16px; padding: 12px; background: var(--bg);">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">í˜„ì¬ ë°°ì •ëœ ì‚¬ëŒ</div>
                    <div id="currentAssignmentInfo" style="font-weight: 500;">-</div>
                </div>
                
                <!-- í•„í„° -->
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <select id="replaceFilterTier" class="filter-select" onchange="filterReplaceCandidates()">
                        <option value="">ì „ì²´ í‹°ì–´</option>
                        <option value="S">Sí‹°ì–´</option>
                        <option value="A">Aí‹°ì–´</option>
                        <option value="B">Bí‹°ì–´</option>
                    </select>
                    <select id="replaceFilterJob" class="filter-select" onchange="filterReplaceCandidates()">
                        <option value="">ì „ì²´ ì§ì—…</option>
                    </select>
                    <span id="replaceCandidateCount" style="color: var(--text-muted); align-self: center;">0ëª…</span>
                </div>
                
                <!-- í›„ë³´ ëª©ë¡ -->
                <div style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ë‚˜ì´</th>
                                <th>í‚¤</th>
                                <th>ì§ì—…</th>
                                <th>í‹°ì–´</th>
                                <th>ì„ íƒ</th>
                            </tr>
                        </thead>
                        <tbody id="replaceCandidateBody">
                            <tr><td colspan="6" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('replaceModal')">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ë¼ì¸ì—… ê°€ìƒì°¸ì—¬ì ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="lineupEditModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>ğŸ”§ ê°€ìƒì°¸ì—¬ì ì •ë³´ ìˆ˜ì •</h3>
                <button class="modal-close" onclick="closeModal('lineupEditModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="lineupEditId">
                <input type="hidden" id="lineupEditVirtualId">
                <input type="hidden" id="lineupEditGender">
                
                <div style="display: grid; gap: 16px;">
                    <div class="form-group">
                        <label>ì¶œìƒì—°ë„</label>
                        <input type="number" id="lineupEditBirthYear" class="form-control" min="1980" max="2006" placeholder="ì˜ˆ: 1996">
                        <small style="color: var(--text-muted);">í˜„ì¬ ë‚˜ì´: <span id="lineupEditAge">-</span>ì„¸</small>
                    </div>
                    
                    <div class="form-group">
                        <label>í‚¤ (cm)</label>
                        <input type="number" id="lineupEditHeight" class="form-control" min="140" max="200" placeholder="ì˜ˆ: 170">
                    </div>
                    
                    <div class="form-group">
                        <label>ì§ì—…</label>
                        <input type="text" id="lineupEditJob" class="form-control" placeholder="ì§ì—… ì…ë ¥" list="jobSuggestions">
                        <datalist id="jobSuggestions">
                            <option value="ëŒ€ê¸°ì—…">
                            <option value="ê³µê¸°ì—…">
                            <option value="ê¸ˆìœµê¶Œ">
                            <option value="ì „ë¬¸ì§">
                            <option value="ê³µë¬´ì›">
                            <option value="ìŠ¤íƒ€íŠ¸ì—…">
                            <option value="íšŒì‚¬ì›">
                            <option value="ìì˜ì—…">
                            <option value="í”„ë¦¬ëœì„œ">
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label>í‹°ì–´ <span style="color: var(--primary);">(ìë™ ê³„ì‚°)</span></label>
                        <div id="lineupEditTierDisplay" style="padding: 12px; background: var(--bg); border-radius: 8px; text-align: center;">
                            <span class="tier tier-S" style="font-size: 18px;">S</span>
                        </div>
                        <small style="color: var(--text-muted);">ì§ì—… ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ í‹°ì–´ê°€ ê³„ì‚°ë©ë‹ˆë‹¤</small>
                    </div>

                    <div class="form-group">
                        <label>ê³µê°œ ìƒíƒœ</label>
                        <div id="lineupEditVisibilityStatus" style="display: flex; gap: 8px; align-items: center;">
                            <input type="hidden" id="lineupEditIsRevealed" value="false">
                            <button type="button" id="lineupEditRevealBtn" class="btn btn-warning" onclick="toggleLineupEditVisibility(true)" style="flex: 1;">
                                <i class="fas fa-eye"></i> ê³µê°œ
                            </button>
                            <button type="button" id="lineupEditHideBtn" class="btn btn-secondary" onclick="toggleLineupEditVisibility(false)" style="flex: 1;">
                                <i class="fas fa-eye-slash"></i> ë¹„ê³µê°œ
                            </button>
                        </div>
                        <small style="color: var(--text-muted);">ë¹„ê³µê°œ ì‹œ "ì •ë³´í™•ì¸ì¤‘"ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('lineupEditModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveLineupEdit()">
                    <i class="fas fa-save"></i> ì €ì¥
                </button>
            </div>
        </div>
    </div>
    
    <!-- ê³ ê° ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ê³ ê° ìƒì„¸</h3>
                <button class="modal-close" onclick="closeModal('customerModal')">&times;</button>
            </div>
            <div class="modal-body" id="customerModalBody">
            </div>
        </div>
    </div>
    
    <!-- ê³ ê° ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="customerFormModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="customerFormTitle">ê³ ê° ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeModal('customerFormModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="customerForm" onsubmit="saveCustomer(event)">
                    <input type="hidden" id="cf_editPhone">
                    
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì—°ë½ì²˜ *</label>
                            <input type="text" id="cf_phone" placeholder="010-0000-0000" required 
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì´ë¦„ (ì‹¤ëª…)</label>
                                <input type="text" id="cf_name" placeholder="í™ê¸¸ë™"
                                       style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ë‹‰ë„¤ì„ (í”„ë¦½)</label>
                                <input type="text" id="cf_nickname" placeholder="ê¸¸ë™ì´"
                                       style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì„±ë³„</label>
                                <select id="cf_gender" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                    <option value="">ì„ íƒ</option>
                                    <option value="ë‚¨ì">ë‚¨ì</option>
                                    <option value="ì—¬ì">ì—¬ì</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì¶œìƒì—°ë„</label>
                                <input type="number" id="cf_birthYear" placeholder="1995" min="1950" max="2010"
                                       style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">í‚¤ (cm)</label>
                                <input type="number" id="cf_height" placeholder="170" min="140" max="210"
                                       style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì§ì—… ë¶„ë¥˜</label>
                                <select id="cf_jobCategory" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                    <option value="">ì„ íƒ</option>
                                    <option value="ëŒ€ê¸°ì—…">ëŒ€ê¸°ì—…</option>
                                    <option value="íšŒì‚¬ì›">íšŒì‚¬ì›</option>
                                    <option value="ì™¸êµ­ê³„">ì™¸êµ­ê³„</option>
                                    <option value="ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´)">ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)</option>
                                    <option value="ì „ë¬¸ì§(ì´ê³¼ê³„ì—´)">ì „ë¬¸ì§(ì´ê³¼ê³„ì—´ - ì˜ì‚¬,ì•½ì‚¬,í•œì˜ì‚¬ ë“±)</option>
                                    <option value="ì—°ì˜ˆì¸/ì¸í”Œë£¨ì–¸ì„œ">ì—°ì˜ˆì¸/ì¸í”Œë£¨ì–¸ì„œ</option>
                                    <option value="í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)">í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)</option>
                                    <option value="ê³µê¸°ì—…">ê³µê¸°ì—…</option>
                                    <option value="ê³µë¬´ì›">ê³µë¬´ì›</option>
                                    <option value="ì˜ˆì²´ëŠ¥">ì˜ˆì²´ëŠ¥</option>
                                    <option value="ê¸ˆìœµê¶Œ">ê¸ˆìœµê¶Œ</option>
                                    <option value="êµìœ¡ì§">êµìœ¡ì§</option>
                                    <option value="ì—°êµ¬ì§">ì—°êµ¬ì§</option>
                                    <option value="IT/ê°œë°œì">IT/ê°œë°œì</option>
                                    <option value="ë””ìì´ë„ˆ">ë””ìì´ë„ˆ</option>
                                    <option value="ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´">ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´</option>
                                    <option value="ê°„í˜¸ì‚¬">ê°„í˜¸ì‚¬</option>
                                    <option value="í”„ë¦¬ëœì„œ">í”„ë¦¬ëœì„œ</option>
                                    <option value="ìì˜ì—…/ì‚¬ì—…ê°€">ìì˜ì—…/ì‚¬ì—…ê°€</option>
                                    <option value="ëŒ€í•™ì›ìƒ">ëŒ€í•™ì›ìƒ</option>
                                    <option value="ì˜ë£Œì§">ì˜ë£Œì§</option>
                                    <option value="í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)">í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)</option>
                                    <option value="ì„œë¹„ìŠ¤/í˜¸í…”">ì„œë¹„ìŠ¤/í˜¸í…”</option>
                                    <option value="ì‚¬ë¬´ì§">ì‚¬ë¬´ì§</option>
                                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì§ì—… ìƒì„¸</label>
                                <input type="text" id="cf_jobDetail" placeholder="ì‚¼ì„±ì „ì, ë³€í˜¸ì‚¬ ë“±"
                                       style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ìœ ì… ê²½ë¡œ</label>
                            <select id="cf_source" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                <option value="organic">ì¼ë°˜</option>
                                <option value="invitation">ì´ˆëŒ€ì¥</option>
                                <option value="direct">ì§ì ‘ ì¶”ê°€</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ë©”ëª¨</label>
                            <textarea id="cf_memo" placeholder="íŠ¹ì´ì‚¬í•­, ë©”ëª¨ ë“±" rows="3"
                                      style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); resize: vertical;"></textarea>
                        </div>

                        <!-- ì˜ˆì•½ í•¨ê»˜ ìƒì„± ì˜µì…˜ -->
                        <div style="padding: 16px; background: rgba(99, 102, 241, 0.1); border: 1px solid var(--primary); border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="cf_createReservation" onchange="toggleReservationFields()">
                                <span style="font-weight: 600; color: var(--primary);">ğŸ“… ì˜ˆì•½ë„ í•¨ê»˜ ìƒì„± (ì˜ˆì•½ í˜„í™©ì— í‘œì‹œë¨)</span>
                            </label>
                            <div id="cf_reservationFields" style="display: none; margin-top: 12px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">íŒŒí‹° ë‚ ì§œ</label>
                                        <select id="cf_resDate" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">íŒŒíŠ¸</label>
                                        <select id="cf_resPart" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                            <option value="1ë¶€">1ë¶€</option>
                                            <option value="2ë¶€">2ë¶€</option>
                                            <option value="3ë¶€">3ë¶€</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-top: 12px;">
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">ê²°ì œ ìœ í˜•</label>
                                    <select id="cf_resPaymentType" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                        <option value="waived">ğŸ« ë©´ì œ (ì§ì ‘ ë“±ë¡)</option>
                                        <option value="cash">ğŸ’µ í˜„ê¸ˆ</option>
                                        <option value="comp">ğŸ ë³´ìƒ</option>
                                        <option value="frip">ğŸ…¿ï¸ í”„ë¦½</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('customerFormModal')">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ì˜ˆì•½ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="reservationModal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3 id="reservationModalTitle">ì˜ˆì•½ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeModal('reservationModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reservationForm" onsubmit="saveReservation(event)">
                    <input type="hidden" id="rf_editId">

                    <div style="display: grid; gap: 16px;">
                        <!-- ì—°ë½ì²˜ -->
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì—°ë½ì²˜ *</label>
                            <input type="text" id="rf_phone" placeholder="010-0000-0000" required
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                        </div>

                        <!-- í¬ë£¨ëª… -->
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">í¬ë£¨ëª… (ë‹‰ë„¤ì„) *</label>
                            <input type="text" id="rf_crewName" placeholder="í”„ë¦½ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì´ë¦„" required
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                        </div>

                        <!-- ì§„í–‰ì¼ì‹œ -->
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì§„í–‰ì¼ì‹œ *</label>
                            <select id="rf_eventDate" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                <option value="">ë‚ ì§œ/ì„¸ì…˜ ì„ íƒ</option>
                            </select>
                        </div>

                        <!-- ì˜µì…˜ & ìœ í˜• -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì„¸ì…˜</label>
                                <select id="rf_eventPart" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                    <option value="1ë¶€">1ë¶€ â˜•</option>
                                    <option value="2ë¶€">2ë¶€ â˜•</option>
                                    <option value="3ë¶€">3ë¶€ ğŸ·</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ìœ í˜•</label>
                                <select id="rf_isInvitation" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                    <option value="false">ì¼ë°˜</option>
                                    <option value="true">ğŸ« ì¸ë¹„í…Œì´ì…˜</option>
                                </select>
                            </div>
                        </div>

                        <!-- ì˜µì…˜ ìƒì„¸ -->
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ì˜µì…˜ ìƒì„¸</label>
                            <input type="text" id="rf_option" placeholder="[3ë¶€ ì™€ì¸] ì¸ë¹„í…Œì´ì…˜ íŒ¨ìŠ¤ ì†Œì§€ì"
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                        </div>

                        <!-- ìƒíƒœ & ê²°ì œìœ í˜• -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ìƒíƒœ</label>
                                <select id="rf_status" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                                    <option value="ì˜ˆì•½ì™„ë£Œ">ì˜ˆì•½ì™„ë£Œ</option>
                                    <option value="ì·¨ì†Œ">ì·¨ì†Œ</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ê²°ì œ ìœ í˜•</label>
                                <select id="rf_paymentType" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);" onchange="togglePaymentNote()">
                                    <option value="frip">ğŸ…¿ï¸ í”„ë¦½ ê²°ì œ</option>
                                    <option value="cash">ğŸ’µ í˜„ê¸ˆ/ê³„ì¢Œì´ì²´</option>
                                    <option value="waived">ğŸ« ê²°ì œ ë©´ì œ (VIP/ì´ˆì²­)</option>
                                    <option value="comp">ğŸ ë³´ìƒ ë¬´ë£Œ</option>
                                </select>
                            </div>
                        </div>

                        <!-- ê²°ì œ ì‚¬ìœ  (ë©´ì œ/ë³´ìƒ ì„ íƒ ì‹œ í‘œì‹œ) -->
                        <div id="paymentNoteWrapper" style="display: none;">
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--text-muted);">ê²°ì œ ë©´ì œ/ë³´ìƒ ì‚¬ìœ </label>
                            <input type="text" id="rf_paymentNote" placeholder="ì˜ˆ: VIP ì´ˆì²­, 12ì›” íŒŒí‹° ë³´ìƒ ë“±"
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                        </div>
                    </div>

                    <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('reservationModal')">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <script>
        // ========================================
        // Supabase ì„¤ì •
        // ========================================
        const SUPABASE_URL = 'https://bqpxdxsgxoapguknxwul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcHhkeHNneG9hcGd1a254d3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjUyNDAsImV4cCI6MjA4MzEwMTI0MH0.v_r3wIIIe024k-H-9dyHH-LJj73kP9iU_eYgHZX7CGA';
        
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const API_BASE = `${SUPABASE_URL}/rest/v1`;
        const PASSWORD = 'svvys2025';  // ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ë„ ìœ ì§€ (2ë‹¨ê³„ ì¸ì¦)
        
        // í˜„ì¬ ì„¸ì…˜ì˜ ì•¡ì„¸ìŠ¤ í† í° (ë¡œê·¸ì¸ í›„ ì„¤ì •ë¨)
        let currentAccessToken = SUPABASE_ANON_KEY;
        
        // Supabase API í—¤ë” (ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨)
        function getSupabaseHeaders() {
            return {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${currentAccessToken}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            };
        }
        
        // ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ìš©
        const SUPABASE_HEADERS = {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };
        
        // ìµœì†Œ í‘œì‹œ ë‚ ì§œ (ì´ ë‚ ì§œ ì´ì „ì€ ìˆ¨ê¹€)
        const MIN_PARTY_DATE = '2026-01-11';  // ì²« íŒŒí‹° ë‚ ì§œ
        
        // ========================================
        // í…Œì´ë¸”ëª… (Supabase - ì •ìƒ í…Œì´ë¸”ëª… ì‚¬ìš©)
        // ========================================
        const TB = {
            CUSTOMERS: 'customers',
            VIRTUAL_POOL: 'virtual_pool',
            VIRTUAL_ASSIGN: 'party_virtual_assignments',
            PUBLIC_LINEUP: 'public_lineup',
            INVITATIONS: 'invitations',
            RESERVATIONS: 'reservations',
            SURVEYS: 'surveys',
            COUPONS: 'coupons',
            VIRTUAL_RULES: 'virtual_participants',
            JOB_TIERS: 'job_tiers',
            PARTY_SCHEDULES: 'party_schedules',
            SESSION_TEMPLATES: 'session_templates',
            PARTY_TYPES: 'party_types',
            ATTENDANCE: 'attendance'
        };
        
        // ========================================
        // ì „ì—­ ë‚ ì§œ ì •ê·œí™” í•¨ìˆ˜ (ëª¨ë“  ë‚ ì§œ ë¹„êµì— ì‚¬ìš©)
        // ========================================
        // "2026ë…„ 1ì›” 11ì¼", "2026ë…„  1ì›”  11ì¼", "2026ë…„ 01ì›” 11ì¼", 
        // "2026-01-11", "2026-01-11T03:00:00.000Z" ë“±ì„ 
        // ëª¨ë‘ "2026ë…„ 1ì›” 11ì¼" í˜•ì‹ìœ¼ë¡œ í†µì¼
        function normalizeDateStr(d) {
            if (!d) return '';
            // í•œê¸€ í˜•ì‹: "2026ë…„ 1ì›” 11ì¼"
            const korMatch = d.match(/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
            if (korMatch) return `${korMatch[1]}ë…„ ${parseInt(korMatch[2])}ì›” ${parseInt(korMatch[3])}ì¼`;
            // ISO í˜•ì‹: "2026-01-11T03:00:00.000Z" ë˜ëŠ” "2026-01-11"
            const isoMatch = d.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (isoMatch) return `${isoMatch[1]}ë…„ ${parseInt(isoMatch[2])}ì›” ${parseInt(isoMatch[3])}ì¼`;
            return d;
        }
        
        // ë‘ ë‚ ì§œê°€ ê°™ì€ì§€ ë¹„êµ (ì •ê·œí™” í›„ ë¹„êµ)
        function isSameDate(date1, date2) {
            return normalizeDateStr(date1) === normalizeDateStr(date2);
        }
        
        // ========================================
        // ë‚˜ì´ëŒ€ ë³€í™˜ í•¨ìˆ˜ (ê³µê°œìš©)
        // ========================================
        function getAgeRange(birthYear) {
            if (!birthYear) return '-';
            const currentYear = new Date().getFullYear();
            const age = currentYear - birthYear;
            
            if (age >= 20 && age <= 24) return '20ëŒ€ ì´ˆë°˜';
            if (age >= 25 && age <= 27) return '20ëŒ€ ì¤‘ë°˜';
            if (age >= 28 && age <= 29) return '20ëŒ€ í›„ë°˜';
            if (age >= 30 && age <= 34) return '30ëŒ€ ì´ˆë°˜';
            if (age >= 35 && age <= 37) return '30ëŒ€ ì¤‘ë°˜';
            if (age >= 38 && age <= 39) return '30ëŒ€ í›„ë°˜';
            if (age >= 40 && age <= 44) return '40ëŒ€ ì´ˆë°˜';
            if (age >= 45 && age <= 47) return '40ëŒ€ ì¤‘ë°˜';
            if (age >= 48 && age <= 49) return '40ëŒ€ í›„ë°˜';
            if (age >= 50) return '50ëŒ€';
            return '20ëŒ€';
        }
        
        // ë°ì´í„° ì €ì¥ì†Œ
        const data = {
            customers: [],
            invitations: [],
            reservations: [],
            surveys: [],
            coupons: [],
            virtual: [],           // ê°€ìƒì°¸ì—¬ì ìƒì„± ê·œì¹™ (ë¹„ìœ¨í‘œ)
            tiers: [],             // ì§ì—… í‹°ì–´í‘œ
            generatedVirtuals: [], // ìƒì„±ëœ ê°€ìƒì°¸ì—¬ì
            schedules: [],         // íŒŒí‹° ì¼ì •
            sessions: [],          // ì„¸ì…˜ í…œí”Œë¦¿
            partyTypes: [],        // íŒŒí‹° ìœ í˜• (ì»¤í”¼, ì™€ì¸, ì†Œì£¼ ë“±)
            virtualPool: [],       // ê°€ìƒì°¸ì—¬ì í’€ (500ëª…)
            virtualAssignments: [], // íŒŒí‹°ë³„ ê°€ìƒì°¸ì—¬ì ë°°ì •
            publicLineup: [],      // ê³µê°œìš© ë¼ì¸ì—… (ë¯¼ê°ì •ë³´ ì—†ìŒ)
            integratedCustomers: []
        };
        
        // ========================================
        // ì´ˆê¸°í™”
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Supabase ì„¸ì…˜ ë³µì› ì‹œë„
            const sessionRestored = await restoreSession();
            
            if (sessionRestored) {
                document.getElementById('loginScreen').classList.add('hidden');
                initTabs();
                refreshAllData();
            }
        });
        
        // ========================================
        // Supabase ì¸ì¦ ë¡œê·¸ì¸
        // ========================================
        async function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                document.getElementById('loginError').textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
                document.getElementById('loginError').classList.add('show');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    document.getElementById('loginError').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message;
                    document.getElementById('loginError').classList.add('show');
                    document.getElementById('passwordInput').value = '';
                    return;
                }
                
                // ë¡œê·¸ì¸ ì„±ê³µ - ì•¡ì„¸ìŠ¤ í† í° ì €ì¥
                currentAccessToken = data.session.access_token;
                
                // SUPABASE_HEADERS ì—…ë°ì´íŠ¸
                SUPABASE_HEADERS['Authorization'] = `Bearer ${currentAccessToken}`;
                
                sessionStorage.setItem('adminLoggedIn', 'true');
                sessionStorage.setItem('supabaseToken', currentAccessToken);
                
                document.getElementById('loginScreen').classList.add('hidden');
                initTabs();
                refreshAllData();
                
            } catch (err) {
                document.getElementById('loginError').textContent = 'ì˜¤ë¥˜: ' + err.message;
                document.getElementById('loginError').classList.add('show');
            }
        }
        
        // ì„¸ì…˜ ë³µì› (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ)
        async function restoreSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentAccessToken = session.access_token;
                SUPABASE_HEADERS['Authorization'] = `Bearer ${currentAccessToken}`;
                return true;
            }
            return false;
        }
        
        // ========================================
        // íƒ­ ê´€ë¦¬
        // ========================================
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                });
            });
        }
        
        // ========================================
        // Supabase ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // ========================================
        
        // snake_case â†’ camelCase ë³€í™˜
        function convertToCamelCase(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            const newObj = {};
            for (const key in obj) {
                const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
                newObj[camelKey] = obj[key];
            }
            return newObj;
        }
        
        // camelCase â†’ snake_case ë³€í™˜ (ì €ì¥ìš©)
        function convertToSnakeCase(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            const newObj = {};
            for (const key in obj) {
                const snakeKey = key.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
                newObj[snakeKey] = obj[key];
            }
            return newObj;
        }
        
        // Supabase API í˜¸ì¶œ í—¬í¼
        async function supabaseSelect(table, query = '') {
            const url = `${API_BASE}/${table}?select=*${query ? '&' + query : ''}`;
            const res = await fetch(url, { headers: SUPABASE_HEADERS });
            if (!res.ok) throw new Error(`Select failed: ${res.status}`);
            return (await res.json()).map(convertToCamelCase);
        }
        
        async function supabaseInsert(table, data) {
            const snakeData = convertToSnakeCase(data);
            const res = await fetch(`${API_BASE}/${table}`, {
                method: 'POST',
                headers: SUPABASE_HEADERS,
                body: JSON.stringify(snakeData)
            });
            if (!res.ok) throw new Error(`Insert failed: ${res.status}`);
            const result = await res.json();
            return Array.isArray(result) ? result.map(convertToCamelCase) : convertToCamelCase(result);
        }
        
        async function supabaseUpdate(table, id, data) {
            const snakeData = convertToSnakeCase(data);
            delete snakeData.id;  // PKëŠ” PATCHì—ì„œ ë³€ê²½ ë¶ˆê°€
            const res = await fetch(`${API_BASE}/${table}?id=eq.${encodeURIComponent(id)}`, {
                method: 'PATCH',
                headers: SUPABASE_HEADERS,
                body: JSON.stringify(snakeData)
            });
            if (!res.ok) throw new Error(`Update failed: ${res.status}`);
            const result = await res.json();
            return Array.isArray(result) ? result.map(convertToCamelCase) : convertToCamelCase(result);
        }
        
        async function supabaseDelete(table, id) {
            const res = await fetch(`${API_BASE}/${table}?id=eq.${encodeURIComponent(id)}`, {
                method: 'DELETE',
                headers: SUPABASE_HEADERS
            });
            if (!res.ok) throw new Error(`Delete failed: ${res.status}`);
            return true;
        }
        
        // ========================================
        // ì„¤ë¬¸ â†’ ê³ ê° ìë™ ë™ê¸°í™”
        // ========================================
        async function syncSurveyToCustomers() {
            // ì„¤ë¬¸ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°, í•´ë‹¹ ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸
            const updatePromises = [];

            for (const survey of data.surveys) {
                const phone = survey.phone ? normalizePhone(survey.phone) : null;
                if (!phone) continue;

                // ì´ë¯¸ ê³ ê° í…Œì´ë¸”ì— ìˆëŠ”ì§€ í™•ì¸
                const existingCustomer = data.customers.find(c => c.id === phone);

                // ì„¤ë¬¸ì—ì„œ ê°€ì ¸ì˜¬ ë°ì´í„° (nullì´ ì•„ë‹Œ ê°’ë§Œ)
                const surveyData = {
                    name: survey.name || null,
                    gender: survey.gender || null,
                    birth_year: survey.birthYear || null,
                    height: survey.height || null,
                    job_category: survey.jobCategory || null,
                    job_detail: survey.jobDetail || null
                };

                // null ê°’ ì œê±°
                Object.keys(surveyData).forEach(key => {
                    if (surveyData[key] === null || surveyData[key] === undefined || surveyData[key] === '') {
                        delete surveyData[key];
                    }
                });

                // ì—…ë°ì´íŠ¸í•  ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                if (Object.keys(surveyData).length === 0) continue;

                if (existingCustomer) {
                    // ê¸°ì¡´ ê³ ê°ì˜ ë¹ˆ í•„ë“œë§Œ ì„¤ë¬¸ ë°ì´í„°ë¡œ ì±„ì›€
                    const fieldsToUpdate = {};
                    if (!existingCustomer.name && surveyData.name) fieldsToUpdate.name = surveyData.name;
                    if (!existingCustomer.gender && surveyData.gender) fieldsToUpdate.gender = surveyData.gender;
                    if (!existingCustomer.birthYear && surveyData.birth_year) fieldsToUpdate.birth_year = surveyData.birth_year;
                    if (!existingCustomer.height && surveyData.height) fieldsToUpdate.height = surveyData.height;
                    if (!existingCustomer.jobCategory && surveyData.job_category) fieldsToUpdate.job_category = surveyData.job_category;
                    if (!existingCustomer.jobDetail && surveyData.job_detail) fieldsToUpdate.job_detail = surveyData.job_detail;

                    if (Object.keys(fieldsToUpdate).length > 0) {
                        updatePromises.push(
                            fetch(`${API_BASE}/${TB.CUSTOMERS}?id=eq.${encodeURIComponent(phone)}`, {
                                method: 'PATCH',
                                headers: SUPABASE_HEADERS,
                                body: JSON.stringify(fieldsToUpdate)
                            }).catch(e => console.warn('ì„¤ë¬¸â†’ê³ ê° ë™ê¸°í™” ì‹¤íŒ¨:', phone, e))
                        );
                    }
                } else {
                    // ê³ ê°ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„± (ì˜ˆì•½ì€ ìˆëŠ”ë° ê³ ê° ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°)
                    const hasReservation = data.reservations.some(r => normalizePhone(r.phone) === phone);
                    if (hasReservation) {
                        const newCustomer = {
                            id: phone,
                            source: 'survey',
                            ...surveyData
                        };
                        updatePromises.push(
                            fetch(`${API_BASE}/${TB.CUSTOMERS}`, {
                                method: 'POST',
                                headers: SUPABASE_HEADERS,
                                body: JSON.stringify(newCustomer)
                            }).catch(e => console.warn('ì„¤ë¬¸â†’ê³ ê° ìƒì„± ì‹¤íŒ¨:', phone, e))
                        );
                    }
                }
            }

            // ë™ì‹œì— ìµœëŒ€ 10ê°œì”© ì²˜ë¦¬
            if (updatePromises.length > 0) {
                await Promise.all(updatePromises);
                // ë¡œì»¬ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ (UI ë°˜ì˜ìš©)
                const customersRes = await fetch(`${API_BASE}/${TB.CUSTOMERS}?select=*`, { headers: SUPABASE_HEADERS });
                if (customersRes.ok) {
                    data.customers = (await customersRes.json()).map(convertToCamelCase);
                }
            }
        }

        // ========================================
        // ë°ì´í„° ë¡œë”© (Supabase)
        // ========================================
        async function refreshAllData() {
            showToast('ë°ì´í„° ë¡œë”© ì¤‘...', 'info');
            
            try {
                // Supabaseìš© ì•ˆì „í•œ fetch í•¨ìˆ˜
                const safeFetch = async (tableName) => {
                    try {
                        const res = await fetch(`${API_BASE}/${tableName}?select=*`, {
                            headers: SUPABASE_HEADERS
                        });
                        if (!res.ok) {
                            console.warn(`API ì‹¤íŒ¨ (${tableName}):`, res.status);
                            return [];
                        }
                        return await res.json();
                    } catch (e) {
                        console.warn(`API í˜¸ì¶œ ì‹¤íŒ¨: ${tableName}`, e);
                        return [];
                    }
                };
                
                // ëª¨ë“  í…Œì´ë¸” ë°ì´í„° ë¡œë“œ (SupabaseëŠ” ë°°ì—´ ì§ì ‘ ë°˜í™˜)
                const [customersData, invitationsData, reservationsData, surveysData, couponsData, virtualData, tiersData, schedulesData, sessionsData, partyTypesData, poolData, assignmentsData, publicLineupData] = await Promise.all([
                    safeFetch(TB.CUSTOMERS),
                    safeFetch(TB.INVITATIONS),
                    safeFetch(TB.RESERVATIONS),
                    safeFetch(TB.SURVEYS),
                    safeFetch(TB.COUPONS),
                    safeFetch(TB.VIRTUAL_RULES),
                    safeFetch(TB.JOB_TIERS),
                    safeFetch(TB.PARTY_SCHEDULES),
                    safeFetch(TB.SESSION_TEMPLATES),
                    safeFetch(TB.PARTY_TYPES),
                    safeFetch(TB.VIRTUAL_POOL),
                    safeFetch(TB.VIRTUAL_ASSIGN),
                    safeFetch(TB.PUBLIC_LINEUP)
                ]);
                
                // SupabaseëŠ” ë°°ì—´ì„ ì§ì ‘ ë°˜í™˜í•˜ë¯€ë¡œ .data ë¶ˆí•„ìš”
                data.customers = customersData || [];
                data.invitations = invitationsData || [];
                data.reservations = reservationsData || [];
                data.surveys = surveysData || [];
                data.coupons = couponsData || [];
                data.virtual = virtualData || [];
                data.tiers = tiersData || [];
                data.generatedVirtuals = [];  // ë” ì´ìƒ ì‚¬ìš© ì•ˆí•¨
                data.schedules = schedulesData || [];
                data.sessions = sessionsData || [];
                data.partyTypes = partyTypesData || [];
                data.virtualPool = poolData || [];
                data.virtualAssignments = assignmentsData || [];
                data.publicLineup = publicLineupData || [];
                
                // Supabase ì»¬ëŸ¼ëª… ë³€í™˜ (snake_case â†’ camelCase)
                data.customers = data.customers.map(convertToCamelCase);
                data.invitations = data.invitations.map(convertToCamelCase);
                data.reservations = data.reservations.map(convertToCamelCase);
                data.surveys = data.surveys.map(convertToCamelCase);
                data.schedules = data.schedules.map(convertToCamelCase);
                data.sessions = data.sessions.map(convertToCamelCase);
                data.partyTypes = data.partyTypes.map(convertToCamelCase);
                data.virtual = data.virtual.map(convertToCamelCase);
                data.tiers = data.tiers.map(convertToCamelCase);
                data.virtualPool = data.virtualPool.map(convertToCamelCase);
                data.virtualAssignments = data.virtualAssignments.map(convertToCamelCase);
                data.publicLineup = data.publicLineup.map(convertToCamelCase);

                // ì„¤ë¬¸ ë°ì´í„° â†’ ê³ ê° í…Œì´ë¸” ìë™ ë™ê¸°í™”
                await syncSurveyToCustomers();

                // í†µí•© ê³ ê° ë°ì´í„° ìƒì„± (1ì˜ˆì•½ = 1í–‰)
                data.integratedCustomers = buildIntegratedCustomers();
                
                // UI ì—…ë°ì´íŠ¸ (ê°œë³„ í•¨ìˆ˜ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
                const safeCall = (fn) => { try { fn(); } catch(e) { console.warn('UI í•¨ìˆ˜ ì˜¤ë¥˜:', e); } };
                
                safeCall(updateDateFilter);
                safeCall(updateVirtualDateFilters);
                safeCall(updateLineupDateFilter);
                safeCall(updateScheduleMonthFilter);
                safeCall(updateAssignDateFilter);
                safeCall(updatePoolStats);
                safeCall(renderDashboard);
                safeCall(renderCustomers);
                safeCall(renderInvitations);
                safeCall(renderReservations);
                safeCall(renderVirtualRules);
                safeCall(renderGeneratedVirtuals);
                safeCall(renderTiers);
                safeCall(renderSchedules);
                safeCall(renderSessions);
                safeCall(renderPartyTypes);
                safeCall(renderLineup);
                safeCall(renderAssignments);
                safeCall(renderVirtualPool);
                safeCall(updatePublicLineupDateFilter);
                safeCall(refreshPublicLineupList);
                
                // ì§ì—…í‹°ì–´/ê°€ìƒì°¸ì—¬ì/íŒŒí‹°ì¼ì •/ì„¸ì…˜í…œí”Œë¦¿ ë°ì´í„° ë¹„ì–´ìˆìœ¼ë©´ ìë™ ì´ˆê¸°í™”
                if (data.tiers.length === 0 || data.virtual.length === 0 || data.schedules.length === 0 || data.sessions.length === 0) {
                    showToast('ğŸ“‹ ê¸°ë³¸ ë°ì´í„° ìë™ ì´ˆê¸°í™” ì¤‘...', 'info', 5000);
                    await autoInitializeDefaultData();
                } else {
                    showToast('ë°ì´í„° ë¡œë”© ì™„ë£Œ!', 'success');
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                showToast('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨', 'error');
            }
        }
        
        // í†µí•© ê³ ê° ë°ì´í„° ìƒì„± (customers + invitations + reservations JOIN)
        function buildIntegratedCustomers() {
            const result = [];
            const processedPhones = new Set();
            
            // ê³ ê° ë§µ ìƒì„± (normalizedPhone -> customer)
            const customerMap = {};
            data.customers.forEach(c => {
                const normalizedId = normalizePhone(c.id);
                customerMap[normalizedId] = c;
            });

            // ì´ˆëŒ€ì¥ ë§µ ìƒì„± (normalizedPhone -> invitation)
            const invitationMap = {};
            data.invitations.forEach(inv => {
                const normalizedPhone = normalizePhone(inv.phone);
                invitationMap[normalizedPhone] = inv;
            });

            // ì‚¬ì „ì¡°ì‚¬ ë§µ ìƒì„± (normalizedPhone -> survey)
            const surveyMap = {};
            data.surveys.forEach(s => {
                const normalizedPhone = normalizePhone(s.phone);
                surveyMap[normalizedPhone] = s;
            });

            // ì˜ˆì•½ ë§µ ìƒì„± (normalizedPhone -> reservations[])
            const reservationMap = {};
            data.reservations.forEach(res => {
                const normalizedPhone = normalizePhone(res.phone);
                if (!reservationMap[normalizedPhone]) {
                    reservationMap[normalizedPhone] = [];
                }
                reservationMap[normalizedPhone].push(res);
            });
            
            // 1. ì˜ˆì•½ì´ ìˆëŠ” ê³ ê° (1ëª… = 1í–‰)
            data.reservations.forEach(res => {
                const phone = res.phone;
                const normalizedPhone = normalizePhone(phone); // ì •ê·œí™”ëœ ì „í™”ë²ˆí˜¸ë¡œ ì¤‘ë³µ ì²´í¬
                if (processedPhones.has(normalizedPhone)) return;
                processedPhones.add(normalizedPhone);
                
                const customer = customerMap[normalizedPhone] || {};
                const inv = invitationMap[normalizedPhone] || {};
                const survey = surveyMap[normalizedPhone];
                const reservations = reservationMap[normalizedPhone] || [];
                const hasSurvey = survey || (customer.gender && (customer.birth_year || customer.birthYear));

                // í™œì„± ì˜ˆì•½ (ì·¨ì†Œ ì œì™¸)
                const activeReservations = reservations.filter(r => r.status !== 'ì·¨ì†Œ');
                // ëª¨ë“  ì˜ˆì•½ì´ ì·¨ì†Œëœ ê²½ìš°
                const allCancelled = reservations.length > 0 && activeReservations.length === 0;
                
                // ì¸ì¦ë‹¨ê³„ ê²°ì •: 1.ì´ˆëŒ€ì¥ì‹ ì²­, 2.í”„ë¦½ì˜ˆì•½, 3.ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ, 4.ì°¸ì—¬ì™„ë£Œ, 5.í–‰ì‚¬ë¶ˆì°¸, 6.ì˜ˆì•½ì·¨ì†Œ
                let stage = '2.í”„ë¦½ì˜ˆì•½';
                if (allCancelled) stage = '6.ì˜ˆì•½ì·¨ì†Œ';
                else if (hasSurvey) stage = '3.ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ';
                
                // ì°¸ì—¬ì™„ë£Œ/ë¶ˆì°¸ ì²´í¬ (í™œì„± ì˜ˆì•½ë§Œ)
                const hasAttended = activeReservations.some(r => r.attended == true || r.attended === 1);
                const hasNoShow = activeReservations.some(r => (r.attended === false || r.attended === 0) && (r.noShow == true || r.noShow === 1));
                if (hasAttended) stage = '4.ì°¸ì—¬ì™„ë£Œ';
                if (hasNoShow) stage = '5.í–‰ì‚¬ë¶ˆì°¸';
                
                // ë‹‰ë„¤ì„ì€ ì˜ˆì•½ì˜ crewNameì—ì„œ ê°€ì ¸ì˜´ (í”„ë¦½ì—ì„œ ì˜¤ëŠ” ì´ë¦„)
                const nickname = reservations.length > 0 ? reservations[0].crewName : (customer.nickname || '');
                
                result.push({
                    ì¸ì¦ë‹¨ê³„: stage,
                    ìœ ì…ê²½ë¡œ: inv.phone ? 'invitation' : (customer.source || 'organic'),
                    í¬ë£¨ëª…: customer.name || survey?.name || '',
                    ë‹‰ë„¤ì„: nickname,
                    ì—°ë½ì²˜: phone,
                    ì„±ë³„: customer.gender || survey?.gender || '',
                    ì¶œìƒì—°ë„: customer.birth_year || customer.birthYear || survey?.birth_year || survey?.birthYear || '',
                    ì‹ ì¥: customer.height || survey?.height || '',
                    ì§ì—…ë¶„ë¥˜: customer.job_category || customer.jobCategory || survey?.job_category || survey?.jobCategory || '',
                    ì§ì—…ìƒì„¸: customer.job_detail || customer.jobDetail || survey?.job_detail || survey?.jobDetail || '',
                    ì„ íƒìê²©: inv.qualifications || '',
                    ì„ íƒê·¸ë£¹: inv.groups || '',
                    ì™€ì¸ë³´ë„ˆìŠ¤: inv.wineBonus ? 'Y' : 'N',
                    ì¸ì¦ë°©ë²•: inv.authType || '',
                    SNSë§í¬: inv.snsLink || '',
                    ì´ˆëŒ€ì¥íŒŒì¼ë§í¬: inv.fileLinks || '',
                    ì¿ í°ì½”ë“œ: inv.couponCode || '',
                    í˜¸ìŠ¤íŠ¸ëª…: inv.hostName || '',
                    ì¶”ì²œê²½ìœ„: inv.referralReason || '',
                    ë°°í¬ì²˜: inv.distributor || '',
                    ì§ì—…ì¸ì¦ì„œë¥˜: customer.jobCertFile || survey?.jobCertFile || '',
                    ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ: hasSurvey ? 'Y' : 'N',
                    ìŠ¹ì¸ìƒíƒœ: inv.approvalStatus || '',
                    ì˜ˆì•½ê±´ìˆ˜: reservations.length,
                    ì˜ˆì•½ëª©ë¡: reservations,
                    ë©”ëª¨: customer.memo || '',
                    ë¸”ë™ë¦¬ìŠ¤íŠ¸: customer.is_blacklisted || false,
                    ë¸”ë™ë¦¬ìŠ¤íŠ¸ì‚¬ìœ : customer.blacklist_reason || '',
                    _phone: phone
                });
            });

            // 2. ì˜ˆì•½ ì—†ì´ ì´ˆëŒ€ì¥ë§Œ ì‹ ì²­í•œ ê²½ìš°
            data.invitations.forEach(inv => {
                const phone = inv.phone;
                const normalizedPhone = normalizePhone(phone);
                if (processedPhones.has(normalizedPhone)) return;
                processedPhones.add(normalizedPhone);

                const customer = customerMap[normalizedPhone] || {};
                const survey = surveyMap[normalizedPhone];
                const hasSurvey = survey || (customer.gender && (customer.birth_year || customer.birthYear));

                result.push({
                    ì¸ì¦ë‹¨ê³„: '1.ì´ˆëŒ€ì¥ì‹ ì²­',
                    ìœ ì…ê²½ë¡œ: 'invitation',
                    í¬ë£¨ëª…: customer.name || survey?.name || '',
                    ë‹‰ë„¤ì„: customer.nickname || '',
                    ì—°ë½ì²˜: phone,
                    ì„±ë³„: customer.gender || survey?.gender || '',
                    ì¶œìƒì—°ë„: customer.birth_year || customer.birthYear || survey?.birth_year || survey?.birthYear || '',
                    ì‹ ì¥: customer.height || survey?.height || '',
                    ì§ì—…ë¶„ë¥˜: customer.job_category || customer.jobCategory || survey?.job_category || survey?.jobCategory || '',
                    ì§ì—…ìƒì„¸: customer.job_detail || customer.jobDetail || survey?.job_detail || survey?.jobDetail || '',
                    ì„ íƒìê²©: inv.qualifications || '',
                    ì„ íƒê·¸ë£¹: inv.groups || '',
                    ì™€ì¸ë³´ë„ˆìŠ¤: inv.wineBonus ? 'Y' : 'N',
                    ì¸ì¦ë°©ë²•: inv.authType || '',
                    SNSë§í¬: inv.snsLink || '',
                    ì´ˆëŒ€ì¥íŒŒì¼ë§í¬: inv.fileLinks || '',
                    ì¿ í°ì½”ë“œ: inv.couponCode || '',
                    í˜¸ìŠ¤íŠ¸ëª…: inv.hostName || '',
                    ì¶”ì²œê²½ìœ„: inv.referralReason || '',
                    ë°°í¬ì²˜: inv.distributor || '',
                    ì§ì—…ì¸ì¦ì„œë¥˜: customer.jobCertFile || survey?.jobCertFile || '',
                    ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ: hasSurvey ? 'Y' : 'N',
                    ìŠ¹ì¸ìƒíƒœ: inv.approvalStatus || '',
                    ì˜ˆì•½ê±´ìˆ˜: 0,
                    ì˜ˆì•½ëª©ë¡: [],
                    ë©”ëª¨: customer.memo || '',
                    ë¸”ë™ë¦¬ìŠ¤íŠ¸: customer.is_blacklisted || false,
                    ë¸”ë™ë¦¬ìŠ¤íŠ¸ì‚¬ìœ : customer.blacklist_reason || '',
                    _phone: phone
                });
            });

            // 3. customersì—ë§Œ ìˆê³  ì˜ˆì•½/ì´ˆëŒ€ì¥ ì—†ëŠ” ê²½ìš° (surveyë§Œ ì œì¶œí•œ ì¼ë°˜ê³ ê°)
            data.customers.forEach(c => {
                const phone = c.id;
                const normalizedPhone = normalizePhone(phone);
                if (processedPhones.has(normalizedPhone)) return;
                processedPhones.add(normalizedPhone);

                const survey = surveyMap[normalizedPhone];
                const hasSurvey = survey || (c.gender && (c.birth_year || c.birthYear));

                result.push({
                    ì¸ì¦ë‹¨ê³„: hasSurvey ? '3.ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ' : '0.ë¯¸ë¶„ë¥˜',
                    ìœ ì…ê²½ë¡œ: c.source || 'organic',
                    í¬ë£¨ëª…: c.name || survey?.name || '',
                    ë‹‰ë„¤ì„: c.nickname || '',
                    ì—°ë½ì²˜: phone,
                    ì„±ë³„: c.gender || survey?.gender || '',
                    ì¶œìƒì—°ë„: c.birth_year || c.birthYear || survey?.birth_year || survey?.birthYear || '',
                    ì‹ ì¥: c.height || survey?.height || '',
                    ì§ì—…ë¶„ë¥˜: c.job_category || c.jobCategory || survey?.job_category || survey?.jobCategory || '',
                    ì§ì—…ìƒì„¸: c.job_detail || c.jobDetail || survey?.job_detail || survey?.jobDetail || '',
                    ì„ íƒìê²©: '',
                    ì„ íƒê·¸ë£¹: '',
                    ì™€ì¸ë³´ë„ˆìŠ¤: 'N',
                    ì¸ì¦ë°©ë²•: '',
                    SNSë§í¬: '',
                    ì´ˆëŒ€ì¥íŒŒì¼ë§í¬: '',
                    ì¿ í°ì½”ë“œ: '',
                    í˜¸ìŠ¤íŠ¸ëª…: '',
                    ì¶”ì²œê²½ìœ„: '',
                    ë°°í¬ì²˜: '',
                    ì§ì—…ì¸ì¦ì„œë¥˜: c.jobCertFile || survey?.jobCertFile || '',
                    ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ: hasSurvey ? 'Y' : 'N',
                    ìŠ¹ì¸ìƒíƒœ: '',
                    ì˜ˆì•½ê±´ìˆ˜: 0,
                    ì˜ˆì•½ëª©ë¡: [],
                    ë©”ëª¨: c.memo || '',
                    ë¸”ë™ë¦¬ìŠ¤íŠ¸: c.is_blacklisted || false,
                    ë¸”ë™ë¦¬ìŠ¤íŠ¸ì‚¬ìœ : c.blacklist_reason || '',
                    _phone: phone
                });
            });

            return result;
        }
        
        async function fetchTable(tableName) {
            try {
                const response = await fetch(`${API_BASE}/${tableName}?limit=1000`);
                const result = await response.json();
                return result.data || [];
            } catch (error) {
                console.error(`${tableName} ë¡œë”© ì˜¤ë¥˜:`, error);
                return [];
            }
        }
        
        // ========================================
        // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
        // ========================================
        function renderDashboard() {
            const integrated = data.integratedCustomers;
            const confirmed = integrated.filter(c => c.í˜„ì¬ë‹¨ê³„ === '3.ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ').length;
            const needSurvey = integrated.filter(c => c.í˜„ì¬ë‹¨ê³„ === '2.í”„ë¦½ì˜ˆì•½').length;
            const waiting = integrated.filter(c => c.í˜„ì¬ë‹¨ê³„ === '1.ì´ˆëŒ€ì¥ì‹ ì²­').length;
            
            document.getElementById('stat-totalCustomers').textContent = data.customers.length;
            document.getElementById('stat-confirmed').textContent = confirmed;
            document.getElementById('stat-needSurvey').textContent = needSurvey;
            document.getElementById('stat-waiting').textContent = waiting;
            
            document.getElementById('customerBadge').textContent = integrated.length;
            
            renderUpcomingParties();
        }
        
        function renderUpcomingParties() {
            const container = document.getElementById('upcomingParties');
            const parties = groupByPartyFromReservations(data.reservations);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const minDate = new Date(2026, 0, 11);
            
            const upcomingKeys = Object.keys(parties)
                .filter(key => {
                    const partyDate = parsePartyDate(key.split('|')[0]);
                    return partyDate >= today && partyDate >= minDate;
                })
                .slice(0, 6);
            
            if (upcomingKeys.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><h3>ì˜ˆì •ëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤</h3></div>';
                return;
            }
            
            container.innerHTML = upcomingKeys.map(key => renderPartyCard(parties[key])).join('');
        }
        
        // ì˜ˆì•½ ë°ì´í„°ë¡œ íŒŒí‹° ê·¸ë£¹í™”
        function groupByPartyFromReservations(reservations) {
            const parties = {};
            const customerMap = {};
            data.customers.forEach(c => { customerMap[c.id] = c; });
            
            reservations.forEach(res => {
                if (res.status !== 'ì˜ˆì•½ì™„ë£Œ') return;
                
                // ì§„í–‰ì¼ì‹œì—ì„œ ë‚ ì§œ/ì‹œê°„ íŒŒì‹±
                const eventDate = res.eventDate || '';
                const dateMatch = eventDate.match(/(\d+)ì›”\s*(\d+)ì¼/);
                const timeMatch = eventDate.match(/(\d+):00/) || eventDate.match(/(\d+)ì‹œ/);
                
                if (!dateMatch) return;
                
                const month = parseInt(dateMatch[1]);
                const day = parseInt(dateMatch[2]);
                const hour = timeMatch ? parseInt(timeMatch[1]) : 12;
                
                // ë¶€ ê²°ì • (12ì‹œ=1ë¶€, 15ì‹œ=2ë¶€, 19ì‹œ=3ë¶€)
                let partyName = '1ë¶€ ì»¤í”¼';
                if (hour === 15 || hour === 3) partyName = '2ë¶€ ì»¤í”¼';
                else if (hour === 19 || hour === 7) partyName = '3ë¶€ ì™€ì¸';
                
                const date = new Date(2026, month - 1, day);
                const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
                const dateStr = `${month}/${day} ${days[date.getDay()]}`;
                
                const key = `${dateStr}|${partyName}`;
                
                if (!parties[key]) {
                    parties[key] = {
                        date: dateStr,
                        party: partyName,
                        time: hour + ':00',
                        male: { total: 5, filled: 0 },
                        female: { total: 5, filled: 0 }
                    };
                }
                
                // ê³ ê° ì •ë³´ì—ì„œ ì„±ë³„ ê°€ì ¸ì˜¤ê¸°
                const customer = customerMap[res.phone];
                const gender = customer?.gender;
                
                if (gender === 'ë‚¨ì') {
                    parties[key].male.filled++;
                } else if (gender === 'ì—¬ì') {
                    parties[key].female.filled++;
                }
            });
            
            return parties;
        }
        
        function groupByParty(lineupData) {
            const parties = {};
            
            lineupData.forEach(row => {
                let dateStr = row['ë‚ ì§œ'];
                
                if (dateStr instanceof Date) {
                    const m = dateStr.getMonth() + 1;
                    const d = dateStr.getDate();
                    const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
                    dateStr = `${m}/${d} ${days[dateStr.getDay()]}`;
                } else if (typeof dateStr === 'string' && dateStr.includes('T')) {
                    const date = new Date(dateStr);
                    const m = date.getMonth() + 1;
                    const d = date.getDate();
                    const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
                    dateStr = `${m}/${d} ${days[date.getDay()]}`;
                }
                
                const partyName = row['íŒŒí‹°'];
                const key = `${dateStr}|${partyName}`;
                
                if (!parties[key]) {
                    parties[key] = {
                        date: dateStr,
                        party: partyName,
                        time: row['ì‹œê°„'],
                        male: { total: 0, filled: 0 },
                        female: { total: 0, filled: 0 }
                    };
                }
                
                const genderKey = row['ì„±ë³„'] === 'ë‚¨ì' ? 'male' : 'female';
                parties[key][genderKey].total++;
                
                if (row['ìƒíƒœ'] === 'ì˜ˆì•½ì™„ë£Œ') {
                    parties[key][genderKey].filled++;
                }
            });
            
            return parties;
        }
        
        function parsePartyDate(dateStr) {
            if (!dateStr) return new Date();
            
            // ISO í˜•ì‹: "2026-01-11T03:00:00.000Z" ë˜ëŠ” "2026-01-11"
            const isoMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (isoMatch) {
                return new Date(parseInt(isoMatch[1]), parseInt(isoMatch[2]) - 1, parseInt(isoMatch[3]));
            }
            
            // "2026ë…„ 1ì›” 11ì¼ ì˜¤í›„ 12:00" í˜•ì‹
            const koreanMatch = dateStr.match(/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
            if (koreanMatch) {
                return new Date(parseInt(koreanMatch[1]), parseInt(koreanMatch[2]) - 1, parseInt(koreanMatch[3]));
            }
            
            // "1/11" í˜•ì‹ (ë ˆê±°ì‹œ)
            const slashMatch = dateStr.match(/(\d+)\/(\d+)/);
            if (slashMatch) {
                return new Date(2026, parseInt(slashMatch[1]) - 1, parseInt(slashMatch[2]));
            }
            
            return new Date();
        }
        
        function renderPartyCard(party) {
            const malePercent = party.male.total > 0 ? Math.round(party.male.filled / party.male.total * 100) : 0;
            const femalePercent = party.female.total > 0 ? Math.round(party.female.filled / party.female.total * 100) : 0;
            
            return `
                <div class="party-card">
                    <div class="party-card-header">
                        <h3>${party.date} ${party.party}</h3>
                        <span style="color: var(--text-muted); font-size: 13px;">${party.time || ''}</span>
                    </div>
                    <div class="party-card-body">
                        <div class="party-stat">
                            <span class="gender-male">ë‚¨ì</span>
                            <span>${party.male.filled}/${party.male.total} (${malePercent}%)</span>
                        </div>
                        <div class="party-stat">
                            <span class="gender-female">ì—¬ì</span>
                            <span>${party.female.filled}/${party.female.total} (${femalePercent}%)</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ========================================
        // ê³ ê° ê´€ë¦¬ ë Œë”ë§ (í†µí•©ë·° - 1ì˜ˆì•½=1í–‰)
        // ========================================
        function renderCustomers() {
            const tbody = document.getElementById('customersBody');
            const search = (document.getElementById('customerSearch')?.value || '').toLowerCase();
            const stageFilter = document.getElementById('customerStageFilter')?.value || '';
            const sourceFilter = document.getElementById('customerSourceFilter')?.value || '';
            const blacklistFilter = document.getElementById('customerBlacklistFilter')?.value || '';

            let filtered = data.integratedCustomers || [];

            // ê²€ìƒ‰ í•„í„°
            if (search) {
                filtered = filtered.filter(c =>
                    (c.í¬ë£¨ëª… || '').toLowerCase().includes(search) ||
                    (c.ì—°ë½ì²˜ || '').includes(search) ||
                    (c.ì§ì—…ë¶„ë¥˜ || '').toLowerCase().includes(search) ||
                    (c.ì§ì—…ìƒì„¸ || '').toLowerCase().includes(search)
                );
            }

            // ë‹¨ê³„ í•„í„°
            if (stageFilter) {
                filtered = filtered.filter(c => c.ì¸ì¦ë‹¨ê³„ === stageFilter);
            }

            // ìœ ì… í•„í„°
            if (sourceFilter) {
                filtered = filtered.filter(c => c.ìœ ì…ê²½ë¡œ === sourceFilter);
            }

            // ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•„í„°
            if (blacklistFilter === 'blacklist') {
                filtered = filtered.filter(c => c.ë¸”ë™ë¦¬ìŠ¤íŠ¸ === true);
            } else if (blacklistFilter === 'normal') {
                filtered = filtered.filter(c => !c.ë¸”ë™ë¦¬ìŠ¤íŠ¸);
            }
            
            // ê³ ê° ìˆ˜ í‘œì‹œ
            document.getElementById('customerCount').textContent = `ì´ ${filtered.length}ëª…`;
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(row => {
                // ì¸ì¦ë‹¨ê³„ ë±ƒì§€
                const stageNum = row.ì¸ì¦ë‹¨ê³„?.charAt(0) || '0';
                const stageLabel = {
                    '0': 'ë¯¸ë¶„ë¥˜',
                    '1': 'ì´ˆëŒ€ì¥ì‹ ì²­',
                    '2': 'ê²°ì œì™„ë£Œ',
                    '3': 'ì¡°ì‚¬ì™„ë£Œ',
                    '4': 'ì°¸ì—¬ì™„ë£Œ',
                    '5': 'ë¶ˆì°¸'
                }[stageNum] || '-';
                const stageClass = {
                    '0': 'status-muted',
                    '1': 'status-info',
                    '2': 'status-warning',
                    '3': 'status-success',
                    '4': 'status-purple',
                    '5': 'status-danger'
                }[stageNum] || 'status-muted';
                
                // ìœ ì… ë±ƒì§€
                const sourceLabel = row.ìœ ì…ê²½ë¡œ === 'invitation' ? 'ì´ˆëŒ€' : 
                                   row.ìœ ì…ê²½ë¡œ === 'organic' ? 'ì¼ë°˜' : '-';
                const sourceClass = row.ìœ ì…ê²½ë¡œ === 'invitation' ? 'status-purple' : 'status-muted';
                
                // ì„±ë³„
                const genderClass = row.ì„±ë³„ === 'ë‚¨ì' ? 'gender-male' : 
                                   row.ì„±ë³„ === 'ì—¬ì' ? 'gender-female' : '';
                
                // ë‚˜ì´ ê³„ì‚°
                const age = row.ì¶œìƒì—°ë„ ? (2026 - row.ì¶œìƒì—°ë„ + 1) + 'ì„¸' : '-';
                
                // í‚¤
                const height = row.ì‹ ì¥ ? row.ì‹ ì¥ + 'cm' : '-';
                
                // ì§ì—… (ìƒì„¸ ìš°ì„ )
                const job = row.ì§ì—…ìƒì„¸ || row.ì§ì—…ë¶„ë¥˜ || '-';
                
                // ì‚¬ì „ì¡°ì‚¬
                const surveyIcon = row.ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ === 'Y' ? 'âœ“' : '-';
                const surveyClass = row.ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ === 'Y' ? 'status-success' : '';
                
                // ì˜ˆì•½ ê±´ìˆ˜
                const reserveCount = row.ì˜ˆì•½ê±´ìˆ˜ || 0;
                const reserveLabel = reserveCount > 0 ? `${reserveCount}ê±´` : '-';
                
                // ì—°ë½ì²˜ í‘œì‹œ (ì „ì²´ í˜•ì‹ ìœ ì§€)
                const phone = row.ì—°ë½ì²˜ || '';
                const displayPhone = phone.includes('-') ? phone : formatPhone(phone);
                
                // ë‹‰ë„¤ì„ í‘œì‹œ
                const nickname = row.ë‹‰ë„¤ì„ || '-';

                // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì—¬ë¶€
                const isBlacklisted = row.ë¸”ë™ë¦¬ìŠ¤íŠ¸ || false;
                const blacklistIcon = isBlacklisted ? '<span style="color: var(--danger);" title="ë¸”ë™ë¦¬ìŠ¤íŠ¸: ' + (row.ë¸”ë™ë¦¬ìŠ¤íŠ¸ì‚¬ìœ  || '').replace(/"/g, '&quot;') + '">â›”</span> ' : '';

                return `
                    <tr class="clickable-row ${isBlacklisted ? 'blacklist-row' : ''}" onclick="showIntegratedDetail('${row._phone || phone}')" ${isBlacklisted ? 'style="background: rgba(255,77,77,0.1);"' : ''}>
                        <td><span class="status ${stageClass}">${stageLabel}</span></td>
                        <td><span class="status ${sourceClass}">${sourceLabel}</span></td>
                        <td>${blacklistIcon}${row.í¬ë£¨ëª… || '-'}</td>
                        <td title="${nickname}">${nickname.length > 6 ? nickname.substring(0,6) + '..' : nickname}</td>
                        <td title="${phone}">${displayPhone || '-'}</td>
                        <td class="${genderClass}">${row.ì„±ë³„ || '-'}</td>
                        <td>${age}</td>
                        <td>${height}</td>
                        <td title="${job}">${job.length > 8 ? job.substring(0,8) + '..' : job}</td>
                        <td class="${surveyClass}">${surveyIcon}</td>
                        <td>${reserveLabel}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // ê³ ê° ì •ë ¬ ê¸°ëŠ¥
        let customerSortField = '';
        let customerSortOrder = 'asc';
        
        function sortCustomers(field) {
            // ê°™ì€ í•„ë“œ í´ë¦­ ì‹œ ì •ë ¬ ìˆœì„œ í† ê¸€
            if (customerSortField === field) {
                customerSortOrder = customerSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                customerSortField = field;
                customerSortOrder = 'asc';
            }
            
            // í—¤ë” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.sortable-table th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sort === field) {
                    th.classList.add(customerSortOrder);
                }
            });
            
            // ì •ë ¬ ì‹¤í–‰
            if (data.integratedCustomers) {
                data.integratedCustomers.sort((a, b) => {
                    let valA = a[field] || '';
                    let valB = b[field] || '';
                    
                    // ìˆ«ì í•„ë“œ ì²˜ë¦¬
                    if (field === 'ì¶œìƒì—°ë„' || field === 'ì‹ ì¥' || field === 'ì˜ˆì•½ê±´ìˆ˜') {
                        valA = Number(valA) || 0;
                        valB = Number(valB) || 0;
                    }
                    
                    // ì§ì—… í•„ë“œ ì²˜ë¦¬
                    if (field === 'ì§ì—…') {
                        valA = a.ì§ì—…ìƒì„¸ || a.ì§ì—…ë¶„ë¥˜ || '';
                        valB = b.ì§ì—…ìƒì„¸ || b.ì§ì—…ë¶„ë¥˜ || '';
                    }
                    
                    // ë¹„êµ
                    if (valA < valB) return customerSortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return customerSortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            renderCustomers();
        }
        
        // ë‚ ì§œ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateDateFilter() {
            const dates = new Set();
            (data.integratedCustomers || []).forEach(row => {
                if (row.ì§„í–‰ì¼ì‹œ) {
                    const match = String(row.ì§„í–‰ì¼ì‹œ).match(/(\d+)ì›”\s*(\d+)ì¼/);
                    if (match) dates.add(`${match[1]}ì›” ${match[2]}ì¼`);
                }
            });
            
            const select = document.getElementById('customerDateFilter');
            if (select) {
                select.innerHTML = '<option value="">ì „ì²´ ë‚ ì§œ</option>' +
                    [...dates].sort().map(d => `<option value="${d}">${d}</option>`).join('');
            }
        }
        
        // í†µí•© ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (RESTful API ì‚¬ìš©)
        async function refreshIntegratedData() {
            showToast('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì¤‘...', 'info');
            
            try {
                await refreshAllData();
                showToast('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!', 'success');
            } catch (error) {
                console.error('í†µí•© ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜', 'error');
            }
        }
        
        // í†µí•© ìƒì„¸ ëª¨ë‹¬
        function showIntegratedDetail(phone) {
            const customer = (data.integratedCustomers || []).find(r =>
                normalizePhone(r.ì—°ë½ì²˜) === normalizePhone(phone) || r._phone === phone
            );

            if (!customer) return;

            // DBì˜ customers í…Œì´ë¸”ì—ì„œ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const normalizedPhone = normalizePhone(phone);
            const customerDB = (data.customers || []).find(c =>
                normalizePhone(c.id) === normalizedPhone
            );

            const modalBody = document.getElementById('customerModalBody');
            const isInvitation = customer.ìœ ì…ê²½ë¡œ === 'invitation';
            
            // ì¸ì¦ë‹¨ê³„ ë±ƒì§€
            const stageNum = customer.ì¸ì¦ë‹¨ê³„?.charAt(0) || '0';
            const stageLabel = {
                '0': 'ë¯¸ë¶„ë¥˜',
                '1': 'ì´ˆëŒ€ì¥ ì‹ ì²­',
                '2': 'í”„ë¦½ ê²°ì œì™„ë£Œ',
                '3': 'ì‚¬ì „ì¡°ì‚¬ ì™„ë£Œ',
                '4': 'ì°¸ì—¬ ì™„ë£Œ',
                '5': 'í–‰ì‚¬ ë¶ˆì°¸'
            }[stageNum] || '-';
            const stageClass = {
                '0': 'status-muted',
                '1': 'status-info',
                '2': 'status-warning',
                '3': 'status-success',
                '4': 'status-purple',
                '5': 'status-danger'
            }[stageNum] || 'status-muted';
            
            // ì˜ˆì•½ ëª©ë¡ HTML
            const reservations = customer.ì˜ˆì•½ëª©ë¡ || [];
            const reservationsHtml = reservations.length > 0 
                ? reservations.map(r => `
                    <div class="reservation-item" style="padding: 8px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">${r.eventDate || '-'}</div>
                            <div style="color: var(--text-muted); font-size: 11px;">${r.option || '-'}</div>
                        </div>
                        <span class="status ${r.status === 'ì˜ˆì•½ì™„ë£Œ' ? 'status-success' : r.status === 'ì·¨ì†Œ' ? 'status-danger' : 'status-muted'}">${r.status || '-'}</span>
                    </div>
                `).join('') 
                : '<div style="color: var(--text-muted);">ì˜ˆì•½ ì—†ìŒ</div>';
            
            // ì œì¶œ ì„œë¥˜ ì„¹ì…˜ - ì´ˆëŒ€ê³ ê°ìš© (í•­ëª©ë³„ ê°œë³„ í‘œì‹œ)
            let invitationDocsHtml = '';
            if (isInvitation) {
                // ì„ íƒ ì¹´í…Œê³ ë¦¬
                invitationDocsHtml += `
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">ğŸ“‹ ì„ íƒ ì¹´í…Œê³ ë¦¬</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 13px;">
                            ${customer.ì„ íƒìê²© ? customer.ì„ íƒìê²©.split(',').map(q => 
                                `<span class="status status-info">${q.trim()}</span>`
                            ).join('') : '<span style="color: var(--text-muted);">ì„ íƒ ì—†ìŒ</span>'}
                        </div>
                    </div>
                `;
                
                // fileLinksê°€ JSONì¸ì§€ í™•ì¸í•˜ê³  íŒŒì‹± (ìƒˆ êµ¬ì¡°: { ìê²©ëª…: { authMethod, onsiteDocs, fields: {...} } })
                let fieldData = {};
                try {
                    if (customer.ì´ˆëŒ€ì¥íŒŒì¼ë§í¬ && customer.ì´ˆëŒ€ì¥íŒŒì¼ë§í¬.startsWith('{')) {
                        fieldData = JSON.parse(customer.ì´ˆëŒ€ì¥íŒŒì¼ë§í¬);
                    }
                } catch (e) {
                    console.log('fieldData íŒŒì‹± ì‹¤íŒ¨, ê¸°ì¡´ í˜•ì‹:', customer.ì´ˆëŒ€ì¥íŒŒì¼ë§í¬);
                }
                
                // í•­ëª©ë³„ ì„œë¥˜ ë¼ë²¨ ì •ì˜
                const qualFieldLabels = {
                    'ì§ì—…': { job_cert: 'ëª…í•¨/ì¬ì§ì¦ëª…ì„œ', onsiteDocs: 'ëª…í•¨ ë˜ëŠ” ì‚¬ì›ì¦' },
                    'í•™ë ¥': { edu_cert: 'ì¡¸ì—…ì¦ëª…ì„œ/í•™ìƒì¦', onsiteDocs: 'í•™ìƒì¦ ë˜ëŠ” ì¡¸ì—…ì¦ëª…ì„œ' },
                    'ì—°ë´‰ìì‚°': { asset_cert: 'ì†Œë“/ìì‚° ì¦ë¹™', onsiteDocs: 'ì†Œë“/ìì‚° ì¦ë¹™ ì„œë¥˜' },
                    'SNS': { sns_platform: 'SNS í”Œë«í¼', sns_account: 'SNS ê³„ì •', sns_screenshot: 'íŒ”ë¡œì›Œ ìŠ¤í¬ë¦°ìƒ·', onsiteDocs: 'SNS ê³„ì • í™”ë©´' },
                    'ìš´ë™': { fitness_cert: 'ì™„ì£¼ ì¸ì¦ì„œ/ì¸ë°”ë””', onsiteDocs: 'ì™„ì£¼ ë©”ë‹¬ ë˜ëŠ” ì¸ë°”ë”” ê²°ê³¼ì§€' },
                    'ì™¸ëª¨': { photo_1: 'ë³¸ì¸ ì‚¬ì§„ 1', photo_2: 'ë³¸ì¸ ì‚¬ì§„ 2', onsiteDocs: 'ì‹ ë¶„ì¦ (í˜„ì¥ í™•ì¸)' },
                    'ë“í‘œ3í‘œ': { party_name: 'ì°¸ì„ íŒŒí‹° ì´ë¦„', vote_screenshot: 'ë“í‘œ ì¸ì¦ ìŠ¤í¬ë¦°ìƒ·', onsiteDocs: 'í˜¸ìŠ¤íŠ¸ì—ê²Œ í™•ì¸' }
                };
                
                let docsRows = '';
                let onsiteRows = '';  // í˜„ì¥ í™•ì¸ í•„ìš” í•­ëª©
                const qualifications = customer.ì„ íƒìê²© ? customer.ì„ íƒìê²©.split(',').map(q => q.trim()) : [];
                
                qualifications.forEach(qual => {
                    const labels = qualFieldLabels[qual];
                    if (!labels) return;
                    
                    const qualFieldData = fieldData[qual];
                    const authMethod = qualFieldData?.authMethod || 'upload';
                    const fieldsData = qualFieldData?.fields || qualFieldData || {};  // ë ˆê±°ì‹œ ì§€ì›
                    
                    // í˜„ì¥ ì¸ì¦ ì„ íƒí•œ í•­ëª©
                    if (authMethod === 'onsite') {
                        const onsiteDoc = qualFieldData?.onsiteDocs || labels.onsiteDocs || '';
                        onsiteRows += `
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(255,165,0,0.1); border-radius: 6px; border: 1px solid rgba(255,165,0,0.3);">
                                <span style="color: #FFA500;"><i class="fas fa-building"></i> [${qual}]</span>
                                <span style="color: #FFA500;">í˜„ì¥ í™•ì¸: ${onsiteDoc}</span>
                            </div>
                        `;
                        return;
                    }
                    
                    // ì§€ê¸ˆ ì²¨ë¶€ ì„ íƒí•œ í•­ëª© - í•„ë“œë³„ í‘œì‹œ
                    Object.entries(labels).forEach(([fieldId, label]) => {
                        if (fieldId === 'onsiteDocs') return;  // ë©”íƒ€ë°ì´í„° ìŠ¤í‚µ
                        
                        const fieldInfo = fieldsData[fieldId];
                        let valueHtml = '<span class="status status-muted">ë¯¸ì œì¶œ</span>';
                        
                        if (fieldInfo) {
                            if (fieldInfo.type === 'text' && fieldInfo.value) {
                                // SNS ê³„ì •ì˜ ê²½ìš° ë§í¬ë„ í‘œì‹œ
                                if (fieldInfo.link) {
                                    valueHtml = `<a href="${fieldInfo.link}" target="_blank" style="color: var(--primary);">${fieldInfo.value}</a>`;
                                } else {
                                    valueHtml = `<span style="color: var(--text);">${fieldInfo.value}</span>`;
                                }
                            } else if (fieldInfo.type === 'file' && fieldInfo.url) {
                                valueHtml = `<a href="${fieldInfo.url}" target="_blank" class="status status-success">ë³´ê¸°</a>`;
                            } else if (typeof fieldInfo === 'string' && fieldInfo.startsWith('http')) {
                                // ë ˆê±°ì‹œ URL í˜•íƒœ
                                valueHtml = `<a href="${fieldInfo}" target="_blank" class="status status-success">ë³´ê¸°</a>`;
                            }
                        }
                        
                        docsRows += `
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg); border-radius: 6px;">
                                <span>[${qual}] ${label}</span>
                                ${valueHtml}
                            </div>
                        `;
                    });
                });
                
                // ê¸°ì¡´ fileLinksê°€ URL í˜•íƒœì¸ ê²½ìš° (ë ˆê±°ì‹œ ì§€ì›)
                if (!docsRows && !onsiteRows && customer.ì´ˆëŒ€ì¥íŒŒì¼ë§í¬ && !customer.ì´ˆëŒ€ì¥íŒŒì¼ë§í¬.startsWith('{')) {
                    docsRows = `
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg); border-radius: 6px;">
                            <span>ì—…ë¡œë“œ ì„œë¥˜</span>
                            <a href="${customer.ì´ˆëŒ€ì¥íŒŒì¼ë§í¬}" target="_blank" class="status status-success">ë³´ê¸°</a>
                        </div>
                    `;
                }
                
                // SNS ë§í¬ (í•„ë“œ ì™¸ì— ë³„ë„ë¡œ ì €ì¥ëœ ê²½ìš°)
                if (customer.SNSë§í¬ && !fieldData['SNS']?.fields?.sns_account) {
                    docsRows += `
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg); border-radius: 6px;">
                            <span>[SNS] ê³„ì • ì£¼ì†Œ</span>
                            <a href="${customer.SNSë§í¬}" target="_blank" style="color: var(--primary);">ë³´ê¸°</a>
                        </div>
                    `;
                }
                
                // í˜„ì¥ í™•ì¸ í•„ìš” ì„¹ì…˜
                if (onsiteRows) {
                    invitationDocsHtml += `
                        <div style="margin-bottom: 24px;">
                            <h4 style="font-size: 14px; color: #FFA500; margin-bottom: 12px;">âš ï¸ í˜„ì¥ í™•ì¸ í•„ìš”</h4>
                            <div style="display: grid; gap: 8px; font-size: 13px;">
                                ${onsiteRows}
                            </div>
                        </div>
                    `;
                }
                
                // ì œì¶œ ì„œë¥˜ ì„¹ì…˜
                if (docsRows) {
                    invitationDocsHtml += `
                        <div style="margin-bottom: 24px;">
                            <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">ğŸ“ ì œì¶œ ì„œë¥˜ (ì´ˆëŒ€ê³ ê°)</h4>
                            <div style="display: grid; gap: 8px; font-size: 13px;">
                                ${docsRows}
                            </div>
                        </div>
                    `;
                }
            }
            
            // ì œì¶œ ì„œë¥˜ ì„¹ì…˜ - ì¼ë°˜ê³ ê°ìš©
            const organicDocsHtml = !isInvitation ? `
                <div style="margin-bottom: 24px;">
                    <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">ğŸ“ ì œì¶œ ì„œë¥˜ (ì¼ë°˜ê³ ê°)</h4>
                    <div style="display: grid; gap: 8px; font-size: 13px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg); border-radius: 6px;">
                            <span>ì§ì—… ì¸ì¦ì„œ</span>
                            ${customer.ì§ì—…ì¸ì¦ì„œë¥˜ 
                                ? `<a href="${customer.ì§ì—…ì¸ì¦ì„œë¥˜}" target="_blank" class="status status-success">ë³´ê¸°</a>` 
                                : '<span class="status status-muted">ë¯¸ì œì¶œ</span>'}
                        </div>
                    </div>
                </div>
            ` : '';
            
            // ì œì¶œ ì„œë¥˜ ì„¹ì…˜ - ì‚¬ì „ì¡°ì‚¬ (ëª¨ë“  ê³ ê° ê³µí†µ)
            const survey = (data.surveys || []).find(s => normalizePhone(s.phone) === normalizePhone(phone));
            const surveyDocsHtml = `
                <div style="margin-bottom: 24px;">
                    <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">ğŸ“ ì œì¶œ ì„œë¥˜ (ì‚¬ì „ì¡°ì‚¬)</h4>
                    <div style="display: grid; gap: 8px; font-size: 13px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg); border-radius: 6px;">
                            <span>ì§ì—… ì¸ì¦ì„œ (ëª…í•¨/ì¬ì§ì¦ëª…ì„œ)</span>
                            ${survey?.jobCertFile 
                                ? `<a href="${survey.jobCertFile}" target="_blank" class="status status-success">ë³´ê¸°</a>` 
                                : '<span class="status status-muted">ë¯¸ì œì¶œ</span>'}
                        </div>
                    </div>
                    ${survey ? `
                        <div style="margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 6px; font-size: 12px; color: var(--text-muted);">
                            ì œì¶œì¼ì‹œ: ${survey.submittedAt ? new Date(survey.submittedAt).toLocaleString('ko-KR') : '-'}
                        </div>
                    ` : '<div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">ì‚¬ì „ì¡°ì‚¬ ë¯¸ì œì¶œ</div>'}
                </div>
            `;
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">ê¸°ë³¸ ì •ë³´</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                        <div><span style="color: var(--text-muted);">ì´ë¦„:</span> ${customer.í¬ë£¨ëª… || '-'}</div>
                        <div><span style="color: var(--text-muted);">ë‹‰ë„¤ì„:</span> ${customer.ë‹‰ë„¤ì„ || '-'}</div>
                        <div><span style="color: var(--text-muted);">ì—°ë½ì²˜:</span> ${customer.ì—°ë½ì²˜ || '-'}</div>
                        <div><span style="color: var(--text-muted);">ì„±ë³„:</span> ${customer.ì„±ë³„ || '-'}</div>
                        <div><span style="color: var(--text-muted);">ì¶œìƒì—°ë„:</span> ${customer.ì¶œìƒì—°ë„ || '-'}</div>
                        <div><span style="color: var(--text-muted);">ì‹ ì¥:</span> ${customer.ì‹ ì¥ ? customer.ì‹ ì¥ + 'cm' : '-'}</div>
                        <div><span style="color: var(--text-muted);">ì§ì—…:</span> ${customer.ì§ì—…ìƒì„¸ || customer.ì§ì—…ë¶„ë¥˜ || '-'}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">ì¸ì¦ ë‹¨ê³„</h4>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <select id="stageChangeSelect" class="filter-select" style="min-width: 180px; padding: 8px 12px;" onchange="handleStageChange('${phone}', this.value)">
                            <option value="0" ${stageNum === '0' ? 'selected' : ''}>0 - ë¯¸ë¶„ë¥˜</option>
                            <option value="1" ${stageNum === '1' ? 'selected' : ''}>1 - ì´ˆëŒ€ì¥ ì‹ ì²­</option>
                            <option value="2" ${stageNum === '2' ? 'selected' : ''}>2 - í”„ë¦½ ê²°ì œì™„ë£Œ</option>
                            <option value="3" ${stageNum === '3' ? 'selected' : ''}>3 - ì‚¬ì „ì¡°ì‚¬ ì™„ë£Œ</option>
                            <option value="4" ${stageNum === '4' ? 'selected' : ''}>4 - ì°¸ì—¬ ì™„ë£Œ</option>
                            <option value="5" ${stageNum === '5' ? 'selected' : ''}>5 - í–‰ì‚¬ ë¶ˆì°¸</option>
                        </select>
                        <span style="color: var(--text-muted); font-size: 12px;">
                            ${stageNum === '3' || stageNum === '4' ? 'âœ… ì¸ì¦ëœ ê³ ê°' : 'âš ï¸ ë‹¨ê³„ ë³€ê²½ ì‹œ ê´€ë ¨ ë°ì´í„°ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤'}
                        </span>
                    </div>
                </div>
                
                ${invitationDocsHtml}
                ${organicDocsHtml}
                ${surveyDocsHtml}
                
                <div style="margin-bottom: 24px;">
                    <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">ì°¸ì—¬ íˆìŠ¤í† ë¦¬ (${reservations.length}ê±´)</h4>
                    ${reservationsHtml}
                </div>
                
                ${isInvitation ? `
                <div>
                    <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">ì´ˆëŒ€ì¥ ì •ë³´</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                        <div><span style="color: var(--text-muted);">ì™€ì¸ë³´ë„ˆìŠ¤:</span> ${customer.ì™€ì¸ë³´ë„ˆìŠ¤ || '-'}</div>
                        <div><span style="color: var(--text-muted);">ì¸ì¦ë°©ë²•:</span> ${customer.ì¸ì¦ë°©ë²• || '-'}</div>
                        <div><span style="color: var(--text-muted);">ìŠ¹ì¸ìƒíƒœ:</span> ${customer.ìŠ¹ì¸ìƒíƒœ || '-'}</div>
                        <div><span style="color: var(--text-muted);">ë°°í¬ì²˜:</span> ${customer.ë°°í¬ì²˜ || '-'}</div>
                        <div><span style="color: var(--text-muted);">í˜¸ìŠ¤íŠ¸:</span> ${customer.í˜¸ìŠ¤íŠ¸ëª… || '-'}</div>
                        <div><span style="color: var(--text-muted);">ì¿ í°ì½”ë“œ:</span> ${customer.ì¿ í°ì½”ë“œ || '-'}</div>
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 24px; padding: 16px; border: 1px solid ${customerDB?.is_blacklisted ? 'var(--danger)' : 'var(--border)'}; border-radius: 8px; background: ${customerDB?.is_blacklisted ? 'rgba(255,77,77,0.1)' : 'var(--bg)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${customerDB?.is_blacklisted ? '12px' : '0'};">
                        <h4 style="font-size: 14px; color: ${customerDB?.is_blacklisted ? 'var(--danger)' : 'var(--text-muted)'}; margin: 0;">
                            ${customerDB?.is_blacklisted ? 'â›” ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê³ ê°' : 'ğŸ›¡ï¸ ë¸”ë™ë¦¬ìŠ¤íŠ¸'}
                        </h4>
                        <button class="btn ${customerDB?.is_blacklisted ? 'btn-secondary' : 'btn-danger'}" style="font-size: 12px; padding: 6px 12px;" onclick="toggleBlacklist('${phone}', ${!customerDB?.is_blacklisted})">
                            ${customerDB?.is_blacklisted ? 'ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•´ì œ' : 'ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë“±ë¡'}
                        </button>
                    </div>
                    ${customerDB?.is_blacklisted ? `
                        <div style="font-size: 13px;">
                            <div style="color: var(--danger); margin-bottom: 8px;"><strong>ì‚¬ìœ :</strong> ${customerDB?.blacklist_reason || '(ì‚¬ìœ  ë¯¸ì…ë ¥)'}</div>
                            <div style="color: var(--text-muted); font-size: 11px;">ë“±ë¡ì¼: ${customerDB?.blacklisted_at ? new Date(customerDB.blacklisted_at).toLocaleString('ko-KR') : '-'}</div>
                        </div>
                    ` : ''}
                </div>

                <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="openCustomerForm('${phone}')">
                        <i class="fas fa-edit"></i> ìˆ˜ì •
                    </button>
                    <button class="btn btn-danger" onclick="deleteCustomer('${phone}')">
                        <i class="fas fa-trash"></i> ì‚­ì œ
                    </button>
                </div>
            `;
            
            openModal('customerModal');
        }
        
        // ê³ ê° ì¶”ê°€/ìˆ˜ì • í¼ ì—´ê¸°
        function openCustomerForm(phone = null) {
            const form = document.getElementById('customerForm');
            const title = document.getElementById('customerFormTitle');
            
            // í¼ ì´ˆê¸°í™”
            form.reset();
            document.getElementById('cf_editPhone').value = '';
            
            if (phone) {
                // ìˆ˜ì • ëª¨ë“œ
                title.textContent = 'ê³ ê° ìˆ˜ì •';
                document.getElementById('cf_editPhone').value = phone;
                document.getElementById('cf_phone').value = phone;
                document.getElementById('cf_phone').disabled = true; // ì—°ë½ì²˜ëŠ” ìˆ˜ì • ë¶ˆê°€

                // ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (customers í…Œì´ë¸” ìš°ì„ , ì—†ìœ¼ë©´ integratedCustomersì—ì„œ)
                const normalizedPhone = normalizePhone(phone);
                let customer = data.customers.find(c => c.id === normalizedPhone || c.id === phone);

                // customersì— ì—†ìœ¼ë©´ integratedCustomersì—ì„œ ì°¾ê¸° (ì˜ˆì•½/ì´ˆëŒ€ì¥ì—ì„œë§Œ ì˜¨ ê³ ê°)
                if (!customer) {
                    const integrated = data.integratedCustomers.find(c =>
                        normalizePhone(c.ì—°ë½ì²˜) === normalizedPhone
                    );
                    if (integrated) {
                        customer = {
                            name: integrated.í¬ë£¨ëª…,
                            gender: integrated.ì„±ë³„,
                            birthYear: integrated.ì¶œìƒì—°ë„,
                            height: integrated.ì‹ ì¥,
                            jobCategory: integrated.ì§ì—…ë¶„ë¥˜,
                            jobDetail: integrated.ì§ì—…ìƒì„¸,
                            source: integrated.ìœ ì…ê²½ë¡œ || 'organic',
                            memo: ''
                        };
                    }
                }

                if (customer) {
                    document.getElementById('cf_name').value = customer.name || '';
                    document.getElementById('cf_nickname').value = customer.nickname || '';
                    document.getElementById('cf_gender').value = customer.gender || '';
                    document.getElementById('cf_birthYear').value = customer.birth_year || customer.birthYear || '';
                    document.getElementById('cf_height').value = customer.height || '';
                    document.getElementById('cf_jobCategory').value = customer.job_category || customer.jobCategory || '';
                    document.getElementById('cf_jobDetail').value = customer.job_detail || customer.jobDetail || '';
                    document.getElementById('cf_source').value = customer.source || 'organic';
                    document.getElementById('cf_memo').value = customer.memo || '';
                }
                
                // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
                closeModal('customerModal');
            } else {
                // ì¶”ê°€ ëª¨ë“œ
                title.textContent = 'ê³ ê° ì¶”ê°€';
                document.getElementById('cf_phone').disabled = false;
                document.getElementById('cf_source').value = 'direct';
            }

            // ì˜ˆì•½ ìƒì„± ì˜µì…˜ ì´ˆê¸°í™”
            document.getElementById('cf_createReservation').checked = false;
            document.getElementById('cf_reservationFields').style.display = 'none';

            // íŒŒí‹° ë‚ ì§œ ì˜µì…˜ ì±„ìš°ê¸°
            const dateSelect = document.getElementById('cf_resDate');
            dateSelect.innerHTML = '';
            const schedules = data.schedules || [];
            const uniqueDates = [...new Set(schedules.map(s => s.date))].sort();
            uniqueDates.forEach(date => {
                const opt = document.createElement('option');
                opt.value = date;
                opt.textContent = date;
                dateSelect.appendChild(opt);
            });

            openModal('customerFormModal');
        }

        // ì˜ˆì•½ í•„ë“œ í† ê¸€
        function toggleReservationFields() {
            const checkbox = document.getElementById('cf_createReservation');
            const fields = document.getElementById('cf_reservationFields');
            fields.style.display = checkbox.checked ? 'block' : 'none';
        }
        
        // ê³ ê° ì €ì¥ (UPSERT ë°©ì‹ - ìˆìœ¼ë©´ ìˆ˜ì •, ì—†ìœ¼ë©´ ì¶”ê°€)
        async function saveCustomer(event) {
            event.preventDefault();

            const editPhone = document.getElementById('cf_editPhone').value;
            const phone = document.getElementById('cf_phone').value.trim();

            if (!phone) {
                showToast('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            // ì „í™”ë²ˆí˜¸ í˜•ì‹ ì •ê·œí™”
            const normalizedPhone = normalizePhone(phone);

            const customerData = {
                id: normalizedPhone,
                name: document.getElementById('cf_name').value.trim() || null,
                nickname: document.getElementById('cf_nickname').value.trim() || null,
                gender: document.getElementById('cf_gender').value || null,
                birth_year: document.getElementById('cf_birthYear').value ? parseInt(document.getElementById('cf_birthYear').value) : null,
                height: document.getElementById('cf_height').value ? parseInt(document.getElementById('cf_height').value) : null,
                job_category: document.getElementById('cf_jobCategory').value || null,
                job_detail: document.getElementById('cf_jobDetail').value.trim() || null,
                source: document.getElementById('cf_source').value || 'direct',
                memo: document.getElementById('cf_memo').value.trim() || null
            };

            try {
                // DBì—ì„œ ê¸°ì¡´ ê³ ê° í™•ì¸ (ë¡œì»¬ ë°ì´í„°ê°€ ì•„ë‹Œ ì‹¤ì œ DB í™•ì¸)
                const checkResponse = await fetch(`${API_BASE}/${TB.CUSTOMERS}?id=eq.${encodeURIComponent(normalizedPhone)}`, {
                    method: 'GET',
                    headers: SUPABASE_HEADERS
                });
                const existingInDB = await checkResponse.json();

                let response;
                if (existingInDB && existingInDB.length > 0) {
                    // DBì— ìˆìœ¼ë©´ PATCHë¡œ ìˆ˜ì •
                    const updateData = { ...customerData };
                    delete updateData.id;
                    response = await fetch(`${API_BASE}/${TB.CUSTOMERS}?id=eq.${encodeURIComponent(normalizedPhone)}`, {
                        method: 'PATCH',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(updateData)
                    });
                } else {
                    // DBì— ì—†ìœ¼ë©´ POSTë¡œ ì¶”ê°€
                    response = await fetch(`${API_BASE}/${TB.CUSTOMERS}`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(customerData)
                    });
                }

                if (response.ok) {
                    // ì˜ˆì•½ë„ í•¨ê»˜ ìƒì„± ì˜µì…˜ ì²´í¬
                    const createReservation = document.getElementById('cf_createReservation').checked;
                    if (createReservation) {
                        const resDate = document.getElementById('cf_resDate').value;
                        const resPart = document.getElementById('cf_resPart').value;
                        const resPaymentType = document.getElementById('cf_resPaymentType').value;

                        if (resDate) {
                            const reservationData = {
                                phone: normalizedPhone,
                                crewName: customerData.nickname || customerData.name || '',
                                eventDate: resDate,
                                eventPart: resPart,
                                option: 'ì§ì ‘ë“±ë¡',
                                isInvitation: false,
                                status: 'confirmed',
                                paymentType: resPaymentType,
                                paymentNote: 'ì§ì ‘ ë“±ë¡'
                            };

                            const resResponse = await fetch(`${API_BASE}/${TB.RESERVATIONS}`, {
                                method: 'POST',
                                headers: SUPABASE_HEADERS,
                                body: JSON.stringify(reservationData)
                            });

                            if (resResponse.ok) {
                                showToast('ê³ ê° + ì˜ˆì•½ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                            } else {
                                showToast('ê³ ê° ì €ì¥ë¨, ì˜ˆì•½ ìƒì„± ì‹¤íŒ¨', 'warning');
                            }
                        }
                    } else {
                        showToast('ê³ ê° ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    }
                    closeModal('customerFormModal');
                    await refreshAllData();
                } else {
                    const errorText = await response.text();
                    console.error('ì €ì¥ ì‹¤íŒ¨:', response.status, errorText);
                    showToast('ì €ì¥ ì‹¤íŒ¨: ' + response.status, 'error');
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                showToast('ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
        
        // ê³ ê° ì‚­ì œ
        async function deleteCustomer(phone) {
            if (!confirm(`ì •ë§ ì´ ê³ ê°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì—°ë½ì²˜: ${phone}\n\nê´€ë ¨ëœ ì˜ˆì•½, ì´ˆëŒ€ì¥, ì‚¬ì „ì¡°ì‚¬ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                // ê³ ê° ì‚­ì œ (Supabase)
                await fetch(`${API_BASE}/${TB.CUSTOMERS}?id=eq.${encodeURIComponent(phone)}`, {
                    method: 'DELETE',
                    headers: SUPABASE_HEADERS
                });
                
                // ê´€ë ¨ ì˜ˆì•½ ì‚­ì œ
                const relatedReservations = data.reservations.filter(r => r.phone === phone);
                for (const r of relatedReservations) {
                    await fetch(`${API_BASE}/${TB.RESERVATIONS}?id=eq.${encodeURIComponent(r.id)}`, {
                        method: 'DELETE',
                        headers: SUPABASE_HEADERS
                    });
                }
                
                // ê´€ë ¨ ì´ˆëŒ€ì¥ ì‚­ì œ
                const relatedInvitations = data.invitations.filter(i => i.phone === phone);
                for (const i of relatedInvitations) {
                    await fetch(`${API_BASE}/${TB.INVITATIONS}?id=eq.${encodeURIComponent(i.id)}`, {
                        method: 'DELETE',
                        headers: SUPABASE_HEADERS
                    });
                }
                
                // ê´€ë ¨ ì‚¬ì „ì¡°ì‚¬ ì‚­ì œ
                const relatedSurveys = data.surveys.filter(s => s.phone === phone);
                for (const s of relatedSurveys) {
                    await fetch(`${API_BASE}/${TB.SURVEYS}?id=eq.${encodeURIComponent(s.id)}`, {
                        method: 'DELETE',
                        headers: SUPABASE_HEADERS
                    });
                }
                
                showToast('ê³ ê°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                closeModal('customerModal');
                await refreshAllData();
            } catch (error) {
                showToast('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ë¸”ë™ë¦¬ìŠ¤íŠ¸ í† ê¸€ í•¨ìˆ˜
        async function toggleBlacklist(phone, setBlacklisted) {
            const normalizedPhone = normalizePhone(phone);

            let reason = '';
            if (setBlacklisted) {
                reason = prompt('ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë“±ë¡ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                if (reason === null) return; // ì·¨ì†Œ
            } else {
                if (!confirm('ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            }

            try {
                // customers í…Œì´ë¸”ì— í•´ë‹¹ ê³ ê°ì´ ìˆëŠ”ì§€ í™•ì¸
                const checkResponse = await fetch(`${API_BASE}/${TB.CUSTOMERS}?id=eq.${encodeURIComponent(normalizedPhone)}`, {
                    method: 'GET',
                    headers: SUPABASE_HEADERS
                });
                const existingCustomer = await checkResponse.json();

                const blacklistData = {
                    is_blacklisted: setBlacklisted,
                    blacklist_reason: setBlacklisted ? reason : null,
                    blacklisted_at: setBlacklisted ? new Date().toISOString() : null
                };

                if (existingCustomer && existingCustomer.length > 0) {
                    // ê¸°ì¡´ ê³ ê° ì—…ë°ì´íŠ¸
                    await fetch(`${API_BASE}/${TB.CUSTOMERS}?id=eq.${encodeURIComponent(normalizedPhone)}`, {
                        method: 'PATCH',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(blacklistData)
                    });
                } else {
                    // ì‹ ê·œ ê³ ê° ìƒì„± (ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì •ë³´ë§Œ)
                    await fetch(`${API_BASE}/${TB.CUSTOMERS}`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify({
                            id: normalizedPhone,
                            ...blacklistData
                        })
                    });
                }

                showToast(setBlacklisted ? 'â›” ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ë¸”ë™ë¦¬ìŠ¤íŠ¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤', setBlacklisted ? 'error' : 'success');
                closeModal('customerModal');
                await refreshAllData();
            } catch (error) {
                console.error('ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showToast('ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ë‹¨ê³„ ìˆ˜ë™ ë³€ê²½ í•¨ìˆ˜
        async function handleStageChange(phone, newStage) {
            const normalizedPhone = normalizePhone(phone);
            const stageLabels = {
                '0': 'ë¯¸ë¶„ë¥˜',
                '1': 'ì´ˆëŒ€ì¥ ì‹ ì²­',
                '2': 'í”„ë¦½ ê²°ì œì™„ë£Œ',
                '3': 'ì‚¬ì „ì¡°ì‚¬ ì™„ë£Œ',
                '4': 'ì°¸ì—¬ ì™„ë£Œ',
                '5': 'í–‰ì‚¬ ë¶ˆì°¸'
            };

            if (!confirm(`ë‹¨ê³„ë¥¼ "${stageLabels[newStage]}"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní•„ìš”í•œ ë°ì´í„°ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤.`)) {
                // ì·¨ì†Œ ì‹œ ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
                const customer = (data.integratedCustomers || []).find(c =>
                    normalizePhone(c.ì—°ë½ì²˜) === normalizedPhone
                );
                const originalStage = customer?.ì¸ì¦ë‹¨ê³„?.charAt(0) || '0';
                document.getElementById('stageChangeSelect').value = originalStage;
                return;
            }

            try {
                const customer = (data.integratedCustomers || []).find(c =>
                    normalizePhone(c.ì—°ë½ì²˜) === normalizedPhone
                );
                const customerName = customer?.í¬ë£¨ëª… || '-';

                // ë‹¨ê³„ë³„ í•„ìš” ë°ì´í„° ìƒì„±
                if (newStage >= '1') {
                    // 1ë‹¨ê³„ ì´ìƒ: ì´ˆëŒ€ì¥ ë°ì´í„° í™•ì¸/ìƒì„±
                    const existingInvitation = (data.invitations || []).find(i => normalizePhone(i.phone) === normalizedPhone);
                    if (!existingInvitation) {
                        await fetch(`${API_BASE}/${TB.INVITATIONS}`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify({
                                id: `INV_MANUAL_${normalizedPhone}_${Date.now()}`,
                                phone: normalizedPhone,
                                name: customerName,
                                qualifications: 'ìˆ˜ë™ë“±ë¡',
                                status: 'approved',
                                source: 'manual',
                                createdAt: new Date().toISOString()
                            })
                        });
                    }
                }

                if (newStage >= '2') {
                    // 2ë‹¨ê³„ ì´ìƒ: ì˜ˆì•½ ë°ì´í„° í™•ì¸/ìƒì„±
                    const existingReservation = (data.reservations || []).find(r => normalizePhone(r.phone) === normalizedPhone);
                    if (!existingReservation) {
                        // ê°€ì¥ ê°€ê¹Œìš´ íŒŒí‹° ì¼ì • ì°¾ê¸°
                        const today = new Date();
                        const futureSchedules = (data.schedules || [])
                            .filter(s => parsePartyDate(s.date) >= today && s.isActive !== false)
                            .sort((a, b) => parsePartyDate(a.date) - parsePartyDate(b.date));
                        const nextSchedule = futureSchedules[0];

                        await fetch(`${API_BASE}/${TB.RESERVATIONS}`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify({
                                id: `RES_MANUAL_${normalizedPhone}_${Date.now()}`,
                                phone: normalizedPhone,
                                crewName: customerName,
                                eventDate: nextSchedule?.date || '-',
                                eventPart: nextSchedule?.part || '1ë¶€',
                                option: 'ìˆ˜ë™ë“±ë¡',
                                status: 'ì˜ˆì•½ì™„ë£Œ',
                                isInvitation: false,
                                paymentType: 'waived',
                                paymentNote: 'ë‹¨ê³„ ìˆ˜ë™ ë³€ê²½ìœ¼ë¡œ ìƒì„±',
                                createdAt: new Date().toISOString()
                            })
                        });
                    }
                }

                if (newStage >= '3') {
                    // 3ë‹¨ê³„ ì´ìƒ: ì‚¬ì „ì¡°ì‚¬ ë°ì´í„° í™•ì¸/ìƒì„±
                    const existingSurvey = (data.surveys || []).find(s => normalizePhone(s.phone) === normalizedPhone);
                    if (!existingSurvey) {
                        await fetch(`${API_BASE}/${TB.SURVEYS}`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify({
                                id: `SRV_MANUAL_${normalizedPhone}_${Date.now()}`,
                                phone: normalizedPhone,
                                name: customerName,
                                gender: customer?.ì„±ë³„ || null,
                                birthYear: customer?.ì¶œìƒì—°ë„ || null,
                                height: customer?.ì‹ ì¥ || null,
                                jobCategory: customer?.ì§ì—…ë¶„ë¥˜ || null,
                                jobDetail: customer?.ì§ì—…ìƒì„¸ || null,
                                submittedAt: new Date().toISOString()
                            })
                        });
                    }
                }

                // customers í…Œì´ë¸”ì— stage ì—…ë°ì´íŠ¸ (ì—†ìœ¼ë©´ ìƒì„±)
                const existingCustomer = (data.customers || []).find(c => c.id === normalizedPhone);
                if (existingCustomer) {
                    await fetch(`${API_BASE}/${TB.CUSTOMERS}?id=eq.${encodeURIComponent(normalizedPhone)}`, {
                        method: 'PATCH',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify({ stage: newStage })
                    });
                } else {
                    await fetch(`${API_BASE}/${TB.CUSTOMERS}`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify({
                            id: normalizedPhone,
                            name: customerName,
                            gender: customer?.ì„±ë³„ || null,
                            birth_year: customer?.ì¶œìƒì—°ë„ || null,
                            height: customer?.ì‹ ì¥ || null,
                            job_category: customer?.ì§ì—…ë¶„ë¥˜ || null,
                            job_detail: customer?.ì§ì—…ìƒì„¸ || null,
                            stage: newStage,
                            source: 'manual'
                        })
                    });
                }

                showToast(`ë‹¨ê³„ê°€ "${stageLabels[newStage]}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                await refreshAllData();

                // ëª¨ë‹¬ ë‚´ìš© ìƒˆë¡œê³ ì¹¨
                showIntegratedDetail(phone);

            } catch (error) {
                console.error('ë‹¨ê³„ ë³€ê²½ ì˜¤ë¥˜:', error);
                showToast('ë‹¨ê³„ ë³€ê²½ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ê²€ìƒ‰/í•„í„° ì´ë²¤íŠ¸
        document.getElementById('customerSearch')?.addEventListener('input', renderCustomers);
        document.getElementById('customerStageFilter')?.addEventListener('change', renderCustomers);
        document.getElementById('customerSourceFilter')?.addEventListener('change', renderCustomers);
        document.getElementById('customerBlacklistFilter')?.addEventListener('change', renderCustomers);

        // ========================================
        // ì´ˆëŒ€ì¥ ë Œë”ë§
        // ========================================
        let invitationSortField = '';
        let invitationSortAsc = true;
        
        function sortInvitations(field) {
            if (invitationSortField === field) {
                invitationSortAsc = !invitationSortAsc;
            } else {
                invitationSortField = field;
                invitationSortAsc = true;
            }
            renderInvitations();
        }
        
        function renderInvitations() {
            const tbody = document.getElementById('invitationsBody');
            const search = (document.getElementById('invitationSearch')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('invitationStatusFilter')?.value || '';
            
            let filtered = data.invitations;
            
            if (search) {
                filtered = filtered.filter(inv => 
                    (inv.phone || '').includes(search)
                );
            }
            
            if (statusFilter) {
                filtered = filtered.filter(inv => inv.approvalStatus === statusFilter);
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            // í”„ë¦½ ì˜ˆì•½ëœ ì „í™”ë²ˆí˜¸ ëª©ë¡
            const reservedPhones = data.reservations.map(r => r.phone);
            
            // ë°ì´í„°ì— hasReservation ì¶”ê°€
            let invData = filtered.map(inv => ({
                ...inv,
                hasReservation: reservedPhones.includes(inv.phone)
            }));
            
            // ì†ŒíŒ… ì ìš©
            if (invitationSortField) {
                invData.sort((a, b) => {
                    let valA, valB;
                    switch (invitationSortField) {
                        case 'phone': valA = a.phone || ''; valB = b.phone || ''; break;
                        case 'qualifications': valA = a.qualifications || ''; valB = b.qualifications || ''; break;
                        case 'wineBonus': valA = a.wineBonus ? 1 : 0; valB = b.wineBonus ? 1 : 0; break;
                        case 'authType': valA = a.authType || ''; valB = b.authType || ''; break;
                        case 'approvalStatus': valA = a.approvalStatus || ''; valB = b.approvalStatus || ''; break;
                        case 'distributor': valA = a.distributor || ''; valB = b.distributor || ''; break;
                        case 'hasReservation': valA = a.hasReservation ? 1 : 0; valB = b.hasReservation ? 1 : 0; break;
                        default: valA = ''; valB = '';
                    }
                    
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return invitationSortAsc ? valA - valB : valB - valA;
                    }
                    const strA = String(valA).toLowerCase();
                    const strB = String(valB).toLowerCase();
                    if (strA < strB) return invitationSortAsc ? -1 : 1;
                    if (strA > strB) return invitationSortAsc ? 1 : -1;
                    return 0;
                });
            }
            
            tbody.innerHTML = invData.map(inv => {
                const statusClass = {
                    'ì¿ í°ìŠ¹ì¸': 'status-success',
                    'ìŠ¹ì¸ì™„ë£Œ': 'status-success',
                    'ì„œë¥˜ì œì¶œì™„ë£Œ': 'status-info',
                    'í˜„ì¥ì¸ì¦ì˜ˆì •': 'status-warning',
                    'ì¸ì¦ëŒ€ê¸°': 'status-purple'
                }[inv.approvalStatus] || '';
                
                return `
                    <tr>
                        <td>${inv.phone || '-'}</td>
                        <td>${inv.qualifications || '-'}</td>
                        <td>${inv.wineBonus ? 'O' : '-'}</td>
                        <td>${inv.authType || '-'}</td>
                        <td><span class="status ${statusClass}">${inv.approvalStatus || '-'}</span></td>
                        <td>${inv.distributor || '-'}</td>
                        <td>${inv.hasReservation ? '<span class="status status-success">ì˜ˆì•½ì™„ë£Œ</span>' : '<span class="status status-danger">ë¯¸ì˜ˆì•½</span>'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        document.getElementById('invitationSearch')?.addEventListener('input', renderInvitations);
        document.getElementById('invitationStatusFilter')?.addEventListener('change', renderInvitations);
        
        // ========================================
        // ì˜ˆì•½ ê´€ë¦¬ ë Œë”ë§ (FM ì—”íŠ¸ë¦¬ ëª…ë‹¨ ìŠ¤íƒ€ì¼)
        // ========================================
        let currentReservationData = []; // CSV/í…ìŠ¤íŠ¸ ë‚´ë³´ë‚´ê¸°ìš©
        
        function renderReservations() {
            const tbody = document.getElementById('reservationBody');
            const summaryContainer = document.getElementById('reservationSummary');
            const reservations = data.reservations || [];
            
            // ë‚ ì§œ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ì œê±°)
            const dateSelect = document.getElementById('reservationDateFilter');
            const allDates = [...new Set(reservations.map(r => r.eventDate).filter(Boolean))];
            const sortedDates = allDates.sort((a, b) => parsePartyDate(a) - parsePartyDate(b));
            
            // ë¯¸ë˜ ë‚ ì§œë§Œ (1/11 ì´í›„)
            const minDate = new Date(2026, 0, 11);
            const futureDates = sortedDates.filter(d => parsePartyDate(d) >= minDate);
            
            // ë‚ ì§œ ì˜µì…˜ ì—…ë°ì´íŠ¸ (ì •ê·œí™”ëœ í˜•ì‹ìœ¼ë¡œ í‘œì‹œ)
            const currentValue = dateSelect?.value || '';
            if (dateSelect) {
                dateSelect.innerHTML = '<option value="">ğŸ“… ì „ì²´ ë‚ ì§œ</option>' + 
                    futureDates.map(d => `<option value="${d}">${normalizeDateStr(d)}</option>`).join('');
                if (currentValue) dateSelect.value = currentValue;
            }
            
            const search = (document.getElementById('reservationSearch')?.value || '').toLowerCase();
            const dateFilter = dateSelect?.value || '';
            const partFilter = document.getElementById('reservationPartFilter')?.value || '';
            const typeFilter = document.getElementById('reservationTypeFilter')?.value || '';
            
            // ì˜ˆì•½ í•„í„°ë§ (ì·¨ì†Œ ì œì™¸)
            let filtered = reservations.filter(r => r.status !== 'ì·¨ì†Œ');
            
            // ê²€ìƒ‰
            if (search) {
                filtered = filtered.filter(r => {
                    const phone = normalizePhone(r.phone);
                    const customer = (data.customers || []).find(c => normalizePhone(c.id) === phone);
                    const survey = (data.surveys || []).find(s => normalizePhone(s.phone) === phone);
                    const name = customer?.name || survey?.name || '';
                    return (r.crewName || '').toLowerCase().includes(search) ||
                           name.toLowerCase().includes(search) ||
                           (r.phone || '').includes(search);
                });
            }
            
            // ë‚ ì§œ í•„í„° (ì „ì²´ ë‚ ì§œ ì„ íƒ ê°€ëŠ¥) - ì •ê·œí™” ë¹„êµ
            if (dateFilter) {
                filtered = filtered.filter(r => isSameDate(r.eventDate, dateFilter));
            }
            // ì „ì²´ ë‚ ì§œê°€ ì„ íƒë˜ë©´ í•„í„°ë§í•˜ì§€ ì•ŠìŒ
            
            // ì„¸ì…˜ í•„í„°
            if (partFilter) {
                filtered = filtered.filter(r => r.eventPart === partFilter);
            }
            
            // ìœ í˜• í•„í„°
            if (typeFilter === 'invitation') {
                filtered = filtered.filter(r => r.isInvitation === true);
            } else if (typeFilter === 'organic') {
                filtered = filtered.filter(r => !r.isInvitation);
            }
            
            // ë¯¸ë˜ ë‚ ì§œë§Œ í‘œì‹œ
            filtered = filtered.filter(r => {
                const partyDate = parsePartyDate(r.eventDate);
                return partyDate >= minDate;
            });
            
            // ê´€ë ¨ ë°ì´í„° ì¡°ì¸ (customers, surveys, invitations, schedules)
            const lineupData = filtered.map((res, idx) => {
                const phone = normalizePhone(res.phone);
                const customer = (data.customers || []).find(c => normalizePhone(c.id) === phone);
                const survey = (data.surveys || []).find(s => normalizePhone(s.phone) === phone);
                const invitation = (data.invitations || []).find(i => normalizePhone(i.phone) === phone);

                // íŒŒí‹° ì¼ì •ì—ì„œ ì‹œê°„ ì¡°íšŒ (ì—°ë™)
                const schedule = (data.schedules || []).find(s =>
                    isSameDate(s.date, res.eventDate) && s.part === res.eventPart
                );
                const partyTime = schedule?.time || '-';
                const partyType = schedule?.partyType || 'coffee';

                // íŒŒí‹° ì¼ì‹œ ë¬¸ìì—´ ìƒì„±
                const partyDateStr = res.eventDate ? normalizeDateStr(res.eventDate) : '-';
                const partyTimeDisplay = `${partyDateStr} ${partyTime} ${res.eventPart || ''}`;

                // ê²°ì œ ìœ í˜• (ê¸°ë³¸ê°’: frip)
                const paymentType = res.paymentType || 'frip';
                const paymentTypeDisplay = {
                    'frip': 'ğŸ…¿ï¸ í”„ë¦½',
                    'cash': 'ğŸ’µ í˜„ê¸ˆ',
                    'waived': 'ğŸ« ë©´ì œ',
                    'comp': 'ğŸ ë³´ìƒ'
                }[paymentType] || 'ğŸ…¿ï¸ í”„ë¦½';

                // í˜„ì¥ í™•ì¸ í•„ìš” í•­ëª© ì¶”ì¶œ
                let onsiteItems = [];
                if (invitation?.fileLinks) {
                    try {
                        const fieldData = JSON.parse(invitation.fileLinks);
                        Object.entries(fieldData).forEach(([qual, qData]) => {
                            if (qData.authMethod === 'onsite') {
                                onsiteItems.push({ qual, docs: qData.onsiteDocs || '' });
                            }
                        });
                    } catch (e) {}
                }

                // ë‚˜ì´ ê³„ì‚°
                const birthYear = customer?.birth_year || customer?.birthYear || survey?.birth_year || survey?.birthYear;
                const age = birthYear ? (2026 - birthYear) : null;

                // ë‚˜ì´ì¡°ê±´ ì²´í¬
                const ageCondition = getAgeCondition(res.eventDate, res.eventPart);
                const isAgeValid = ageCondition
                    ? checkAgeCondition(birthYear, ageCondition.minBirthYear, ageCondition.maxBirthYear)
                    : true;

                return {
                    index: idx + 1,
                    partyTimeDisplay: partyTimeDisplay,
                    partyTime: partyTime,
                    partyType: partyType,
                    paymentType: paymentType,
                    paymentTypeDisplay: paymentTypeDisplay,
                    paymentNote: res.paymentNote || '',
                    source: res.isInvitation ? 'INV' : 'ORG',
                    name: customer?.name || survey?.name || '-',
                    nickname: res.crewName || '-',
                    gender: customer?.gender || survey?.gender || '-',
                    birthYear: birthYear,
                    age: age || '-',
                    isAgeValid: isAgeValid,
                    height: customer?.height || survey?.height || '-',
                    job: customer?.job_detail || customer?.jobDetail || survey?.job_detail || survey?.jobDetail || customer?.job_category || customer?.jobCategory || survey?.job_category || survey?.jobCategory || '-',
                    qualifications: invitation?.qualifications || '-',
                    onsiteItems: onsiteItems,
                    wineBonus: invitation?.wineBonus ? 'ğŸ·' : '-',
                    hasSurvey: !!survey,
                    phone: res.phone || '-',
                    eventPart: res.eventPart || '-',
                    // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì •ë³´
                    isBlacklisted: customer?.is_blacklisted || false,
                    blacklistReason: customer?.blacklist_reason || '',
                    // ê´€ë¦¬ìš© ë°ì´í„°
                    reservationId: res.id,
                    eventDate: res.eventDate,
                    option: res.option,
                    isInvitation: res.isInvitation,
                    status: res.status
                };
            });
            
            // ì†ŒíŒ… ì ìš©
            if (reservationSortField) {
                lineupData.sort((a, b) => {
                    let valA, valB;
                    switch (reservationSortField) {
                        case 'partyTime':
                            valA = a.partyTimeDisplay;
                            valB = b.partyTimeDisplay;
                            break;
                        case 'paymentType':
                            const paymentOrder = { 'frip': 1, 'cash': 2, 'waived': 3, 'comp': 4 };
                            valA = paymentOrder[a.paymentType] || 0;
                            valB = paymentOrder[b.paymentType] || 0;
                            break;
                        case 'source': valA = a.source; valB = b.source; break;
                        case 'name': valA = a.name; valB = b.name; break;
                        case 'nickname': valA = a.nickname; valB = b.nickname; break;
                        case 'gender': valA = a.gender; valB = b.gender; break;
                        case 'age':
                            valA = a.age === '-' ? 999 : a.age;
                            valB = b.age === '-' ? 999 : b.age;
                            break;
                        case 'height':
                            valA = a.height === '-' ? 0 : parseInt(a.height);
                            valB = b.height === '-' ? 0 : parseInt(b.height);
                            break;
                        case 'job': valA = a.job; valB = b.job; break;
                        case 'onsite':
                            valA = a.onsiteItems.length;
                            valB = b.onsiteItems.length;
                            break;
                        case 'wine':
                            valA = a.wineBonus === 'ğŸ·' ? 1 : 0;
                            valB = b.wineBonus === 'ğŸ·' ? 1 : 0;
                            break;
                        case 'survey':
                            valA = a.hasSurvey ? 1 : 0;
                            valB = b.hasSurvey ? 1 : 0;
                            break;
                        default: valA = ''; valB = '';
                    }
                    
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return reservationSortAsc ? valA - valB : valB - valA;
                    }
                    const strA = String(valA).toLowerCase();
                    const strB = String(valB).toLowerCase();
                    if (strA < strB) return reservationSortAsc ? -1 : 1;
                    if (strA > strB) return reservationSortAsc ? 1 : -1;
                    return 0;
                });
                
                // ì†ŒíŒ… í›„ index ì¬í• ë‹¹
                lineupData.forEach((d, idx) => d.index = idx + 1);
            }
            
            // í˜„ì¬ ë°ì´í„° ì €ì¥ (ë‚´ë³´ë‚´ê¸°ìš©)
            currentReservationData = lineupData;
            
            // í†µê³„ ë Œë”ë§
            const maleCount = lineupData.filter(d => d.gender === 'ë‚¨ì').length;
            const femaleCount = lineupData.filter(d => d.gender === 'ì—¬ì').length;
            const invCount = lineupData.filter(d => d.source === 'INV').length;
            const orgCount = lineupData.filter(d => d.source === 'ORG').length;
            const wineCount = lineupData.filter(d => d.wineBonus === 'ğŸ·').length;
            const onsiteCount = lineupData.filter(d => d.onsiteItems.length > 0).length;
            const surveyDoneCount = lineupData.filter(d => d.hasSurvey).length;
            
            summaryContainer.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 12px; padding: 16px 24px; display: flex; gap: 24px; align-items: center; flex-wrap: wrap;">
                    <div><span style="color: var(--text-muted);">ì´</span> <strong style="font-size: 20px; color: var(--primary);">${lineupData.length}</strong><span style="color: var(--text-muted);">ëª…</span></div>
                    <div style="width: 1px; height: 30px; background: var(--border);"></div>
                    <div><span class="gender-male">â™‚ ${maleCount}ëª…</span></div>
                    <div><span class="gender-female">â™€ ${femaleCount}ëª…</span></div>
                    <div style="width: 1px; height: 30px; background: var(--border);"></div>
                    <div><span style="color: var(--primary);">INV ${invCount}</span></div>
                    <div><span style="color: var(--text-muted);">ì¼ë°˜ ${orgCount}</span></div>
                    <div style="width: 1px; height: 30px; background: var(--border);"></div>
                    <div><span style="color: var(--success);">ì¡°ì‚¬ì™„ë£Œ ${surveyDoneCount}</span></div>
                    ${wineCount > 0 ? `<div>ğŸ· ${wineCount}</div>` : ''}
                    ${onsiteCount > 0 ? `<div style="color: #FFA500;">âš ï¸ í˜„ì¥í™•ì¸ ${onsiteCount}ëª…</div>` : ''}
                </div>
            `;
            
            // í…Œì´ë¸” ë Œë”ë§
            if (lineupData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="empty-state" style="padding: 60px; text-align: center;"><i class="fas fa-users" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px;"></i><br>ì˜ˆì•½ëœ ì°¸ì„ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = lineupData.map(d => {
                const onsiteHtml = d.onsiteItems.length > 0
                    ? `<span style="color: #FFA500; font-size: 11px;" title="${d.onsiteItems.map(i => `${i.qual}: ${i.docs}`).join('\n')}">âš ï¸ ${d.onsiteItems.map(i => i.qual).join(', ')}</span>`
                    : '<span style="color: var(--text-muted);">-</span>';

                const sourceClass = d.source === 'INV' ? 'status-info' : 'status-muted';
                const genderClass = d.gender === 'ë‚¨ì' ? 'gender-male' : d.gender === 'ì—¬ì' ? 'gender-female' : '';
                const surveyClass = d.hasSurvey ? 'status-success' : 'status-warning';
                const surveyLabel = d.hasSurvey ? 'ì™„ë£Œ' : 'ë¯¸ì™„';

                // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
                const blacklistStyle = d.isBlacklisted ? 'background: rgba(255,77,77,0.15);' : '';
                const blacklistIcon = d.isBlacklisted ? `<span style="color: var(--danger);" title="â›” ë¸”ë™ë¦¬ìŠ¤íŠ¸: ${(d.blacklistReason || '').replace(/"/g, '&quot;')}">â›”</span> ` : '';

                // ê²°ì œ ìœ í˜• ìŠ¤íƒ€ì¼
                const paymentClass = {
                    'frip': 'status-info',
                    'cash': 'status-success',
                    'waived': 'status-warning',
                    'comp': 'status-muted'
                }[d.paymentType] || 'status-info';

                // ê´€ë¦¬ìš© ë°ì´í„° JSON (escape ì²˜ë¦¬)
                const resData = JSON.stringify({
                    id: d.reservationId,
                    phone: d.phone,
                    crewName: d.nickname,
                    eventDate: d.eventDate,
                    eventPart: d.eventPart,
                    option: d.option,
                    isInvitation: d.isInvitation,
                    status: d.status,
                    paymentType: d.paymentType,
                    paymentNote: d.paymentNote
                }).replace(/"/g, '&quot;');

                return `
                    <tr style="${blacklistStyle}">
                        <td style="text-align: center; color: var(--text-muted);">${d.index}</td>
                        <td style="font-size: 11px; white-space: nowrap;" title="${d.partyTimeDisplay}">${d.partyTimeDisplay}</td>
                        <td><span class="status ${paymentClass}" style="font-size: 10px;" title="${d.paymentNote || ''}">${d.paymentTypeDisplay}</span></td>
                        <td><span class="status ${sourceClass}" style="font-size: 11px;">${d.source}</span></td>
                        <td style="font-weight: 500; cursor: pointer;" onclick="openCustomerModal('${d.phone}')">${blacklistIcon}${d.name}</td>
                        <td style="color: var(--text-muted);">${d.nickname}</td>
                        <td class="${genderClass}">${d.gender === 'ë‚¨ì' ? 'â™‚' : d.gender === 'ì—¬ì' ? 'â™€' : '-'}</td>
                        <td style="${!d.isAgeValid ? 'color: var(--danger); font-weight: bold;' : ''}">${d.birthYear ? formatBirthYear(d.birthYear) : '-'}${!d.isAgeValid ? ' âš ï¸' : ''}</td>
                        <td>${d.height !== '-' ? d.height : '-'}</td>
                        <td style="max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${d.job}">${d.job}</td>
                        <td style="font-size: 11px; max-width: 80px; overflow: hidden; text-overflow: ellipsis;" title="${d.qualifications}">${d.qualifications}</td>
                        <td>${onsiteHtml}</td>
                        <td style="text-align: center;">${d.wineBonus}</td>
                        <td><span class="status ${surveyClass}" style="font-size: 10px;">${surveyLabel}</span></td>
                        <td style="font-size: 11px; color: var(--text-muted);">${d.phone}</td>
                        <td style="text-align: center;" onclick="event.stopPropagation()">
                            <button class="btn btn-sm" style="padding: 4px 8px; font-size: 11px;" onclick="openEditReservationModal(${resData})" title="ìˆ˜ì •">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="handleDeleteReservation('${d.reservationId}')" title="ì‚­ì œ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function refreshReservations() {
            renderReservations();
            showToast('ì˜ˆì•½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ', 'success');
        }

        // ========================================
        // ì˜ˆì•½ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥
        // ========================================

        // ì˜ˆì•½ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
        function openAddReservationModal() {
            document.getElementById('reservationModalTitle').textContent = 'ì˜ˆì•½ ì¶”ê°€';
            document.getElementById('reservationForm').reset();
            document.getElementById('rf_editId').value = '';
            document.getElementById('rf_paymentType').value = 'frip';
            document.getElementById('rf_paymentNote').value = '';
            document.getElementById('paymentNoteWrapper').style.display = 'none';

            // ë‚ ì§œ ì˜µì…˜ ì±„ìš°ê¸°
            populateReservationDateOptions();

            openModal('reservationModal');
        }

        // ì˜ˆì•½ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openEditReservationModal(res) {
            document.getElementById('reservationModalTitle').textContent = 'ì˜ˆì•½ ìˆ˜ì •';
            document.getElementById('rf_editId').value = res.id || '';
            document.getElementById('rf_phone').value = res.phone || '';
            document.getElementById('rf_crewName').value = res.crewName || '';
            document.getElementById('rf_eventPart').value = res.eventPart || '1ë¶€';
            document.getElementById('rf_option').value = res.option || '';
            document.getElementById('rf_isInvitation').value = res.isInvitation ? 'true' : 'false';
            document.getElementById('rf_status').value = res.status || 'ì˜ˆì•½ì™„ë£Œ';
            document.getElementById('rf_paymentType').value = res.paymentType || 'frip';
            document.getElementById('rf_paymentNote').value = res.paymentNote || '';

            // ê²°ì œ ì‚¬ìœ  í‘œì‹œ/ìˆ¨ê¹€
            togglePaymentNote();

            // ë‚ ì§œ ì˜µì…˜ ì±„ìš°ê¸° í›„ ì„ íƒ
            populateReservationDateOptions(res.eventDate);

            openModal('reservationModal');
        }

        // ê²°ì œ ì‚¬ìœ  ì…ë ¥ì°½ í‘œì‹œ/ìˆ¨ê¹€
        function togglePaymentNote() {
            const paymentType = document.getElementById('rf_paymentType').value;
            const wrapper = document.getElementById('paymentNoteWrapper');
            if (paymentType === 'waived' || paymentType === 'comp') {
                wrapper.style.display = 'block';
            } else {
                wrapper.style.display = 'none';
            }
        }

        // ë‚ ì§œ ì˜µì…˜ ì±„ìš°ê¸°
        function populateReservationDateOptions(selectedDate = '') {
            const select = document.getElementById('rf_eventDate');
            const schedules = data.schedules || [];

            // í™œì„± ì¼ì •ë§Œ í•„í„°ë§í•˜ê³  ì •ë ¬
            const activeSchedules = schedules
                .filter(s => s.isActive !== false)
                .sort((a, b) => {
                    const dateA = parsePartyDate(a.date);
                    const dateB = parsePartyDate(b.date);
                    return dateA - dateB;
                });

            // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
            const dateGroups = {};
            activeSchedules.forEach(s => {
                const dateKey = s.date;
                if (!dateGroups[dateKey]) {
                    dateGroups[dateKey] = [];
                }
                dateGroups[dateKey].push(s);
            });

            let options = '<option value="">ë‚ ì§œ/ì„¸ì…˜ ì„ íƒ</option>';
            Object.keys(dateGroups).forEach(dateKey => {
                dateGroups[dateKey].forEach(s => {
                    const label = `${normalizeDateStr(s.date)} ${s.part} (${s.time})`;
                    const value = `${s.date}|${s.part}`;
                    const selected = selectedDate && selectedDate.includes(dateKey) ? 'selected' : '';
                    options += `<option value="${value}" ${selected}>${label}</option>`;
                });
            });

            select.innerHTML = options;

            // ìˆ˜ì • ëª¨ë“œì—ì„œ ê¸°ì¡´ ë‚ ì§œ ì„ íƒ
            if (selectedDate) {
                // ê¸°ì¡´ ë‚ ì§œì™€ ë§¤ì¹­ë˜ëŠ” ì˜µì…˜ ì°¾ê¸°
                const normalizedSelected = normalizeDateStr(selectedDate);
                Array.from(select.options).forEach(opt => {
                    if (opt.value && normalizeDateStr(opt.value.split('|')[0]) === normalizedSelected) {
                        opt.selected = true;
                    }
                });
            }
        }

        // ì˜ˆì•½ ì €ì¥
        async function saveReservation(event) {
            event.preventDefault();

            const editId = document.getElementById('rf_editId').value;
            const phone = document.getElementById('rf_phone').value.trim();
            const crewName = document.getElementById('rf_crewName').value.trim();
            const eventDateValue = document.getElementById('rf_eventDate').value;
            const eventPart = document.getElementById('rf_eventPart').value;
            const option = document.getElementById('rf_option').value.trim();
            const isInvitation = document.getElementById('rf_isInvitation').value === 'true';
            const status = document.getElementById('rf_status').value;
            const paymentType = document.getElementById('rf_paymentType').value;
            const paymentNote = document.getElementById('rf_paymentNote').value.trim();

            if (!phone || !crewName || !eventDateValue) {
                showToast('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            // ë‚ ì§œ/ì„¸ì…˜ íŒŒì‹±
            let eventDate = eventDateValue;
            let selectedPart = eventPart;
            if (eventDateValue.includes('|')) {
                const [datePart, partPart] = eventDateValue.split('|');
                eventDate = datePart;
                selectedPart = partPart || eventPart;
            }

            // ì˜ˆì•½ ë°ì´í„° êµ¬ì„± (camelCase - DB ì»¬ëŸ¼ëª…ê³¼ ì¼ì¹˜)
            // formatPhoneìœ¼ë¡œ í•˜ì´í”ˆ í¬í•¨ í˜•ì‹ (GASì™€ ë™ì¼í•˜ê²Œ)
            const reservationData = {
                phone: formatPhone(phone),
                crewName: crewName,
                eventDate: eventDate,
                eventPart: selectedPart,
                option: option || `[${selectedPart}] ${isInvitation ? 'ì¸ë¹„í…Œì´ì…˜ íŒ¨ìŠ¤' : 'ì¼ë°˜'}`,
                isInvitation: isInvitation,
                status: status,
                paymentType: paymentType,
                paymentNote: (paymentType === 'waived' || paymentType === 'comp') ? paymentNote : ''
            };

            try {
                if (editId) {
                    // ìˆ˜ì •
                    await supabaseUpdate('reservations', editId, reservationData);
                    showToast('ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                } else {
                    // ì¶”ê°€
                    reservationData.id = 'RES-' + Date.now();
                    await supabaseInsert('reservations', reservationData);
                    showToast('ì˜ˆì•½ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                }

                closeModal('reservationModal');
                await refreshAllData();
                renderReservations();
            } catch (error) {
                console.error('ì˜ˆì•½ ì €ì¥ ì˜¤ë¥˜:', error);
                showToast('ì˜ˆì•½ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì˜ˆì•½ ì‚­ì œ (ë˜í¼ - onclickì—ì„œ í˜¸ì¶œ)
        function handleDeleteReservation(reservationId) {
            deleteReservation(reservationId);
        }

        // ì˜ˆì•½ ì‚­ì œ (ì‹¤ì œ ì²˜ë¦¬)
        async function deleteReservation(reservationId) {
            if (!reservationId || reservationId === 'undefined') {
                showToast('ì˜ˆì•½ IDê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            if (!confirm('ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)')) {
                return;
            }

            try {
                showToast('ì‚­ì œ ì¤‘...', 'info');
                await supabaseDelete('reservations', reservationId);

                // ë¡œì»¬ ë°ì´í„°ì—ì„œ ì¦‰ì‹œ ì œê±°
                if (data.reservations) {
                    data.reservations = data.reservations.filter(r => r.id !== reservationId);
                }

                renderReservations();
                showToast('ì˜ˆì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                console.error('ì˜ˆì•½ ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ì˜ˆì•½ ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ========================================

        // CSV ë‚´ë³´ë‚´ê¸°
        function exportReservationsCSV() {
            if (currentReservationData.length === 0) {
                showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            const headers = ['ë²ˆí˜¸', 'ìœ ì…', 'ì´ë¦„', 'ë‹‰ë„¤ì„', 'ì„±ë³„', 'ë‚˜ì´', 'í‚¤', 'ì§ì—…', 'ìê²©ìœ í˜•', 'í˜„ì¥í™•ì¸', 'ì™€ì¸', 'ì¡°ì‚¬ì™„ë£Œ', 'ì—°ë½ì²˜'];
            const rows = currentReservationData.map(d => [
                d.index,
                d.source,
                d.name,
                d.nickname,
                d.gender,
                d.age,
                d.height,
                d.job,
                d.qualifications,
                d.onsiteItems.map(i => `${i.qual}(${i.docs})`).join('; '),
                d.wineBonus === 'ğŸ·' ? 'Y' : 'N',
                d.hasSurvey ? 'Y' : 'N',
                d.phone
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì˜ˆì•½ëª…ë‹¨_${document.getElementById('reservationDateFilter')?.value || 'ì „ì²´'}.csv`;
            link.click();
            
            showToast('CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
        }
        
        // í…ìŠ¤íŠ¸ ë³µì‚¬ (í˜„ì¥ìš©)
        function copyReservationsText() {
            if (currentReservationData.length === 0) {
                showToast('ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            const dateText = document.getElementById('reservationDateFilter')?.value || 'ì „ì²´';
            const partText = document.getElementById('reservationPartFilter')?.value || 'ì „ì²´';
            
            let text = `ğŸ“‹ ${dateText} ${partText} ì°¸ì„ì ëª…ë‹¨ (${currentReservationData.length}ëª…)\n`;
            text += 'â”'.repeat(40) + '\n\n';
            
            // í˜„ì¥í™•ì¸ í•„ìš”í•œ ì‚¬ëŒ ë¨¼ì €
            const onsiteNeeded = currentReservationData.filter(d => d.onsiteItems.length > 0);
            if (onsiteNeeded.length > 0) {
                text += 'âš ï¸ í˜„ì¥í™•ì¸ í•„ìš” (' + onsiteNeeded.length + 'ëª…)\n';
                text += 'â”€'.repeat(30) + '\n';
                onsiteNeeded.forEach(d => {
                    text += `â€¢ ${d.name} (${d.phone})\n`;
                    d.onsiteItems.forEach(item => {
                        text += `  â”” ${item.qual}: ${item.docs}\n`;
                    });
                });
                text += '\n';
            }
            
            // ì‚¬ì „ì¡°ì‚¬ ë¯¸ì™„ë£Œ
            const surveyNeeded = currentReservationData.filter(d => !d.hasSurvey);
            if (surveyNeeded.length > 0) {
                text += 'ğŸ“ ì‚¬ì „ì¡°ì‚¬ ë¯¸ì™„ë£Œ (' + surveyNeeded.length + 'ëª…)\n';
                text += 'â”€'.repeat(30) + '\n';
                surveyNeeded.forEach(d => {
                    text += `â€¢ ${d.nickname} (${d.phone})\n`;
                });
                text += '\n';
            }
            
            // ì „ì²´ ëª…ë‹¨
            text += 'ğŸ‘¥ ì „ì²´ ëª…ë‹¨\n';
            text += 'â”€'.repeat(30) + '\n';
            currentReservationData.forEach(d => {
                const genderIcon = d.gender === 'ë‚¨ì' ? 'â™‚' : d.gender === 'ì—¬ì' ? 'â™€' : '';
                const surveyIcon = d.hasSurvey ? 'âœ“' : 'âœ—';
                text += `${d.index}. ${d.name} ${genderIcon} ${d.age}ì„¸ | ${d.job} [${surveyIcon}]\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨', 'success');
            }).catch(() => {
                showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
            });
        }
        
        document.getElementById('reservationSearch')?.addEventListener('input', renderReservations);
        document.getElementById('reservationDateFilter')?.addEventListener('change', renderReservations);
        document.getElementById('reservationPartFilter')?.addEventListener('change', renderReservations);
        document.getElementById('reservationTypeFilter')?.addEventListener('change', renderReservations);
        
        // ì˜ˆì•½ ê´€ë¦¬ ì†ŒíŒ…
        let reservationSortField = '';
        let reservationSortAsc = true;
        
        function sortReservations(field) {
            if (reservationSortField === field) {
                reservationSortAsc = !reservationSortAsc;
            } else {
                reservationSortField = field;
                reservationSortAsc = true;
            }
            renderReservations();
        }
        
        // ========================================
        // ê°€ìƒì°¸ì—¬ì ìƒì„± ê·œì¹™ ë Œë”ë§ (ë¹„ìœ¨í‘œ)
        // ========================================
        let virtualRuleSortField = '';
        let virtualRuleSortAsc = true;
        
        function sortVirtualRule(field) {
            if (virtualRuleSortField === field) {
                virtualRuleSortAsc = !virtualRuleSortAsc;
            } else {
                virtualRuleSortField = field;
                virtualRuleSortAsc = true;
            }
            renderVirtualRules();
        }
        
        function renderVirtualRules() {
            const tbody = document.getElementById('virtualRuleBody');
            const genderFilter = document.getElementById('ruleGenderFilter')?.value || '';
            
            let filtered = data.virtual;
            if (genderFilter) {
                filtered = filtered.filter(v => v.gender === genderFilter);
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ìƒì„± ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • íƒ­ì—ì„œ "ê¸°ë³¸ ë°ì´í„° ì´ˆê¸°í™”"ë¥¼ í´ë¦­í•˜ì„¸ìš”.</td></tr>';
                return;
            }
            
            // í‹°ì–´í‘œì—ì„œ í‹°ì–´ ì •ë³´ ê°€ì ¸ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜
            const getTierForRule = (gender, job) => {
                const tier = data.tiers.find(t => t.gender === gender && t.job === job);
                return tier?.tier || '?';
            };
            
            let virtualData = [...filtered];
            
            // ì†ŒíŒ… ì ìš©
            if (virtualRuleSortField) {
                virtualData.sort((a, b) => {
                    let valA, valB;
                    switch (virtualRuleSortField) {
                        case 'gender': valA = a.gender || ''; valB = b.gender || ''; break;
                        case 'job': valA = a.job || ''; valB = b.job || ''; break;
                        case 'tier': 
                            const tierOrder = {'S': 1, 'A': 2, 'B': 3, 'C': 4, '?': 5};
                            valA = tierOrder[getTierForRule(a.gender, a.job)] || 5;
                            valB = tierOrder[getTierForRule(b.gender, b.job)] || 5;
                            break;
                        case 'ratio': valA = parseFloat(a.ratio) || 0; valB = parseFloat(b.ratio) || 0; break;
                        default: valA = ''; valB = '';
                    }
                    
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return virtualRuleSortAsc ? valA - valB : valB - valA;
                    }
                    const strA = String(valA).toLowerCase();
                    const strB = String(valB).toLowerCase();
                    if (strA < strB) return virtualRuleSortAsc ? -1 : 1;
                    if (strA > strB) return virtualRuleSortAsc ? 1 : -1;
                    return 0;
                });
            }
            
            tbody.innerHTML = virtualData.map(v => {
                const tier = getTierForRule(v.gender, v.job);
                const tierClass = tier === '?' ? 'tier-pending' : `tier-${tier}`;
                return `
                <tr>
                    <td class="${v.gender === 'ë‚¨ì' ? 'gender-male' : 'gender-female'}">${v.gender || '-'}</td>
                    <td>${v.job || '-'}</td>
                    <td><span class="tier ${tierClass}">${tier}</span></td>
                    <td><strong>${v.ratio || 0}%</strong></td>
                    <td>${v.minBirthYear || '-'} ~ ${v.maxBirthYear || '-'}</td>
                    <td>${v.minHeight || '-'} ~ ${v.maxHeight || '-'}cm</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editVirtualRule('${v.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteVirtualRule('${v.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
            
            // í‹°ì–´í‘œì™€ ë™ê¸°í™” ì²´í¬: í‹°ì–´í‘œì— ìˆëŠ”ë° ìƒì„±ê·œì¹™ì— ì—†ëŠ” ì§ì—… ê²½ê³ 
            checkTierRuleSync(genderFilter);
        }
        
        // í‹°ì–´í‘œì™€ ìƒì„±ê·œì¹™ ë™ê¸°í™” ì²´í¬
        // ê°€ìƒì°¸ì—¬ì ê·œì¹™ì— ìˆëŠ” ì§ì—…ì´ í‹°ì–´í‘œì— ì—†ìœ¼ë©´ ê²½ê³  (ë°˜ëŒ€ ë°©í–¥ì€ ì •ìƒ)
        function checkTierRuleSync(genderFilter = '') {
            const rulesToCheck = genderFilter ? data.virtual.filter(v => v.gender === genderFilter) : data.virtual;
            const tierJobs = data.tiers.map(t => `${t.gender}|${t.job}`);
            
            // ê°€ìƒì°¸ì—¬ì ê·œì¹™ì— ìˆëŠ” ì§ì—…ì´ í‹°ì–´í‘œì— ì—†ëŠ” ê²½ìš°ë§Œ ê²½ê³ 
            const missingInTiers = rulesToCheck.filter(v => !tierJobs.includes(`${v.gender}|${v.job}`));
            
            // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
            let warningEl = document.getElementById('tierRuleSyncWarning');
            if (!warningEl) {
                // ê²½ê³  ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
                const container = document.querySelector('#tab-virtual .section-header');
                if (container) {
                    warningEl = document.createElement('div');
                    warningEl.id = 'tierRuleSyncWarning';
                    warningEl.style.cssText = 'margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 8px; color: var(--danger);';
                    container.after(warningEl);
                }
            }
            
            if (warningEl) {
                if (missingInTiers.length > 0) {
                    const missingList = missingInTiers.map(v => `${v.gender} - ${v.job}`).join(', ');
                    warningEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>í‹°ì–´í‘œ ë™ê¸°í™” í•„ìš”!</strong> ë‹¤ìŒ ì§ì—…ì´ í‹°ì–´í‘œì— ì—†ìŠµë‹ˆë‹¤: ${missingList}`;
                    warningEl.style.display = 'block';
                } else {
                    warningEl.style.display = 'none';
                }
            }
        }
        
        document.getElementById('ruleGenderFilter')?.addEventListener('change', renderVirtualRules);
        
        // ========================================
        // ìƒì„±ëœ ê°€ìƒì°¸ì—¬ì ë Œë”ë§
        // ========================================
        function renderGeneratedVirtuals() {
            const tbody = document.getElementById('generatedVirtualBody');
            const dateFilter = document.getElementById('generatedDateFilter')?.value || '';
            const partFilter = document.getElementById('generatedPartFilter')?.value || '';
            const genderFilter = document.getElementById('generatedGenderFilter')?.value || '';
            
            let filtered = data.generatedVirtuals;
            
            if (dateFilter) {
                filtered = filtered.filter(v => isSameDate(v.eventDate, dateFilter));
            }
            if (partFilter) {
                filtered = filtered.filter(v => v.eventPart === partFilter);
            }
            if (genderFilter) {
                filtered = filtered.filter(v => v.gender === genderFilter);
            }
            
            // í‹°ì–´ìˆœ ì •ë ¬ (S â†’ A â†’ B)
            filtered = sortByTier(filtered);
            
            const countEl = document.getElementById('generatedCount');
            if (countEl) countEl.textContent = `(${filtered.length}ëª…)`;
            
            if (!tbody) return;
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">ìƒì„±ëœ ê°€ìƒì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            const currentYear = new Date().getFullYear();
            
            tbody.innerHTML = filtered.map((v, idx) => `
                <tr>
                    <td>${v.eventDate || '-'}</td>
                    <td>${v.eventPart || '-'}</td>
                    <td class="${v.gender === 'ë‚¨ì' ? 'gender-male' : 'gender-female'}">${v.gender || '-'}</td>
                    <td>${v.name || '-'}</td>
                    <td>${v.birthYear ? currentYear - v.birthYear : '-'}</td>
                    <td>${v.height || '-'}cm</td>
                    <td>${v.job || '-'}</td>
                    <td><span class="tier tier-${v.tier}">${v.tier || '-'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteGeneratedVirtual('${v.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        document.getElementById('generatedDateFilter')?.addEventListener('change', renderGeneratedVirtuals);
        document.getElementById('generatedPartFilter')?.addEventListener('change', renderGeneratedVirtuals);
        document.getElementById('generatedGenderFilter')?.addEventListener('change', renderGeneratedVirtuals);
        
        // ========================================
        // í‹°ì–´ ê¸°ë°˜ ì •ë ¬ í•¨ìˆ˜ (ì „ì—­ ì‚¬ìš©)
        // ========================================
        function getTierOrder(gender, job) {
            const tierEntry = data.tiers.find(t => t.gender === gender && t.job === job);
            if (!tierEntry) return 99; // í‹°ì–´ ì—†ìœ¼ë©´ ë§¨ ë’¤
            switch (tierEntry.tier) {
                case 'S': return 1;
                case 'A': return 2;
                case 'B': return 3;
                case 'C': return 4;
                default: return 99;
            }
        }
        
        function getTier(gender, job) {
            const tierEntry = data.tiers.find(t => t.gender === gender && t.job === job);
            return tierEntry?.tier || 'B';
        }
        
        function sortByTier(list) {
            return [...list].sort((a, b) => {
                // ì •ë³´í™•ì¸ì¤‘(ë¯¸ê³µê°œ)ì€ ë§¨ ë’¤ë¡œ
                const aIsPending = (a.type === 'virtual' && !a.isRevealed) || (a.type === 'real' && !a.hasSurvey);
                const bIsPending = (b.type === 'virtual' && !b.isRevealed) || (b.type === 'real' && !b.hasSurvey);
                
                if (aIsPending && !bIsPending) return 1;
                if (!aIsPending && bIsPending) return -1;
                
                // ë‘˜ ë‹¤ ê³µê°œëê±°ë‚˜ ë‘˜ ë‹¤ ë¯¸ê³µê°œë©´ í‹°ì–´ìˆœ
                const tierA = getTierOrder(a.gender, a.job);
                const tierB = getTierOrder(b.gender, b.job);
                return tierA - tierB;
            });
        }
        
        // ========================================
        // ê°€ìƒì°¸ì—¬ì ìë™ ìƒì„±
        // ========================================
        function updateVirtualDateFilters() {
            // party_schedulesì—ì„œ í™œì„±í™”ëœ ë‚ ì§œ ì¶”ì¶œ
            const scheduleDates = data.schedules
                .filter(s => s.isActive !== false)
                .map(s => formatDateKorean(s.date))
                .filter(Boolean);
            
            // ì˜ˆì•½ ë°ì´í„°ì—ì„œ ë‚ ì§œ ì¶”ì¶œ (ìŠ¤ì¼€ì¤„ì— ì—†ëŠ” ë‚ ì§œê°€ ìˆì„ ê²½ìš°)
            const reservationDates = data.reservations
                .map(r => {
                    const match = r.eventDate?.match(/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
                    if (match) return `${match[1]}ë…„ ${match[2]}ì›” ${match[3]}ì¼`;
                    return null;
                })
                .filter(Boolean);
            
            // ìµœì†Œ ë‚ ì§œ í•„í„°ë§ ì¶”ê°€
            const allDates = [...new Set([...scheduleDates, ...reservationDates])]
                .filter(d => isDateAfterMin(d));
            
            // ë‚ ì§œ ì •ë ¬
            allDates.sort((a, b) => {
                const dateA = parseDateForComparison(a) || '';
                const dateB = parseDateForComparison(b) || '';
                return dateA.localeCompare(dateB);
            });
            
            // ìƒì„±ìš© ë‚ ì§œ í•„í„°
            const genDateSelect = document.getElementById('virtualGenDate');
            if (genDateSelect) {
                genDateSelect.innerHTML = '<option value="">ë‚ ì§œ ì„ íƒ</option>' + 
                    allDates.map(d => `<option value="${d}">${d}</option>`).join('');
            }
            
            // ìƒì„±ëœ ê°€ìƒì°¸ì—¬ìì—ì„œ ë‚ ì§œ ì¶”ì¶œ (ìµœì†Œ ë‚ ì§œ í•„í„°ë§)
            const genDates = [...new Set(data.generatedVirtuals.map(v => formatDateKorean(v.eventDate)).filter(Boolean))]
                .filter(d => isDateAfterMin(d));
            genDates.sort((a, b) => {
                const dateA = parseDateForComparison(a) || '';
                const dateB = parseDateForComparison(b) || '';
                return dateA.localeCompare(dateB);
            });
            
            const genFilterSelect = document.getElementById('generatedDateFilter');
            if (genFilterSelect) {
                genFilterSelect.innerHTML = '<option value="">ì „ì²´ ë‚ ì§œ</option>' + 
                    genDates.map(d => `<option value="${d}">${d}</option>`).join('');
            }
        }
        
        async function generateVirtuals(gender) {
            const eventDate = document.getElementById('virtualGenDate').value;
            const eventPart = document.getElementById('virtualGenPart').value;
            const count = gender === 'ë‚¨ì' 
                ? parseInt(document.getElementById('virtualGenMale').value) || 0
                : parseInt(document.getElementById('virtualGenFemale').value) || 0;
            
            if (!eventDate) {
                showToast('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            if (!eventPart) {
                showToast('ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            if (count <= 0) {
                showToast('ìƒì„±í•  ì¸ì› ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            // í•´ë‹¹ ì„±ë³„ì˜ ìƒì„± ê·œì¹™ ê°€ì ¸ì˜¤ê¸°
            const rules = data.virtual.filter(v => v.gender === gender);
            if (rules.length === 0) {
                showToast(`${gender} ìƒì„± ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ì´ˆê¸°í™”í•˜ì„¸ìš”.`, 'error');
                return;
            }
            
            showToast(`${gender} ${count}ëª… ìƒì„± ì¤‘...`, 'info');
            
            // ë¹„ìœ¨ì— ë”°ë¼ ì¸ì› ë°°ë¶„
            const totalRatio = rules.reduce((sum, r) => sum + (r.ratio || 0), 0);
            const distribution = [];
            let remaining = count;
            
            rules.forEach((rule, idx) => {
                if (idx === rules.length - 1) {
                    // ë§ˆì§€ë§‰ì€ ë‚˜ë¨¸ì§€ ì „ë¶€
                    distribution.push({ rule, count: remaining });
                } else {
                    const ruleCount = Math.round(count * (rule.ratio / totalRatio));
                    distribution.push({ rule, count: ruleCount });
                    remaining -= ruleCount;
                }
            });
            
            // ê°€ìƒ ì´ë¦„ ìƒì„±ìš©
            const lastNames = ['ê¹€', 'ì´', 'ë°•', 'ìµœ', 'ì •', 'ê°•', 'ì¡°', 'ìœ¤', 'ì¥', 'ì„', 'í•œ', 'ì˜¤', 'ì„œ', 'ì‹ ', 'ê¶Œ'];
            const maleNames = ['ë¯¼ì¤€', 'ì„œì¤€', 'ë„ìœ¤', 'ì˜ˆì¤€', 'ì‹œìš°', 'í•˜ì¤€', 'ì£¼ì›', 'ì§€í˜¸', 'ì¤€ì„œ', 'í˜„ìš°', 'ë„í˜„', 'ê±´ìš°'];
            const femaleNames = ['ì„œì—°', 'ì„œìœ¤', 'ì§€ìš°', 'ë¯¼ì„œ', 'í•˜ì€', 'í•˜ìœ¤', 'ìœ¤ì„œ', 'ì§€ë¯¼', 'ì±„ì›', 'ìˆ˜ì•„', 'ì§€ì•„', 'ì˜ˆì€'];
            
            const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
            
            // ê°€ìƒì°¸ì—¬ì ìƒì„± ë° ì €ì¥
            let successCount = 0;
            
            for (const { rule, count: ruleCount } of distribution) {
                for (let i = 0; i < ruleCount; i++) {
                    const firstName = gender === 'ë‚¨ì' ? rand(maleNames) : rand(femaleNames);
                    const name = `${rand(lastNames)}${firstName}`;
                    const birthYear = randInt(rule.minBirthYear || 1990, rule.maxBirthYear || 2000);
                    const height = randInt(rule.minHeight || 160, rule.maxHeight || 180);
                    const tier = getTier(gender, rule.job);
                    
                    const virtualPerson = {
                        event_date: eventDate,
                        event_part: eventPart,
                        gender,
                        name,
                        birth_year: birthYear,
                        height,
                        job: rule.job,
                        tier
                    };
                    
                    try {
                        const res = await fetch(`${API_BASE}/generated_virtuals`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify(virtualPerson)
                        });
                        if (res.ok) successCount++;
                    } catch (e) {
                        console.error('ìƒì„± ì˜¤ë¥˜:', e);
                    }
                }
            }
            
            showToast(`âœ… ${gender} ${successCount}ëª… ìƒì„± ì™„ë£Œ!`, 'success');
            await refreshAllData();
        }
        
        // ========================================
        // ê°€ìƒì°¸ì—¬ì í’€ ê´€ë¦¬ (ì‹ ê·œ)
        // ========================================
        
        // ê°€ìƒì°¸ì—¬ì í’€ 500ëª… ìƒì„±
        async function generateVirtualPool(count = 500) {
            if (data.virtualPool.length > 0) {
                if (!confirm(`ì´ë¯¸ ${data.virtualPool.length}ëª…ì´ ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ í’€ì„ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
                // ê¸°ì¡´ í’€ ì‚­ì œ (ë³‘ë ¬)
                showToast('ê¸°ì¡´ í’€ ì‚­ì œ ì¤‘...', 'info');
                await Promise.all(data.virtualPool.map(v => 
                    fetch(`${API_BASE}/${TB.VIRTUAL_POOL}/${v.id}`, { method: 'DELETE' }).catch(() => {})
                ));
            }
            
            showToast(`ê°€ìƒì°¸ì—¬ì í’€ ${count}ëª… ìƒì„± ì¤‘... (ì•½ 10ì´ˆ ì†Œìš”)`, 'info');
            
            // ë‚¨ë…€ ë¹„ìœ¨ 1:1
            const maleCount = Math.floor(count / 2);
            const femaleCount = count - maleCount;
            
            // ìƒì„± ê·œì¹™ ê°€ì ¸ì˜¤ê¸°
            const maleRules = data.virtual.filter(v => v.gender === 'ë‚¨ì');
            const femaleRules = data.virtual.filter(v => v.gender === 'ì—¬ì');
            
            if (maleRules.length === 0 || femaleRules.length === 0) {
                showToast('ìƒì„± ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ì´ˆê¸°í™”í•˜ì„¸ìš”.', 'error');
                return;
            }
            
            const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            
            // ë°ì´í„° ë¨¼ì € ëª¨ë‘ ìƒì„±
            function generatePersons(gender, totalCount, rules) {
                const totalRatio = rules.reduce((sum, r) => sum + (r.ratio || 0), 0);
                const persons = [];
                let remaining = totalCount;
                
                for (let i = 0; i < rules.length; i++) {
                    const rule = rules[i];
                    const ruleCount = (i === rules.length - 1) 
                        ? remaining 
                        : Math.round(totalCount * (rule.ratio / totalRatio));
                    remaining -= ruleCount;
                    
                    for (let j = 0; j < ruleCount; j++) {
                        persons.push({
                            gender,
                            birth_year: randInt(rule.minBirthYear || 1990, rule.maxBirthYear || 2000),
                            height: randInt(rule.minHeight || 160, rule.maxHeight || 180),
                            job: rule.job,
                            tier: getTier(gender, rule.job),
                            is_active: true,
                            usage_count: 0
                        });
                    }
                }
                return persons;
            }
            
            const malePersons = generatePersons('ë‚¨ì', maleCount, maleRules);
            const femalePersons = generatePersons('ì—¬ì', femaleCount, femaleRules);
            const allPersons = [...malePersons, ...femalePersons];
            
            // ë³‘ë ¬ë¡œ API í˜¸ì¶œ (50ê°œì”© ë°°ì¹˜)
            const batchSize = 50;
            let successCount = 0;
            
            for (let i = 0; i < allPersons.length; i += batchSize) {
                const batch = allPersons.slice(i, i + batchSize);
                const results = await Promise.all(batch.map(person =>
                    fetch(`${API_BASE}/${TB.VIRTUAL_POOL}`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(person)
                    }).then(res => res.ok ? 1 : 0).catch(() => 0)
                ));
                successCount += results.reduce((a, b) => a + b, 0);
            }
            
            showToast(`âœ… ê°€ìƒì°¸ì—¬ì í’€ ìƒì„± ì™„ë£Œ! (${successCount}ëª…)`, 'success');
            await refreshAllData();
            updatePoolStats();
        }
        
        function updatePoolStats() {
            const pool = data.virtualPool || [];
            const males = pool.filter(p => p.gender === 'ë‚¨ì');
            const females = pool.filter(p => p.gender === 'ì—¬ì');
            const sTier = pool.filter(p => p.tier === 'S');
            
            console.log('=== í’€ í†µê³„ ì—…ë°ì´íŠ¸ ===');
            console.log('data.virtualPool ê¸¸ì´:', pool.length);
            console.log('ë‚¨ì:', males.length, 'ì—¬ì:', females.length, 'Sí‹°ì–´:', sTier.length);
            
            const totalEl = document.getElementById('poolTotalCount');
            const maleEl = document.getElementById('poolMaleCount');
            const femaleEl = document.getElementById('poolFemaleCount');
            const sTierEl = document.getElementById('poolSTierCount');
            const countEl = document.getElementById('poolCount');
            
            if (totalEl) totalEl.textContent = pool.length;
            if (maleEl) maleEl.textContent = males.length;
            if (femaleEl) femaleEl.textContent = females.length;
            if (sTierEl) sTierEl.textContent = sTier.length;
            if (countEl) countEl.textContent = `(${pool.length}ëª…)`;
        }
        
        function refreshVirtualPool() {
            updatePoolStats();
            renderVirtualPool();
            renderAssignments();
            showToast('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ', 'success');
        }
        
        // í’€ í…Œì´ë¸” ì†ŒíŒ… ìƒíƒœ
        let poolSortField = '';
        let poolSortAsc = true;
        
        function sortPoolTable(field) {
            if (poolSortField === field) {
                poolSortAsc = !poolSortAsc;
            } else {
                poolSortField = field;
                poolSortAsc = true;
            }
            // ì†ŒíŒ… ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            ['name', 'gender', 'birthYear', 'height', 'job', 'tier', 'usageCount'].forEach(f => {
                const span = document.getElementById(`poolSort_${f}`);
                if (span) span.textContent = (f === field) ? (poolSortAsc ? 'â–²' : 'â–¼') : '';
            });
            renderVirtualPool();
        }
        
        // ë°°ì • í…Œì´ë¸” ì†ŒíŒ… ìƒíƒœ
        let assignSortField = '';
        let assignSortAsc = true;
        
        function sortAssignedTable(field) {
            if (assignSortField === field) {
                assignSortAsc = !assignSortAsc;
            } else {
                assignSortField = field;
                assignSortAsc = true;
            }
            // ì†ŒíŒ… ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            ['scheduleDate', 'schedulePart', 'gender', 'birthYear', 'height', 'job', 'tier', 'isRevealed'].forEach(f => {
                const span = document.getElementById(`assignSort_${f}`);
                if (span) span.textContent = (f === field) ? (assignSortAsc ? 'â–²' : 'â–¼') : '';
            });
            renderAssignments();
        }
        
        // ê°€ìƒì°¸ì—¬ì í’€ ëª©ë¡ ë Œë”ë§
        function renderVirtualPool() {
            const pool = data.virtualPool || [];
            const tbody = document.getElementById('virtualPoolBody');
            const countSpan = document.getElementById('poolListCount');
            const jobFilter = document.getElementById('poolJobFilter');
            
            // ì§ì—… í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
            const jobs = [...new Set(pool.map(p => p.job))].sort();
            if (jobFilter) {
                const currentValue = jobFilter.value;
                jobFilter.innerHTML = '<option value="">ì „ì²´ ì§ì—…</option>' + 
                    jobs.map(j => `<option value="${j}">${j}</option>`).join('');
                jobFilter.value = currentValue;
            }
            
            // í•„í„° ì ìš©
            const genderFilter = document.getElementById('poolGenderFilter')?.value || '';
            const tierFilter = document.getElementById('poolTierFilter')?.value || '';
            const jobFilterValue = jobFilter?.value || '';
            
            let filtered = pool;
            if (genderFilter) filtered = filtered.filter(p => p.gender === genderFilter);
            if (tierFilter) filtered = filtered.filter(p => p.tier === tierFilter);
            if (jobFilterValue) filtered = filtered.filter(p => p.job === jobFilterValue);
            
            // ì •ë ¬ ì ìš© (ì‚¬ìš©ì ì†ŒíŒ… ë˜ëŠ” ê¸°ë³¸ê°’)
            if (poolSortField) {
                filtered.sort((a, b) => {
                    let valA, valB;
                    const tierOrder = { 'S': 0, 'A': 1, 'B': 2 };
                    switch (poolSortField) {
                        case 'name': valA = a.name || ''; valB = b.name || ''; break;
                        case 'gender': valA = a.gender || ''; valB = b.gender || ''; break;
                        case 'birthYear': valA = a.birthYear || 0; valB = b.birthYear || 0; break;
                        case 'height': valA = a.height || 0; valB = b.height || 0; break;
                        case 'job': valA = a.job || ''; valB = b.job || ''; break;
                        case 'tier': valA = tierOrder[a.tier] ?? 2; valB = tierOrder[b.tier] ?? 2; break;
                        case 'usageCount': valA = a.usageCount || 0; valB = b.usageCount || 0; break;
                        default: valA = ''; valB = '';
                    }
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return poolSortAsc ? valA - valB : valB - valA;
                    }
                    const strA = String(valA).toLowerCase();
                    const strB = String(valB).toLowerCase();
                    if (strA < strB) return poolSortAsc ? -1 : 1;
                    if (strA > strB) return poolSortAsc ? 1 : -1;
                    return 0;
                });
            } else {
                // ê¸°ë³¸ ì •ë ¬: í‹°ì–´ìˆœ (S > A > B), ì„±ë³„, ë‚˜ì´
                filtered.sort((a, b) => {
                    const tierOrder = { 'S': 0, 'A': 1, 'B': 2 };
                    if (tierOrder[a.tier] !== tierOrder[b.tier]) return tierOrder[a.tier] - tierOrder[b.tier];
                    if (a.gender !== b.gender) return a.gender === 'ë‚¨ì' ? -1 : 1;
                    return (b.birthYear || 0) - (a.birthYear || 0);
                });
            }
            
            // ìµœëŒ€ 100ê°œê¹Œì§€ë§Œ í‘œì‹œ (ì„±ëŠ¥)
            const displayPool = filtered.slice(0, 200);
            
            if (countSpan) {
                countSpan.textContent = `(${filtered.length}ëª…${filtered.length > 200 ? ', ìƒìœ„ 200ëª… í‘œì‹œ' : ''})`;
            }
            
            if (!tbody) return;
            
            if (displayPool.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="empty-state">ê°€ìƒì°¸ì—¬ì í’€ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }
            
            tbody.innerHTML = displayPool.map(p => {
                const displayName = p.name || `ê°€ìƒ${String(p.id).slice(-4)}`;
                return `
                    <tr>
                        <td><input type="checkbox" class="pool-select" value="${p.id}"></td>
                        <td>${displayName}</td>
                        <td><span class="gender-${p.gender === 'ë‚¨ì' ? 'male' : 'female'}">${p.gender}</span></td>
                        <td>${formatBirthYear(p.birthYear)}</td>
                        <td>${p.height || '-'}cm</td>
                        <td>${p.job || '-'}</td>
                        <td><span class="tier-badge tier-${p.tier || 'B'}">${p.tier || 'B'}</span></td>
                        <td>${p.usageCount || 0}íšŒ</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="openEditPoolModal('${p.id}')" title="ìˆ˜ì •">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFromPool('${p.id}')" title="ì‚­ì œ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ì „ì²´ ì„ íƒ í† ê¸€
        function toggleSelectAllPool() {
            const checkboxes = document.querySelectorAll('.pool-select');
            const allCheck = document.getElementById('poolSelectAll');
            const newState = allCheck ? !allCheck.checked : true;
            
            checkboxes.forEach(cb => cb.checked = newState);
            if (allCheck) allCheck.checked = newState;
        }
        
        // Nëª… ì¶”ê°€ ìƒì„±
        // ì¤‘ë³µ í´ë¦­ ë°©ì§€ í”Œë˜ê·¸
        let isGeneratingPool = false;
        
        async function addToVirtualPool() {
            // ì¤‘ë³µ í´ë¦­ ë°©ì§€
            if (isGeneratingPool) {
                showToast('ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            isGeneratingPool = true;
            
            try {
                const count = parseInt(document.getElementById('poolAddCount')?.value) || 50;
                const poolMinYear = parseInt(document.getElementById('poolMinBirthYear')?.value) || 1987;
                const poolMaxYear = parseInt(document.getElementById('poolMaxBirthYear')?.value) || 2002;
                
                console.log('=== ê°€ìƒì°¸ì—¬ì ìƒì„± ì‹œì‘ ===');
                console.log('ì…ë ¥ê°’:', { count, poolMinYear, poolMaxYear });
                
                if (count < 1 || count > 1000) {
                    showToast('1~1000 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                    return;
                }
                
                if (poolMinYear > poolMaxYear) {
                    showToast('ì¶œìƒì—°ë„ ë²”ìœ„ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                showToast(`ê°€ìƒì°¸ì—¬ì ${count}ëª… ìƒì„± ì¤‘... (ë²„íŠ¼ ë‹¤ì‹œ ëˆ„ë¥´ì§€ ë§ˆì„¸ìš”)`, 'info');
                
                // ê°„ë‹¨í•œ ëœë¤ í•¨ìˆ˜
                const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
                
                // DBì—ì„œ ìƒì„± ê·œì¹™ ê°€ì ¸ì˜¤ê¸° (virtual_participants)
                const maleRules = (data.virtual || []).filter(r => r.gender === 'ë‚¨ì' && r.ratio > 0);
                const femaleRules = (data.virtual || []).filter(r => r.gender === 'ì—¬ì' && r.ratio > 0);
                
                // ë¹„ìœ¨ í•©ê³„ ê³„ì‚°
                const maleRatioSum = maleRules.reduce((sum, r) => sum + (parseFloat(r.ratio) || 0), 0);
                const femaleRatioSum = femaleRules.reduce((sum, r) => sum + (parseFloat(r.ratio) || 0), 0);
                
                console.log('ë‚¨ì ê·œì¹™:', maleRules.length, 'ê°œ, ë¹„ìœ¨ í•©ê³„:', maleRatioSum);
                console.log('ì—¬ì ê·œì¹™:', femaleRules.length, 'ê°œ, ë¹„ìœ¨ í•©ê³„:', femaleRatioSum);
                
                // ê·œì¹™ ì²´í¬
                if (maleRules.length === 0 && femaleRules.length === 0) {
                    showToast('ìƒì„± ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • íƒ­ì—ì„œ ê·œì¹™ì„ ì¶”ê°€í•˜ì„¸ìš”.', 'error');
                    return;
                }
                
                // ì§ì—…ì—ì„œ í‹°ì–´ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
                const getTierForJob = (gender, job) => {
                    const tier = (data.tiers || []).find(t => t.gender === gender && t.job === job);
                    return tier?.tier || 'B';
                };
                
                // ë¹„ìœ¨ ê¸°ë°˜ìœ¼ë¡œ ì§ì—… ì„ íƒ í•¨ìˆ˜
                const selectJobByRatio = (rules, ratioSum, fallbackMinYear, fallbackMaxYear) => {
                    const random = Math.random() * ratioSum;
                    let cumulative = 0;
                    
                    for (const rule of rules) {
                        cumulative += parseFloat(rule.ratio) || 0;
                        if (random <= cumulative) {
                            // ê·œì¹™ì— ë‚˜ì´/í‚¤ ì¡°ê±´ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ í’€ ìƒì„± UI ì…ë ¥ê°’ ì‚¬ìš©
                            const minYear = rule.minBirthYear || fallbackMinYear;
                            const maxYear = rule.maxBirthYear || fallbackMaxYear;
                            const minHeight = rule.minHeight || (rule.gender === 'ë‚¨ì' ? 173 : 158);
                            const maxHeight = rule.maxHeight || (rule.gender === 'ë‚¨ì' ? 183 : 170);
                            
                            return {
                                job: rule.job,
                                tier: getTierForJob(rule.gender, rule.job),
                                minBirthYear: minYear,
                                maxBirthYear: maxYear,
                                minHeight: minHeight,
                                maxHeight: maxHeight
                            };
                        }
                    }
                    
                    // í´ë°± (ë§ˆì§€ë§‰ ê·œì¹™)
                    const lastRule = rules[rules.length - 1];
                    return {
                        job: lastRule.job,
                        tier: getTierForJob(lastRule.gender, lastRule.job),
                        minBirthYear: lastRule.minBirthYear || fallbackMinYear,
                        maxBirthYear: lastRule.maxBirthYear || fallbackMaxYear,
                        minHeight: lastRule.minHeight || (lastRule.gender === 'ë‚¨ì' ? 173 : 158),
                        maxHeight: lastRule.maxHeight || (lastRule.gender === 'ë‚¨ì' ? 183 : 170)
                    };
                };
                
                // ì´ë¦„ ëª©ë¡
                const lastNames = ['ê¹€', 'ì´', 'ë°•', 'ìµœ', 'ì •', 'ê°•', 'ì¡°', 'ìœ¤', 'ì¥', 'ì„'];
                const maleFirstNames = ['ë¯¼ì¤€', 'ì„œì¤€', 'ì˜ˆì¤€', 'ë„ìœ¤', 'ì‹œìš°', 'ì£¼ì›', 'í•˜ì¤€', 'ì§€í˜¸', 'ì¤€ì„œ', 'ì¤€ìš°'];
                const femaleFirstNames = ['ì„œì—°', 'ì„œìœ¤', 'ì§€ìš°', 'ì„œí˜„', 'ë¯¼ì„œ', 'í•˜ì€', 'í•˜ìœ¤', 'ìœ¤ì„œ', 'ì§€ìœ ', 'ì±„ì›'];
                
                // ë°ì´í„° ìƒì„± - ë‚¨ë…€ ë²ˆê°ˆì•„ ìƒì„±
                const allPersons = [];
                const maleCount = Math.floor(count / 2);
                const femaleCount = count - maleCount;
                const maxCount = Math.max(maleCount, femaleCount);
                
                console.log(`ë‚¨ë…€ ë¶„ë°°: ë‚¨ì ${maleCount}ëª…, ì—¬ì ${femaleCount}ëª…`);
                
                // ë‚¨ë…€ ë²ˆê°ˆì•„ ìƒì„± (APIê°€ ìµœê·¼ 100ê°œë§Œ ë°˜í™˜í•´ë„ ë‚¨ë…€ ì„ì´ë„ë¡)
                for (let i = 0; i < maxCount; i++) {
                    // ë‚¨ì ìƒì„± (ê·œì¹™ ìˆì„ ë•Œë§Œ)
                    if (i < maleCount && maleRules.length > 0) {
                        const selected = selectJobByRatio(maleRules, maleRatioSum, poolMinYear, poolMaxYear);
                        allPersons.push({
                            name: lastNames[rand(0, 9)] + maleFirstNames[rand(0, 9)],
                            gender: 'ë‚¨ì',
                            birth_year: rand(selected.minBirthYear, selected.maxBirthYear),
                            height: rand(selected.minHeight, selected.maxHeight),
                            job: selected.job,
                            tier: selected.tier,
                            is_active: true,
                            usage_count: 0
                        });
                    }
                    
                    // ì—¬ì ìƒì„± (ê·œì¹™ ìˆì„ ë•Œë§Œ)
                    if (i < femaleCount && femaleRules.length > 0) {
                        const selected = selectJobByRatio(femaleRules, femaleRatioSum, poolMinYear, poolMaxYear);
                        allPersons.push({
                            name: lastNames[rand(0, 9)] + femaleFirstNames[rand(0, 9)],
                            gender: 'ì—¬ì',
                            birth_year: rand(selected.minBirthYear, selected.maxBirthYear),
                            height: rand(selected.minHeight, selected.maxHeight),
                            job: selected.job,
                            tier: selected.tier,
                            is_active: true,
                            usage_count: 0
                        });
                    }
                }
                
                console.log('ìƒì„±ëœ ë°ì´í„°:', allPersons.length, 'ê°œ');
                console.log('ë‚¨ì ìˆ˜:', allPersons.filter(p => p.gender === 'ë‚¨ì').length);
                console.log('ì—¬ì ìˆ˜:', allPersons.filter(p => p.gender === 'ì—¬ì').length);
                console.log('Sí‹°ì–´ ìˆ˜:', allPersons.filter(p => p.tier === 'S').length);
                
                // API í˜¸ì¶œ (ìˆœì°¨ì ìœ¼ë¡œ - ì•ˆì •ì„± í™•ë³´)
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < allPersons.length; i++) {
                    try {
                        const res = await fetch(`${API_BASE}/${TB.VIRTUAL_POOL}`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify(allPersons[i])
                        });
                        
                        if (res.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                            const errText = await res.text();
                            console.error(`[${i+1}] API ì˜¤ë¥˜:`, res.status, errText);
                        }
                    } catch (e) {
                        errorCount++;
                        console.error(`[${i+1}] ìš”ì²­ ì‹¤íŒ¨:`, e.message);
                    }
                    
                    // 20ê°œë§ˆë‹¤ ì§„í–‰ìƒí™© ë¡œê·¸ ë° UI ì—…ë°ì´íŠ¸
                    if ((i + 1) % 20 === 0) {
                        console.log(`ì§„í–‰: ${i+1}/${allPersons.length} (ì„±ê³µ: ${successCount})`);
                        showToast(`ìƒì„± ì¤‘... ${i+1}/${allPersons.length} (${Math.round((i+1)/allPersons.length*100)}%)`, 'info');
                    }
                }
                
                console.log('=== ìƒì„± ì™„ë£Œ ===');
                console.log(`ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${errorCount}`);
                
                // ì‹¤ì œ ìƒì„±ëœ ë‚¨/ì—¬ ìˆ˜ ê³„ì‚°
                const actualMale = allPersons.filter(p => p.gender === 'ë‚¨ì').length;
                const actualFemale = allPersons.filter(p => p.gender === 'ì—¬ì').length;
                const actualSTier = allPersons.filter(p => p.tier === 'S').length;
                
                console.log(`ì‹¤ì œ ìƒì„±: ë‚¨ì ${actualMale}ëª…, ì—¬ì ${actualFemale}ëª…, Sí‹°ì–´ ${actualSTier}ëª…`);
                
                if (successCount > 0) {
                    showToast(`âœ… ${successCount}ëª… ì¶”ê°€ ì™„ë£Œ! (ë‚¨ì ${actualMale}, ì—¬ì ${actualFemale}, Sí‹°ì–´ ${actualSTier})`, 'success');
                } else {
                    showToast(`âŒ ìƒì„± ì‹¤íŒ¨. ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì„¸ìš”.`, 'error');
                }
                
                await refreshAllData();
                updatePoolStats();
                renderVirtualPool();
            } finally {
                isGeneratingPool = false;
            }
        }
        
        // ì„ íƒ ì‚­ì œ
        async function deleteSelectedFromPool() {
            const selected = Array.from(document.querySelectorAll('.pool-select:checked')).map(cb => cb.value);
            
            if (selected.length === 0) {
                showToast('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.', 'warning');
                return;
            }
            
            if (!confirm(`ì„ íƒí•œ ${selected.length}ëª…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            showToast(`${selected.length}ëª… ì‚­ì œ ì¤‘...`, 'info');
            
            // ë³‘ë ¬ë¡œ ì‚­ì œ
            await Promise.all(selected.map(id =>
                fetch(`${API_BASE}/${TB.VIRTUAL_POOL}/${id}`, { method: 'DELETE' }).catch(() => {})
            ));
            
            showToast(`âœ… ${selected.length}ëª… ì‚­ì œ ì™„ë£Œ!`, 'success');
            await refreshAllData();
            updatePoolStats();
            renderVirtualPool();
        }
        
        // ê°œë³„ ì‚­ì œ
        async function deleteFromPool(id) {
            if (!confirm('ì´ ê°€ìƒì°¸ì—¬ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await fetch(`${API_BASE}/${TB.VIRTUAL_POOL}/${id}`, { method: 'DELETE' });
                showToast('ì‚­ì œ ì™„ë£Œ', 'success');
                await refreshAllData();
                updatePoolStats();
                renderVirtualPool();
            } catch (e) {
                showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        }
        
        // í’€ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openEditPoolModal(id) {
            const person = data.virtualPool.find(p => p.id === id);
            if (!person) {
                showToast('ê°€ìƒì°¸ì—¬ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            document.getElementById('poolEditId').value = id;
            document.getElementById('poolEditName').value = person.name || '';
            document.getElementById('poolEditGender').value = person.gender || 'ë‚¨ì';
            document.getElementById('poolEditBirthYear').value = person.birthYear || 1995;
            document.getElementById('poolEditHeight').value = person.height || 170;
            document.getElementById('poolEditTier').value = person.tier || 'B';
            document.getElementById('poolEditJob').value = person.job || 'íšŒì‚¬ì›';
            
            // DBì—ì„œ ì§ì—… ëª©ë¡ ë™ì  ë¡œë”© (ì„±ë³„ì— ë§ê²Œ)
            updateJobDatalist(person.gender || 'ë‚¨ì');
            
            openModal('poolEditModal');
        }
        
        // ì§ì—… datalist ë™ì  ì—…ë°ì´íŠ¸
        function updateJobDatalist(gender) {
            const datalist = document.getElementById('jobList');
            if (!datalist) return;
            
            // í•´ë‹¹ ì„±ë³„ì˜ ì§ì—… ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (DB tiersì—ì„œ)
            const jobs = (data.tiers || [])
                .filter(t => t.gender === gender)
                .map(t => t.job)
                .sort();
            
            // datalist ì˜µì…˜ ì—…ë°ì´íŠ¸
            datalist.innerHTML = jobs.map(job => `<option value="${job}">`).join('');
        }
        
        // ì„±ë³„ ë³€ê²½ ì‹œ ì§ì—… datalist ì—…ë°ì´íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            const genderSelect = document.getElementById('poolEditGender');
            if (genderSelect) {
                genderSelect.addEventListener('change', (e) => {
                    updateJobDatalist(e.target.value);
                });
            }
        });
        
        // í’€ ìˆ˜ì • ì €ì¥
        async function savePoolEdit() {
            const id = document.getElementById('poolEditId').value;
            if (!id) {
                showToast('IDê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (PUTì€ ì „ì²´ êµì²´ì´ë¯€ë¡œ ê¸°ì¡´ í•„ë“œ ìœ ì§€ í•„ìš”)
            const existingPerson = data.virtualPool.find(p => p.id === id);
            if (!existingPerson) {
                showToast('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            const updateData = {
                ...convertToSnakeCase(existingPerson),  // ê¸°ì¡´ ë°ì´í„° ìœ ì§€ (snake_caseë¡œ ë³€í™˜)
                name: document.getElementById('poolEditName').value.trim(),
                gender: document.getElementById('poolEditGender').value,
                birth_year: parseInt(document.getElementById('poolEditBirthYear').value) || 1995,
                height: parseInt(document.getElementById('poolEditHeight').value) || 170,
                tier: document.getElementById('poolEditTier').value,
                job: document.getElementById('poolEditJob').value.trim() || 'íšŒì‚¬ì›'
            };
            
            // idëŠ” bodyì—ì„œ ì œê±° (URLì— ìˆìŒ)
            delete updateData.id;
            
            console.log('=== í’€ ìˆ˜ì • ìš”ì²­ ===');
            console.log('ID:', id);
            console.log('ìˆ˜ì • ë°ì´í„°:', updateData);
            
            try {
                const response = await fetch(`${API_BASE}/${TB.VIRTUAL_POOL}?id=eq.${encodeURIComponent(id)}`, {
                    method: 'PATCH',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify(updateData)
                });
                
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (response.ok) {
                    closeModal('poolEditModal');
                    showToast('ìˆ˜ì • ì™„ë£Œ', 'success');
                    await refreshAllData();
                    renderVirtualPool();
                } else {
                    const errorText = await response.text();
                    console.error('ìˆ˜ì • ì‹¤íŒ¨ ì‘ë‹µ:', errorText);
                    showToast(`ìˆ˜ì • ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (e) {
                console.error('ìˆ˜ì • ì˜¤ë¥˜:', e);
                showToast('ìˆ˜ì • ì˜¤ë¥˜: ' + e.message, 'error');
            }
        }
        
        // ë°°ì • ë‚ ì§œ í•„í„° ì—…ë°ì´íŠ¸
        function updateAssignDateFilter() {
            const scheduleDates = data.schedules
                .filter(s => s.isActive !== false)
                .map(s => s.date)
                .filter((v, i, a) => a.indexOf(v) === i)
                .filter(d => isDateAfterMin(d))  // ìµœì†Œ ë‚ ì§œ í•„í„°ë§
                .sort((a, b) => {
                    const dateA = parseDateForComparison(a) || '';
                    const dateB = parseDateForComparison(b) || '';
                    return dateA.localeCompare(dateB);
                });
            
            const assignSelect = document.getElementById('assignDate');
            const filterSelect = document.getElementById('assignedDateFilter');
            
            if (assignSelect) {
                assignSelect.innerHTML = '<option value="">ë‚ ì§œ ì„ íƒ</option>' + 
                    scheduleDates.map(d => `<option value="${d}">${d}</option>`).join('');
            }
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">ì „ì²´ ë‚ ì§œ</option>' + 
                    scheduleDates.map(d => `<option value="${d}">${d}</option>`).join('');
            }
        }
        
        // ë°°ì • í˜„í™© ì—…ë°ì´íŠ¸
        function updateAssignmentStatus() {
            const date = document.getElementById('assignDate')?.value;
            const part = document.getElementById('assignPart')?.value;
            const statusCard = document.getElementById('assignmentStatusCard');
            
            if (!date || !part) {
                statusCard.style.display = 'none';
                return;
            }
            
            statusCard.style.display = 'block';
            
            // ì‹¤ì œ ì˜ˆì•½ì ìˆ˜ - ì •ê·œí™” ë¹„êµ
            const realCount = data.reservations.filter(r => 
                isSameDate(r.eventDate, date) && r.eventPart === part && r.status !== 'ì·¨ì†Œ'
            ).length;
            
            // ê°€ìƒì°¸ì—¬ì ìˆ˜ - ì •ê·œí™” ë¹„êµ
            const assignments = data.virtualAssignments.filter(v => 
                isSameDate(v.scheduleDate, date) && v.schedulePart === part
            );
            const virtualCount = assignments.length;
            const pendingCount = assignments.filter(v => !v.isRevealed).length;
            
            const totalCount = realCount + virtualCount;
            const virtualRatio = totalCount > 0 ? Math.round((virtualCount / totalCount) * 100) : 0;
            
            document.getElementById('statusRealCount').textContent = realCount;
            document.getElementById('statusVirtualCount').textContent = virtualCount;
            document.getElementById('statusTotalCount').textContent = totalCount;
            document.getElementById('statusVirtualRatio').textContent = virtualRatio + '%';
            document.getElementById('statusPendingCount').textContent = pendingCount;
            
            // íŒŒí‹°ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜ ê³„ì‚°
            const partyDate = parseDateForComparison(date);
            const today = new Date().toISOString().split('T')[0];
            const diffTime = new Date(partyDate) - new Date(today);
            const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            document.getElementById('daysUntilParty').textContent = daysUntil >= 0 ? daysUntil : 0;
            
            // ê¶Œì¥ ë¹„ìœ¨ ê°€ì´ë“œ
            let guide = '';
            if (daysUntil >= 14) {
                guide = 'ê¶Œì¥: 10~20% (ëª¨ì§‘ ì´ˆê¸°, ê°€ìƒì°¸ì—¬ì ì ê²Œ)';
            } else if (daysUntil >= 7) {
                guide = 'ê¶Œì¥: 20~30% (ëª¨ì§‘ ì¤‘ê¸°)';
            } else if (daysUntil >= 3) {
                guide = 'ê¶Œì¥: 30~40% (ëª¨ì§‘ í›„ê¸°)';
            } else if (daysUntil >= 1) {
                guide = 'ê¶Œì¥: ìµœëŒ€ 50% (ë§ˆê° ì„ë°•)';
            } else {
                guide = 'âš ï¸ íŒŒí‹° ë‹¹ì¼/ì§€ë‚¨ - ê°€ìƒì°¸ì—¬ì ìµœì†Œí™” ê¶Œì¥';
            }
            document.getElementById('recommendedRatioGuide').textContent = guide;
        }
        
        // íŒŒí‹°ì— ê°€ìƒì°¸ì—¬ì ë°°ì •
        // ì„¸ì…˜ì˜ ë‚˜ì´ì¡°ê±´ ê°€ì ¸ì˜¤ê¸° (ì¼ì • ì˜¤ë²„ë¼ì´ë“œ > í…œí”Œë¦¿ ê¸°ë³¸ê°’)
        function getAgeCondition(date, part) {
            // ë¨¼ì € party_schedulesì—ì„œ ì˜¤ë²„ë¼ì´ë“œ í™•ì¸ - ì •ê·œí™” ë¹„êµ
            const schedule = data.schedules.find(s => isSameDate(s.date, date) && s.part === part);
            if (schedule && schedule.minBirthYear && schedule.maxBirthYear) {
                return { minBirthYear: schedule.minBirthYear, maxBirthYear: schedule.maxBirthYear };
            }
            
            // ì—†ìœ¼ë©´ session_templatesì—ì„œ ê¸°ë³¸ê°’
            const session = data.sessions.find(s => s.id === part);
            if (session && session.minBirthYear && session.maxBirthYear) {
                return { minBirthYear: session.minBirthYear, maxBirthYear: session.maxBirthYear };
            }
            
            // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ null (í•„í„°ë§ ì•ˆ í•¨)
            return null;
        }
        
        async function assignVirtualsToParty(gender) {
            const date = document.getElementById('assignDate')?.value;
            const part = document.getElementById('assignPart')?.value;
            const count = gender === 'ë‚¨ì' 
                ? parseInt(document.getElementById('assignMaleCount').value) || 0
                : parseInt(document.getElementById('assignFemaleCount').value) || 0;
            
            if (!date || !part) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            if (count <= 0) {
                showToast('ë°°ì •í•  ì¸ì› ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            // ë‚˜ì´ì¡°ê±´ ê°€ì ¸ì˜¤ê¸°
            const ageCondition = getAgeCondition(date, part);
            
            // í•´ë‹¹ ì„±ë³„ í’€ì—ì„œ ëœë¤ ì„ íƒ (ì´ë¯¸ ì´ íŒŒí‹°ì— ë°°ì •ëœ ê±´ ì œì™¸) - ì •ê·œí™” ë¹„êµ
            const alreadyAssigned = data.virtualAssignments
                .filter(v => isSameDate(v.scheduleDate, date) && v.schedulePart === part)
                .map(v => v.virtualId);
            
            let availablePool = data.virtualPool.filter(p => 
                p.gender === gender && 
                p.isActive !== false && 
                !alreadyAssigned.includes(p.id)
            );
            
            // ë‚˜ì´ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§
            if (ageCondition) {
                availablePool = availablePool.filter(p => 
                    p.birthYear >= ageCondition.minBirthYear && 
                    p.birthYear <= ageCondition.maxBirthYear
                );
            }
            
            if (availablePool.length === 0) {
                const conditionText = ageCondition 
                    ? ` (${ageCondition.minBirthYear}~${ageCondition.maxBirthYear}ë…„ìƒ)` 
                    : '';
                showToast(`ì¡°ê±´ì— ë§ëŠ” ${gender} í’€ì´ ì—†ìŠµë‹ˆë‹¤${conditionText}`, 'error');
                return;
            }
            
            // ì¸ì› ë¶€ì¡± ì‹œ ê°€ëŠ¥í•œ ë§Œí¼ë§Œ ë°°ì •
            const actualCount = Math.min(count, availablePool.length);
            if (actualCount < count) {
                const conditionText = ageCondition 
                    ? ` (${ageCondition.minBirthYear}~${ageCondition.maxBirthYear}ë…„ìƒ)` 
                    : '';
                showToast(`ì¡°ê±´ì— ë§ëŠ” ì¸ì› ë¶€ì¡±${conditionText}: ìš”ì²­ ${count}ëª… ì¤‘ ${actualCount}ëª…ë§Œ ë°°ì •í•©ë‹ˆë‹¤`, 'warning');
            }
            
            // í‹°ì–´ë³„ ê· í˜• ë°°ì • + ì§ì—… ì¤‘ë³µ ë°©ì§€
            // í‹°ì–´ ë¹„ìœ¨: S=20%, A=50%, B=30%
            const tierRatio = { S: 0.2, A: 0.5, B: 0.3 };
            const tierCounts = {
                S: Math.round(actualCount * tierRatio.S),
                A: Math.round(actualCount * tierRatio.A),
                B: actualCount - Math.round(actualCount * tierRatio.S) - Math.round(actualCount * tierRatio.A)
            };
            
            // í‹°ì–´ë³„ë¡œ ê·¸ë£¹í™”
            const byTier = {
                S: availablePool.filter(p => p.tier === 'S').sort(() => Math.random() - 0.5),
                A: availablePool.filter(p => p.tier === 'A').sort(() => Math.random() - 0.5),
                B: availablePool.filter(p => p.tier === 'B').sort(() => Math.random() - 0.5)
            };
            
            // ì§ì—… ì¤‘ë³µ ì²´í¬ìš©
            const selectedJobs = {};
            const maxSameJob = 2; // ê°™ì€ ì§ì—… ìµœëŒ€ 2ëª…
            
            const selected = [];
            
            // í‹°ì–´ë³„ë¡œ ì„ íƒ (ì§ì—… ì¤‘ë³µ ë°©ì§€)
            const selectFromTier = (tier, targetCount) => {
                const pool = byTier[tier];
                let count = 0;
                for (const person of pool) {
                    if (count >= targetCount) break;
                    const jobCount = selectedJobs[person.job] || 0;
                    if (jobCount < maxSameJob) {
                        selected.push(person);
                        selectedJobs[person.job] = jobCount + 1;
                        count++;
                    }
                }
                return count;
            };
            
            // S, A, B ìˆœì„œë¡œ ì„ íƒ
            let sSelected = selectFromTier('S', tierCounts.S);
            let aSelected = selectFromTier('A', tierCounts.A);
            let bSelected = selectFromTier('B', tierCounts.B);
            
            // ëª©í‘œ ì¸ì› ë¯¸ë‹¬ ì‹œ ë‹¤ë¥¸ í‹°ì–´ì—ì„œ ë³´ì¶©
            const remaining = actualCount - selected.length;
            if (remaining > 0) {
                // ë‚¨ì€ í’€ì—ì„œ ì¶”ê°€ ì„ íƒ
                const usedIds = new Set(selected.map(p => p.id));
                const leftover = availablePool
                    .filter(p => !usedIds.has(p.id))
                    .sort(() => Math.random() - 0.5);
                
                for (const person of leftover) {
                    if (selected.length >= actualCount) break;
                    const jobCount = selectedJobs[person.job] || 0;
                    if (jobCount < maxSameJob) {
                        selected.push(person);
                        selectedJobs[person.job] = jobCount + 1;
                    }
                }
            }
            
            console.log(`ë°°ì • ê²°ê³¼: S=${sSelected}, A=${aSelected}, B=${bSelected}, ì´=${selected.length}`);
            
            showToast(`${gender} ${actualCount}ëª… ë°°ì • ì¤‘...`, 'info');
            
            let successCount = 0;
            const currentOrder = data.virtualAssignments.filter(v => 
                isSameDate(v.scheduleDate, date) && v.schedulePart === part && v.gender === gender
            ).length;
            
            for (let i = 0; i < selected.length; i++) {
                const p = selected[i];
                const assignment = {
                    schedule_date: date,
                    schedule_part: part,
                    virtual_id: p.id,
                    gender: p.gender,
                    birth_year: p.birthYear,
                    height: p.height,
                    job: p.job,
                    tier: p.tier,
                    is_revealed: false,  // ì²˜ìŒì—” ì •ë³´í™•ì¸ì¤‘
                    display_order: currentOrder + i + 1
                };
                
                try {
                    const res = await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(assignment)
                    });
                    if (res.ok) successCount++;
                } catch (e) {
                    console.error('ë°°ì • ì˜¤ë¥˜:', e);
                }
            }
            
            showToast(`âœ… ${gender} ${successCount}ëª… ë°°ì • ì™„ë£Œ! (ì •ë³´í™•ì¸ì¤‘ ìƒíƒœ)`, 'success');
            await refreshAllData();
            updateAssignmentStatus();
            renderAssignments();
        }
        
        // ë°°ì •ëœ ê°€ìƒì°¸ì—¬ì ëª©ë¡ ë Œë”ë§
        function renderAssignments() {
            const tbody = document.getElementById('assignedVirtualBody');
            if (!tbody) return;
            
            const dateFilter = document.getElementById('assignedDateFilter')?.value || '';
            const partFilter = document.getElementById('assignedPartFilter')?.value || '';
            const genderFilter = document.getElementById('assignedGenderFilter')?.value || '';
            const revealFilter = document.getElementById('assignedRevealFilter')?.value || '';
            
            let filtered = (data.virtualAssignments || [])
                .filter(v => isDateAfterMin(v.scheduleDate));  // ìµœì†Œ ë‚ ì§œ í•„í„°ë§
            
            if (dateFilter) filtered = filtered.filter(v => isSameDate(v.scheduleDate, dateFilter));
            if (partFilter) filtered = filtered.filter(v => v.schedulePart === partFilter);
            if (genderFilter) filtered = filtered.filter(v => v.gender === genderFilter);
            if (revealFilter === 'revealed') filtered = filtered.filter(v => v.isRevealed);
            if (revealFilter === 'pending') filtered = filtered.filter(v => !v.isRevealed);
            
            // ì •ë ¬ ì ìš© (ì‚¬ìš©ì ì†ŒíŒ… ë˜ëŠ” ê¸°ë³¸ê°’)
            if (assignSortField) {
                filtered.sort((a, b) => {
                    let valA, valB;
                    const tierOrder = { 'S': 0, 'A': 1, 'B': 2 };
                    switch (assignSortField) {
                        case 'scheduleDate': 
                            valA = parseDateForComparison(a.scheduleDate) || ''; 
                            valB = parseDateForComparison(b.scheduleDate) || ''; 
                            break;
                        case 'schedulePart': valA = a.schedulePart || ''; valB = b.schedulePart || ''; break;
                        case 'gender': valA = a.gender || ''; valB = b.gender || ''; break;
                        case 'birthYear': valA = a.birthYear || 0; valB = b.birthYear || 0; break;
                        case 'height': valA = a.height || 0; valB = b.height || 0; break;
                        case 'job': valA = a.job || ''; valB = b.job || ''; break;
                        case 'tier': valA = tierOrder[a.tier] ?? 2; valB = tierOrder[b.tier] ?? 2; break;
                        case 'isRevealed': valA = a.isRevealed ? 1 : 0; valB = b.isRevealed ? 1 : 0; break;
                        default: valA = ''; valB = '';
                    }
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return assignSortAsc ? valA - valB : valB - valA;
                    }
                    const strA = String(valA).toLowerCase();
                    const strB = String(valB).toLowerCase();
                    if (strA < strB) return assignSortAsc ? -1 : 1;
                    if (strA > strB) return assignSortAsc ? 1 : -1;
                    return 0;
                });
            } else {
                // ê¸°ë³¸ ì •ë ¬: ë‚ ì§œ > ì„¸ì…˜ > ì„±ë³„ > í‹°ì–´
                filtered.sort((a, b) => {
                    const dateA = parseDateForComparison(a.scheduleDate) || '';
                    const dateB = parseDateForComparison(b.scheduleDate) || '';
                    if (dateA !== dateB) return dateA.localeCompare(dateB);
                    if (a.schedulePart !== b.schedulePart) return a.schedulePart.localeCompare(b.schedulePart);
                    if (a.gender !== b.gender) return a.gender.localeCompare(b.gender);
                    const tierOrder = { S: 0, A: 1, B: 2 };
                    return (tierOrder[a.tier] || 99) - (tierOrder[b.tier] || 99);
                });
            }
            
            document.getElementById('assignedCount').textContent = `(${filtered.length}ëª…)`;
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">ë°°ì •ëœ ê°€ìƒì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            const currentYear = new Date().getFullYear();
            
            tbody.innerHTML = filtered.map(v => {
                // ë‚˜ì´ í˜•ì‹: ì—°ë„ ë’¤ 2ìë¦¬ (ì˜ˆ: 94)
                const birthYearShort = v.birthYear ? String(v.birthYear).slice(-2) : '-';
                
                // í•´ë‹¹ ì„¸ì…˜ì˜ ë‚˜ì´ì¡°ê±´ ì²´í¬
                const session = data.sessions.find(s => s.id === v.schedulePart);
                let ageWarning = '';
                if (v.birthYear && session) {
                    const minBY = session.minBirthYear;
                    const maxBY = session.maxBirthYear;
                    if (minBY && maxBY && (v.birthYear < minBY || v.birthYear > maxBY)) {
                        ageWarning = ' <span title="ì„¸ì…˜ ë‚˜ì´ì¡°ê±´ ë¶ˆì¼ì¹˜" style="color:#ef4444;">âš ï¸</span>';
                    }
                }
                
                const statusBadge = v.isRevealed 
                    ? '<span class="badge badge-success">ê³µê°œë¨</span>'
                    : '<span class="badge badge-warning">ì •ë³´í™•ì¸ì¤‘</span>';
                
                return `
                    <tr class="${!v.isRevealed ? 'pending-row' : ''}">
                        <td>${v.scheduleDate || '-'}</td>
                        <td>${v.schedulePart || '-'}</td>
                        <td><span class="gender-${v.gender === 'ë‚¨ì' ? 'male' : 'female'}">${v.gender}</span></td>
                        <td>${birthYearShort}${ageWarning}</td>
                        <td>${v.height || '-'}</td>
                        <td>${v.job || '-'}</td>
                        <td><span class="tier tier-${v.tier}">${v.tier || '-'}</span></td>
                        <td>${statusBadge}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-sm btn-secondary" onclick="openReplaceModal('${v.id}')" title="ë‹¤ë¥¸ ì‚¬ëŒìœ¼ë¡œ êµì²´"><i class="fas fa-exchange-alt"></i></button>
                            ${!v.isRevealed ? `<button class="btn btn-sm btn-info" onclick="revealAssignment('${v.id}')"><i class="fas fa-eye"></i></button>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteAssignment('${v.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ê°€ìƒì°¸ì—¬ì êµì²´ ëª¨ë‹¬ ì—´ê¸°
        let currentReplaceAssignment = null;
        
        function openReplaceModal(assignmentId) {
            const assignment = data.virtualAssignments.find(v => v.id === assignmentId);
            if (!assignment) {
                showToast('ë°°ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            currentReplaceAssignment = assignment;
            document.getElementById('replaceAssignmentId').value = assignmentId;
            
            // í˜„ì¬ ë°°ì •ëœ ì‚¬ëŒ ì •ë³´ í‘œì‹œ
            document.getElementById('currentAssignmentInfo').innerHTML = `
                <span class="tier tier-${assignment.tier}">${assignment.tier}</span>
                ${assignment.job} | ${formatBirthYear(assignment.birthYear)} | ${assignment.height}cm
                <span class="gender-${assignment.gender === 'ë‚¨ì' ? 'male' : 'female'}">(${assignment.gender})</span>
            `;
            
            // ì§ì—… í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
            const jobs = [...new Set(data.virtualPool.filter(p => p.gender === assignment.gender).map(p => p.job))].sort();
            const jobFilter = document.getElementById('replaceFilterJob');
            jobFilter.innerHTML = '<option value="">ì „ì²´ ì§ì—…</option>' + jobs.map(j => `<option value="${j}">${j}</option>`).join('');
            
            // í‹°ì–´ í•„í„° ì´ˆê¸°í™”
            document.getElementById('replaceFilterTier').value = '';
            
            filterReplaceCandidates();
            openModal('replaceModal');
        }
        
        function filterReplaceCandidates() {
            if (!currentReplaceAssignment) return;
            
            const tierFilter = document.getElementById('replaceFilterTier')?.value || '';
            const jobFilter = document.getElementById('replaceFilterJob')?.value || '';
            const tbody = document.getElementById('replaceCandidateBody');
            
            // ê°™ì€ ì„±ë³„, ì´ë¯¸ í•´ë‹¹ íŒŒí‹°ì— ë°°ì •ë˜ì§€ ì•Šì€ ì‚¬ëŒë“¤ - ì •ê·œí™” ë¹„êµ
            const alreadyAssigned = data.virtualAssignments
                .filter(v => isSameDate(v.scheduleDate, currentReplaceAssignment.scheduleDate) && 
                            v.schedulePart === currentReplaceAssignment.schedulePart)
                .map(v => v.virtualId);
            
            let candidates = data.virtualPool.filter(p => 
                p.gender === currentReplaceAssignment.gender &&
                p.isActive !== false &&
                !alreadyAssigned.includes(p.id)
            );
            
            // í•„í„° ì ìš©
            if (tierFilter) candidates = candidates.filter(p => p.tier === tierFilter);
            if (jobFilter) candidates = candidates.filter(p => p.job === jobFilter);
            
            // í‹°ì–´ìˆœ ì •ë ¬
            candidates.sort((a, b) => {
                const tierOrder = { S: 0, A: 1, B: 2 };
                return (tierOrder[a.tier] || 2) - (tierOrder[b.tier] || 2);
            });
            
            document.getElementById('replaceCandidateCount').textContent = `${candidates.length}ëª…`;
            
            if (candidates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ì¡°ê±´ì— ë§ëŠ” í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = candidates.slice(0, 100).map(p => `
                <tr>
                    <td>${p.name || '-'}</td>
                    <td>${formatBirthYear(p.birthYear)}</td>
                    <td>${p.height}cm</td>
                    <td>${p.job}</td>
                    <td><span class="tier tier-${p.tier}">${p.tier}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="executeReplace('${p.id}')">
                            <i class="fas fa-check"></i> ì„ íƒ
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function executeReplace(newPoolId) {
            const assignmentId = document.getElementById('replaceAssignmentId').value;
            const newPerson = data.virtualPool.find(p => p.id === newPoolId);
            
            if (!assignmentId || !newPerson || !currentReplaceAssignment) {
                showToast('êµì²´ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            // ìƒˆ ì‚¬ëŒ ì •ë³´ë¡œ ì—…ë°ì´íŠ¸ (í•„ìš”í•œ í•„ë“œë§Œ, snake_case)
            const updateData = {
                virtual_id: newPerson.id,
                birth_year: newPerson.birthYear,
                height: newPerson.height,
                job: newPerson.job,
                tier: newPerson.tier
            };

            try {
                const response = await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${encodeURIComponent(assignmentId)}`, {
                    method: 'PATCH',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    closeModal('replaceModal');
                    showToast(`âœ… ${newPerson.job} (${newPerson.tier}í‹°ì–´)ë¡œ êµì²´ ì™„ë£Œ!`, 'success');
                    await refreshAllData();
                    renderAssignments();
                    renderLineup();
                } else {
                    const errText = await response.text();
                    console.error('êµì²´ ì‹¤íŒ¨:', response.status, errText);
                    showToast('êµì²´ ì‹¤íŒ¨: ' + response.status, 'error');
                }
            } catch (e) {
                console.error('êµì²´ ì˜¤ë¥˜:', e);
                showToast('êµì²´ ì˜¤ë¥˜', 'error');
            }
        }
        
        // ====== ìë™ ë°°ì • ì‹œìŠ¤í…œ ======
        
        // ë‚ ì§œê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜ ê³„ì‚°
        function getDaysUntil(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // dateStr íŒŒì‹± (ì˜ˆ: "2026ë…„ 01ì›” 10ì¼")
            const match = dateStr.match(/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
            if (!match) return 999;
            
            const targetDate = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
            const diffTime = targetDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        // ì‹œì ë³„ ìµœì†Œ ì¸ì› ë²”ìœ„ ê°€ì ¸ì˜¤ê¸° (UIì—ì„œ ì½ìŒ) - ë ˆê±°ì‹œ
        function getMinPersonRange(daysUntil) {
            let min, max;
            if (daysUntil >= 21) {
                min = parseInt(document.getElementById('autoMin3w')?.value) || 6;
                max = parseInt(document.getElementById('autoMax3w')?.value) || 8;
            } else if (daysUntil >= 14) {
                min = parseInt(document.getElementById('autoMin2w')?.value) || 8;
                max = parseInt(document.getElementById('autoMax2w')?.value) || 10;
            } else if (daysUntil >= 7) {
                min = parseInt(document.getElementById('autoMin1w')?.value) || 9;
                max = parseInt(document.getElementById('autoMax1w')?.value) || 12;
            } else {
                min = parseInt(document.getElementById('autoMin0w')?.value) || 10;
                max = parseInt(document.getElementById('autoMax0w')?.value) || 14;
            }
            return { min, max };
        }
        
        // ======== ë¹„ìœ¨ ê¸°ë°˜ ê³„ì‚° ì‹œìŠ¤í…œ ========
        // D-14ì—ì„œ D-0ê¹Œì§€ ì‹œì‘ë¹„ìœ¨ â†’ ìµœëŒ€ë¹„ìœ¨ë¡œ ì¦ê°€ (ë“±ì°¨ìˆ˜ì—´)
        
        function getRatioByDday(daysUntil) {
            // UIì—ì„œ ê°’ ì½ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
            const START_RATIO = parseInt(document.getElementById('ratioStart')?.value) || 30;
            const END_RATIO = parseInt(document.getElementById('ratioEnd')?.value) || 80;
            const DAYS_RANGE = 14;   // 2ì£¼
            const DAILY_INCREMENT = (END_RATIO - START_RATIO) / DAYS_RANGE;
            
            // D-14 ì´ìƒì´ë©´ ì‹œì‘ ë¹„ìœ¨ ê³ ì •
            if (daysUntil >= DAYS_RANGE) {
                return START_RATIO;
            }
            // D-0 ì´í•˜ë©´ ìµœëŒ€ ë¹„ìœ¨ ê³ ì •
            if (daysUntil <= 0) {
                return END_RATIO;
            }
            // ë“±ì°¨ìˆ˜ì—´: 30 + (14 - daysUntil) * 3.57
            const ratio = START_RATIO + (DAYS_RANGE - daysUntil) * DAILY_INCREMENT;
            return Math.min(ratio, END_RATIO);
        }
        
        // íŒŒí‹° ìœ í˜•ë³„ ì •ì› ë° ìµœì†Œ ê³µì„ ê¸°ì¤€ìœ¼ë¡œ ê°€ìƒì°¸ì—¬ì ìˆ˜ ê³„ì‚°
        function calculateVirtualCount(capacity, minVacancy, realCount, daysUntil) {
            const ratio = getRatioByDday(daysUntil);
            const targetTotal = Math.round(capacity * ratio / 100);
            
            // ê°€ìƒ í•„ìš” ì¸ì› = ëª©í‘œ - ì‹¤ì œ ì˜ˆì•½
            let virtualNeeded = Math.max(0, targetTotal - realCount);
            
            // ìµœëŒ€ í•œë„: ì •ì›ì˜ 80%
            const maxVirtual = Math.floor(capacity * 0.8) - realCount;
            virtualNeeded = Math.min(virtualNeeded, maxVirtual);
            
            // ìµœì†Œ ê³µì„ ìœ ì§€
            const maxWithVacancy = capacity - minVacancy - realCount;
            virtualNeeded = Math.min(virtualNeeded, maxWithVacancy);
            
            return Math.max(0, virtualNeeded);
        }
        
        // ë””ë²„ê·¸ìš©: ë¹„ìœ¨ í‘œ ì¶œë ¥
        function printRatioTable() {
            console.log('=== D-dayë³„ ë¹„ìœ¨í‘œ ===');
            for (let d = 14; d >= 0; d--) {
                const ratio = getRatioByDday(d);
                console.log(`D-${d}: ${ratio.toFixed(1)}% | ì»¤í”¼(12): ${Math.round(12 * ratio / 100)}ëª… | ì™€ì¸(24): ${Math.round(24 * ratio / 100)}ëª…`);
            }
        }
        
        // ëœë¤ ë²”ìœ„ ê°’
        function randRange(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        // í–¥í›„ Nì£¼ íŒŒí‹° ìë™ ë°°ì • (ë¹„ìœ¨ ê¸°ë°˜ ë²„ì „)
        // - D-dayì— ë”°ë¥¸ ë“±ì°¨ìˆ˜ì—´ ë¹„ìœ¨ (30% â†’ 80%)
        // - ì—¬ìê°€ í•­ìƒ 1~2ëª… ë” ë§ê²Œ ë°°ì •
        // - ì •ë³´í™•ì¸ì¤‘ì€ 3~4ëª…ë§Œ, Sí‹°ì–´ ìœ„ì£¼
        // - íŒŒí‹° ìœ í˜•ë³„ ì •ì› ë° ìµœì†Œ ê³µì„ ì ìš©
        async function autoAssignAllParties() {
            const weeks = parseInt(document.getElementById('autoAssignWeeks')?.value) || 2;
            
            // í–¥í›„ Nì£¼ ë‚´ì˜ í™œì„± íŒŒí‹° ì¼ì • ê°€ì ¸ì˜¤ê¸°
            const upcomingParties = [];
            
            for (const schedule of (data.schedules || [])) {
                if (schedule.isActive === false) continue;
                
                // ìµœì†Œ ë‚ ì§œ í•„í„°ë§ (1ì›” 11ì¼ ì´ì „ ì œì™¸)
                if (!isDateAfterMin(schedule.date)) continue;
                
                const daysUntil = getDaysUntil(schedule.date);
                if (daysUntil < 0 || daysUntil > weeks * 7) continue;
                
                // íŒŒí‹° ìœ í˜•ë³„ ì •ì› ë° ìµœì†Œ ê³µì„
                const partyType = schedule.partyType || 'coffee';
                const partyTypeInfo = data.partyTypes?.find(t => t.id === partyType);
                const maleCapacity = partyTypeInfo?.maleCapacity || 12;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
                const femaleCapacity = partyTypeInfo?.femaleCapacity || 12;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
                const minVacancy = partyTypeInfo?.minVacancy || 2;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
                
                // í•´ë‹¹ ì¼ì •ì˜ ì„¸ì…˜ (partë¡œ ì €ì¥ë¨)
                const session = schedule.part;
                if (!session) continue;
                
                // ì´ë¯¸ ë°°ì •ëœ ê°€ìƒì°¸ì—¬ì ìˆ˜ í™•ì¸ - ì •ê·œí™” ë¹„êµ
                const existingAssignments = (data.virtualAssignments || []).filter(v => 
                    isSameDate(v.scheduleDate, schedule.date) && v.schedulePart === session
                );
                
                // ì‹¤ì œ ì˜ˆì•½ì ìˆ˜ í™•ì¸
                const realReservations = (data.reservations || []).filter(r => {
                    const dateStr = parseDateForComparison(schedule.date);
                    const rDateStr = r.eventDate ? parseDateForComparison(r.eventDate) : r.partyDate;
                    const matchDate = rDateStr === dateStr;
                    const matchPart = r.partySession === session || r.eventPart === session;
                    const notCanceled = r.status !== 'ì·¨ì†Œ' && r.status !== 'í™˜ë¶ˆ';
                    return matchDate && matchPart && notCanceled;
                });
                
                // ê¸°ì¡´ ë°°ì • ë° ì‹¤ì œ ì˜ˆì•½ ì„±ë³„ë³„ ì¹´ìš´íŠ¸
                const existingMale = existingAssignments.filter(a => a.gender === 'ë‚¨ì').length;
                const existingFemale = existingAssignments.filter(a => a.gender === 'ì—¬ì').length;
                const realMales = realReservations.filter(r => r.gender === 'ë‚¨ì').length;
                const realFemales = realReservations.filter(r => r.gender === 'ì—¬ì').length;
                
                // ë¹„ìœ¨ ê¸°ë°˜ ê°€ìƒì°¸ì—¬ì ìˆ˜ ê³„ì‚°
                const ratio = getRatioByDday(daysUntil);
                
                // ë‚¨ì ëª©í‘œ ê³„ì‚°
                let needMaleTotal = calculateVirtualCount(maleCapacity, Math.floor(minVacancy/2), realMales, daysUntil);
                // ì—¬ì ëª©í‘œ ê³„ì‚° (1~2ëª… ë” ë§ê²Œ)
                const femaleExtra = randRange(1, 2);
                let needFemaleTotal = calculateVirtualCount(femaleCapacity, Math.ceil(minVacancy/2), realFemales, daysUntil);
                needFemaleTotal = Math.min(needFemaleTotal + femaleExtra, femaleCapacity - Math.ceil(minVacancy/2) - realFemales);
                
                // ì´ë¯¸ ë°°ì •ëœ ë§Œí¼ ë¹¼ê¸°
                const needMale = Math.max(0, needMaleTotal - existingMale);
                const needFemale = Math.max(0, needFemaleTotal - existingFemale);
                
                if (needMale > 0 || needFemale > 0) {
                    upcomingParties.push({
                        date: schedule.date,
                        session: session,
                        daysUntil: daysUntil,
                        partyType: partyType,
                        maleCapacity: maleCapacity,
                        femaleCapacity: femaleCapacity,
                        minVacancy: minVacancy,
                        realMales: realMales,
                        realFemales: realFemales,
                        existingMale: existingMale,
                        existingFemale: existingFemale,
                        existingVirtual: existingAssignments.length,
                        needMale: needMale,
                        needFemale: needFemale,
                        ratio: ratio
                    });
                }
            }
            
            if (upcomingParties.length === 0) {
                showToast('ë°°ì •í•  íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì´ë¯¸ ë°°ì • ì™„ë£Œë˜ì—ˆê±°ë‚˜ íŒŒí‹°ê°€ ì—†ìŒ)', 'info');
                return;
            }
            
            // í™•ì¸ ë©”ì‹œì§€
            let confirmMsg = `í–¥í›„ ${weeks}ì£¼ ë‚´ íŒŒí‹°ì— ìë™ ë°°ì •í•©ë‹ˆë‹¤.\n\n`;
            confirmMsg += `ğŸ“Š ë¹„ìœ¨ ê¸°ë°˜ ê³„ì‚° (D-day: 30%â†’80%)\n`;
            confirmMsg += `ğŸ‘© ì—¬ìê°€ í•­ìƒ 1~2ëª… ë” ë§ê²Œ ë°°ì •\n`;
            confirmMsg += `ğŸ”’ ì •ë³´í™•ì¸ì¤‘: Sí‹°ì–´ ìœ„ì£¼ 3~4ëª…ë§Œ\n`;
            confirmMsg += `ğŸ“¦ ìµœì†Œ ê³µì„ ìœ ì§€\n\n`;
            for (const p of upcomingParties.slice(0, 5)) {
                const typeIcon = p.partyType === 'wine' ? 'ğŸ·' : 'â˜•';
                confirmMsg += `â€¢ ${p.date} ${p.session} ${typeIcon}: ë‚¨${p.needMale}+ì—¬${p.needFemale} (D-${p.daysUntil}, ${p.ratio.toFixed(0)}%)\n`;
            }
            if (upcomingParties.length > 5) {
                confirmMsg += `... ì™¸ ${upcomingParties.length - 5}ê°œ ì„¸ì…˜\n`;
            }
            const totalMale = upcomingParties.reduce((sum, p) => sum + p.needMale, 0);
            const totalFemale = upcomingParties.reduce((sum, p) => sum + p.needFemale, 0);
            confirmMsg += `\nì´ ${totalMale + totalFemale}ëª… (ë‚¨${totalMale} + ì—¬${totalFemale}) ë°°ì • ì˜ˆì •\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            if (!confirm(confirmMsg)) return;
            
            showToast('ìë™ ë°°ì • ì¤‘... (0%)', 'info');
            
            let totalSuccess = 0;
            let totalFailed = 0;
            
            for (const party of upcomingParties) {
                // ë‚˜ì´ì¡°ê±´ ê°€ì ¸ì˜¤ê¸°
                const ageCondition = getAgeCondition(party.date, party.session);
                
                // ì´ë¯¸ ì´ íŒŒí‹°ì— ë°°ì •ëœ ID - ì •ê·œí™” ë¹„êµ
                const alreadyAssigned = (data.virtualAssignments || [])
                    .filter(v => isSameDate(v.scheduleDate, party.date) && v.schedulePart === party.session)
                    .map(v => v.virtualId);
                
                // ì„±ë³„ë³„ë¡œ ë°°ì •
                for (const gender of ['ë‚¨ì', 'ì—¬ì']) {
                    const needCount = gender === 'ë‚¨ì' ? party.needMale : party.needFemale;
                    if (needCount <= 0) continue;
                    
                    // ì‹¤ì œ ì˜ˆì•½ì ìˆ˜ (í•´ë‹¹ ì„±ë³„)
                    const realCount = gender === 'ë‚¨ì' ? party.realMales : party.realFemales;
                    // ì „ì²´ ë¼ì¸ì—… = ì‹¤ì œ + ê°€ìƒ
                    const totalLineup = realCount + needCount;
                    
                    // ì •ë³´í™•ì¸ì¤‘ ê·œì¹™: ì „ì²´ ë¼ì¸ì—…ì˜ 30% ì´ë‚´, ìµœëŒ€ 3ëª…
                    const maxPendingByRatio = Math.floor(totalLineup * 0.3);
                    const pendingCountForGender = Math.min(maxPendingByRatio, 3, needCount);
                    
                    // í’€ì—ì„œ í›„ë³´ ì„ íƒ
                    let availablePool = (data.virtualPool || []).filter(p => 
                        p.gender === gender && 
                        p.isActive !== false && 
                        !alreadyAssigned.includes(p.id)
                    );
                    
                    // ë‚˜ì´ì¡°ê±´ í•„í„°
                    if (ageCondition) {
                        availablePool = availablePool.filter(p => 
                            p.birthYear >= ageCondition.minBirthYear && 
                            p.birthYear <= ageCondition.maxBirthYear
                        );
                    }
                    
                    // Sí‹°ì–´ ë¨¼ì €, ê·¸ ë‹¤ìŒ A, B ìˆœìœ¼ë¡œ ì •ë ¬ í›„ ì…”í”Œ
                    const sTier = availablePool.filter(p => p.tier === 'S').sort(() => Math.random() - 0.5);
                    const aTier = availablePool.filter(p => p.tier === 'A').sort(() => Math.random() - 0.5);
                    const bTier = availablePool.filter(p => p.tier === 'B').sort(() => Math.random() - 0.5);
                    
                    // í‹°ì–´ ë¹„ìœ¨ ì ìš©: S 20%, A 50%, B 30%
                    const sCount = Math.max(1, Math.round(needCount * 0.2));
                    const aCount = Math.round(needCount * 0.5);
                    const bCount = needCount - sCount - aCount;
                    
                    const selected = [
                        ...sTier.slice(0, sCount),
                        ...aTier.slice(0, aCount),
                        ...bTier.slice(0, bCount)
                    ];
                    
                    // ë¶€ì¡±í•˜ë©´ ë‚¨ì€ í’€ì—ì„œ ë³´ì¶©
                    if (selected.length < needCount) {
                        const remaining = [...sTier.slice(sCount), ...aTier.slice(aCount), ...bTier.slice(bCount)];
                        selected.push(...remaining.slice(0, needCount - selected.length));
                    }
                    
                    // ì •ë³´í™•ì¸ì¤‘ ëŒ€ìƒ ëœë¤ ì„ íƒ (ì¸ë±ìŠ¤ ë°°ì—´)
                    const pendingIndices = new Set();
                    while (pendingIndices.size < pendingCountForGender && pendingIndices.size < selected.length) {
                        pendingIndices.add(Math.floor(Math.random() * selected.length));
                    }
                    
                    // í˜„ì¬ ìˆœì„œ ê³„ì‚°
                    const currentOrder = alreadyAssigned.length;
                    
                    // API í˜¸ì¶œë¡œ ë°°ì •
                    for (let i = 0; i < Math.min(selected.length, needCount); i++) {
                        const person = selected[i];
                        
                        // ì •ë³´í™•ì¸ì¤‘ ì—¬ë¶€: ëœë¤ìœ¼ë¡œ ì„ íƒëœ ì¸ë±ìŠ¤ë©´ ë¯¸ê³µê°œ
                        const isPending = pendingIndices.has(i);
                        
                        try {
                            const res = await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}`, {
                                method: 'POST',
                                headers: SUPABASE_HEADERS,
                                body: JSON.stringify({
                                    schedule_date: party.date,
                                    schedule_part: party.session,
                                    virtual_id: person.id,
                                    gender: person.gender,
                                    birth_year: person.birthYear,
                                    height: person.height,
                                    job: person.job,
                                    tier: person.tier,
                                    is_revealed: !isPending,  // ì •ë³´í™•ì¸ì¤‘ì´ ì•„ë‹ˆë©´ ê³µê°œ
                                    display_order: currentOrder + i
                                })
                            });
                            if (res.ok) {
                                totalSuccess++;
                                alreadyAssigned.push(person.id);
                            } else {
                                totalFailed++;
                            }
                        } catch (e) {
                            totalFailed++;
                        }
                    }
                }
                
                // íŒŒí‹°ë³„ ì§„í–‰ìƒí™© í‘œì‹œ
                const partyIdx = upcomingParties.indexOf(party) + 1;
                const progress = Math.round(partyIdx / upcomingParties.length * 100);
                showToast(`ìë™ ë°°ì • ì¤‘... ${partyIdx}/${upcomingParties.length} ì„¸ì…˜ (${progress}%)`, 'info');
            }
            
            showToast(`âœ… ìë™ ë°°ì • ì™„ë£Œ! (ì„±ê³µ: ${totalSuccess}ëª…, ì‹¤íŒ¨: ${totalFailed}ëª…)`, 'success');
            await refreshAllData();
            updateAssignmentStatus();
            renderAssignments();
        }
        
        // ê°€ìƒì°¸ì—¬ì ì§ì—… ê³µê°œ
        async function revealAssignment(id) {
            try {
                const response = await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${encodeURIComponent(id)}`, {
                    method: 'PATCH',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify({ is_revealed: true, revealed_at: new Date().toISOString() })
                });

                if (response.ok) {
                    // ë¡œì»¬ ë°ì´í„° ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    const idx = data.virtualAssignments.findIndex(v => v.id === id);
                    if (idx !== -1) {
                        data.virtualAssignments[idx].isRevealed = true;
                        data.virtualAssignments[idx].revealedAt = Date.now();
                    }
                    showToast('âœ… ì§ì—… ê³µê°œë¨', 'success');
                    updateAssignmentStatus();
                    renderAssignments();
                    renderLineup();
                } else {
                    const errText = await response.text();
                    console.error('ê³µê°œ ì‹¤íŒ¨:', response.status, errText);
                    showToast('ê³µê°œ ì‹¤íŒ¨: ' + response.status, 'error');
                }
            } catch (e) {
                console.error('ê³µê°œ ì˜¤ë¥˜:', e);
                showToast('ê³µê°œ ì‹¤íŒ¨', 'error');
            }
        }
        
        // ì „ì²´ ê³µê°œ
        async function revealAllPending() {
            const date = document.getElementById('assignDate')?.value;
            const part = document.getElementById('assignPart')?.value;
            
            if (!date || !part) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            const pendingList = data.virtualAssignments.filter(v => 
                v.scheduleDate === date && v.schedulePart === part && !v.isRevealed
            );
            
            if (pendingList.length === 0) {
                showToast('ê³µê°œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
                return;
            }
            
            if (!confirm(`${pendingList.length}ëª…ì˜ ì •ë³´ë¥¼ ëª¨ë‘ ê³µê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            showToast('ê³µê°œ ì²˜ë¦¬ ì¤‘...', 'info');

            for (const v of pendingList) {
                await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${encodeURIComponent(v.id)}`, {
                    method: 'PATCH',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify({ is_revealed: true, revealed_at: new Date().toISOString() })
                });

                // ë¡œì»¬ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
                const idx = data.virtualAssignments.findIndex(a => a.id === v.id);
                if (idx !== -1) {
                    data.virtualAssignments[idx].isRevealed = true;
                    data.virtualAssignments[idx].revealedAt = Date.now();
                }
            }

            showToast(`âœ… ${pendingList.length}ëª… ê³µê°œ ì™„ë£Œ!`, 'success');
            updateAssignmentStatus();
            renderAssignments();
            renderLineup();
        }
        
        // ë°°ì • ì‚­ì œ
        async function deleteAssignment(id) {
            if (!confirm('ì´ ë°°ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    headers: SUPABASE_HEADERS
                });

                if (response.ok) {
                    // ë¡œì»¬ ë°ì´í„°ì—ì„œ ì¦‰ì‹œ ì œê±°
                    data.virtualAssignments = data.virtualAssignments.filter(v => v.id !== id);
                    showToast('âœ… ì‚­ì œ ì™„ë£Œ', 'success');
                    updateAssignmentStatus();
                    renderAssignments();
                    renderLineup();  // ë¼ì¸ì—…ë„ ì—…ë°ì´íŠ¸
                } else {
                    showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', e);
                showToast('ì‚­ì œ ì˜¤ë¥˜', 'error');
            }
        }
        
        // íŒŒí‹° ì „ì²´ ë°°ì • ì‚­ì œ
        async function clearPartyAssignments() {
            const date = document.getElementById('assignDate')?.value;
            const part = document.getElementById('assignPart')?.value;
            
            if (!date || !part) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            const toDelete = data.virtualAssignments.filter(v => 
                v.scheduleDate === date && v.schedulePart === part
            );
            
            if (toDelete.length === 0) {
                showToast('ì‚­ì œí•  ë°°ì •ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
                return;
            }
            
            if (!confirm(`${date} ${part}ì˜ ê°€ìƒì°¸ì—¬ì ${toDelete.length}ëª…ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            showToast('ì‚­ì œ ì¤‘...', 'info');

            for (const v of toDelete) {
                await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${encodeURIComponent(v.id)}`, {
                    method: 'DELETE',
                    headers: SUPABASE_HEADERS
                });
            }

            // ë¡œì»¬ ë°ì´í„°ì—ì„œë„ ì œê±°
            const deleteIds = toDelete.map(v => v.id);
            data.virtualAssignments = data.virtualAssignments.filter(v => !deleteIds.includes(v.id));

            showToast(`âœ… ${toDelete.length}ëª… ì‚­ì œ ì™„ë£Œ!`, 'success');
            updateAssignmentStatus();
            renderAssignments();
            renderLineup();
        }
        
        // ========================================
        // ê¸°ì¡´ ê°€ìƒì°¸ì—¬ì í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜)
        // ========================================
        
        async function clearGeneratedVirtuals() {
            const eventDate = document.getElementById('virtualGenDate').value;
            const eventPart = document.getElementById('virtualGenPart').value;
            
            if (!eventDate || !eventPart) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            const toDelete = data.generatedVirtuals.filter(v => 
                v.eventDate === eventDate && v.eventPart === eventPart
            );
            
            if (toDelete.length === 0) {
                showToast('ì‚­ì œí•  ê°€ìƒì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤', 'info');
                return;
            }
            
            if (!confirm(`${eventDate} ${eventPart}ì˜ ê°€ìƒì°¸ì—¬ì ${toDelete.length}ëª…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            showToast('ì‚­ì œ ì¤‘...', 'info');
            
            for (const v of toDelete) {
                await fetch(`${API_BASE}/generated_virtuals/${v.id}`, { method: 'DELETE' });
            }
            
            showToast(`âœ… ${toDelete.length}ëª… ì‚­ì œ ì™„ë£Œ!`, 'success');
            await refreshAllData();
        }
        
        async function deleteGeneratedVirtual(id) {
            if (!confirm('ì´ ê°€ìƒì°¸ì—¬ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            await fetch(`${API_BASE}/generated_virtuals/${id}`, { method: 'DELETE' });
            showToast('ì‚­ì œ ì™„ë£Œ', 'success');
            await refreshAllData();
        }
        
        function refreshGeneratedVirtuals() {
            renderGeneratedVirtuals();
            showToast('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ', 'success');
        }
        
        // ========================================
        // ë¼ì¸ì—… (ì‹¤ì œ ì˜ˆì•½ì + ê°€ìƒì°¸ì—¬ì)
        // ========================================
        function updateLineupDateFilter() {
            // í˜„ì¬ ì„ íƒëœ ê°’ ì €ì¥ (ë¦¬ì…‹ ë°©ì§€)
            const select = document.getElementById('lineupDateFilter');
            const currentValue = select?.value || '';
            
            // party_schedulesì—ì„œ í™œì„±í™”ëœ ë‚ ì§œ ì¶”ì¶œ
            const scheduleDates = data.schedules
                .filter(s => s.isActive !== false)
                .map(s => formatDateKorean(s.date))
                .filter(Boolean);
            
            // ì˜ˆì•½ ë°ì´í„°ì—ì„œ ë‚ ì§œ ì¶”ì¶œ - ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©
            const reservationDates = data.reservations
                .map(r => normalizeDateStr(r.eventDate))
                .filter(Boolean);
            
            // ë°°ì •ëœ ê°€ìƒì°¸ì—¬ìì—ì„œ ë‚ ì§œ ì¶”ì¶œ (ìƒˆ ì‹œìŠ¤í…œ) - ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©
            const assignmentDates = (data.virtualAssignments || [])
                .map(v => normalizeDateStr(v.scheduleDate))
                .filter(Boolean);
            
            // ì´ì „ ì‹œìŠ¤í…œ ê°€ìƒì°¸ì—¬ì (í˜¸í™˜ì„±)
            const virtualDates = (data.generatedVirtuals || [])
                .map(v => normalizeDateStr(v.eventDate))
                .filter(Boolean);
            
            // ëª¨ë“  ë‚ ì§œ í•©ì§‘í•© (ì¤‘ë³µ ì œê±°) + ìµœì†Œ ë‚ ì§œ í•„í„°ë§
            const allDates = [...new Set([...scheduleDates, ...reservationDates, ...assignmentDates, ...virtualDates])]
                .filter(d => isDateAfterMin(d));  // 1ì›” 11ì¼ ì´ì „ ë‚ ì§œ ì œì™¸
            
            // ë‚ ì§œ ì •ë ¬ (parseDateForComparison ê¸°ì¤€)
            allDates.sort((a, b) => {
                const dateA = parseDateForComparison(a) || '';
                const dateB = parseDateForComparison(b) || '';
                return dateA.localeCompare(dateB);
            });
            
            if (select) {
                select.innerHTML = '<option value="">ë‚ ì§œ ì„ íƒ</option>' + 
                    allDates.map(d => `<option value="${d}">${d}</option>`).join('');
                
                // ì´ì „ ì„ íƒ ê°’ ë³µì› (ìˆìœ¼ë©´)
                if (currentValue && allDates.includes(currentValue)) {
                    select.value = currentValue;
                }
            }
        }
        
        let currentLineupData = { male: [], female: [] };
        
        // ì¶œìƒì—°ë„ë¥¼ 2ìë¦¬ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (1994 â†’ 94)
        function formatBirthYear(birthYear) {
            if (!birthYear) return '-';
            return String(birthYear).slice(-2);
        }
        
        // ë‚˜ì´ì¡°ê±´ ì²´í¬ (ì´ˆê³¼ ì—¬ë¶€)
        function checkAgeCondition(birthYear, minBirthYear, maxBirthYear) {
            if (!birthYear || !minBirthYear || !maxBirthYear) return true; // ì¡°ê±´ ì—†ìœ¼ë©´ í†µê³¼
            return birthYear >= minBirthYear && birthYear <= maxBirthYear;
        }
        
        function renderLineup() {
            const dateFilter = document.getElementById('lineupDateFilter')?.value || '';
            const partFilter = document.getElementById('lineupPartFilter')?.value || '';
            
            const maleBody = document.getElementById('lineupMaleBody');
            const femaleBody = document.getElementById('lineupFemaleBody');
            
            if (!dateFilter || !partFilter) {
                maleBody.innerHTML = '<tr><td colspan="7" class="empty-state">ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</td></tr>';
                femaleBody.innerHTML = '<tr><td colspan="7" class="empty-state">ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</td></tr>';
                document.getElementById('lineupTotalCount').textContent = '-';
                document.getElementById('lineupRealCount').textContent = '-';
                document.getElementById('lineupVirtualCount').textContent = '-';
                document.getElementById('lineupMaleCount').textContent = '-';
                document.getElementById('lineupFemaleCount').textContent = '-';
                document.getElementById('lineupMaleSubCount').textContent = '';
                document.getElementById('lineupFemaleSubCount').textContent = '';
                return;
            }
            
            const currentYear = new Date().getFullYear();
            
            // ë‚˜ì´ì¡°ê±´ ê°€ì ¸ì˜¤ê¸°
            const ageCondition = getAgeCondition(dateFilter, partFilter);
            
            // ì‹¤ì œ ì˜ˆì•½ì (í•´ë‹¹ ë‚ ì§œ/ì„¸ì…˜)
            const realReservations = data.reservations.filter(r => {
                const matchDate = isSameDate(r.eventDate, dateFilter);
                const matchPart = r.eventPart === partFilter;
                const notCancelled = r.status !== 'ì·¨ì†Œ';
                return matchDate && matchPart && notCancelled;
            });
            
            // ì‹¤ì œ ì˜ˆì•½ì ë°ì´í„° ê°€ê³µ
            const realPeople = realReservations.map(r => {
                const customer = data.customers.find(c => normalizePhone(c.id) === normalizePhone(r.phone));
                const survey = data.surveys.find(s => normalizePhone(s.phone) === normalizePhone(r.phone));
                
                const hasSurvey = !!survey;
                const name = customer?.name || survey?.name || r.crewName || 'ì´ë¦„ì—†ìŒ';
                const gender = customer?.gender || survey?.gender || 'ë¯¸ìƒ';
                const birthYear = customer?.birth_year || customer?.birthYear || survey?.birth_year || survey?.birthYear;
                const height = customer?.height || survey?.height;
                const job = customer?.job_category || customer?.jobCategory || survey?.job_category || survey?.jobCategory || '-';
                const tier = getTier(gender, job);
                
                return {
                    type: 'real',
                    hasSurvey,
                    name,
                    gender,
                    birthYear,
                    age: birthYear ? currentYear - birthYear : null,
                    height,
                    job,
                    tier
                };
            });
            
            // ========== ì‹¤ì‹œê°„ ê³„ì‚° ì‹œìŠ¤í…œ ==========
            // ì „ì—­ normalizeDateStr í•¨ìˆ˜ ì‚¬ìš©
            const normalizedDateFilter = normalizeDateStr(dateFilter);
            
            // í•´ë‹¹ ì¼ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸° - ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©
            const schedule = data.schedules.find(s => {
                return normalizeDateStr(s.date) === normalizedDateFilter && s.part === partFilter;
            });
            
            // íŒŒí‹° ìœ í˜•ë³„ ì •ì› ì •ë³´
            const partyType = schedule?.partyType || 'coffee';
            const partyTypeInfo = data.partyTypes?.find(t => t.id === partyType);
            const maleCapacity = partyTypeInfo?.maleCapacity || 12;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
            const femaleCapacity = partyTypeInfo?.femaleCapacity || 12;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
            const minVacancy = partyTypeInfo?.minVacancy || 2;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
            
            // D-day ë° ë¹„ìœ¨ ê³„ì‚°
            const daysUntil = getDaysUntil(dateFilter);
            const ratio = getRatioByDday(daysUntil);
            
            // ì‹¤ì œ ì˜ˆì•½ì ì„±ë³„ë³„ ë¶„ë¥˜
            const realMalesPeople = realPeople.filter(p => p.gender === 'ë‚¨ì');
            const realFemalesPeople = realPeople.filter(p => p.gender === 'ì—¬ì');
            
            // ë¹„ìœ¨ ê¸°ë°˜ ëª©í‘œ ê³„ì‚°
            const targetMale = Math.round(maleCapacity * ratio / 100);
            const targetFemale = Math.round(femaleCapacity * ratio / 100);
            
            // í•„ìš”í•œ ê°€ìƒ ì¸ì› ê³„ì‚° (ì‹¤ì‹œê°„)
            let needVirtualMale = Math.max(0, targetMale - realMalesPeople.length);
            let needVirtualFemale = Math.max(0, targetFemale - realFemalesPeople.length);
            
            // ìµœëŒ€ 80% í•œë„
            needVirtualMale = Math.min(needVirtualMale, Math.floor(maleCapacity * 0.8) - realMalesPeople.length);
            needVirtualFemale = Math.min(needVirtualFemale, Math.floor(femaleCapacity * 0.8) - realFemalesPeople.length);
            
            // ìµœì†Œ ê³µì„ ìœ ì§€
            needVirtualMale = Math.min(needVirtualMale, maleCapacity - Math.floor(minVacancy/2) - realMalesPeople.length);
            needVirtualFemale = Math.min(needVirtualFemale, femaleCapacity - Math.ceil(minVacancy/2) - realFemalesPeople.length);
            
            needVirtualMale = Math.max(0, needVirtualMale);
            needVirtualFemale = Math.max(0, needVirtualFemale);
            
            // DBì—ì„œ ê°€ìƒì°¸ì—¬ì ê°€ì ¸ì˜¤ê¸° - ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©
            const allVirtualFromDB = data.virtualAssignments
                .filter(v => {
                    return normalizeDateStr(v.scheduleDate) === normalizedDateFilter && v.schedulePart === partFilter;
                })
                .map(v => ({
                    type: 'virtual',
                    id: v.id,
                    isRevealed: v.isRevealed,
                    gender: v.gender,
                    birthYear: v.birthYear,
                    age: v.birthYear ? currentYear - v.birthYear : null,
                    height: v.height,
                    job: v.job,
                    tier: v.tier || getTier(v.gender, v.job)
                }));
            
            // ë°°ì •ëœ ëª¨ë“  ê°€ìƒì°¸ì—¬ì í‘œì‹œ (DBì— ì €ì¥ëœ ëª¨ë“  ë°°ì • í‘œì‹œ)
            const virtualMalesPeople = allVirtualFromDB.filter(v => v.gender === 'ë‚¨ì');
            const virtualFemalesPeople = allVirtualFromDB.filter(v => v.gender === 'ì—¬ì');
            const virtualPeople = [...virtualMalesPeople, ...virtualFemalesPeople];
            
            // í•©ì¹˜ê¸°
            const allPeople = [...realPeople, ...virtualPeople];
            
            // ë‚¨ë…€ ë¶„ë¦¬ í›„ í‹°ì–´ìˆœ ì •ë ¬
            const males = sortByTier([...realMalesPeople, ...virtualMalesPeople]);
            const females = sortByTier([...realFemalesPeople, ...virtualFemalesPeople]);
            
            currentLineupData = { male: males, female: females };
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            const realMales = males.filter(p => p.type === 'real').length;
            const realFemales = females.filter(p => p.type === 'real').length;
            const virtualMales = males.filter(p => p.type === 'virtual').length;
            const virtualFemales = females.filter(p => p.type === 'virtual').length;
            const pendingCount = allPeople.filter(p => 
                (p.type === 'virtual' && !p.isRevealed) || 
                (p.type === 'real' && !p.hasSurvey)
            ).length;
            
            document.getElementById('lineupTotalCount').textContent = allPeople.length;
            document.getElementById('lineupRealCount').textContent = realPeople.length;
            document.getElementById('lineupVirtualCount').textContent = virtualPeople.length;
            document.getElementById('lineupMaleCount').textContent = males.length;
            document.getElementById('lineupFemaleCount').textContent = females.length;
            document.getElementById('lineupMaleSubCount').textContent = `(ì‹¤ì œ ${realMales} + ê°€ìƒ ${virtualMales})`;
            document.getElementById('lineupFemaleSubCount').textContent = `(ì‹¤ì œ ${realFemales} + ê°€ìƒ ${virtualFemales})`;
            
            // ë¹„ìœ¨ ê¸°ë°˜ ì •ë³´ ì—…ë°ì´íŠ¸
            updateLineupRatioInfo(dateFilter, partFilter, males.length, females.length);
            
            // í…Œì´ë¸” ë Œë”ë§ (ì •ë³´í™•ì¸ì¤‘/ëª¨ì§‘ì¤‘ í‘œì‹œ)
            const renderRow = (p, idx) => {
                // ì •ë³´í™•ì¸ì¤‘ ì—¬ë¶€ íŒë‹¨
                const isPending = (p.type === 'virtual' && !p.isRevealed) || (p.type === 'real' && !p.hasSurvey);
                
                // ë‚˜ì´ì¡°ê±´ ì²´í¬
                const isAgeValid = ageCondition 
                    ? checkAgeCondition(p.birthYear, ageCondition.minBirthYear, ageCondition.maxBirthYear)
                    : true;
                const ageWarning = !isAgeValid ? ' âš ï¸' : '';
                const ageStyle = !isAgeValid ? 'color: var(--danger); font-weight: bold;' : '';
                
                // ìœ í˜• í‘œì‹œ (í•­ìƒ í‘œì‹œ)
                const typeIcon = p.type === 'virtual' 
                    ? '<span style="color: var(--purple);" title="ê°€ìƒ">ğŸ‘»</span>' 
                    : '<span style="color: var(--primary);" title="ì‹¤ì œ">âœ“</span>';
                
                // ê³µê°œ/ë¹„ê³µê°œ í† ê¸€ ë²„íŠ¼ (ê°€ìƒì°¸ì—¬ìë§Œ)
                let visibilityBtn = '';
                if (p.type === 'virtual' && p.id) {
                    if (!p.isRevealed) {
                        // ë¹„ê³µê°œ ìƒíƒœ â†’ ê³µê°œí•˜ê¸° ë²„íŠ¼
                        visibilityBtn = `<button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); revealFromLineup('${p.id}')" title="ê³µê°œí•˜ê¸° (${p.job}, ${p.tier}í‹°ì–´)" style="padding: 2px 6px; font-size: 11px;">
                             <i class="fas fa-eye"></i>
                           </button>`;
                    } else {
                        // ê³µê°œ ìƒíƒœ â†’ ë¹„ê³µê°œí•˜ê¸° ë²„íŠ¼
                        visibilityBtn = `<button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); hideFromLineup('${p.id}')" title="ë¹„ê³µê°œí•˜ê¸° (ì •ë³´í™•ì¸ì¤‘ìœ¼ë¡œ ë³€ê²½)" style="padding: 2px 6px; font-size: 11px;">
                             <i class="fas fa-eye-slash"></i>
                           </button>`;
                    }
                }
                const revealBtn = visibilityBtn;
                
                if (isPending) {
                    // ì •ë³´í™•ì¸ì¤‘ - ê°€ìƒì°¸ì—¬ìë§Œ í´ë¦­ ê°€ëŠ¥
                    const pendingClickHandler = p.type === 'virtual' && p.id
                        ? `onclick="openLineupEditModal('${p.id}', '${p.gender}')" style="cursor: pointer;" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •"`
                        : '';
                    
                    return `
                        <tr class="pending-row" style="opacity: 0.7;" ${pendingClickHandler}>
                            <td>${idx + 1}</td>
                            <td><span class="tier tier-pending">?</span></td>
                            <td style="color: var(--text-muted);">-</td>
                            <td style="color: var(--text-muted);">-</td>
                            <td style="color: var(--text-muted);">-</td>
                            <td style="color: var(--warning); font-weight: 500;">ì •ë³´í™•ì¸ì¤‘ ${p.type === 'virtual' ? '<i class="fas fa-edit" style="font-size: 11px;"></i>' : ''}</td>
                            <td>${typeIcon} ${revealBtn}</td>
                        </tr>
                    `;
                }
                
                // ê°€ìƒì°¸ì—¬ìë§Œ í´ë¦­ ê°€ëŠ¥
                const clickHandler = p.type === 'virtual' && p.id
                    ? `onclick="openLineupEditModal('${p.id}', '${p.gender}')" style="cursor: pointer;" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •"`
                    : '';
                
                // ì‚­ì œ ë²„íŠ¼ (ê°€ìƒì°¸ì—¬ìë§Œ)
                const deleteBtn = p.type === 'virtual' && p.id
                    ? `<button onclick="event.stopPropagation(); deleteFromLineup('${p.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 2px 4px;" title="ì‚­ì œ"><i class="fas fa-trash" style="font-size: 11px;"></i></button>`
                    : '';
                
                return `
                    <tr class="${p.type === 'virtual' ? 'virtual-row' : ''} ${!isAgeValid ? 'age-warning-row' : ''}" ${clickHandler}>
                        <td>${idx + 1}</td>
                        <td><span class="tier tier-${p.tier}">${p.tier}</span></td>
                        <td style="color: var(--text-muted);">-</td>
                        <td style="${ageStyle}">${formatBirthYear(p.birthYear)}${ageWarning}</td>
                        <td>${p.height || '-'}</td>
                        <td>${p.job}</td>
                        <td>${typeIcon}${p.type === 'virtual' ? ' <i class="fas fa-edit" style="color: var(--text-muted); font-size: 11px;"></i>' : ''} ${deleteBtn}</td>
                    </tr>
                `;
            };
            
            maleBody.innerHTML = males.length > 0 
                ? males.map(renderRow).join('')
                : '<tr><td colspan="7" class="empty-state">ë‚¨ì ë¼ì¸ì—… ì—†ìŒ</td></tr>';
                
            femaleBody.innerHTML = females.length > 0 
                ? females.map(renderRow).join('')
                : '<tr><td colspan="7" class="empty-state">ì—¬ì ë¼ì¸ì—… ì—†ìŒ</td></tr>';
        }
        
        document.getElementById('lineupDateFilter')?.addEventListener('change', renderLineup);
        document.getElementById('lineupPartFilter')?.addEventListener('change', renderLineup);
        
        // ë¼ì¸ì—…ì—ì„œ ê°œë³„ ê°€ìƒì°¸ì—¬ì ê³µê°œ
        async function revealFromLineup(id) {
            try {
                const existing = data.virtualAssignments.find(v => v.id === id);
                if (!existing) {
                    showToast('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }

                // snake_caseë¡œ í•„ìš”í•œ í•„ë“œë§Œ ì—…ë°ì´íŠ¸
                const response = await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${encodeURIComponent(id)}`, {
                    method: 'PATCH',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify({
                        is_revealed: true,
                        revealed_at: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    showToast(`âœ… ${existing.job} (${existing.tier}í‹°ì–´) ê³µê°œë¨!`, 'success');

                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    const idx = data.virtualAssignments.findIndex(v => v.id === id);
                    if (idx !== -1) {
                        data.virtualAssignments[idx].isRevealed = true;
                        data.virtualAssignments[idx].revealedAt = Date.now();
                    }

                    renderLineup();
                    renderAssignments();
                } else {
                    const errText = await response.text();
                    console.error('ê³µê°œ ì‹¤íŒ¨:', response.status, errText);
                    showToast('ê³µê°œ ì‹¤íŒ¨: ' + response.status, 'error');
                }
            } catch (e) {
                console.error('ê³µê°œ ì˜¤ë¥˜:', e);
                showToast('ê³µê°œ ì˜¤ë¥˜', 'error');
            }
        }

        // ë¼ì¸ì—…ì—ì„œ ê°œë³„ ê°€ìƒì°¸ì—¬ì ë¹„ê³µê°œ (ì •ë³´í™•ì¸ì¤‘ìœ¼ë¡œ ë³€ê²½)
        async function hideFromLineup(id) {
            try {
                const existing = data.virtualAssignments.find(v => v.id === id);
                if (!existing) {
                    showToast('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }

                // snake_caseë¡œ í•„ìš”í•œ í•„ë“œë§Œ ì—…ë°ì´íŠ¸
                const response = await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${encodeURIComponent(id)}`, {
                    method: 'PATCH',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify({
                        is_revealed: false,
                        revealed_at: null
                    })
                });

                if (response.ok) {
                    showToast(`ğŸ™ˆ ${existing.job} (${existing.tier}í‹°ì–´) ë¹„ê³µê°œë¨ (ì •ë³´í™•ì¸ì¤‘)`, 'success');

                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    const idx = data.virtualAssignments.findIndex(v => v.id === id);
                    if (idx !== -1) {
                        data.virtualAssignments[idx].isRevealed = false;
                        data.virtualAssignments[idx].revealedAt = null;
                    }

                    renderLineup();
                    renderAssignments();
                } else {
                    const errText = await response.text();
                    console.error('ë¹„ê³µê°œ ì‹¤íŒ¨:', response.status, errText);
                    showToast('ë¹„ê³µê°œ ì‹¤íŒ¨: ' + response.status, 'error');
                }
            } catch (e) {
                console.error('ë¹„ê³µê°œ ì˜¤ë¥˜:', e);
                showToast('ë¹„ê³µê°œ ì˜¤ë¥˜', 'error');
            }
        }

        function refreshLineup() {
            renderLineup();
            showToast('ë¼ì¸ì—… ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ', 'success');
        }

        // ë¼ì¸ì—…ì—ì„œ ê°€ìƒì°¸ì—¬ì ëœë¤ ì¶”ê°€
        async function addRandomVirtualToLineup(gender) {
            const dateFilter = document.getElementById('lineupDateFilter')?.value;
            const partFilter = document.getElementById('lineupPartFilter')?.value;

            if (!dateFilter || !partFilter) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            // í•´ë‹¹ ì„±ë³„ì˜ ê°€ìƒì°¸ì—¬ì í’€ì—ì„œ ì•„ì§ ë°°ì •ë˜ì§€ ì•Šì€ ì‚¬ëŒ ì°¾ê¸°
            const normalizedDate = normalizeDateStr(dateFilter);
            const alreadyAssignedIds = data.virtualAssignments
                .filter(v => normalizeDateStr(v.scheduleDate) === normalizedDate && v.schedulePart === partFilter)
                .map(v => v.virtualId);

            let availablePool = data.virtualPool.filter(v =>
                v.gender === gender && !alreadyAssignedIds.includes(v.id)
            );

            if (availablePool.length === 0) {
                showToast(`ë°°ì • ê°€ëŠ¥í•œ ${gender} ê°€ìƒì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤`, 'error');
                return;
            }

            // ë‚˜ì´ì¡°ê±´ ì²´í¬ - ê°€ìƒì°¸ì—¬ìëŠ” ë°˜ë“œì‹œ ë‚˜ì´ ì¡°ê±´ ë‚´ì—ì„œë§Œ ì„ íƒ
            const ageCondition = getAgeCondition(dateFilter, partFilter);
            if (ageCondition && ageCondition.minBirthYear && ageCondition.maxBirthYear) {
                // ë‚˜ì´ì¡°ê±´ì— ë§ëŠ” í’€ë¡œ í•„í„°ë§
                availablePool = availablePool.filter(v =>
                    checkAgeCondition(v.birthYear, ageCondition.minBirthYear, ageCondition.maxBirthYear)
                );

                if (availablePool.length === 0) {
                    const ageRange = `${String(ageCondition.minBirthYear).slice(-2)}~${String(ageCondition.maxBirthYear).slice(-2)}ë…„ìƒ`;
                    showToast(`ë‚˜ì´ì¡°ê±´(${ageRange})ì— ë§ëŠ” ${gender} ê°€ìƒì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤. í’€ì— í•´ë‹¹ ë‚˜ì´ëŒ€ ì¶”ê°€ í•„ìš”.`, 'error');
                    return;
                }
            }

            // ì¡°ê±´ì— ë§ëŠ” í’€ì—ì„œ ëœë¤ ì„ íƒ
            const randomIndex = Math.floor(Math.random() * availablePool.length);
            const selected = availablePool[randomIndex];

            try {
                // DBì— ì €ì¥ (snake_case, ISO í˜•ì‹)
                const assignmentData = {
                    virtual_id: selected.id,
                    schedule_date: dateFilter,
                    schedule_part: partFilter,
                    gender: gender,
                    birth_year: selected.birthYear,
                    height: selected.height,
                    job: selected.job,
                    tier: selected.tier || getTier(gender, selected.job),
                    is_revealed: false,
                    assigned_at: new Date().toISOString()
                };

                const response = await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}`, {
                    method: 'POST',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify(assignmentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    const newId = result[0]?.id || result.id;

                    // ë¡œì»¬ ë°ì´í„° ì¶”ê°€
                    data.virtualAssignments.push({
                        id: newId,
                        virtualId: selected.id,
                        scheduleDate: dateFilter,
                        schedulePart: partFilter,
                        gender: gender,
                        birthYear: selected.birthYear,
                        height: selected.height,
                        job: selected.job,
                        tier: selected.tier || getTier(gender, selected.job),
                        isRevealed: false,
                        assignedAt: Date.now()
                    });

                    showToast(`âœ… ${gender} ê°€ìƒì°¸ì—¬ì ì¶”ê°€: ${selected.job} (${selected.tier}í‹°ì–´)`, 'success');
                    renderLineup();
                    renderAssignments();
                } else {
                    const errText = await response.text();
                    console.error('ëœë¤ ë°°ì • ì‹¤íŒ¨:', errText);
                    showToast('ë°°ì • ì‹¤íŒ¨: ' + response.status, 'error');
                }
            } catch (e) {
                console.error('ëœë¤ ë°°ì • ì˜¤ë¥˜:', e);
                showToast('ë°°ì • ì˜¤ë¥˜: ' + e.message, 'error');
            }
        }

        // ë¼ì¸ì—…ì—ì„œ ê°€ìƒì°¸ì—¬ì ì‚­ì œ
        async function deleteFromLineup(id) {
            if (!confirm('ì´ ê°€ìƒì°¸ì—¬ìë¥¼ ë¼ì¸ì—…ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    headers: SUPABASE_HEADERS
                });
                
                if (response.ok) {
                    // ë¡œì»¬ ë°ì´í„°ì—ì„œë„ ì œê±°
                    data.virtualAssignments = data.virtualAssignments.filter(v => v.id !== id);
                    showToast('âœ… ì‚­ì œ ì™„ë£Œ', 'success');
                    renderLineup();
                    renderAssignments();
                } else {
                    showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', e);
                showToast('ì‚­ì œ ì˜¤ë¥˜', 'error');
            }
        }
        
        // ===== ë¼ì¸ì—…ì—ì„œ ê°€ìƒì°¸ì—¬ì ìˆ˜ì • ê¸°ëŠ¥ =====
        
        // ëª¨ë‹¬ ì—´ê¸° - ê°€ìƒì°¸ì—¬ì ì •ë³´ ë¡œë“œ
        function openLineupEditModal(assignmentId, gender) {
            // ë°°ì • ë°ì´í„°ì—ì„œ ì°¾ê¸°
            const assignment = data.virtualAssignments.find(v => v.id === assignmentId);
            if (!assignment) {
                showToast('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            // ëª¨ë‹¬ì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('lineupEditId').value = assignmentId;
            document.getElementById('lineupEditVirtualId').value = assignment.virtualId || '';
            document.getElementById('lineupEditGender').value = gender;
            document.getElementById('lineupEditBirthYear').value = assignment.birthYear || '';
            document.getElementById('lineupEditHeight').value = assignment.height || '';
            document.getElementById('lineupEditJob').value = assignment.job || '';

            // ê³µê°œ ìƒíƒœ ì„¤ì •
            const isRevealed = assignment.isRevealed || false;
            document.getElementById('lineupEditIsRevealed').value = isRevealed ? 'true' : 'false';
            updateLineupEditVisibilityButtons(isRevealed);

            // ë‚˜ì´ ê³„ì‚°
            updateLineupEditAge();

            // í‹°ì–´ í‘œì‹œ
            updateLineupEditTier();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            const birthYearInput = document.getElementById('lineupEditBirthYear');
            const jobInput = document.getElementById('lineupEditJob');

            birthYearInput.onchange = updateLineupEditAge;
            jobInput.oninput = updateLineupEditTier;
            jobInput.onchange = updateLineupEditTier;

            openModal('lineupEditModal');
        }

        // ê³µê°œ/ë¹„ê³µê°œ í† ê¸€ í•¨ìˆ˜
        function toggleLineupEditVisibility(reveal) {
            document.getElementById('lineupEditIsRevealed').value = reveal ? 'true' : 'false';
            updateLineupEditVisibilityButtons(reveal);
        }

        // ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
        function updateLineupEditVisibilityButtons(isRevealed) {
            const revealBtn = document.getElementById('lineupEditRevealBtn');
            const hideBtn = document.getElementById('lineupEditHideBtn');

            if (isRevealed) {
                revealBtn.classList.remove('btn-secondary');
                revealBtn.classList.add('btn-warning');
                revealBtn.style.opacity = '1';
                hideBtn.classList.remove('btn-warning');
                hideBtn.classList.add('btn-secondary');
                hideBtn.style.opacity = '0.6';
            } else {
                revealBtn.classList.remove('btn-warning');
                revealBtn.classList.add('btn-secondary');
                revealBtn.style.opacity = '0.6';
                hideBtn.classList.remove('btn-secondary');
                hideBtn.classList.add('btn-warning');
                hideBtn.style.opacity = '1';
            }
        }
        
        // ë‚˜ì´ ê³„ì‚° ì—…ë°ì´íŠ¸
        function updateLineupEditAge() {
            const birthYear = parseInt(document.getElementById('lineupEditBirthYear').value);
            const ageSpan = document.getElementById('lineupEditAge');
            
            if (birthYear && birthYear > 1900 && birthYear < 2010) {
                const currentYear = new Date().getFullYear();
                const age = currentYear - birthYear + 1; // í•œêµ­ ë‚˜ì´
                ageSpan.textContent = age;
            } else {
                ageSpan.textContent = '-';
            }
        }
        
        // í‹°ì–´ ìë™ ê³„ì‚° ì—…ë°ì´íŠ¸
        function updateLineupEditTier() {
            const gender = document.getElementById('lineupEditGender').value;
            const job = document.getElementById('lineupEditJob').value.trim();
            const tierDisplay = document.getElementById('lineupEditTierDisplay');
            
            if (!job) {
                tierDisplay.innerHTML = '<span class="tier tier-pending" style="font-size: 18px;">?</span>';
                return;
            }
            
            // getTier í•¨ìˆ˜ ì‚¬ìš© (ì´ë¯¸ ì¡´ì¬)
            const tier = getTier(gender, job);
            
            tierDisplay.innerHTML = `<span class="tier tier-${tier}" style="font-size: 18px;">${tier}</span>`;
        }
        
        // ì €ì¥ - virtual_pool + party_virtual_assignments ë™ì‹œ ì—…ë°ì´íŠ¸
        async function saveLineupEdit() {
            const assignmentId = document.getElementById('lineupEditId').value;
            const virtualId = document.getElementById('lineupEditVirtualId').value;
            const gender = document.getElementById('lineupEditGender').value;
            const birthYear = parseInt(document.getElementById('lineupEditBirthYear').value);
            const height = parseInt(document.getElementById('lineupEditHeight').value) || null;
            const job = document.getElementById('lineupEditJob').value.trim();
            const isRevealed = document.getElementById('lineupEditIsRevealed').value === 'true';

            console.log('=== ë¼ì¸ì—… ìˆ˜ì • ë””ë²„ê·¸ ===');
            console.log('assignmentId:', assignmentId);
            console.log('virtualId:', virtualId);
            console.log('gender:', gender, 'birthYear:', birthYear, 'height:', height, 'job:', job, 'isRevealed:', isRevealed);

            if (!job) {
                showToast('ì§ì—…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            // í‹°ì–´ ìë™ ê³„ì‚°
            const tier = getTier(gender, job);
            console.log('ê³„ì‚°ëœ tier:', tier);

            try {
                let success = true;

                // 1. party_virtual_assignments ì—…ë°ì´íŠ¸ (í˜„ì¬ ë°°ì •)
                const assignmentUpdate = {
                    birth_year: birthYear,
                    height: height,
                    job: job,
                    tier: tier,
                    is_revealed: isRevealed,
                    revealed_at: isRevealed ? new Date().toISOString() : null
                };
                
                const assignUrl = `${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${encodeURIComponent(assignmentId)}`;
                console.log('ë°°ì • PATCH URL:', assignUrl);
                
                const assignRes = await fetch(assignUrl, {
                    method: 'PATCH',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify(assignmentUpdate)
                });
                
                console.log('ë°°ì • PATCH ì‘ë‹µ:', assignRes.status);
                
                if (!assignRes.ok) {
                    const errText = await assignRes.text();
                    console.error('ë°°ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', errText);
                    showToast('ë°°ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + assignRes.status, 'error');
                    success = false;
                }
                
                // 2. virtual_pool ì—…ë°ì´íŠ¸ (ì›ë³¸, virtualIdê°€ ìˆëŠ” ê²½ìš°ë§Œ)
                if (virtualId) {
                    const poolUpdate = {
                        birth_year: birthYear,
                        height: height,
                        job: job,
                        tier: tier
                    };
                    
                    const poolUrl = `${API_BASE}/${TB.VIRTUAL_POOL}?id=eq.${encodeURIComponent(virtualId)}`;
                    console.log('í’€ PATCH URL:', poolUrl);
                    
                    const poolRes = await fetch(poolUrl, {
                        method: 'PATCH',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(poolUpdate)
                    });
                    
                    console.log('í’€ PATCH ì‘ë‹µ:', poolRes.status);
                    
                    if (!poolRes.ok) {
                        console.error('í’€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', await poolRes.text());
                        // í’€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ ë°°ì •ì€ ì„±ê³µí•  ìˆ˜ ìˆìŒ
                    }
                    
                    // 3. ê°™ì€ virtualIdë¥¼ ê°€ì§„ ë‹¤ë¥¸ ë°°ì •ë“¤ë„ ì—…ë°ì´íŠ¸
                    const otherAssignments = data.virtualAssignments.filter(
                        v => v.virtualId === virtualId && v.id !== assignmentId
                    );
                    
                    for (const other of otherAssignments) {
                        await fetch(`${API_BASE}/${TB.VIRTUAL_ASSIGN}?id=eq.${other.id}`, {
                            method: 'PATCH',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify(assignmentUpdate)
                        });
                    }
                }
                
                if (success) {
                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    const idx = data.virtualAssignments.findIndex(v => v.id === assignmentId);
                    if (idx !== -1) {
                        data.virtualAssignments[idx].birthYear = birthYear;
                        data.virtualAssignments[idx].height = height;
                        data.virtualAssignments[idx].job = job;
                        data.virtualAssignments[idx].tier = tier;
                        data.virtualAssignments[idx].isRevealed = isRevealed;
                        data.virtualAssignments[idx].revealedAt = isRevealed ? Date.now() : null;
                    }
                    
                    // virtualPoolë„ ì—…ë°ì´íŠ¸
                    if (virtualId) {
                        const poolIdx = data.virtualPool.findIndex(v => v.id === virtualId);
                        if (poolIdx !== -1) {
                            data.virtualPool[poolIdx].birthYear = birthYear;
                            data.virtualPool[poolIdx].height = height;
                            data.virtualPool[poolIdx].job = job;
                            data.virtualPool[poolIdx].tier = tier;
                        }
                    }
                    
                    closeModal('lineupEditModal');
                    showToast(`âœ… ìˆ˜ì • ì™„ë£Œ! ${job} (${tier}í‹°ì–´)`, 'success');
                    
                    // ë¼ì¸ì—… ë‹¤ì‹œ ë Œë”ë§
                    renderLineup();
                    renderAssignments();
                } else {
                    showToast('ìˆ˜ì • ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                console.error('ìˆ˜ì • ì˜¤ë¥˜:', e);
                showToast('ìˆ˜ì • ì˜¤ë¥˜: ' + e.message, 'error');
            }
        }
        
        // ë¼ì¸ì—…ì— ë¹„ìœ¨ ê¸°ë°˜ ì •ë³´ í‘œì‹œ
        function updateLineupRatioInfo(dateFilter, partFilter, currentMales, currentFemales) {
            const infoDiv = document.getElementById('lineupRatioInfo');
            if (!infoDiv) return;
            
            // í•´ë‹¹ ì¼ì • ì°¾ê¸°
            const schedule = data.schedules.find(s => {
                const dateMatch = s.date === dateFilter;
                const partMatch = s.part === partFilter;
                return dateMatch && partMatch;
            });
            
            if (!schedule) {
                infoDiv.style.display = 'none';
                return;
            }
            
            infoDiv.style.display = 'block';
            
            // íŒŒí‹° ìœ í˜• ì •ë³´
            const partyType = schedule.partyType || 'coffee';
            const partyTypeInfo = data.partyTypes?.find(t => t.id === partyType);
            const maleCapacity = partyTypeInfo?.maleCapacity || 12;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
            const femaleCapacity = partyTypeInfo?.femaleCapacity || 12;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
            const minVacancy = partyTypeInfo?.minVacancy || 2;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
            
            // D-day ë° ë¹„ìœ¨ ê³„ì‚°
            const daysUntil = getDaysUntil(schedule.date);
            const ratio = getRatioByDday(daysUntil);
            
            // ê³µì„ ê³„ì‚°
            const maleVacancy = maleCapacity - currentMales;
            const femaleVacancy = femaleCapacity - currentFemales;
            const totalVacancy = maleVacancy + femaleVacancy;
            
            // UI ì—…ë°ì´íŠ¸
            const typeIcon = partyType === 'wine' ? 'ğŸ·' : 'â˜•';
            document.getElementById('lineupPartyType').textContent = `${typeIcon} ${partyTypeInfo?.name || partyType}`;
            document.getElementById('lineupDday').textContent = daysUntil >= 0 ? `D-${daysUntil}` : `D+${Math.abs(daysUntil)}`;
            document.getElementById('lineupTargetRatio').textContent = `${ratio.toFixed(0)}%`;
            document.getElementById('lineupCapacity').textContent = `ë‚¨ ${maleCapacity} / ì—¬ ${femaleCapacity}`;
            
            // ê³µì„ í‘œì‹œ (ìµœì†Œ ê³µì„ ë¯¸ë§Œì´ë©´ ê²½ê³ )
            const vacancyEl = document.getElementById('lineupVacancy');
            vacancyEl.textContent = `ë‚¨ ${maleVacancy} / ì—¬ ${femaleVacancy}`;
            if (totalVacancy < minVacancy) {
                vacancyEl.style.color = 'var(--danger)';
                vacancyEl.textContent += ` âš ï¸ (ìµœì†Œ ${minVacancy}ëª… í•„ìš”)`;
            } else {
                vacancyEl.style.color = 'var(--success)';
            }
        }
        
        // ì „ì²´ íŒŒí‹° ë¼ì¸ì—… ë³´ê¸°
        function showAllLineups() {
            const weeks = parseInt(document.getElementById('allLineupWeeks')?.value) || 2;
            const container = document.getElementById('allLineupsContainer');
            const section = document.getElementById('allLineupsSection');
            
            if (!container || !section) return;
            
            // í–¥í›„ Nì£¼ ë‚´ì˜ í™œì„± íŒŒí‹° ì¼ì • ê°€ì ¸ì˜¤ê¸°
            const upcomingParties = [];
            const seenKeys = new Set();  // ì¤‘ë³µ ë°©ì§€ìš©
            
            for (const schedule of (data.schedules || [])) {
                if (schedule.isActive === false) continue;
                
                // ìµœì†Œ ë‚ ì§œ í•„í„°ë§ (1ì›” 11ì¼ ì´ì „ ì œì™¸)
                if (!isDateAfterMin(schedule.date)) continue;
                
                const daysUntil = getDaysUntil(schedule.date);
                if (daysUntil < 0 || daysUntil > weeks * 7) continue;
                
                // part í•„ë“œ ì‚¬ìš© (ê° ë ˆì½”ë“œê°€ 1ë¶€, 2ë¶€, 3ë¶€ë¡œ ì €ì¥ë¨)
                const session = schedule.part;
                if (!session) continue;
                
                // ì¤‘ë³µ ì²´í¬ (ë‚ ì§œ+ì„¸ì…˜ ì¡°í•©)
                const key = `${schedule.date}_${session}`;
                if (seenKeys.has(key)) continue;
                seenKeys.add(key);
                
                upcomingParties.push({
                    date: schedule.date,
                    session: session,
                    daysUntil: daysUntil,
                    partyType: schedule.partyType
                });
            }
            
            // ë‚ ì§œ+ì„¸ì…˜ ìˆœ ì •ë ¬
            upcomingParties.sort((a, b) => {
                if (a.daysUntil !== b.daysUntil) return a.daysUntil - b.daysUntil;
                const partOrder = {'1ë¶€': 1, '2ë¶€': 2, '3ë¶€': 3};
                return (partOrder[a.session] || 0) - (partOrder[b.session] || 0);
            });
            
            if (upcomingParties.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 40px;">í–¥í›„ ' + weeks + 'ì£¼ ë‚´ íŒŒí‹° ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                section.style.display = 'block';
                return;
            }
            
            const currentYear = new Date().getFullYear();
            
            // ì „ì—­ normalizeDateStr í•¨ìˆ˜ ì‚¬ìš©
            
            let html = '';
            for (const party of upcomingParties) {
                // í•´ë‹¹ íŒŒí‹°ì˜ ë¼ì¸ì—… ê°€ì ¸ì˜¤ê¸°
                const ageCondition = getAgeCondition(party.date, party.session);
                const normalizedPartyDate = normalizeDateStr(party.date);
                
                // ì‹¤ì œ ì˜ˆì•½ì - ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©
                const realPeople = (data.reservations || [])
                    .filter(r => {
                        const rDate = normalizeDateStr(r.partyDate) || normalizeDateStr(r.eventDate);
                        const matchDate = rDate === normalizedPartyDate;
                        const matchPart = r.partySession === party.session || r.eventPart === party.session;
                        const notCanceled = r.status !== 'ì·¨ì†Œ' && r.status !== 'í™˜ë¶ˆ';
                        return matchDate && matchPart && notCanceled;
                    })
                    .map(r => ({
                        type: 'real',
                        gender: r.gender || '?',
                        birthYear: r.birthYear,
                        age: r.birthYear ? currentYear - r.birthYear : null,
                        height: r.height,
                        job: r.job || '-',
                        tier: getTier(r.gender, r.job)
                    }));
                
                // ê°€ìƒì°¸ì—¬ì - ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©
                const virtualPeople = (data.virtualAssignments || [])
                    .filter(v => {
                        return normalizeDateStr(v.scheduleDate) === normalizedPartyDate && v.schedulePart === party.session;
                    })
                    .map(v => ({
                        type: 'virtual',
                        isRevealed: v.isRevealed,
                        gender: v.gender,
                        birthYear: v.birthYear,
                        age: v.birthYear ? currentYear - v.birthYear : null,
                        height: v.height,
                        job: v.job,
                        tier: v.tier || getTier(v.gender, v.job)
                    }));
                
                const allPeople = [...realPeople, ...virtualPeople];
                const males = allPeople.filter(p => p.gender === 'ë‚¨ì');
                const females = allPeople.filter(p => p.gender === 'ì—¬ì');
                const virtualCount = virtualPeople.length;
                const realCount = realPeople.length;
                const ratio = allPeople.length > 0 ? Math.round(virtualCount / allPeople.length * 100) : 0;
                
                // D-day ë±ƒì§€ ìƒ‰ìƒ
                const dBadgeColor = party.daysUntil <= 3 ? 'var(--danger)' : 
                                   party.daysUntil <= 7 ? 'var(--warning)' : 'var(--info)';
                
                html += `
                <div class="card" style="margin-bottom: 16px; padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="background: ${dBadgeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                D-${party.daysUntil}
                            </span>
                            <h4 style="margin: 0;">${party.date} ${party.session}</h4>
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 13px;">
                            <span>ì´ <strong>${allPeople.length}</strong>ëª…</span>
                            <span style="color: var(--primary);">ì‹¤ì œ <strong>${realCount}</strong></span>
                            <span style="color: var(--warning);">ê°€ìƒ <strong>${virtualCount}</strong> (${ratio}%)</span>
                            <span style="color: #4a9eff;">ë‚¨ <strong>${males.length}</strong></span>
                            <span style="color: #ff6b9d;">ì—¬ <strong>${females.length}</strong></span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <div style="font-size: 12px; color: #4a9eff; margin-bottom: 8px; font-weight: 500;">ğŸ‘¨ ë‚¨ì (${males.length}ëª…)</div>
                            ${males.length > 0 ? `
                            <table style="font-size: 12px;">
                                <thead>
                                    <tr style="background: var(--bg);">
                                        <th style="padding: 4px 8px;">#</th>
                                        <th style="padding: 4px 8px;">ìœ í˜•</th>
                                        <th style="padding: 4px 8px;">í‹°ì–´</th>
                                        <th style="padding: 4px 8px;">ë‚˜ì´</th>
                                        <th style="padding: 4px 8px;">í‚¤</th>
                                        <th style="padding: 4px 8px;">ì§ì—…</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${males.map((p, i) => `
                                    <tr style="${p.type === 'virtual' && !p.isRevealed ? 'opacity: 0.5;' : ''}">
                                        <td style="padding: 4px 8px;">${i + 1}</td>
                                        <td style="padding: 4px 8px;"><span style="font-size: 10px; padding: 2px 4px; border-radius: 4px; background: ${p.type === 'real' ? 'var(--primary)' : 'var(--warning)'}; color: white;">${p.type === 'real' ? 'ì‹¤ì œ' : 'ê°€ìƒ'}</span></td>
                                        <td style="padding: 4px 8px;"><span class="tier tier-${p.tier}">${p.tier}</span></td>
                                        <td style="padding: 4px 8px;">${p.birthYear ? String(p.birthYear).slice(-2) : '-'}</td>
                                        <td style="padding: 4px 8px;">${p.height || '-'}</td>
                                        <td style="padding: 4px 8px;">${p.type === 'virtual' && !p.isRevealed ? 'ì •ë³´í™•ì¸ì¤‘' : (p.job || '-')}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ` : '<div style="color: var(--text-muted); font-size: 12px;">-</div>'}
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #ff6b9d; margin-bottom: 8px; font-weight: 500;">ğŸ‘© ì—¬ì (${females.length}ëª…)</div>
                            ${females.length > 0 ? `
                            <table style="font-size: 12px;">
                                <thead>
                                    <tr style="background: var(--bg);">
                                        <th style="padding: 4px 8px;">#</th>
                                        <th style="padding: 4px 8px;">ìœ í˜•</th>
                                        <th style="padding: 4px 8px;">í‹°ì–´</th>
                                        <th style="padding: 4px 8px;">ë‚˜ì´</th>
                                        <th style="padding: 4px 8px;">í‚¤</th>
                                        <th style="padding: 4px 8px;">ì§ì—…</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${females.map((p, i) => `
                                    <tr style="${p.type === 'virtual' && !p.isRevealed ? 'opacity: 0.5;' : ''}">
                                        <td style="padding: 4px 8px;">${i + 1}</td>
                                        <td style="padding: 4px 8px;"><span style="font-size: 10px; padding: 2px 4px; border-radius: 4px; background: ${p.type === 'real' ? 'var(--primary)' : 'var(--warning)'}; color: white;">${p.type === 'real' ? 'ì‹¤ì œ' : 'ê°€ìƒ'}</span></td>
                                        <td style="padding: 4px 8px;"><span class="tier tier-${p.tier}">${p.tier}</span></td>
                                        <td style="padding: 4px 8px;">${p.birthYear ? String(p.birthYear).slice(-2) : '-'}</td>
                                        <td style="padding: 4px 8px;">${p.height || '-'}</td>
                                        <td style="padding: 4px 8px;">${p.type === 'virtual' && !p.isRevealed ? 'ì •ë³´í™•ì¸ì¤‘' : (p.job || '-')}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ` : '<div style="color: var(--text-muted); font-size: 12px;">-</div>'}
                        </div>
                    </div>
                </div>
                `;
            }
            
            container.innerHTML = html;
            section.style.display = 'block';
            
            // ìŠ¤í¬ë¡¤
            section.scrollIntoView({ behavior: 'smooth' });
            showToast(`í–¥í›„ ${weeks}ì£¼ ë¼ì¸ì—… ${upcomingParties.length}ê°œ ì„¸ì…˜ í‘œì‹œ`, 'success');
        }
        
        function hideAllLineups() {
            const section = document.getElementById('allLineupsSection');
            if (section) section.style.display = 'none';
        }
        
        // ========================================
        // ê³µê°œìš© ë¼ì¸ì—… ê¸°ëŠ¥ (ë¯¼ê°ì •ë³´ ì œì™¸)
        // ========================================
        
        // ê³µê°œ ë¼ì¸ì—… ë‚ ì§œ í•„í„° ì—…ë°ì´íŠ¸
        function updatePublicLineupDateFilter() {
            const select = document.getElementById('publicLineupDate');
            if (!select) return;
            
            const scheduleDates = data.schedules
                .filter(s => s.isActive !== false)
                .map(s => normalizeDateStr(s.date))
                .filter(d => isDateAfterMin(d));
            
            const uniqueDates = [...new Set(scheduleDates)].sort((a, b) => {
                return parseDateForComparison(a)?.localeCompare(parseDateForComparison(b) || '') || 0;
            });
            
            select.innerHTML = '<option value="">ë‚ ì§œ ì„ íƒ</option>' + 
                uniqueDates.map(d => `<option value="${d}">${d}</option>`).join('');
        }
        
        // ê³µê°œ ë¼ì¸ì—… ìƒì„±
        let isGeneratingPublicLineup = false;  // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        
        async function generatePublicLineup() {
            // ì¤‘ë³µ í´ë¦­ ë°©ì§€
            if (isGeneratingPublicLineup) {
                showToast('ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            isGeneratingPublicLineup = true;
            
            const date = document.getElementById('publicLineupDate')?.value;
            const part = document.getElementById('publicLineupPart')?.value;
            
            if (!date || !part) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                isGeneratingPublicLineup = false;
                return;
            }
            
            // ë¼ì¸ì—… í•„í„°ê°€ ë‹¤ë¥´ë©´ ë™ê¸°í™”
            const lineupDate = document.getElementById('lineupDateFilter')?.value;
            const lineupPart = document.getElementById('lineupPartFilter')?.value;
            
            if (lineupDate !== date || lineupPart !== part) {
                showToast('ë¼ì¸ì—… íƒ­ì—ì„œ ê°™ì€ ë‚ ì§œ/ì„¸ì…˜ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            // currentLineupData ì‚¬ìš© (ìµœì¢… ë¼ì¸ì—…ê³¼ 100% ë™ì¼)
            if (!currentLineupData || (!currentLineupData.male?.length && !currentLineupData.female?.length)) {
                showToast('ë¼ì¸ì—… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¼ì¸ì—… íƒ­ì—ì„œ ë‚ ì§œ/ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }
            
            const males = currentLineupData.male || [];
            const females = currentLineupData.female || [];
            
            console.log('=== ê³µê°œ ë¼ì¸ì—… ìƒì„± ë””ë²„ê·¸ ===');
            console.log('males:', males.map(p => ({ job: p.job, type: p.type, isRevealed: p.isRevealed })));
            console.log('females:', females.map(p => ({ job: p.job, type: p.type, isRevealed: p.isRevealed })));
            
            const allPeople = [...males, ...females];
            
            if (allPeople.length === 0) {
                showToast('ë¼ì¸ì—… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            // ê¸°ì¡´ ê³µê°œ ë¼ì¸ì—… ì‚­ì œ (í•œë²ˆì— ì‚­ì œ)
            try {
                const deleteUrl = `${API_BASE}/${TB.PUBLIC_LINEUP}?schedule_date=eq.${encodeURIComponent(date)}&schedule_part=eq.${encodeURIComponent(part)}`;
                console.log('ì‚­ì œ URL:', deleteUrl);
                
                const deleteRes = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: SUPABASE_HEADERS
                });
                
                console.log('ì‚­ì œ ì‘ë‹µ:', deleteRes.status);
                
                if (!deleteRes.ok) {
                    console.error('ì‚­ì œ ì‹¤íŒ¨:', await deleteRes.text());
                }
            } catch (e) {
                console.error('ê¸°ì¡´ ê³µê°œ ë¼ì¸ì—… ì‚­ì œ ì˜¤ë¥˜:', e);
            }
            
            // ìƒˆ ê³µê°œ ë¼ì¸ì—… ìƒì„± (ë¯¼ê°ì •ë³´ ì œì™¸)
            let successCount = 0;
            let displayOrder = 0;
            
            for (const person of [...males, ...females]) {
                // ì‹¤ì œ ì°¸ì—¬ìëŠ” ì„¤ë¬¸ì™„ë£Œ ì‹œ ê³µê°œ, ê°€ìƒì€ isRevealed ì²´í¬
                const isReal = person.type === 'real';
                const revealed = isReal ? (person.hasSurvey !== false) : person.isRevealed;
                
                const publicData = {
                    schedule_date: date,
                    schedule_part: part,
                    gender: person.gender,
                    age_range: revealed ? getAgeRange(person.birthYear) : 'ì •ë³´í™•ì¸ì¤‘',
                    height: revealed ? (person.height || null) : null,
                    job: revealed ? (person.job || '-') : 'ì •ë³´í™•ì¸ì¤‘',
                    display_order: displayOrder++,
                    is_revealed: revealed
                };
                
                try {
                    const res = await fetch(`${API_BASE}/${TB.PUBLIC_LINEUP}`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(publicData)
                    });
                    if (res.ok) successCount++;
                } catch (e) {
                    console.error('ê³µê°œ ë¼ì¸ì—… ìƒì„± ì˜¤ë¥˜:', e);
                }
            }
            
            showToast(`âœ… ê³µê°œ ë¼ì¸ì—… ìƒì„± ì™„ë£Œ! (${successCount}ëª…)`, 'success');
            await refreshPublicLineupData();
            showPublicLineupPreview(date, part);
            refreshPublicLineupList();
            
            isGeneratingPublicLineup = false;  // ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ
        }
        
        // ê³µê°œ ë¼ì¸ì—… ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshPublicLineupData() {
            try {
                const response = await fetch(`${API_BASE}/${TB.PUBLIC_LINEUP}?limit=1000`, {
                    headers: SUPABASE_HEADERS
                });
                const result = await response.json();
                data.publicLineup = (Array.isArray(result) ? result : []).map(row => ({
                    id: row.id,
                    scheduleDate: row.schedule_date,
                    schedulePart: row.schedule_part,
                    gender: row.gender,
                    ageRange: row.age_range,
                    height: row.height,
                    job: row.job,
                    displayOrder: row.display_order,
                    isRevealed: row.is_revealed
                }));
            } catch (e) {
                data.publicLineup = [];
            }
        }
        
        // ê³µê°œ ë¼ì¸ì—… ë¯¸ë¦¬ë³´ê¸°
        function showPublicLineupPreview(date, part) {
            const preview = document.getElementById('publicLineupPreview');
            const content = document.getElementById('publicLineupContent');
            if (!preview || !content) return;
            
            const lineup = (data.publicLineup || [])
                .filter(p => isSameDate(p.scheduleDate, date) && p.schedulePart === part)
                .sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            
            if (lineup.length === 0) {
                preview.style.display = 'none';
                return;
            }
            
            // ì •ì› ê°€ì ¸ì˜¤ê¸°
            const schedule = data.schedules.find(s => isSameDate(s.date, date) && s.part === part);
            const partyType = schedule?.partyType || 'coffee';
            const partyTypeInfo = data.partyTypes?.find(t => t.id === partyType);
            const maleCapacity = partyTypeInfo?.maleCapacity || 12;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
            const femaleCapacity = partyTypeInfo?.femaleCapacity || 12;  // party_typesì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
            
            const males = lineup.filter(p => p.gender === 'ë‚¨ì');
            const females = lineup.filter(p => p.gender === 'ì—¬ì');
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <div style="font-weight: 600; color: #4a9eff; margin-bottom: 8px;">ğŸ‘¨ ë‚¨ ${males.length}/${maleCapacity}</div>
                        <table style="font-size: 12px; width: 100%;">
                            <thead>
                                <tr style="background: var(--card-bg);">
                                    <th style="padding: 4px;">ë‚˜ì´ëŒ€</th>
                                    <th style="padding: 4px;">í‚¤</th>
                                    <th style="padding: 4px;">ì§ì—…</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${males.map(p => `
                                    <tr style="${!p.isRevealed ? 'opacity: 0.6;' : ''}">
                                        <td style="padding: 4px;">${p.isRevealed ? (p.ageRange || '-') : '-'}</td>
                                        <td style="padding: 4px;">${p.isRevealed ? (p.height || '-') : '-'}</td>
                                        <td style="padding: 4px;">${p.job || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #ff6b9d; margin-bottom: 8px;">ğŸ‘© ì—¬ ${females.length}/${femaleCapacity}</div>
                        <table style="font-size: 12px; width: 100%;">
                            <thead>
                                <tr style="background: var(--card-bg);">
                                    <th style="padding: 4px;">ë‚˜ì´ëŒ€</th>
                                    <th style="padding: 4px;">í‚¤</th>
                                    <th style="padding: 4px;">ì§ì—…</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${females.map(p => `
                                    <tr style="${!p.isRevealed ? 'opacity: 0.6;' : ''}">
                                        <td style="padding: 4px;">${p.isRevealed ? (p.ageRange || '-') : '-'}</td>
                                        <td style="padding: 4px;">${p.isRevealed ? (p.height || '-') : '-'}</td>
                                        <td style="padding: 4px;">${p.job || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            preview.style.display = 'block';
        }
        
        // ê³µê°œ ë¼ì¸ì—… í…ìŠ¤íŠ¸ ë³µì‚¬ (í”„ë¦½ìš©)
        function copyPublicLineupText() {
            const date = document.getElementById('publicLineupDate')?.value;
            const part = document.getElementById('publicLineupPart')?.value;
            
            if (!date || !part) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            const lineup = (data.publicLineup || [])
                .filter(p => isSameDate(p.scheduleDate, date) && p.schedulePart === part)
                .sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            
            if (lineup.length === 0) {
                showToast('ê³µê°œ ë¼ì¸ì—…ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            // ì •ì›ì€ party_typesì—ì„œ ê°€ì ¸ì˜¤ê¸°
            const schedule = data.schedules.find(s => isSameDate(s.date, date) && s.part === part);
            const partyType = schedule?.partyType || 'coffee';
            const partyTypeInfo = data.partyTypes?.find(t => t.id === partyType);
            const maleCapacity = partyTypeInfo?.maleCapacity || 12;
            const femaleCapacity = partyTypeInfo?.femaleCapacity || 12;
            
            const males = lineup.filter(p => p.gender === 'ë‚¨ì');
            const females = lineup.filter(p => p.gender === 'ì—¬ì');
            
            let text = `â™‚ï¸ ë‚¨ ${males.length}/${maleCapacity}\n`;
            males.forEach(p => {
                text += `${p.ageRange}\t${p.height}\t${p.job}\n`;
            });
            
            text += `\nâ™€ï¸ ì—¬ ${females.length}/${femaleCapacity}\n`;
            females.forEach(p => {
                text += `${p.ageRange}\t${p.height}\t${p.job}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }).catch(() => {
                showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
            });
        }
        
        // ê³µê°œ ë¼ì¸ì—… ì‚­ì œ
        async function clearPublicLineup() {
            const date = document.getElementById('publicLineupDate')?.value;
            const part = document.getElementById('publicLineupPart')?.value;
            
            if (!date || !part) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            if (!confirm(`${date} ${part} ê³µê°œ ë¼ì¸ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const toDelete = (data.publicLineup || []).filter(p => 
                isSameDate(p.scheduleDate, date) && p.schedulePart === part
            );
            
            for (const item of toDelete) {
                await fetch(`${API_BASE}/${TB.PUBLIC_LINEUP}/${item.id}`, { method: 'DELETE' }).catch(() => {});
            }
            
            showToast('âœ… ê³µê°œ ë¼ì¸ì—… ì‚­ì œ ì™„ë£Œ', 'success');
            await refreshPublicLineupData();
            document.getElementById('publicLineupPreview').style.display = 'none';
            refreshPublicLineupList();
        }
        
        // ê³µê°œ ë¼ì¸ì—… í˜„í™© í…Œì´ë¸”
        function refreshPublicLineupList() {
            const tbody = document.getElementById('publicLineupTableBody');
            if (!tbody) return;
            
            // ë‚ ì§œ+ì„¸ì…˜ë³„ë¡œ ê·¸ë£¹í•‘
            const groups = {};
            (data.publicLineup || []).forEach(p => {
                const key = `${p.scheduleDate}|${p.schedulePart}`;
                if (!groups[key]) {
                    groups[key] = { date: p.scheduleDate, part: p.schedulePart, males: 0, females: 0, total: 0 };
                }
                groups[key].total++;
                if (p.gender === 'ë‚¨ì') groups[key].males++;
                if (p.gender === 'ì—¬ì') groups[key].females++;
            });
            
            const rows = Object.values(groups).sort((a, b) => {
                const dateCompare = parseDateForComparison(a.date)?.localeCompare(parseDateForComparison(b.date) || '') || 0;
                if (dateCompare !== 0) return dateCompare;
                return (a.part || '').localeCompare(b.part || '');
            });
            
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ê³µê°œëœ ë¼ì¸ì—…ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = rows.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.part}</td>
                    <td style="color: #4a9eff;">${r.males}</td>
                    <td style="color: #ff6b9d;">${r.females}</td>
                    <td><strong>${r.total}</strong></td>
                    <td>-</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="previewPublicLineup('${r.date}', '${r.part}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePublicLineupByDatePart('${r.date}', '${r.part}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // íŠ¹ì • ë‚ ì§œ/ì„¸ì…˜ ê³µê°œ ë¼ì¸ì—… ë¯¸ë¦¬ë³´ê¸°
        function previewPublicLineup(date, part) {
            document.getElementById('publicLineupDate').value = date;
            document.getElementById('publicLineupPart').value = part;
            showPublicLineupPreview(date, part);
        }
        
        // íŠ¹ì • ë‚ ì§œ/ì„¸ì…˜ ê³µê°œ ë¼ì¸ì—… ì‚­ì œ
        async function deletePublicLineupByDatePart(date, part) {
            if (!confirm(`${date} ${part} ê³µê°œ ë¼ì¸ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const toDelete = (data.publicLineup || []).filter(p => 
                isSameDate(p.scheduleDate, date) && p.schedulePart === part
            );
            
            for (const item of toDelete) {
                await fetch(`${API_BASE}/${TB.PUBLIC_LINEUP}/${item.id}`, { method: 'DELETE' }).catch(() => {});
            }
            
            showToast('âœ… ì‚­ì œ ì™„ë£Œ', 'success');
            await refreshPublicLineupData();
            refreshPublicLineupList();
        }
        
        function exportLineupCSV() {
            const dateFilter = document.getElementById('lineupDateFilter')?.value || '';
            const partFilter = document.getElementById('lineupPartFilter')?.value || '';
            
            if (!dateFilter || !partFilter) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            const allPeople = [...currentLineupData.male, ...currentLineupData.female];
            if (allPeople.length === 0) {
                showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            const headers = ['ë²ˆí˜¸', 'ì„±ë³„', 'í‹°ì–´', 'ì´ë¦„', 'ë‚˜ì´', 'í‚¤', 'ì§ì—…', 'ìœ í˜•'];
            const rows = allPeople.map((p, idx) => [
                idx + 1,
                p.gender,
                p.tier,
                p.name,
                p.age || '',
                p.height || '',
                p.job,
                p.type === 'virtual' ? 'ê°€ìƒ' : 'ì‹¤ì œ'
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ë¼ì¸ì—…_${dateFilter}_${partFilter}.csv`;
            link.click();
            
            showToast('CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
        }
        
        function copyLineupText() {
            const dateFilter = document.getElementById('lineupDateFilter')?.value || '';
            const partFilter = document.getElementById('lineupPartFilter')?.value || '';
            
            if (!dateFilter || !partFilter) {
                showToast('ë‚ ì§œì™€ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            const males = currentLineupData.male;
            const females = currentLineupData.female;
            
            if (males.length === 0 && females.length === 0) {
                showToast('ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            let text = `ğŸ“‹ ${dateFilter} ${partFilter} ë¼ì¸ì—…\n`;
            text += `ì´ ${males.length + females.length}ëª… (ë‚¨ ${males.length} / ì—¬ ${females.length})\n\n`;
            
            text += `ğŸ‘¨ ë‚¨ì (${males.length}ëª…)\n`;
            text += 'â”€'.repeat(30) + '\n';
            males.forEach((p, idx) => {
                const virtual = p.type === 'virtual' ? ' ğŸ‘»' : '';
                text += `${idx + 1}. [${p.tier}] ${p.name} ${p.age || '?'}ì„¸ ${p.height || '?'}cm ${p.job}${virtual}\n`;
            });
            
            text += `\nğŸ‘© ì—¬ì (${females.length}ëª…)\n`;
            text += 'â”€'.repeat(30) + '\n';
            females.forEach((p, idx) => {
                const virtual = p.type === 'virtual' ? ' ğŸ‘»' : '';
                text += `${idx + 1}. [${p.tier}] ${p.name} ${p.age || '?'}ì„¸ ${p.height || '?'}cm ${p.job}${virtual}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ ì™„ë£Œ!', 'success');
            }).catch(() => {
                showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
            });
        }
        
        // ========================================
        // íŒŒí‹° ì¼ì • ê´€ë¦¬
        // ========================================
        
        // ë‚ ì§œ íŒŒì‹± ìœ í‹¸ë¦¬í‹° (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
        function parseDateForComparison(dateStr) {
            if (!dateStr) return null;
            
            // "2026ë…„ 1ì›” 11ì¼ ì˜¤í›„ 12:00" í˜•ì‹
            let match = dateStr.match(/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
            if (match) {
                return `${match[1]}-${match[2].padStart(2, '0')}-${match[3].padStart(2, '0')}`;
            }
            
            // "2026-01-11" í˜•ì‹
            match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                return dateStr.substring(0, 10);
            }
            
            // "1/11(í† )" í˜•ì‹ (í”„ë¦½ì—ì„œ ì˜¬ ìˆ˜ ìˆëŠ” í˜•ì‹)
            match = dateStr.match(/(\d{1,2})\/(\d{1,2})/);
            if (match) {
                const year = new Date().getFullYear();
                return `${year}-${match[1].padStart(2, '0')}-${match[2].padStart(2, '0')}`;
            }
            
            return null;
        }
        
        // ë‚ ì§œê°€ ìµœì†Œ ë‚ ì§œ ì´í›„ì¸ì§€ í™•ì¸ (1ì›” 11ì¼ ì´ì „ íŒŒí‹° ìˆ¨ê¸°ê¸°)
        function isDateAfterMin(dateStr) {
            const parsed = parseDateForComparison(dateStr);
            if (!parsed) return false;
            return parsed >= MIN_PARTY_DATE;
        }
        
        // ë‚ ì§œ â†’ í•œê¸€ í˜•ì‹ ë³€í™˜
        function formatDateKorean(dateStr) {
            const parsed = parseDateForComparison(dateStr);
            if (!parsed) return dateStr;
            
            const [year, month, day] = parsed.split('-');
            return `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
        }
        
        // ë‚ ì§œ â†’ ìš”ì¼ êµ¬í•˜ê¸°
        function getDayOfWeek(dateStr) {
            const parsed = parseDateForComparison(dateStr);
            if (!parsed) return '-';
            
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const date = new Date(parsed);
            return days[date.getDay()];
        }
        
        // ì›” í•„í„° ì—…ë°ì´íŠ¸
        function updateScheduleMonthFilter() {
            const select = document.getElementById('scheduleMonthFilter');
            if (!select) return;
            
            const months = new Set();
            data.schedules.forEach(s => {
                const parsed = parseDateForComparison(s.date);
                if (parsed) {
                    months.add(parsed.substring(0, 7)); // "2026-01"
                }
            });
            
            const sortedMonths = Array.from(months).sort();
            select.innerHTML = '<option value="">ì „ì²´ ì›”</option>' + 
                sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    return `<option value="${m}">${year}ë…„ ${parseInt(month)}ì›”</option>`;
                }).join('');
        }
        
        // íŒŒí‹° ì¼ì • ë Œë”ë§
        function renderSchedules() {
            const tbody = document.getElementById('scheduleBody');
            if (!tbody) return;
            
            const monthFilter = document.getElementById('scheduleMonthFilter')?.value || '';
            const activeFilter = document.getElementById('scheduleActiveFilter')?.value || 'active';
            
            // ìµœì†Œ ë‚ ì§œ í•„í„°ë§ (1ì›” 11ì¼ ì´ì „ ì œì™¸)
            let filtered = [...data.schedules].filter(s => isDateAfterMin(s.date));
            
            // ì›” í•„í„°
            if (monthFilter) {
                filtered = filtered.filter(s => {
                    const parsed = parseDateForComparison(s.date);
                    return parsed && parsed.startsWith(monthFilter);
                });
            }
            
            // í™œì„± í•„í„°
            if (activeFilter === 'active') {
                filtered = filtered.filter(s => s.isActive !== false);
            } else if (activeFilter === 'inactive') {
                filtered = filtered.filter(s => s.isActive === false);
            }
            
            // ì†ŒíŒ… ì ìš©
            filtered.sort((a, b) => {
                let cmp = 0;
                const partOrder = {'1ë¶€': 1, '2ë¶€': 2, '3ë¶€': 3};
                const dayOrder = {'ì¼': 0, 'ì›”': 1, 'í™”': 2, 'ìˆ˜': 3, 'ëª©': 4, 'ê¸ˆ': 5, 'í† ': 6};

                switch (scheduleSortField) {
                    case 'date':
                        cmp = (parseDateForComparison(a.date) || '').localeCompare(parseDateForComparison(b.date) || '');
                        // ê°™ì€ ë‚ ì§œë©´ ë¶€(part) ìˆœìœ¼ë¡œ 2ì°¨ ì •ë ¬
                        if (cmp === 0) {
                            cmp = (partOrder[a.part] || 0) - (partOrder[b.part] || 0);
                        }
                        break;
                    case 'dayOfWeek':
                        cmp = (dayOrder[getDayOfWeek(a.date)] || 0) - (dayOrder[getDayOfWeek(b.date)] || 0);
                        break;
                    case 'partyType':
                        cmp = (a.partyType || 'coffee').localeCompare(b.partyType || 'coffee');
                        break;
                    case 'part':
                        cmp = (partOrder[a.part] || 0) - (partOrder[b.part] || 0);
                        break;
                    case 'time':
                        cmp = (a.time || '').localeCompare(b.time || '');
                        break;
                    case 'isActive':
                        cmp = (a.isActive === false ? 1 : 0) - (b.isActive === false ? 1 : 0);
                        break;
                    default:
                        // ê¸°ë³¸ ì •ë ¬: ë‚ ì§œ â†’ ë¶€(part) ìˆœ
                        cmp = (parseDateForComparison(a.date) || '').localeCompare(parseDateForComparison(b.date) || '');
                        if (cmp === 0) {
                            cmp = (partOrder[a.part] || 0) - (partOrder[b.part] || 0);
                        }
                }

                return scheduleSortAsc ? cmp : -cmp;
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">íŒŒí‹° ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(s => {
                const dayOfWeek = getDayOfWeek(s.date);
                const isWeekend = dayOfWeek === 'í† ' || dayOfWeek === 'ì¼';
                const dayClass = isWeekend ? (dayOfWeek === 'í† ' ? 'text-blue' : 'text-red') : '';
                
                // íŒŒí‹° ìœ í˜• í‘œì‹œ
                const partyTypeDisplay = s.partyType === 'wine' 
                    ? '<span style="color: #9c27b0;">ğŸ· ì™€ì¸</span>' 
                    : '<span style="color: #795548;">â˜• ì»¤í”¼</span>';
                const capacityText = `${s.maleCapacity || 12}:${s.femaleCapacity || 12}`;
                
                return `
                <tr class="${s.isActive === false ? 'row-inactive' : ''}">
                    <td>${formatDateKorean(s.date)}</td>
                    <td class="${dayClass}">${dayOfWeek}</td>
                    <td>${partyTypeDisplay} <span style="font-size: 10px; color: var(--text-muted);">(${capacityText})</span></td>
                    <td>${s.part || '-'}</td>
                    <td>${s.time || '-'}</td>
                    <td>
                        <span class="status ${s.isActive === false ? 'status-muted' : 'status-success'}" 
                              style="cursor: pointer;" onclick="toggleScheduleActive('${s.id}')">
                            ${s.isActive === false ? 'ë¹„í™œì„±' : 'í™œì„±'}
                        </span>
                    </td>
                    <td>${s.memo || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editSchedule('${s.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSchedule('${s.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }
        
        // ì¼ì • í™œì„±/ë¹„í™œì„± í† ê¸€
        async function toggleScheduleActive(id) {
            const schedule = data.schedules.find(s => s.id === id);
            if (!schedule) return;

            try {
                const response = await fetch(`${API_BASE}/party_schedules?id=eq.${encodeURIComponent(id)}`, {
                    method: 'PATCH',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify({ is_active: schedule.isActive === false ? true : false })
                });

                if (response.ok) {
                    showToast('ìƒíƒœ ë³€ê²½ ì™„ë£Œ', 'success');
                    await refreshAllData();
                } else {
                    showToast('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                console.error('í† ê¸€ ì˜¤ë¥˜:', error);
                showToast('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨', 'error');
            }
        }
        
        // ì¼ì • ì‚­ì œ
        async function deleteSchedule(id) {
            const schedule = data.schedules.find(s => s.id === id);
            if (!schedule) return;
            
            // ì—°ê²°ëœ ë°ì´í„° ì²´í¬
            const hasReservations = data.reservations.some(r => {
                const resDate = parseDateForComparison(r.eventDate);
                const schDate = parseDateForComparison(schedule.date);
                return resDate === schDate && r.eventPart === schedule.part;
            });
            
            const hasGenerated = data.generatedVirtuals.some(g => {
                const genDate = parseDateForComparison(g.eventDate);
                const schDate = parseDateForComparison(schedule.date);
                return genDate === schDate && g.eventPart === schedule.part;
            });
            
            if (hasReservations || hasGenerated) {
                if (!confirm(`ì´ ì¼ì •ì— ì—°ê²°ëœ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.\n(ì˜ˆì•½: ${hasReservations ? 'ìˆìŒ' : 'ì—†ìŒ'}, ê°€ìƒì°¸ì—¬ì: ${hasGenerated ? 'ìˆìŒ' : 'ì—†ìŒ'})\n\nì‚­ì œ ëŒ€ì‹  ë¹„í™œì„±í™”ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤. ê·¸ë˜ë„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            } else {
                if (!confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/party_schedules?id=eq.${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    headers: SUPABASE_HEADERS
                });

                if (response.ok || response.status === 204) {
                    showToast('ì¼ì • ì‚­ì œ ì™„ë£Œ', 'success');
                    await refreshAllData();
                } else {
                    showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        }
        
        // ì¼ì • ëª¨ë‹¬ ì—´ê¸°
        function openScheduleModal(id = null) {
            document.getElementById('scheduleId').value = id || '';
            document.getElementById('scheduleModalTitle').textContent = id ? 'ì¼ì • ìˆ˜ì •' : 'ì¼ì • ì¶”ê°€';

            if (id) {
                const schedule = data.schedules.find(s => s.id === id);
                if (schedule) {
                    // ë‚ ì§œë¥¼ input date í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    const parsed = parseDateForComparison(schedule.date);
                    document.getElementById('scheduleDate').value = parsed || '';
                    document.getElementById('schedulePartyType').value = schedule.partyType || 'coffee';
                    document.getElementById('schedulePart').value = schedule.part || '1ë¶€';
                    document.getElementById('scheduleMemo').value = schedule.memo || '';
                    document.getElementById('scheduleMinBirthYear').value = schedule.minBirthYear || '';
                    document.getElementById('scheduleMaxBirthYear').value = schedule.maxBirthYear || '';
                    // ê°œë³„ ì •ì› ë¡œë“œ (íŒŒí‹°ìœ í˜• ê¸°ë³¸ê°’ê³¼ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ í‘œì‹œ)
                    const partyType = data.partyTypes.find(t => t.id === (schedule.partyType || 'coffee'));
                    const defaultMale = partyType?.maleCapacity || 12;
                    const defaultFemale = partyType?.femaleCapacity || 12;
                    // ê¸°ë³¸ê°’ê³¼ ë‹¤ë¥´ë©´ í‘œì‹œ, ê°™ìœ¼ë©´ ë¹„ì›Œë‘  (placeholderë¡œ ê¸°ë³¸ê°’ ë³´ì„)
                    document.getElementById('scheduleMaleCapacity').value =
                        (schedule.maleCapacity && schedule.maleCapacity !== defaultMale) ? schedule.maleCapacity : '';
                    document.getElementById('scheduleFemaleCapacity').value =
                        (schedule.femaleCapacity && schedule.femaleCapacity !== defaultFemale) ? schedule.femaleCapacity : '';
                }
            } else {
                // ê¸°ë³¸ê°’ ì„¤ì •
                const today = new Date();
                document.getElementById('scheduleDate').value = today.toISOString().split('T')[0];
                document.getElementById('schedulePartyType').value = 'coffee';
                document.getElementById('schedulePart').value = '1ë¶€';
                document.getElementById('scheduleMemo').value = '';
                document.getElementById('scheduleMinBirthYear').value = '';
                document.getElementById('scheduleMaxBirthYear').value = '';
                document.getElementById('scheduleMaleCapacity').value = '';
                document.getElementById('scheduleFemaleCapacity').value = '';
            }

            // íŒíŠ¸ ì—…ë°ì´íŠ¸
            updateScheduleAgeHint();
            updateScheduleCapacityHint();
            document.getElementById('schedulePart').onchange = updateScheduleAgeHint;

            openModal('scheduleModal');
        }
        
        // ì„¸ì…˜ ê¸°ë³¸ ë‚˜ì´ì¡°ê±´ íŒíŠ¸ í‘œì‹œ
        function updateScheduleAgeHint() {
            const part = document.getElementById('schedulePart').value;
            const session = data.sessions.find(s => s.id === part);
            const hint = document.getElementById('scheduleAgeHint');

            if (session && session.minBirthYear && session.maxBirthYear) {
                hint.textContent = `ì„¸ì…˜ ê¸°ë³¸ê°’: ${session.minBirthYear}~${session.maxBirthYear}ë…„ìƒ`;
            } else {
                hint.textContent = 'ì„¸ì…˜ ê¸°ë³¸ê°’: ì„¤ì • ì•ˆ ë¨';
            }
        }

        // íŒŒí‹°ìœ í˜• ê¸°ë³¸ ì •ì› íŒíŠ¸ í‘œì‹œ
        function updateScheduleCapacityHint() {
            const partyTypeId = document.getElementById('schedulePartyType').value;
            const partyType = data.partyTypes.find(t => t.id === partyTypeId);
            const hint = document.getElementById('scheduleCapacityHint');
            const maleInput = document.getElementById('scheduleMaleCapacity');
            const femaleInput = document.getElementById('scheduleFemaleCapacity');

            const defaultMale = partyType?.maleCapacity || 12;
            const defaultFemale = partyType?.femaleCapacity || 12;

            hint.textContent = `íŒŒí‹°ìœ í˜• ê¸°ë³¸ê°’: ë‚¨${defaultMale}/ì—¬${defaultFemale}`;
            maleInput.placeholder = defaultMale;
            femaleInput.placeholder = defaultFemale;
        }
        
        function editSchedule(id) {
            openScheduleModal(id);
        }
        
        // ì¼ì • ì €ì¥
        async function saveSchedule() {
            const id = document.getElementById('scheduleId').value;
            const dateInput = document.getElementById('scheduleDate').value;
            const partyTypeId = document.getElementById('schedulePartyType').value;
            const part = document.getElementById('schedulePart').value;
            const memo = document.getElementById('scheduleMemo').value;
            const minBirthYear = parseInt(document.getElementById('scheduleMinBirthYear').value) || null;
            const maxBirthYear = parseInt(document.getElementById('scheduleMaxBirthYear').value) || null;

            // ê°œë³„ ì •ì› ì…ë ¥ê°’ ì½ê¸° (ë¹ˆ ê°’ì´ë©´ íŒŒí‹°ìœ í˜• ê¸°ë³¸ê°’ ì‚¬ìš©)
            const maleCapacityInput = document.getElementById('scheduleMaleCapacity').value;
            const femaleCapacityInput = document.getElementById('scheduleFemaleCapacity').value;

            // ì„¸ì…˜ í…œí”Œë¦¿ì—ì„œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
            const session = data.sessions.find(s => s.id === part);
            const time = session?.time || '12:00';

            if (!dateInput) {
                showToast('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            // YYYY-MM-DDë¥¼ í•œê¸€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const [year, month, day] = dateInput.split('-');
            const dateKorean = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;

            // íŒŒí‹° ìœ í˜•ì—ì„œ ê¸°ë³¸ ì •ì› ê°€ì ¸ì˜¤ê¸°
            const partyType = data.partyTypes.find(t => t.id === partyTypeId);
            const defaultMale = partyType?.maleCapacity || 12;
            const defaultFemale = partyType?.femaleCapacity || 12;

            // ê°œë³„ ì •ì›: ì…ë ¥ê°’ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ íŒŒí‹°ìœ í˜• ê¸°ë³¸ê°’
            const maleCapacity = maleCapacityInput ? parseInt(maleCapacityInput) : defaultMale;
            const femaleCapacity = femaleCapacityInput ? parseInt(femaleCapacityInput) : defaultFemale;

            const scheduleData = {
                date: dateKorean,
                part,
                time,
                party_type: partyTypeId,
                male_capacity: maleCapacity,
                female_capacity: femaleCapacity,
                is_active: true,
                memo,
                min_birth_year: minBirthYear,
                max_birth_year: maxBirthYear
            };

            try {
                let response;
                if (id) {
                    // ìˆ˜ì • - Supabase REST API í˜•ì‹ ì‚¬ìš© (?id=eq.xxx)
                    response = await fetch(`${API_BASE}/party_schedules?id=eq.${encodeURIComponent(id)}`, {
                        method: 'PATCH',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(scheduleData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/party_schedules`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(scheduleData)
                    });
                }

                if (response.ok) {
                    closeModal('scheduleModal');
                    showToast(id ? 'ì¼ì • ìˆ˜ì • ì™„ë£Œ' : 'ì¼ì • ì¶”ê°€ ì™„ë£Œ', 'success');
                    await refreshAllData();
                } else {
                    const error = await response.json().catch(() => ({}));
                    showToast('ì €ì¥ ì‹¤íŒ¨: ' + (error.message || response.status), 'error');
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        }
        
        // ========================================
        // ì„¸ì…˜ í…œí”Œë¦¿ ê´€ë¦¬
        // ========================================
        function renderSessions() {
            const tbody = document.getElementById('sessionTemplateBody');
            if (!tbody) return;
            
            const sessions = [...data.sessions].sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            
            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ì„¸ì…˜ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = sessions.map(s => {
                const ageCondition = (s.minBirthYear && s.maxBirthYear) 
                    ? `${String(s.minBirthYear).slice(-2)}~${String(s.maxBirthYear).slice(-2)}ë…„ìƒ`
                    : '-';
                // íŒŒí‹° ìœ í˜• ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const partyType = data.partyTypes.find(t => t.id === s.type);
                const typeDisplay = partyType 
                    ? `${partyType.icon} ${partyType.name} (${partyType.maleCapacity}/${partyType.femaleCapacity})`
                    : (s.type || '-');
                return `
                <tr>
                    <td><strong>${s.id}</strong></td>
                    <td>${s.time || '-'}</td>
                    <td>${typeDisplay}</td>
                    <td>${ageCondition}</td>
                    <td>${s.sortOrder || '-'}</td>
                    <td>
                        <span class="status ${s.isActive === false ? 'status-muted' : 'status-success'}" 
                              style="cursor: pointer;" onclick="toggleSessionActive('${s.id}')">
                            ${s.isActive === false ? 'ë¹„í™œì„±' : 'í™œì„±'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editSession('${s.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSession('${s.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
            
            // ì„¸ì…˜ ì²´í¬ë°•ìŠ¤ ë° ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
            updateSessionUI();
        }
        
        function updateSessionUI() {
            const activeSessions = data.sessions.filter(s => s.isActive !== false).sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            
            // ìƒì„± ì˜µì…˜ ì²´í¬ë°•ìŠ¤
            const checkboxContainer = document.getElementById('sessionCheckboxes');
            if (checkboxContainer) {
                checkboxContainer.innerHTML = activeSessions.map(s => 
                    `<label style="margin-left: 8px;"><input type="checkbox" id="optSession_${s.id}" checked> ${s.id}(${s.time})</label>`
                ).join('');
            }
            
            // ì¼ì • ì¶”ê°€ ëª¨ë‹¬ì˜ ì„¸ì…˜ ì…€ë ‰íŠ¸
            const schedulePartSelect = document.getElementById('schedulePart');
            if (schedulePartSelect) {
                schedulePartSelect.innerHTML = activeSessions.map(s => 
                    `<option value="${s.id}">${s.id} (${s.time}) - ${s.type}</option>`
                ).join('');
            }
        }
        
        function openSessionModal(id = null) {
            document.getElementById('sessionId').value = id || '';
            document.getElementById('sessionModalTitle').textContent = id ? 'ì„¸ì…˜ ìˆ˜ì •' : 'ì„¸ì…˜ ì¶”ê°€';
            
            // íŒŒí‹° ìœ í˜• ì…€ë ‰íŠ¸ ë™ì  ìƒì„±
            const sessionTypeSelect = document.getElementById('sessionType');
            const activeTypes = (data.partyTypes || []).filter(t => t.isActive !== false);
            
            if (activeTypes.length === 0) {
                // íŒŒí‹° ìœ í˜•ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì˜µì…˜ ì œê³µ
                sessionTypeSelect.innerHTML = `
                    <option value="coffee">â˜• ì»¤í”¼íŒŒí‹° (ë‚¨12/ì—¬12)</option>
                    <option value="wine">ğŸ· ì™€ì¸íŒŒí‹° (ë‚¨24/ì—¬24)</option>
                `;
            } else {
                sessionTypeSelect.innerHTML = activeTypes.map(t => 
                    `<option value="${t.id}">${t.icon || 'ğŸ‰'} ${t.name} (ë‚¨${t.maleCapacity}/ì—¬${t.femaleCapacity})</option>`
                ).join('');
            }
            
            // íŒŒí‹° ìœ í˜• ì„ íƒ ì‹œ ì •ë³´ í‘œì‹œ
            sessionTypeSelect.onchange = updateSessionTypeInfo;
            
            // ê¸°ë³¸ ë‚˜ì´ì¡°ê±´ (ì„¸ì…˜ëª… ê¸°ë°˜)
            const defaultAgeConditions = {
                '1ë¶€': { min: 1990, max: 2002 },
                '2ë¶€': { min: 1987, max: 1997 },
                '3ë¶€': { min: 1987, max: 2002 }
            };
            
            if (id) {
                const session = data.sessions.find(s => s.id === id);
                if (session) {
                    document.getElementById('sessionName').value = session.id || '';
                    document.getElementById('sessionTime').value = session.time || '12:00';
                    document.getElementById('sessionType').value = session.type || (activeTypes[0]?.id || 'coffee');
                    document.getElementById('sessionMinBirthYear').value = session.minBirthYear || '';
                    document.getElementById('sessionMaxBirthYear').value = session.maxBirthYear || '';
                    document.getElementById('sessionOrder').value = session.sortOrder || 1;
                    document.getElementById('sessionName').disabled = true; // IDëŠ” ìˆ˜ì • ë¶ˆê°€
                }
            } else {
                document.getElementById('sessionName').value = '';
                document.getElementById('sessionTime').value = '12:00';
                document.getElementById('sessionType').value = activeTypes[0]?.id || 'coffee';
                document.getElementById('sessionMinBirthYear').value = '';
                document.getElementById('sessionMaxBirthYear').value = '';
                document.getElementById('sessionOrder').value = data.sessions.length + 1;
                document.getElementById('sessionName').disabled = false;
            }
            
            updateSessionTypeInfo();
            openModal('sessionModal');
        }
        
        function updateSessionTypeInfo() {
            const typeId = document.getElementById('sessionType').value;
            const type = data.partyTypes.find(t => t.id === typeId);
            const infoEl = document.getElementById('sessionTypeInfo');
            
            if (type && infoEl) {
                infoEl.innerHTML = `ì •ì›: ë‚¨ <strong>${type.maleCapacity}</strong>ëª… / ì—¬ <strong>${type.femaleCapacity}</strong>ëª… | ìµœì†Œê³µì„: <strong>${type.minVacancy}</strong>ëª…`;
            } else if (infoEl) {
                // ê¸°ë³¸ê°’ í‘œì‹œ (party_typesê°€ ì—†ì„ ë•Œ)
                const defaultValues = {
                    'coffee': { male: 12, female: 12, vacancy: 2 },
                    'wine': { male: 24, female: 24, vacancy: 4 }
                };
                const defaults = defaultValues[typeId] || defaultValues['coffee'];
                infoEl.innerHTML = `ì •ì›: ë‚¨ <strong>${defaults.male}</strong>ëª… / ì—¬ <strong>${defaults.female}</strong>ëª… | ìµœì†Œê³µì„: <strong>${defaults.vacancy}</strong>ëª… <span style="color: var(--warning);">(ê¸°ë³¸ê°’)</span>`;
            }
        }
        
        function editSession(id) {
            openSessionModal(id);
        }
        
        async function saveSession() {
            const id = document.getElementById('sessionId').value;
            const name = document.getElementById('sessionName').value.trim();
            const time = document.getElementById('sessionTime').value;
            const type = document.getElementById('sessionType').value;
            const minBirthYear = parseInt(document.getElementById('sessionMinBirthYear').value) || null;
            const maxBirthYear = parseInt(document.getElementById('sessionMaxBirthYear').value) || null;
            const sortOrder = parseInt(document.getElementById('sessionOrder').value) || 1;
            
            if (!name && !id) {
                showToast('ì„¸ì…˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            try {
                let response;
                if (id) {
                    // ìˆ˜ì • - snake_caseë¡œ ë³€í™˜, Supabase REST API í˜•ì‹ ì‚¬ìš©
                    const updateData = {
                        time,
                        type,
                        sort_order: sortOrder,
                        is_active: true,
                        min_birth_year: minBirthYear,
                        max_birth_year: maxBirthYear
                    };
                    response = await fetch(`${API_BASE}/session_templates?id=eq.${encodeURIComponent(id)}`, {
                        method: 'PATCH',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(updateData)
                    });
                } else {
                    // ì¶”ê°€ - ì¤‘ë³µ ì²´í¬
                    if (data.sessions.some(s => s.id === name)) {
                        showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì„¸ì…˜ëª…ì…ë‹ˆë‹¤', 'error');
                        return;
                    }
                    const newData = {
                        id: name,
                        time,
                        type,
                        sort_order: sortOrder,
                        is_active: true,
                        min_birth_year: minBirthYear,
                        max_birth_year: maxBirthYear
                    };
                    response = await fetch(`${API_BASE}/session_templates`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(newData)
                    });
                }

                if (response.ok) {
                    closeModal('sessionModal');
                    showToast(id ? 'ì„¸ì…˜ ìˆ˜ì • ì™„ë£Œ' : 'ì„¸ì…˜ ì¶”ê°€ ì™„ë£Œ', 'success');
                    await refreshAllData();
                } else {
                    const errorText = await response.text();
                    console.error('ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨:', response.status, errorText);
                    showToast(`ì €ì¥ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                showToast(`ì €ì¥ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        async function toggleSessionActive(id) {
            const session = data.sessions.find(s => s.id === id);
            if (!session) return;

            try {
                const response = await fetch(`${API_BASE}/session_templates?id=eq.${encodeURIComponent(id)}`, {
                    method: 'PATCH',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify({ is_active: session.isActive === false ? true : false })
                });

                if (response.ok) {
                    showToast('ìƒíƒœ ë³€ê²½ ì™„ë£Œ', 'success');
                    await refreshAllData();
                } else {
                    showToast('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                console.error('í† ê¸€ ì˜¤ë¥˜:', error);
                showToast('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨', 'error');
            }
        }

        async function deleteSession(id) {
            // ì—°ê²°ëœ ì¼ì • ì²´í¬
            const hasSchedules = data.schedules.some(s => s.part === id);
            if (hasSchedules) {
                showToast('ì´ ì„¸ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì¼ì •ì´ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¹„í™œì„±í™”ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (!confirm(`"${id}" ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const response = await fetch(`${API_BASE}/session_templates?id=eq.${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    headers: SUPABASE_HEADERS
                });

                if (response.ok || response.status === 204) {
                    showToast('ì„¸ì…˜ ì‚­ì œ ì™„ë£Œ', 'success');
                    await refreshAllData();
                } else {
                    showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        }
        
        // ì„¸ì…˜ í…œí”Œë¦¿ì—ì„œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
        function getSessionTime(partName) {
            const session = data.sessions.find(s => s.id === partName);
            return session?.time || '12:00';
        }
        
        // ========================================
        // íŒŒí‹° ìœ í˜• ê´€ë¦¬
        // ========================================
        
        function renderPartyTypes() {
            const tbody = document.getElementById('partyTypeBody');
            if (!tbody) return;
            
            const types = [...data.partyTypes].sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            
            if (types.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">íŒŒí‹° ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = types.map(t => `
                <tr>
                    <td style="font-size: 24px;">${t.icon || 'ğŸ‰'}</td>
                    <td><strong>${t.name || '-'}</strong></td>
                    <td>${t.maleCapacity || 0}ëª…</td>
                    <td>${t.femaleCapacity || 0}ëª…</td>
                    <td>${t.minVacancy || 0}ëª…</td>
                    <td>
                        <span class="status ${t.isActive === false ? 'status-muted' : 'status-success'}">
                            ${t.isActive === false ? 'ë¹„í™œì„±' : 'í™œì„±'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editPartyType('${t.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePartyType('${t.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // ì„¸ì…˜ í…œí”Œë¦¿ íƒ€ì… ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
            updatePartyTypeSelects();
        }
        
        function updatePartyTypeSelects() {
            const activeTypes = data.partyTypes.filter(t => t.isActive !== false);
            
            // ì„¸ì…˜ í…œí”Œë¦¿ ëª¨ë‹¬ì˜ íƒ€ì… ì…€ë ‰íŠ¸
            const sessionTypeSelect = document.getElementById('sessionType');
            if (sessionTypeSelect) {
                const currentValue = sessionTypeSelect.value;
                sessionTypeSelect.innerHTML = activeTypes.map(t => 
                    `<option value="${t.id}">${t.icon} ${t.name} (${t.maleCapacity}/${t.femaleCapacity})</option>`
                ).join('');
                // ê¸°ì¡´ ê°’ ë³µì› ì‹œë„
                if (currentValue && activeTypes.some(t => t.id === currentValue)) {
                    sessionTypeSelect.value = currentValue;
                }
            }
            
            // ì¼ì • ëª¨ë‹¬ì˜ íŒŒí‹° ìœ í˜• ì…€ë ‰íŠ¸
            const schedulePartyTypeSelect = document.getElementById('schedulePartyType');
            if (schedulePartyTypeSelect) {
                const currentValue = schedulePartyTypeSelect.value;
                schedulePartyTypeSelect.innerHTML = activeTypes.map(t => 
                    `<option value="${t.id}">${t.icon} ${t.name} (ë‚¨${t.maleCapacity}/ì—¬${t.femaleCapacity})</option>`
                ).join('');
                if (currentValue && activeTypes.some(t => t.id === currentValue)) {
                    schedulePartyTypeSelect.value = currentValue;
                }
            }
        }
        
        function openPartyTypeModal(id = null) {
            document.getElementById('partyTypeId').value = id || '';
            document.getElementById('partyTypeModalTitle').textContent = id ? 'íŒŒí‹° ìœ í˜• ìˆ˜ì •' : 'íŒŒí‹° ìœ í˜• ì¶”ê°€';
            
            if (id) {
                const type = data.partyTypes.find(t => t.id === id);
                if (type) {
                    document.getElementById('partyTypeIcon').value = type.icon || 'â˜•';
                    document.getElementById('partyTypeName').value = type.name || '';
                    document.getElementById('partyTypeMaleCapacity').value = type.maleCapacity || 12;
                    document.getElementById('partyTypeFemaleCapacity').value = type.femaleCapacity || 12;
                    document.getElementById('partyTypeMinVacancy').value = type.minVacancy || 2;
                }
            } else {
                document.getElementById('partyTypeIcon').value = 'â˜•';
                document.getElementById('partyTypeName').value = '';
                document.getElementById('partyTypeMaleCapacity').value = 12;
                document.getElementById('partyTypeFemaleCapacity').value = 12;
                document.getElementById('partyTypeMinVacancy').value = 2;
            }
            
            openModal('partyTypeModal');
        }
        
        function editPartyType(id) {
            openPartyTypeModal(id);
        }
        
        async function savePartyType() {
            const id = document.getElementById('partyTypeId').value;
            const icon = document.getElementById('partyTypeIcon').value;
            const name = document.getElementById('partyTypeName').value.trim();
            const maleCapacity = parseInt(document.getElementById('partyTypeMaleCapacity').value) || 12;
            const femaleCapacity = parseInt(document.getElementById('partyTypeFemaleCapacity').value) || 12;
            const minVacancy = parseInt(document.getElementById('partyTypeMinVacancy').value) || 2;

            if (!name) {
                showToast('ìœ í˜•ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            // ID ìƒì„± (í•œê¸€ â†’ ì˜ë¬¸ ë³€í™˜)
            const typeId = id || name.toLowerCase().replace(/[^a-z0-9]/g, '') || `type_${Date.now()}`;

            try {
                let response;
                // snake_caseë¡œ ë³€í™˜í•˜ì—¬ Supabaseì— ì €ì¥
                const typeData = {
                    id: typeId,
                    icon,
                    name,
                    male_capacity: maleCapacity,
                    female_capacity: femaleCapacity,
                    min_vacancy: minVacancy,
                    is_active: true,
                    sort_order: data.partyTypes.length + 1
                };

                if (id) {
                    // ìˆ˜ì • - Supabase REST API í˜•ì‹ ì‚¬ìš© (?id=eq.xxx)
                    const updateData = { ...typeData };
                    delete updateData.id;  // PKëŠ” URLì— ìˆìœ¼ë¯€ë¡œ bodyì—ì„œ ì œê±°
                    response = await fetch(`${API_BASE}/party_types?id=eq.${encodeURIComponent(id)}`, {
                        method: 'PATCH',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(updateData)
                    });
                } else {
                    // ì¶”ê°€ - ì¤‘ë³µ ì²´í¬
                    if (data.partyTypes.some(t => t.name === name)) {
                        showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìœ í˜•ëª…ì…ë‹ˆë‹¤', 'error');
                        return;
                    }
                    response = await fetch(`${API_BASE}/party_types`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(typeData)
                    });
                }

                if (response.ok) {
                    closeModal('partyTypeModal');
                    showToast(id ? 'íŒŒí‹° ìœ í˜• ìˆ˜ì • ì™„ë£Œ' : 'íŒŒí‹° ìœ í˜• ì¶”ê°€ ì™„ë£Œ', 'success');
                    await refreshAllData();
                } else {
                    const errData = await response.json().catch(() => ({}));
                    showToast('ì €ì¥ ì‹¤íŒ¨: ' + (errData.message || response.status), 'error');
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                showToast('ì €ì¥ ì˜¤ë¥˜', 'error');
            }
        }
        
        async function deletePartyType(id) {
            // ì—°ê²°ëœ ì„¸ì…˜/ì¼ì • ì²´í¬
            const hasSession = data.sessions.some(s => s.type === id);
            const hasSchedule = data.schedules.some(s => s.partyType === id);

            if (hasSession || hasSchedule) {
                showToast('ì´ ìœ í˜•ì„ ì‚¬ìš©í•˜ëŠ” ì„¸ì…˜/ì¼ì •ì´ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const type = data.partyTypes.find(t => t.id === id);
            if (!confirm(`"${type?.name || id}" ìœ í˜•ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const response = await fetch(`${API_BASE}/party_types?id=eq.${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    headers: SUPABASE_HEADERS
                });

                if (response.ok || response.status === 204) {
                    showToast('íŒŒí‹° ìœ í˜• ì‚­ì œ ì™„ë£Œ', 'success');
                    await refreshAllData();
                }
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
            }
        }
        
        // íŒŒí‹° ìœ í˜• ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getPartyType(typeId) {
            return data.partyTypes.find(t => t.id === typeId) || {
                id: 'coffee',
                name: 'ì»¤í”¼íŒŒí‹°',
                icon: 'â˜•',
                maleCapacity: 12,
                femaleCapacity: 12,
                minVacancy: 2
            };
        }
        
        // ========================================
        // ì¼ì • ìë™ ìƒì„±
        // ========================================
        
        // ë¹ ë¥¸ ë²„íŠ¼: ì•ìœ¼ë¡œ Nê°œì›” ì¼ì • ìƒì„±
        async function generateSchedulesQuick() {
            const months = parseInt(document.getElementById('quickMonths')?.value) || 3;
            
            if (months < 1 || months > 12) {
                showToast('1~12ê°œì›” ì‚¬ì´ë¡œ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            const today = new Date();
            const startYear = today.getFullYear();
            const startMonth = today.getMonth() + 1;
            
            let endYear = startYear;
            let endMonth = startMonth + months - 1;
            
            while (endMonth > 12) {
                endMonth -= 12;
                endYear++;
            }
            
            await generateSchedulesForRange(startYear, startMonth, endYear, endMonth, true);
        }
        
        // ë²”ìœ„ ì§€ì • ë²„íŠ¼
        async function generateSchedulesRange() {
            const startYear = parseInt(document.getElementById('scheduleGenStartYear').value);
            const startMonth = parseInt(document.getElementById('scheduleGenStartMonth').value);
            const endYear = parseInt(document.getElementById('scheduleGenEndYear').value);
            const endMonth = parseInt(document.getElementById('scheduleGenEndMonth').value);
            
            if (startYear > endYear || (startYear === endYear && startMonth > endMonth)) {
                showToast('ì‹œì‘ ì›”ì´ ì¢…ë£Œ ì›”ë³´ë‹¤ ë’¤ì— ìˆìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            await generateSchedulesForRange(startYear, startMonth, endYear, endMonth, true);
        }
        
        // ê³µí†µ ì¼ì • ìƒì„± í•¨ìˆ˜
        async function generateSchedulesForRange(startYear, startMonth, endYear, endMonth, confirmFirst = false) {
            // ìš”ì¼ ì˜µì…˜ ì½ê¸° (0=ì¼, 1=ì›”, ..., 6=í† )
            const allowedDays = [];
            if (document.getElementById('optSunday')?.checked) allowedDays.push(0);
            if (document.getElementById('optMonday')?.checked) allowedDays.push(1);
            if (document.getElementById('optTuesday')?.checked) allowedDays.push(2);
            if (document.getElementById('optWednesday')?.checked) allowedDays.push(3);
            if (document.getElementById('optThursday')?.checked) allowedDays.push(4);
            if (document.getElementById('optFriday')?.checked) allowedDays.push(5);
            if (document.getElementById('optSaturday')?.checked) allowedDays.push(6);
            
            if (allowedDays.length === 0) {
                showToast('ìµœì†Œ í•˜ë‚˜ì˜ ìš”ì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            // ì„¸ì…˜ ì˜µì…˜ ì½ê¸° (ì„¸ì…˜ í…œí”Œë¦¿ì—ì„œ)
            const activeSessions = data.sessions.filter(s => s.isActive !== false);
            const selectedSessions = activeSessions.filter(s => {
                const checkbox = document.getElementById(`optSession_${s.id}`);
                return checkbox?.checked ?? true;
            });
            
            if (selectedSessions.length === 0) {
                showToast('ìµœì†Œ í•˜ë‚˜ì˜ ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            
            // ë‚ ì§œ ìˆ˜ì§‘
            const targetDates = [];
            let currentYear = startYear;
            let currentMonth = startMonth;
            
            while (currentYear < endYear || (currentYear === endYear && currentMonth <= endMonth)) {
                const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
                
                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(currentYear, currentMonth - 1, d);
                    if (allowedDays.includes(date.getDay())) {
                        targetDates.push(`${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(d).padStart(2, '0')}`);
                    }
                }
                
                currentMonth++;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }
            }
            
            if (targetDates.length === 0) {
                showToast('ì„ íƒí•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            // ì˜ˆìƒ ìƒì„± ê°œìˆ˜ ê³„ì‚° (ì¤‘ë³µ ì œì™¸)
            let toCreate = 0;
            let skipped = 0;
            
            for (const dateStr of targetDates) {
                for (const session of selectedSessions) {
                    const exists = data.schedules.some(s => {
                        const parsed = parseDateForComparison(s.date);
                        return parsed === dateStr && s.part === session.id;
                    });
                    if (exists) skipped++;
                    else toCreate++;
                }
            }
            
            if (toCreate === 0) {
                showToast(`ì¶”ê°€í•  ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤ (${skipped}ê°œ ì¤‘ë³µ)`, 'info');
                return;
            }
            
            // í™•ì¸ íŒì—…
            if (confirmFirst) {
                const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                const selectedDays = allowedDays.map(d => dayNames[d]).join(', ');
                const selectedSessionNames = selectedSessions.map(s => s.id).join(', ');
                
                const confirmMsg = `ğŸ“… ì¼ì • ìƒì„± í™•ì¸\n\n` +
                    `ê¸°ê°„: ${startYear}ë…„ ${startMonth}ì›” ~ ${endYear}ë…„ ${endMonth}ì›”\n` +
                    `ìš”ì¼: ${selectedDays}\n` +
                    `ì„¸ì…˜: ${selectedSessionNames}\n\n` +
                    `ìƒì„±: ${toCreate}ê°œ` + (skipped > 0 ? ` (${skipped}ê°œ ì¤‘ë³µ ìŠ¤í‚µ)` : '') + `\n\n` +
                    `ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                
                if (!confirm(confirmMsg)) {
                    return;
                }
            }
            
            // ìƒì„± ì‹œì‘
            showToast(`ì¼ì • ìƒì„± ì¤‘...`, 'info');
            
            const promises = [];
            
            for (const dateStr of targetDates) {
                const [y, m, d] = dateStr.split('-');
                const dateKorean = `${y}ë…„ ${parseInt(m)}ì›” ${parseInt(d)}ì¼`;
                
                for (const session of selectedSessions) {
                    // ì¤‘ë³µ ì²´í¬
                    const exists = data.schedules.some(s => {
                        const parsed = parseDateForComparison(s.date);
                        return parsed === dateStr && s.part === session.id;
                    });
                    
                    if (exists) continue;
                    
                    // ì„¸ì…˜ì˜ íŒŒí‹° ìœ í˜• ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í•œê¸€â†’ì˜ë¬¸ ë³€í™˜)
                    const typeMap = { 'ì™€ì¸': 'wine', 'ì»¤í”¼': 'coffee' };
                    const partyTypeId = typeMap[session.type] || session.type || 'coffee';
                    const partyType = data.partyTypes.find(t => t.id === partyTypeId);
                    
                    promises.push(
                        fetch(`${API_BASE}/party_schedules`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify({
                                date: dateKorean,
                                part: session.id,
                                time: session.time,
                                party_type: partyTypeId,
                                male_capacity: partyType?.maleCapacity || 12,
                                female_capacity: partyType?.femaleCapacity || 12,
                                min_vacancy: partyType?.minVacancy || 2,
                                is_active: true,
                                memo: '',
                                min_birth_year: session.minBirthYear || null,
                                max_birth_year: session.maxBirthYear || null
                            })
                        })
                    );
                }
            }
            
            try {
                await Promise.all(promises);
                const msg = skipped > 0 
                    ? `âœ… ì¼ì • ${promises.length}ê°œ ìƒì„± ì™„ë£Œ! (${skipped}ê°œ ì¤‘ë³µ ìŠ¤í‚µ)`
                    : `âœ… ì¼ì • ${promises.length}ê°œ ìƒì„± ì™„ë£Œ!`;
                showToast(msg, 'success');
                await refreshAllData();
            } catch (error) {
                console.error('ì¼ì • ìƒì„± ì˜¤ë¥˜:', error);
                showToast('ì¼ì • ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }
        
        // íŒŒí‹°ì¼ì • í…Œì´ë¸” ì†ŒíŒ…
        let scheduleSortField = 'date';
        let scheduleSortAsc = true;
        
        function sortSchedules(field) {
            if (scheduleSortField === field) {
                scheduleSortAsc = !scheduleSortAsc;
            } else {
                scheduleSortField = field;
                scheduleSortAsc = true;
            }
            renderSchedules();
        }
        
        // ì§ì—…í‹°ì–´í‘œ í…Œì´ë¸” ì†ŒíŒ…
        let tierSortField = 'tier';
        let tierSortAsc = true;
        
        function sortTiers(field) {
            if (tierSortField === field) {
                tierSortAsc = !tierSortAsc;
            } else {
                tierSortField = field;
                tierSortAsc = true;
            }
            renderTiers();
        }
        
        // ========================================
        // í‹°ì–´ ë Œë”ë§
        // ========================================
        function renderTiers() {
            const tbody = document.getElementById('tierBody');
            const genderFilter = document.getElementById('tierGenderFilter')?.value || '';
            const tierFilter = document.getElementById('tierFilter')?.value || '';
            
            let filtered = [...data.tiers];
            
            if (genderFilter) {
                filtered = filtered.filter(t => t.gender === genderFilter);
            }
            
            if (tierFilter) {
                filtered = filtered.filter(t => t.tier === tierFilter);
            }
            
            // ì†ŒíŒ… ì ìš©
            const tierOrder = {'S': 1, 'A': 2, 'B': 3, 'C': 4};
            const hasRuleForSort = (gender, job) => data.virtual.some(v => v.gender === gender && v.job === job);
            
            filtered.sort((a, b) => {
                let cmp = 0;
                switch (tierSortField) {
                    case 'gender':
                        cmp = (a.gender || '').localeCompare(b.gender || '');
                        break;
                    case 'job':
                        cmp = (a.job || '').localeCompare(b.job || '');
                        break;
                    case 'tier':
                        cmp = (tierOrder[a.tier] || 99) - (tierOrder[b.tier] || 99);
                        break;
                    case 'hasRule':
                        cmp = (hasRuleForSort(a.gender, a.job) ? 0 : 1) - (hasRuleForSort(b.gender, b.job) ? 0 : 1);
                        break;
                    default:
                        cmp = (tierOrder[a.tier] || 99) - (tierOrder[b.tier] || 99);
                }
                return tierSortAsc ? cmp : -cmp;
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">í‹°ì–´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            // ìƒì„±ê·œì¹™ ì¡´ì¬ ì—¬ë¶€ ì²´í¬ í—¬í¼
            const hasRuleFor = (gender, job) => {
                return data.virtual.some(v => v.gender === gender && v.job === job);
            };
            
            tbody.innerHTML = filtered.map(t => {
                const hasRule = hasRuleFor(t.gender, t.job);
                const ruleStatus = hasRule 
                    ? '<span style="color: var(--success);"><i class="fas fa-check-circle"></i> ìˆìŒ</span>'
                    : '<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> ì—†ìŒ</span>';
                return `
                <tr>
                    <td class="${t.gender === 'ë‚¨ì' ? 'gender-male' : 'gender-female'}">${t.gender || '-'}</td>
                    <td>${t.job || '-'}</td>
                    <td><span class="tier tier-${t.tier}">${t.tier || '-'}</span></td>
                    <td>${ruleStatus}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editTier('${t.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTier('${t.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }
        
        document.getElementById('tierGenderFilter')?.addEventListener('change', renderTiers);
        document.getElementById('tierFilter')?.addEventListener('change', renderTiers);
        
        // ========================================
        // ëª¨ë‹¬ ê´€ë¦¬
        // ========================================
        function openModal(id) {
            document.getElementById(id).classList.add('open');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }
        
        function openAddVirtualRuleModal() {
            document.getElementById('virtualRuleId').value = '';
            document.getElementById('virtualGender').value = 'ë‚¨ì';
            document.getElementById('virtualJob').value = '';
            document.getElementById('virtualRatio').value = '';
            document.getElementById('virtualMinYear').value = '';
            document.getElementById('virtualMaxYear').value = '';
            document.getElementById('virtualMinHeight').value = '';
            document.getElementById('virtualMaxHeight').value = '';
            document.getElementById('virtualModalTitle').textContent = 'ìƒì„± ê·œì¹™ ì¶”ê°€';
            openModal('virtualModal');
        }
        
        function editVirtualRule(id) {
            const rule = data.virtual.find(v => v.id === id);
            if (!rule) return;
            
            document.getElementById('virtualRuleId').value = id;
            document.getElementById('virtualGender').value = rule.gender || 'ë‚¨ì';
            document.getElementById('virtualJob').value = rule.job || '';
            document.getElementById('virtualRatio').value = rule.ratio || '';
            document.getElementById('virtualMinYear').value = rule.minBirthYear || '';
            document.getElementById('virtualMaxYear').value = rule.maxBirthYear || '';
            document.getElementById('virtualMinHeight').value = rule.minHeight || '';
            document.getElementById('virtualMaxHeight').value = rule.maxHeight || '';
            document.getElementById('virtualModalTitle').textContent = 'ìƒì„± ê·œì¹™ ìˆ˜ì •';
            openModal('virtualModal');
        }
        
        // ========================================
        // CRUD ì‘ì—… (RESTful API)
        // ========================================
        
        // ê°€ìƒì°¸ì—¬ì ìƒì„± ê·œì¹™ ì €ì¥ (ì¶”ê°€/ìˆ˜ì •)
        async function saveVirtualRule() {
            const id = document.getElementById('virtualRuleId').value;
            const ruleData = {
                gender: document.getElementById('virtualGender').value,
                job: document.getElementById('virtualJob').value,
                ratio: parseFloat(document.getElementById('virtualRatio').value) || 0,
                minBirthYear: parseInt(document.getElementById('virtualMinYear').value) || 1990,
                maxBirthYear: parseInt(document.getElementById('virtualMaxYear').value) || 2000,
                minHeight: parseInt(document.getElementById('virtualMinHeight').value) || 160,
                maxHeight: parseInt(document.getElementById('virtualMaxHeight').value) || 180
            };
            
            try {
                let response;
                if (id) {
                    // ìˆ˜ì •
                    response = await fetch(`${API_BASE}/virtual_participants/${id}`, {
                        method: 'PUT',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(ruleData)
                    });
                } else {
                    // ì¶”ê°€
                    response = await fetch(`${API_BASE}/virtual_participants`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(ruleData)
                    });
                }
                
                if (response.ok) {
                    closeModal('virtualModal');
                    showToast(id ? 'ê·œì¹™ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ê·œì¹™ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    await refreshAllData();
                } else {
                    throw new Error('ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        async function deleteVirtualRule(id) {
            if (!confirm('ì´ ìƒì„± ê·œì¹™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/virtual_participants/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok || response.status === 204) {
                    showToast('ê·œì¹™ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    await refreshAllData();
                } else {
                    throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                showToast('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        async function saveTier() {
            const id = document.getElementById('tierRuleId').value;
            const tierData = {
                gender: document.getElementById('tierGender').value,
                job: document.getElementById('tierJob').value,
                tier: document.getElementById('tierLevel').value
            };
            
            try {
                let response;
                if (id) {
                    // ìˆ˜ì •
                    response = await fetch(`${API_BASE}/job_tiers/${id}`, {
                        method: 'PUT',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(tierData)
                    });
                } else {
                    // ì¶”ê°€
                    response = await fetch(`${API_BASE}/job_tiers`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(tierData)
                    });
                }
                
                if (response.ok) {
                    closeModal('tierModal');
                    showToast(id ? 'í‹°ì–´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'í‹°ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    await refreshAllData();
                } else {
                    throw new Error('ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        async function deleteTier(id) {
            if (!confirm('ì´ í‹°ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/job_tiers/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok || response.status === 204) {
                    showToast('í‹°ì–´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    await refreshAllData();
                } else {
                    throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                showToast('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        function editTier(id) {
            const tier = data.tiers.find(t => t.id === id);
            if (!tier) return;
            
            document.getElementById('tierRuleId').value = id;
            document.getElementById('tierGender').value = tier.gender || 'ë‚¨ì';
            document.getElementById('tierJob').value = tier.job || '';
            document.getElementById('tierLevel').value = tier.tier || 'S';
            document.getElementById('tierModalTitle').textContent = 'í‹°ì–´ ìˆ˜ì •';
            openModal('tierModal');
        }
        
        // ========================================
        // ìœ í‹¸ë¦¬í‹°
        // ========================================
        function normalizePhone(phone) {
            if (!phone) return '';
            let numbers = String(phone).replace(/[^0-9]/g, '');
            if (numbers.startsWith('82')) numbers = numbers.substring(2);
            if (numbers.length === 10 && !numbers.startsWith('0')) numbers = '0' + numbers;
            return numbers;
        }
        
        function formatPhone(phone) {
            const n = normalizePhone(phone);
            if (n.length === 11) {
                return n.substring(0,3) + '-' + n.substring(3,7) + '-' + n.substring(7);
            }
            return n;
        }
        
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // ========================================
        // ë°ì´í„° ë³µêµ¬/í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥
        // ========================================
        
        const GAS_RESTORE_URL = 'https://script.google.com/macros/s/AKfycbzW9ts1S4krUi1FKW9mYCGbksIHv1MaqMlYNRa07dPy2887DLjOfcbmjZAsrARXj3X-/exec';
        
        async function restoreFromBackup() {
            const statusEl = document.getElementById('restoreStatus');
            statusEl.textContent = 'ë³µêµ¬ ì¤‘...';
            statusEl.style.color = 'var(--warning)';
            
            try {
                const response = await fetch(`${GAS_RESTORE_URL}?action=restore`);
                const result = await response.json();
                
                if (result.success) {
                    statusEl.textContent = `âœ… ë³µêµ¬ ì™„ë£Œ! (ê³ ê°: ${result.restored.customers}ëª…, ì˜ˆì•½: ${result.restored.reservations}ê±´)`;
                    statusEl.style.color = 'var(--primary)';
                    showToast('ë°ì´í„° ë³µêµ¬ ì™„ë£Œ!', 'success');
                    await refreshAllData();
                } else {
                    statusEl.textContent = 'âŒ ë³µêµ¬ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    statusEl.style.color = 'var(--danger)';
                }
            } catch (error) {
                statusEl.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                statusEl.style.color = 'var(--danger)';
            }
        }
        
        // ìë™ ì´ˆê¸°í™” (ë°ì´í„° ì—†ì„ ë•Œ ìë™ ì‹¤í–‰)
        async function autoInitializeDefaultData() {
            console.log('ìë™ ì´ˆê¸°í™” ì‹œì‘...');
            
            // ì§ì—…í‹°ì–´ ê¸°ë³¸ ë°ì´í„°
            const tierData = [
                // ë‚¨ì Sí‹°ì–´ (ì „ë¬¸ì§, ê¸ˆìœµê¶Œ)
                {gender:'ë‚¨ì',job:'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´)',tier:'S'},{gender:'ë‚¨ì',job:'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´)',tier:'S'},
                {gender:'ë‚¨ì',job:'ê¸ˆìœµê¶Œ',tier:'S'},
                // ë‚¨ì Aí‹°ì–´ (ëŒ€ê¸°ì—…, ì™¸êµ­ê³„, ê³µê¸°ì—…, ì—°êµ¬ì§, IT)
                {gender:'ë‚¨ì',job:'ëŒ€ê¸°ì—…',tier:'A'},{gender:'ë‚¨ì',job:'ì™¸êµ­ê³„',tier:'A'},{gender:'ë‚¨ì',job:'ê³µê¸°ì—…',tier:'A'},
                {gender:'ë‚¨ì',job:'ì—°êµ¬ì§',tier:'A'},{gender:'ë‚¨ì',job:'IT/ê°œë°œì',tier:'A'},{gender:'ë‚¨ì',job:'ì˜ë£Œì§',tier:'A'},
                // ë‚¨ì Bí‹°ì–´ (íšŒì‚¬ì›, ê³µë¬´ì›, êµìœ¡ì§ ë“±)
                {gender:'ë‚¨ì',job:'íšŒì‚¬ì›',tier:'B'},{gender:'ë‚¨ì',job:'ì‚¬ë¬´ì§',tier:'B'},{gender:'ë‚¨ì',job:'í”„ë¦¬ëœì„œ',tier:'B'},
                {gender:'ë‚¨ì',job:'ìì˜ì—…/ì‚¬ì—…ê°€',tier:'B'},{gender:'ë‚¨ì',job:'ê³µë¬´ì›',tier:'B'},{gender:'ë‚¨ì',job:'ëŒ€í•™ì›ìƒ',tier:'B'},
                {gender:'ë‚¨ì',job:'ì˜ˆì²´ëŠ¥',tier:'B'},{gender:'ë‚¨ì',job:'êµìœ¡ì§',tier:'B'},{gender:'ë‚¨ì',job:'ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´',tier:'B'},
                {gender:'ë‚¨ì',job:'ë””ìì´ë„ˆ',tier:'B'},{gender:'ë‚¨ì',job:'ê°„í˜¸ì‚¬',tier:'B'},{gender:'ë‚¨ì',job:'ê¸°íƒ€',tier:'B'},
                // ì—¬ì Sí‹°ì–´ (í•­ê³µì—…, í”¼íŠ¸ë‹ˆìŠ¤, ì „ë¬¸ì§, ì„œë¹„ìŠ¤/í˜¸í…”, ì—°ì˜ˆì¸)
                {gender:'ì—¬ì',job:'í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)',tier:'S'},{gender:'ì—¬ì',job:'í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)',tier:'S'},
                {gender:'ì—¬ì',job:'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´)',tier:'S'},{gender:'ì—¬ì',job:'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´)',tier:'S'},
                {gender:'ì—¬ì',job:'ì„œë¹„ìŠ¤/í˜¸í…”',tier:'S'},{gender:'ì—¬ì',job:'ì—°ì˜ˆì¸/ì¸í”Œë£¨ì–¸ì„œ',tier:'S'},
                // ì—¬ì Aí‹°ì–´ (ëŒ€ê¸°ì—…, ì™¸êµ­ê³„, ê¸ˆìœµê¶Œ, ë””ìì´ë„ˆ, ë§ˆì¼€íŒ…)
                {gender:'ì—¬ì',job:'ëŒ€ê¸°ì—…',tier:'A'},{gender:'ì—¬ì',job:'ì™¸êµ­ê³„',tier:'A'},{gender:'ì—¬ì',job:'ê¸ˆìœµê¶Œ',tier:'A'},
                {gender:'ì—¬ì',job:'ë””ìì´ë„ˆ',tier:'A'},{gender:'ì—¬ì',job:'ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´',tier:'A'},{gender:'ì—¬ì',job:'ì˜ˆì²´ëŠ¥',tier:'A'},
                {gender:'ì—¬ì',job:'IT/ê°œë°œì',tier:'A'},
                // ì—¬ì Bí‹°ì–´ (íšŒì‚¬ì›, ì˜ë£Œì§, êµìœ¡ì§, ê³µë¬´ì› ë“±)
                {gender:'ì—¬ì',job:'íšŒì‚¬ì›',tier:'B'},{gender:'ì—¬ì',job:'ì‚¬ë¬´ì§',tier:'B'},{gender:'ì—¬ì',job:'ì˜ë£Œì§',tier:'B'},
                {gender:'ì—¬ì',job:'ê°„í˜¸ì‚¬',tier:'B'},{gender:'ì—¬ì',job:'êµìœ¡ì§',tier:'B'},{gender:'ì—¬ì',job:'ì—°êµ¬ì§',tier:'B'},
                {gender:'ì—¬ì',job:'í”„ë¦¬ëœì„œ',tier:'B'},{gender:'ì—¬ì',job:'ìì˜ì—…/ì‚¬ì—…ê°€',tier:'B'},{gender:'ì—¬ì',job:'ê³µê¸°ì—…',tier:'B'},
                {gender:'ì—¬ì',job:'ê³µë¬´ì›',tier:'B'},{gender:'ì—¬ì',job:'ëŒ€í•™ì›ìƒ',tier:'B'},{gender:'ì—¬ì',job:'ê¸°íƒ€',tier:'B'}
            ];
            
            // ê°€ìƒì°¸ì—¬ì ìƒì„± ê·œì¹™ ê¸°ë³¸ ë°ì´í„° (ìƒˆ ì§ì—… ë¶„ë¥˜ ì ìš©)
            const virtualData = [
                // ë‚¨ì (ì´ 100%)
                {gender:'ë‚¨ì',job:'ëŒ€ê¸°ì—…',ratio:25,minBirthYear:1990,maxBirthYear:2000,minHeight:175,maxHeight:183},
                {gender:'ë‚¨ì',job:'íšŒì‚¬ì›',ratio:20,minBirthYear:1990,maxBirthYear:2000,minHeight:173,maxHeight:180},
                {gender:'ë‚¨ì',job:'ê¸ˆìœµê¶Œ',ratio:12,minBirthYear:1992,maxBirthYear:1999,minHeight:175,maxHeight:182},
                {gender:'ë‚¨ì',job:'IT/ê°œë°œì',ratio:12,minBirthYear:1992,maxBirthYear:2001,minHeight:173,maxHeight:181},
                {gender:'ë‚¨ì',job:'ê³µê¸°ì—…',ratio:10,minBirthYear:1990,maxBirthYear:1998,minHeight:174,maxHeight:180},
                {gender:'ë‚¨ì',job:'ì™¸êµ­ê³„',ratio:8,minBirthYear:1993,maxBirthYear:1999,minHeight:176,maxHeight:183},
                {gender:'ë‚¨ì',job:'ì—°êµ¬ì§',ratio:5,minBirthYear:1990,maxBirthYear:1998,minHeight:174,maxHeight:180},
                {gender:'ë‚¨ì',job:'ê³µë¬´ì›',ratio:4,minBirthYear:1990,maxBirthYear:1998,minHeight:173,maxHeight:179},
                {gender:'ë‚¨ì',job:'ìì˜ì—…/ì‚¬ì—…ê°€',ratio:4,minBirthYear:1988,maxBirthYear:1996,minHeight:174,maxHeight:181},
                // ì—¬ì (ì´ 100%) - ì˜ˆìœ ì§ì—… ë¹„ìœ¨ ë†’ì„
                {gender:'ì—¬ì',job:'íšŒì‚¬ì›',ratio:20,minBirthYear:1992,maxBirthYear:2001,minHeight:155,maxHeight:167},
                {gender:'ì—¬ì',job:'í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)',ratio:12,minBirthYear:1995,maxBirthYear:2001,minHeight:165,maxHeight:172},
                {gender:'ì—¬ì',job:'í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)',ratio:12,minBirthYear:1994,maxBirthYear:2001,minHeight:160,maxHeight:170},
                {gender:'ì—¬ì',job:'ì˜ë£Œì§',ratio:10,minBirthYear:1992,maxBirthYear:2002,minHeight:156,maxHeight:168},
                {gender:'ì—¬ì',job:'ì„œë¹„ìŠ¤/í˜¸í…”',ratio:8,minBirthYear:1995,maxBirthYear:2001,minHeight:162,maxHeight:170},
                {gender:'ì—¬ì',job:'ëŒ€ê¸°ì—…',ratio:8,minBirthYear:1993,maxBirthYear:2000,minHeight:157,maxHeight:170},
                {gender:'ì—¬ì',job:'ë””ìì´ë„ˆ',ratio:7,minBirthYear:1994,maxBirthYear:2001,minHeight:156,maxHeight:168},
                {gender:'ì—¬ì',job:'ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´',ratio:6,minBirthYear:1993,maxBirthYear:2000,minHeight:156,maxHeight:169},
                {gender:'ì—¬ì',job:'ì™¸êµ­ê³„',ratio:5,minBirthYear:1993,maxBirthYear:1999,minHeight:158,maxHeight:170},
                {gender:'ì—¬ì',job:'êµìœ¡ì§',ratio:5,minBirthYear:1992,maxBirthYear:1999,minHeight:155,maxHeight:167},
                {gender:'ì—¬ì',job:'ê¸ˆìœµê¶Œ',ratio:4,minBirthYear:1993,maxBirthYear:1999,minHeight:157,maxHeight:170},
                {gender:'ì—¬ì',job:'IT/ê°œë°œì',ratio:3,minBirthYear:1993,maxBirthYear:2000,minHeight:155,maxHeight:168}
            ];
            
            // ì„¸ì…˜ í…œí”Œë¦¿ ê¸°ë³¸ ë°ì´í„° (snake_case for Supabase)
            const sessionData = [
                { id: '1ë¶€', time: '12:00', type: 'ì»¤í”¼', sort_order: 1, is_active: true },
                { id: '2ë¶€', time: '15:00', type: 'ì»¤í”¼', sort_order: 2, is_active: true },
                { id: '3ë¶€', time: '19:00', type: 'ì™€ì¸', sort_order: 3, is_active: true }
            ];
            
            try {
                let tierCount = 0;
                let virtualCount = 0;
                let sessionCount = 0;
                
                // ì„¸ì…˜ í…œí”Œë¦¿ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (ë¨¼ì € í•´ì•¼ ì¼ì • ìƒì„±ì— ì‚¬ìš© ê°€ëŠ¥)
                if (data.sessions.length === 0) {
                    const sessionPromises = sessionData.map(s => 
                        fetch(`${API_BASE}/session_templates`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify(s)
                        }).then(res => res.ok ? 1 : 0).catch(() => 0)
                    );
                    const sessionResults = await Promise.all(sessionPromises);
                    sessionCount = sessionResults.reduce((a, b) => a + b, 0);
                    
                    // ì„¸ì…˜ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                    const sessionsRes = await fetch(`${API_BASE}/session_templates?limit=1000`, { headers: SUPABASE_HEADERS });
                    const sessionsJson = await sessionsRes.json();
                    data.sessions = Array.isArray(sessionsJson) ? sessionsJson : [];
                }
                
                // í‹°ì–´ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¶”ê°€ (ë³‘ë ¬ ì²˜ë¦¬)
                if (data.tiers.length === 0) {
                    const tierPromises = tierData.map(t => 
                        fetch(`${API_BASE}/job_tiers`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify(t)
                        }).then(res => res.ok ? 1 : 0).catch(() => 0)
                    );
                    const tierResults = await Promise.all(tierPromises);
                    tierCount = tierResults.reduce((a, b) => a + b, 0);
                }
                
                // ê°€ìƒì°¸ì—¬ì ê·œì¹™ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (ë³‘ë ¬ ì²˜ë¦¬)
                if (data.virtual.length === 0) {
                    const virtualPromises = virtualData.map(v => 
                        fetch(`${API_BASE}/virtual_participants`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify(v)
                        }).then(res => res.ok ? 1 : 0).catch(() => 0)
                    );
                    const virtualResults = await Promise.all(virtualPromises);
                    virtualCount = virtualResults.reduce((a, b) => a + b, 0);
                }
                
                // íŒŒí‹° ì¼ì •ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (2026ë…„ 1~2ì›” í† /ì¼ ê¸°ë³¸ ì¼ì •)
                let scheduleCount = 0;
                if (data.schedules.length === 0) {
                    const scheduleData = [];
                    // ì„¸ì…˜ í…œí”Œë¦¿ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    const defaultParts = data.sessions.length > 0 
                        ? data.sessions.filter(s => s.isActive !== false).map(s => ({ part: s.id, time: s.time }))
                        : [
                        { part: '1ë¶€', time: '12:00' },
                        { part: '2ë¶€', time: '15:00' },
                        { part: '3ë¶€', time: '19:00' }
                    ];
                    
                    // 2026ë…„ 1ì›”, 2ì›” í† /ì¼ ê³„ì‚°
                    for (let month = 1; month <= 2; month++) {
                        const daysInMonth = new Date(2026, month, 0).getDate();
                        for (let day = 1; day <= daysInMonth; day++) {
                            const date = new Date(2026, month - 1, day);
                            const dayOfWeek = date.getDay();
                            if (dayOfWeek === 0 || dayOfWeek === 6) { // ì¼, í† 
                                const dateKorean = `2026ë…„ ${month}ì›” ${day}ì¼`;
                                for (const { part, time } of defaultParts) {
                                    scheduleData.push({ date: dateKorean, part, time, is_active: true, memo: '' });
                                }
                            }
                        }
                    }
                    
                    const schedulePromises = scheduleData.map(s => 
                        fetch(`${API_BASE}/party_schedules`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify(s)
                        }).then(res => res.ok ? 1 : 0).catch(() => 0)
                    );
                    const scheduleResults = await Promise.all(schedulePromises);
                    scheduleCount = scheduleResults.reduce((a, b) => a + b, 0);
                }
                
                console.log(`ìë™ ì´ˆê¸°í™” ì™„ë£Œ: ì„¸ì…˜ ${sessionCount}ê°œ, í‹°ì–´ ${tierCount}ê°œ, ê°€ìƒì°¸ì—¬ì ê·œì¹™ ${virtualCount}ê°œ, íŒŒí‹°ì¼ì • ${scheduleCount}ê°œ`);
                showToast(`âœ… ê¸°ë³¸ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ!`, 'success');
                
                // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                const [tiersRes, virtualRes, schedulesRes, sessionsRes2] = await Promise.all([
                    fetch(`${API_BASE}/job_tiers?limit=1000`, { headers: SUPABASE_HEADERS }),
                    fetch(`${API_BASE}/virtual_participants?limit=1000`, { headers: SUPABASE_HEADERS }),
                    fetch(`${API_BASE}/party_schedules?limit=1000`, { headers: SUPABASE_HEADERS }),
                    fetch(`${API_BASE}/session_templates?limit=1000`, { headers: SUPABASE_HEADERS })
                ]);
                
                const tiersData = await tiersRes.json();
                const virtualResData = await virtualRes.json();
                const schedulesData = await schedulesRes.json();
                const sessionsData2 = await sessionsRes2.json();
                
                // SupabaseëŠ” ë°°ì—´ ì§ì ‘ ë°˜í™˜
                data.tiers = Array.isArray(tiersData) ? tiersData : [];
                data.virtual = Array.isArray(virtualResData) ? virtualResData : [];
                data.schedules = Array.isArray(schedulesData) ? schedulesData : [];
                data.sessions = Array.isArray(sessionsData2) ? sessionsData2 : [];
                
                // UI ì—…ë°ì´íŠ¸
                updateScheduleMonthFilter();
                renderVirtualRules();
                renderTiers();
                renderSchedules();
                renderSessions();
                
            } catch (error) {
                console.error('ìë™ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showToast('ìë™ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ========================================
        // ì„¤ì • íƒ­ - ì§ì—… í‹°ì–´í‘œ & ìƒì„±ê·œì¹™ ê´€ë¦¬
        // ========================================
        
        let currentTierGender = 'ë‚¨ì';
        
        function switchTierTab(gender) {
            currentTierGender = gender;
            document.getElementById('tierTabMale').className = gender === 'ë‚¨ì' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            document.getElementById('tierTabMale').style.background = gender === 'ë‚¨ì' ? 'var(--blue)' : '';
            document.getElementById('tierTabMale').style.color = gender === 'ë‚¨ì' ? 'white' : '';
            document.getElementById('tierTabFemale').className = gender === 'ì—¬ì' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            document.getElementById('tierTabFemale').style.background = gender === 'ì—¬ì' ? 'var(--danger)' : '';
            document.getElementById('tierTabFemale').style.color = gender === 'ì—¬ì' ? 'white' : '';
            document.getElementById('ruleGenderTitle').textContent = gender;
            renderTierTable();
            renderRuleTable();
        }
        
        function renderTierTable() {
            const tbody = document.getElementById('tierTableBody');
            if (!tbody) return;
            
            const filtered = (data.tiers || []).filter(t => t.gender === currentTierGender);
            
            // í‹°ì–´ìˆœ ì •ë ¬ (S > A > B > C)
            const tierOrder = { S: 0, A: 1, B: 2, C: 3 };
            filtered.sort((a, b) => (tierOrder[a.tier] || 99) - (tierOrder[b.tier] || 99));
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">ì§ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€í•´ì£¼ì„¸ìš”.</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(t => `
                <tr>
                    <td>${t.job}</td>
                    <td><span class="tier tier-${t.tier}">${t.tier}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="openEditTierModal('${t.id}')" title="ìˆ˜ì •">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTierWithSync('${t.id}')" title="ì‚­ì œ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderRuleTable() {
            const tbody = document.getElementById('ruleTableBody');
            if (!tbody) return;
            
            const filtered = (data.virtual || []).filter(v => v.gender === currentTierGender);
            
            // í‹°ì–´ìˆœ ì •ë ¬
            const getTierForJob = (job) => {
                const tier = data.tiers.find(t => t.gender === currentTierGender && t.job === job);
                return tier?.tier || 'B';
            };
            const tierOrder = { S: 0, A: 1, B: 2, C: 3 };
            filtered.sort((a, b) => (tierOrder[getTierForJob(a.job)] || 99) - (tierOrder[getTierForJob(b.job)] || 99));
            
            // ë¹„ìœ¨ í•©ê³„ ê³„ì‚°
            const ratioSum = filtered.reduce((sum, v) => sum + (parseFloat(v.ratio) || 0), 0);
            document.getElementById('ratioSum').textContent = `${ratioSum}%`;
            document.getElementById('ratioSum').style.color = ratioSum === 100 ? 'var(--primary)' : (ratioSum > 100 ? 'var(--danger)' : 'var(--warning)');
            
            // ê²½ê³  í‘œì‹œ
            const warningEl = document.getElementById('ratioWarning');
            if (ratioSum > 100) {
                warningEl.style.display = 'block';
                document.getElementById('ratioWarningText').textContent = 
                    `âš ï¸ ${currentTierGender} ë¹„ìœ¨ í•©ê³„ê°€ ${ratioSum}%ì…ë‹ˆë‹¤. 100%ë¡œ ë§ì¶°ì£¼ì„¸ìš”. (ì´ˆê³¼: ${ratioSum - 100}%)`;
            } else if (ratioSum < 100 && ratioSum > 0) {
                warningEl.style.display = 'block';
                warningEl.style.background = 'var(--warning)';
                document.getElementById('ratioWarningText').textContent = 
                    `âš ï¸ ${currentTierGender} ë¹„ìœ¨ í•©ê³„ê°€ ${ratioSum}%ì…ë‹ˆë‹¤. 100%ë¡œ ë§ì¶°ì£¼ì„¸ìš”. (ë¶€ì¡±: ${100 - ratioSum}%)`;
            } else {
                warningEl.style.display = 'none';
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ìƒì„± ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(v => {
                const tier = getTierForJob(v.job);
                const isUnset = !v.ratio && !v.minBirthYear && !v.maxBirthYear;
                const yearRange = (v.minBirthYear && v.maxBirthYear) ? `${v.minBirthYear}~${v.maxBirthYear}` : '-';
                const heightRange = (v.minHeight && v.maxHeight) ? `${v.minHeight}~${v.maxHeight}cm` : '-';
                
                return `
                    <tr class="${isUnset ? 'pending-row' : ''}">
                        <td>${v.job} ${isUnset ? '<span style="color:var(--warning);">âš ï¸ë¯¸ì„¤ì •</span>' : ''}</td>
                        <td><span class="tier tier-${tier}">${tier}</span></td>
                        <td>
                            <input type="number" value="${v.ratio || 0}" min="0" max="100" style="width: 60px;" 
                                   onchange="updateRuleRatio('${v.id}', this.value)">%
                        </td>
                        <td>${yearRange}</td>
                        <td>${heightRange}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="openEditRuleModal('${v.id}')" title="ìƒì„¸ ìˆ˜ì •">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ë¹„ìœ¨ ë¹ ë¥¸ ìˆ˜ì •
        async function updateRuleRatio(id, newRatio) {
            const rule = data.virtual.find(v => v.id === id);
            if (!rule) return;
            
            const updateData = { ...rule, ratio: parseFloat(newRatio) || 0 };
            delete updateData.id;
            
            try {
                await fetch(`${API_BASE}/virtual_participants/${id}`, {
                    method: 'PUT',
                    headers: SUPABASE_HEADERS,
                    body: JSON.stringify(updateData)
                });
                await refreshAllData();
                renderRuleTable();
            } catch (e) {
                showToast('ë¹„ìœ¨ ìˆ˜ì • ì‹¤íŒ¨', 'error');
            }
        }
        
        function openAddTierModal() {
            document.getElementById('tierRuleId').value = '';
            document.getElementById('tierGender').value = currentTierGender;
            document.getElementById('tierJob').value = '';
            document.getElementById('tierLevel').value = 'B';
            document.getElementById('tierModalTitle').textContent = 'ì§ì—… ì¶”ê°€';
            openModal('tierModal');
        }
        
        function openEditTierModal(id) {
            const tier = data.tiers.find(t => t.id === id);
            if (!tier) return;
            
            document.getElementById('tierRuleId').value = id;
            document.getElementById('tierGender').value = tier.gender;
            document.getElementById('tierJob').value = tier.job;
            document.getElementById('tierLevel').value = tier.tier;
            document.getElementById('tierModalTitle').textContent = 'ì§ì—… ìˆ˜ì •';
            openModal('tierModal');
        }
        
        // í‹°ì–´ ì €ì¥ + ìƒì„±ê·œì¹™ ë™ê¸°í™”
        async function saveTierAndSync() {
            const id = document.getElementById('tierRuleId').value;
            const gender = document.getElementById('tierGender').value;
            const job = document.getElementById('tierJob').value.trim();
            const tier = document.getElementById('tierLevel').value;
            
            if (!job) {
                showToast('ì§ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            // ì¤‘ë³µ ì²´í¬ (ìˆ˜ì •ì´ ì•„ë‹ ë•Œë§Œ)
            if (!id) {
                const exists = data.tiers.find(t => t.gender === gender && t.job === job);
                if (exists) {
                    showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì§ì—…ì…ë‹ˆë‹¤', 'error');
                    return;
                }
            }
            
            try {
                let response;
                if (id) {
                    // ìˆ˜ì •
                    const existing = data.tiers.find(t => t.id === id);
                    const updateData = { ...existing, gender, job, tier };
                    delete updateData.id;
                    response = await fetch(`${API_BASE}/job_tiers/${id}`, {
                        method: 'PUT',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(updateData)
                    });
                } else {
                    // ì¶”ê°€
                    response = await fetch(`${API_BASE}/job_tiers`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify({ gender, job, tier })
                    });
                    
                    // ìƒì„± ê·œì¹™ì—ë„ ìë™ ì¶”ê°€ (ë¹„ìœ¨ 0%, ì¡°ê±´ ë¯¸ì„¤ì •)
                    if (response.ok) {
                        const existsInRule = data.virtual.find(v => v.gender === gender && v.job === job);
                        if (!existsInRule) {
                            await fetch(`${API_BASE}/virtual_participants`, {
                                method: 'POST',
                                headers: SUPABASE_HEADERS,
                                body: JSON.stringify({
                                    gender, job,
                                    ratio: 0,
                                    minBirthYear: null,
                                    maxBirthYear: null,
                                    minHeight: null,
                                    maxHeight: null
                                })
                            });
                        }
                    }
                }
                
                if (response.ok) {
                    closeModal('tierModal');
                    showToast(id ? 'ì§ì—… ìˆ˜ì • ì™„ë£Œ' : 'ì§ì—… ì¶”ê°€ ì™„ë£Œ (ìƒì„±ê·œì¹™ì— ìë™ ì¶”ê°€ë¨)', 'success');
                    await refreshAllData();
                    renderTierTable();
                    renderRuleTable();
                } else {
                    showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('ì €ì¥ ì˜¤ë¥˜', 'error');
            }
        }
        
        // í‹°ì–´ ì‚­ì œ + ìƒì„±ê·œì¹™ ë™ê¸°í™”
        async function deleteTierWithSync(id) {
            const tier = data.tiers.find(t => t.id === id);
            if (!tier) return;
            
            // ì´ ì§ì—…ìœ¼ë¡œ ìƒì„±ëœ í’€/ë°°ì • ì²´í¬
            const poolCount = (data.virtualPool || []).filter(p => p.job === tier.job && p.gender === tier.gender).length;
            const assignCount = (data.virtualAssignments || []).filter(a => a.job === tier.job && a.gender === tier.gender).length;
            
            let msg = `"${tier.job}" ì§ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            if (poolCount > 0 || assignCount > 0) {
                msg += `\n\nâš ï¸ ì´ ì§ì—…ìœ¼ë¡œ ìƒì„±ëœ ë°ì´í„°:\n- í’€: ${poolCount}ëª…\n- ë°°ì •: ${assignCount}ëª…\n\nì‚­ì œí•´ë„ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.`;
            }
            
            if (!confirm(msg)) return;
            
            try {
                // í‹°ì–´ ì‚­ì œ
                await fetch(`${API_BASE}/job_tiers/${id}`, { method: 'DELETE' });
                
                // ìƒì„±ê·œì¹™ì—ì„œë„ ì‚­ì œ
                const rule = data.virtual.find(v => v.gender === tier.gender && v.job === tier.job);
                if (rule) {
                    await fetch(`${API_BASE}/virtual_participants/${rule.id}`, { method: 'DELETE' });
                }
                
                showToast('ì§ì—… ì‚­ì œ ì™„ë£Œ', 'success');
                await refreshAllData();
                renderTierTable();
                renderRuleTable();
            } catch (e) {
                showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        }
        
        // ìƒì„±ê·œì¹™ ìƒì„¸ ìˆ˜ì • ëª¨ë‹¬
        function openEditRuleModal(id) {
            const rule = data.virtual.find(v => v.id === id);
            if (!rule) return;
            
            document.getElementById('virtualRuleId').value = id;
            document.getElementById('virtualGender').value = rule.gender;
            document.getElementById('virtualJob').value = rule.job;
            document.getElementById('virtualRatio').value = rule.ratio || '';
            document.getElementById('virtualMinYear').value = rule.minBirthYear || '';
            document.getElementById('virtualMaxYear').value = rule.maxBirthYear || '';
            document.getElementById('virtualMinHeight').value = rule.minHeight || '';
            document.getElementById('virtualMaxHeight').value = rule.maxHeight || '';
            document.getElementById('virtualModalTitle').textContent = 'ìƒì„± ê·œì¹™ ìˆ˜ì •';
            openModal('virtualModal');
        }
        
        // í†µì¼ëœ ê¸°ë³¸ ë°ì´í„° ì´ˆê¸°í™”
        async function initializeUnifiedJobData() {
            const statusEl = document.getElementById('initStatus');
            statusEl.textContent = 'ì´ˆê¸°í™” ì¤‘...';
            statusEl.style.color = 'var(--warning)';
            
            if (!confirm('ê¸°ì¡´ ì§ì—…í‹°ì–´/ìƒì„±ê·œì¹™ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  í†µì¼ëœ ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.\n\nâš ï¸ ê¸°ì¡´ í’€ê³¼ ë°°ì • ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                statusEl.textContent = '';
                return;
            }
            
            try {
                // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
                for (const t of (data.tiers || [])) {
                    await fetch(`${API_BASE}/job_tiers/${t.id}`, { method: 'DELETE' });
                }
                for (const v of (data.virtual || [])) {
                    await fetch(`${API_BASE}/virtual_participants/${v.id}`, { method: 'DELETE' });
                }
                
                // í†µì¼ëœ ì§ì—…ëª… (ê¸´ í˜•íƒœ)
                const tierData = [
                    // ë‚¨ì
                    { gender: 'ë‚¨ì', job: 'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)', tier: 'S' },
                    { gender: 'ë‚¨ì', job: 'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´ - ì˜ì‚¬,ì•½ì‚¬,í•œì˜ì‚¬ ë“±)', tier: 'S' },
                    { gender: 'ë‚¨ì', job: 'ê¸ˆìœµê¶Œ', tier: 'S' },
                    { gender: 'ë‚¨ì', job: 'ëŒ€ê¸°ì—…', tier: 'A' },
                    { gender: 'ë‚¨ì', job: 'ì™¸êµ­ê³„', tier: 'A' },
                    { gender: 'ë‚¨ì', job: 'ê³µê¸°ì—…', tier: 'A' },
                    { gender: 'ë‚¨ì', job: 'IT/ê°œë°œì', tier: 'A' },
                    { gender: 'ë‚¨ì', job: 'ì—°êµ¬ì§', tier: 'A' },
                    { gender: 'ë‚¨ì', job: 'íšŒì‚¬ì›', tier: 'B' },
                    { gender: 'ë‚¨ì', job: 'ê³µë¬´ì›', tier: 'B' },
                    { gender: 'ë‚¨ì', job: 'ìì˜ì—…/ì‚¬ì—…ê°€', tier: 'B' },
                    { gender: 'ë‚¨ì', job: 'êµìœ¡ì§', tier: 'B' },
                    { gender: 'ë‚¨ì', job: 'í”„ë¦¬ëœì„œ', tier: 'B' },
                    { gender: 'ë‚¨ì', job: 'ê¸°íƒ€', tier: 'B' },
                    // ì—¬ì
                    { gender: 'ì—¬ì', job: 'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)', tier: 'S' },
                    { gender: 'ì—¬ì', job: 'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´ - ì˜ì‚¬,ì•½ì‚¬,í•œì˜ì‚¬ ë“±)', tier: 'S' },
                    { gender: 'ì—¬ì', job: 'í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)', tier: 'S' },
                    { gender: 'ì—¬ì', job: 'í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)', tier: 'S' },
                    { gender: 'ì—¬ì', job: 'ëŒ€ê¸°ì—…', tier: 'A' },
                    { gender: 'ì—¬ì', job: 'ì™¸êµ­ê³„', tier: 'A' },
                    { gender: 'ì—¬ì', job: 'ê¸ˆìœµê¶Œ', tier: 'A' },
                    { gender: 'ì—¬ì', job: 'ë””ìì´ë„ˆ', tier: 'A' },
                    { gender: 'ì—¬ì', job: 'ê°„í˜¸ì‚¬', tier: 'A' },
                    { gender: 'ì—¬ì', job: 'ì„œë¹„ìŠ¤/í˜¸í…”', tier: 'A' },
                    { gender: 'ì—¬ì', job: 'íšŒì‚¬ì›', tier: 'B' },
                    { gender: 'ì—¬ì', job: 'êµìœ¡ì§', tier: 'B' },
                    { gender: 'ì—¬ì', job: 'ì˜ë£Œì§', tier: 'B' },
                    { gender: 'ì—¬ì', job: 'ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´', tier: 'B' },
                    { gender: 'ì—¬ì', job: 'ì‚¬ë¬´ì§', tier: 'B' },
                    { gender: 'ì—¬ì', job: 'ê¸°íƒ€', tier: 'B' }
                ];
                
                // ìƒì„±ê·œì¹™ (í‹°ì–´í‘œì™€ ë™ì¼í•œ ì§ì—…ëª…, ë¹„ìœ¨/ì¡°ê±´ í¬í•¨)
                const ruleData = [
                    // ë‚¨ì (100%)
                    { gender: 'ë‚¨ì', job: 'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)', ratio: 5, minBirthYear: 1988, maxBirthYear: 1998, minHeight: 175, maxHeight: 183 },
                    { gender: 'ë‚¨ì', job: 'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´ - ì˜ì‚¬,ì•½ì‚¬,í•œì˜ì‚¬ ë“±)', ratio: 5, minBirthYear: 1988, maxBirthYear: 1998, minHeight: 175, maxHeight: 183 },
                    { gender: 'ë‚¨ì', job: 'ê¸ˆìœµê¶Œ', ratio: 12, minBirthYear: 1992, maxBirthYear: 1999, minHeight: 175, maxHeight: 182 },
                    { gender: 'ë‚¨ì', job: 'ëŒ€ê¸°ì—…', ratio: 25, minBirthYear: 1990, maxBirthYear: 2000, minHeight: 175, maxHeight: 183 },
                    { gender: 'ë‚¨ì', job: 'ì™¸êµ­ê³„', ratio: 8, minBirthYear: 1993, maxBirthYear: 1999, minHeight: 176, maxHeight: 183 },
                    { gender: 'ë‚¨ì', job: 'ê³µê¸°ì—…', ratio: 10, minBirthYear: 1990, maxBirthYear: 1998, minHeight: 174, maxHeight: 180 },
                    { gender: 'ë‚¨ì', job: 'IT/ê°œë°œì', ratio: 12, minBirthYear: 1992, maxBirthYear: 2001, minHeight: 173, maxHeight: 181 },
                    { gender: 'ë‚¨ì', job: 'ì—°êµ¬ì§', ratio: 5, minBirthYear: 1990, maxBirthYear: 1998, minHeight: 174, maxHeight: 180 },
                    { gender: 'ë‚¨ì', job: 'íšŒì‚¬ì›', ratio: 10, minBirthYear: 1990, maxBirthYear: 2000, minHeight: 173, maxHeight: 180 },
                    { gender: 'ë‚¨ì', job: 'ê³µë¬´ì›', ratio: 4, minBirthYear: 1990, maxBirthYear: 1998, minHeight: 173, maxHeight: 179 },
                    { gender: 'ë‚¨ì', job: 'ìì˜ì—…/ì‚¬ì—…ê°€', ratio: 4, minBirthYear: 1988, maxBirthYear: 1996, minHeight: 174, maxHeight: 181 },
                    { gender: 'ë‚¨ì', job: 'êµìœ¡ì§', ratio: 0, minBirthYear: null, maxBirthYear: null, minHeight: null, maxHeight: null },
                    { gender: 'ë‚¨ì', job: 'í”„ë¦¬ëœì„œ', ratio: 0, minBirthYear: null, maxBirthYear: null, minHeight: null, maxHeight: null },
                    { gender: 'ë‚¨ì', job: 'ê¸°íƒ€', ratio: 0, minBirthYear: null, maxBirthYear: null, minHeight: null, maxHeight: null },
                    // ì—¬ì (100%)
                    { gender: 'ì—¬ì', job: 'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)', ratio: 3, minBirthYear: 1990, maxBirthYear: 2000, minHeight: 158, maxHeight: 170 },
                    { gender: 'ì—¬ì', job: 'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´ - ì˜ì‚¬,ì•½ì‚¬,í•œì˜ì‚¬ ë“±)', ratio: 3, minBirthYear: 1990, maxBirthYear: 2000, minHeight: 158, maxHeight: 170 },
                    { gender: 'ì—¬ì', job: 'í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)', ratio: 12, minBirthYear: 1995, maxBirthYear: 2001, minHeight: 165, maxHeight: 172 },
                    { gender: 'ì—¬ì', job: 'í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)', ratio: 12, minBirthYear: 1994, maxBirthYear: 2001, minHeight: 160, maxHeight: 170 },
                    { gender: 'ì—¬ì', job: 'ëŒ€ê¸°ì—…', ratio: 8, minBirthYear: 1993, maxBirthYear: 2000, minHeight: 157, maxHeight: 170 },
                    { gender: 'ì—¬ì', job: 'ì™¸êµ­ê³„', ratio: 5, minBirthYear: 1993, maxBirthYear: 1999, minHeight: 158, maxHeight: 170 },
                    { gender: 'ì—¬ì', job: 'ê¸ˆìœµê¶Œ', ratio: 4, minBirthYear: 1993, maxBirthYear: 1999, minHeight: 157, maxHeight: 170 },
                    { gender: 'ì—¬ì', job: 'ë””ìì´ë„ˆ', ratio: 7, minBirthYear: 1994, maxBirthYear: 2001, minHeight: 156, maxHeight: 168 },
                    { gender: 'ì—¬ì', job: 'ê°„í˜¸ì‚¬', ratio: 8, minBirthYear: 1993, maxBirthYear: 2001, minHeight: 156, maxHeight: 168 },
                    { gender: 'ì—¬ì', job: 'ì„œë¹„ìŠ¤/í˜¸í…”', ratio: 8, minBirthYear: 1995, maxBirthYear: 2001, minHeight: 162, maxHeight: 170 },
                    { gender: 'ì—¬ì', job: 'íšŒì‚¬ì›', ratio: 18, minBirthYear: 1992, maxBirthYear: 2001, minHeight: 155, maxHeight: 167 },
                    { gender: 'ì—¬ì', job: 'êµìœ¡ì§', ratio: 5, minBirthYear: 1992, maxBirthYear: 1999, minHeight: 155, maxHeight: 167 },
                    { gender: 'ì—¬ì', job: 'ì˜ë£Œì§', ratio: 4, minBirthYear: 1992, maxBirthYear: 2002, minHeight: 156, maxHeight: 168 },
                    { gender: 'ì—¬ì', job: 'ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´', ratio: 3, minBirthYear: 1993, maxBirthYear: 2000, minHeight: 156, maxHeight: 169 },
                    { gender: 'ì—¬ì', job: 'ì‚¬ë¬´ì§', ratio: 0, minBirthYear: null, maxBirthYear: null, minHeight: null, maxHeight: null },
                    { gender: 'ì—¬ì', job: 'ê¸°íƒ€', ratio: 0, minBirthYear: null, maxBirthYear: null, minHeight: null, maxHeight: null }
                ];
                
                // í‹°ì–´ ë°ì´í„° ì¶”ê°€
                let tierCount = 0;
                for (const t of tierData) {
                    const res = await fetch(`${API_BASE}/job_tiers`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(t)
                    });
                    if (res.ok) tierCount++;
                }
                
                // ê·œì¹™ ë°ì´í„° ì¶”ê°€
                let ruleCount = 0;
                for (const r of ruleData) {
                    const res = await fetch(`${API_BASE}/virtual_participants`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(r)
                    });
                    if (res.ok) ruleCount++;
                }
                
                statusEl.textContent = `âœ… ì´ˆê¸°í™” ì™„ë£Œ! (í‹°ì–´: ${tierCount}ê°œ, ê·œì¹™: ${ruleCount}ê°œ)`;
                statusEl.style.color = 'var(--primary)';
                showToast('í†µì¼ëœ ê¸°ë³¸ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ!', 'success');
                await refreshAllData();
                renderTierTable();
                renderRuleTable();
                
            } catch (error) {
                statusEl.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                statusEl.style.color = 'var(--danger)';
                showToast('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ëˆ„ë½ëœ ì „ë¬¸ì§ ì¶”ê°€ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ë©´ì„œ ì „ë¬¸ì§ë§Œ ì¶”ê°€)
        async function addMissingProfessionalJobs() {
            const statusEl = document.getElementById('initStatus');
            statusEl.textContent = 'ì „ë¬¸ì§ í™•ì¸ ì¤‘...';
            statusEl.style.color = 'var(--warning)';
            
            // ì¶”ê°€í•  ì „ë¬¸ì§ ëª©ë¡ (ê¸´ í˜•íƒœ)
            const professionalJobs = [
                { gender: 'ë‚¨ì', job: 'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)', tier: 'S', ratio: 5, minBirthYear: 1988, maxBirthYear: 1998, minHeight: 175, maxHeight: 183 },
                { gender: 'ë‚¨ì', job: 'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´ - ì˜ì‚¬,ì•½ì‚¬,í•œì˜ì‚¬ ë“±)', tier: 'S', ratio: 5, minBirthYear: 1988, maxBirthYear: 1998, minHeight: 175, maxHeight: 183 },
                { gender: 'ì—¬ì', job: 'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´ - ë³€í˜¸ì‚¬,íšŒê³„ì‚¬,ë…¸ë¬´ì‚¬ ë“±)', tier: 'S', ratio: 3, minBirthYear: 1990, maxBirthYear: 2000, minHeight: 158, maxHeight: 170 },
                { gender: 'ì—¬ì', job: 'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´ - ì˜ì‚¬,ì•½ì‚¬,í•œì˜ì‚¬ ë“±)', tier: 'S', ratio: 3, minBirthYear: 1990, maxBirthYear: 2000, minHeight: 158, maxHeight: 170 }
            ];
            
            let addedTiers = 0;
            let addedRules = 0;
            
            try {
                for (const p of professionalJobs) {
                    // í‹°ì–´ í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                    const existsInTier = (data.tiers || []).some(t => 
                        t.gender === p.gender && t.job === p.job
                    );
                    
                    if (!existsInTier) {
                        // í‹°ì–´ ì¶”ê°€
                        const tierRes = await fetch(`${API_BASE}/job_tiers`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify({ gender: p.gender, job: p.job, tier: p.tier })
                        });
                        if (tierRes.ok) addedTiers++;
                    }
                    
                    // ìƒì„± ê·œì¹™ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                    const existsInRule = (data.virtual || []).some(v => 
                        v.gender === p.gender && v.job === p.job
                    );
                    
                    if (!existsInRule) {
                        // ê·œì¹™ ì¶”ê°€
                        const ruleRes = await fetch(`${API_BASE}/virtual_participants`, {
                            method: 'POST',
                            headers: SUPABASE_HEADERS,
                            body: JSON.stringify({
                                gender: p.gender,
                                job: p.job,
                                ratio: p.ratio,
                                minBirthYear: p.minBirthYear,
                                maxBirthYear: p.maxBirthYear,
                                minHeight: p.minHeight,
                                maxHeight: p.maxHeight
                            })
                        });
                        if (ruleRes.ok) addedRules++;
                    }
                }
                
                if (addedTiers === 0 && addedRules === 0) {
                    statusEl.textContent = 'âœ… ì „ë¬¸ì§ì´ ì´ë¯¸ ëª¨ë‘ ì¡´ì¬í•©ë‹ˆë‹¤.';
                    statusEl.style.color = 'var(--primary)';
                    showToast('ì „ë¬¸ì§ì´ ì´ë¯¸ ëª¨ë‘ ì¡´ì¬í•©ë‹ˆë‹¤.', 'info');
                } else {
                    statusEl.textContent = `âœ… ì „ë¬¸ì§ ì¶”ê°€ ì™„ë£Œ! (í‹°ì–´: ${addedTiers}ê°œ, ê·œì¹™: ${addedRules}ê°œ)`;
                    statusEl.style.color = 'var(--primary)';
                    showToast(`ì „ë¬¸ì§ ì¶”ê°€ ì™„ë£Œ! (í‹°ì–´: ${addedTiers}ê°œ, ê·œì¹™: ${addedRules}ê°œ)`, 'success');
                    await refreshAllData();
                    renderTierTable();
                    renderRuleTable();
                }
            } catch (error) {
                statusEl.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                statusEl.style.color = 'var(--danger)';
                showToast('ì „ë¬¸ì§ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ì§ì—…í‹°ì–´ + ê°€ìƒì°¸ì—¬ì ê¸°ë³¸ ë°ì´í„° ì´ˆê¸°í™” (ìˆ˜ë™ ë²„íŠ¼ìš©) - ê¸°ì¡´ ìœ ì§€
        async function initializeTierAndVirtualData() {
            const statusEl = document.getElementById('initStatus');
            statusEl.textContent = 'ì´ˆê¸°í™” ì¤‘...';
            statusEl.style.color = 'var(--warning)';
            
            if (!confirm('ê¸°ì¡´ ì§ì—…í‹°ì–´/ê°€ìƒì°¸ì—¬ì ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                statusEl.textContent = '';
                return;
            }
            
            try {
                // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
                const existingTiers = data.tiers || [];
                const existingVirtual = data.virtual || [];
                
                for (const t of existingTiers) {
                    await fetch(`${API_BASE}/job_tiers/${t.id}`, { method: 'DELETE' });
                }
                for (const v of existingVirtual) {
                    await fetch(`${API_BASE}/virtual_participants/${v.id}`, { method: 'DELETE' });
                }
                
                // ì§ì—…í‹°ì–´ ê¸°ë³¸ ë°ì´í„° (ìƒˆ ì§ì—… ë¶„ë¥˜ ì ìš©)
                const tierData = [
                    // ë‚¨ì Sí‹°ì–´ (ì „ë¬¸ì§, ê¸ˆìœµê¶Œ)
                    {gender:'ë‚¨ì',job:'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´)',tier:'S'},{gender:'ë‚¨ì',job:'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´)',tier:'S'},
                    {gender:'ë‚¨ì',job:'ê¸ˆìœµê¶Œ',tier:'S'},
                    // ë‚¨ì Aí‹°ì–´ (ëŒ€ê¸°ì—…, ì™¸êµ­ê³„, ê³µê¸°ì—…, ì—°êµ¬ì§, IT)
                    {gender:'ë‚¨ì',job:'ëŒ€ê¸°ì—…',tier:'A'},{gender:'ë‚¨ì',job:'ì™¸êµ­ê³„',tier:'A'},{gender:'ë‚¨ì',job:'ê³µê¸°ì—…',tier:'A'},
                    {gender:'ë‚¨ì',job:'ì—°êµ¬ì§',tier:'A'},{gender:'ë‚¨ì',job:'IT/ê°œë°œì',tier:'A'},{gender:'ë‚¨ì',job:'ì˜ë£Œì§',tier:'A'},
                    // ë‚¨ì Bí‹°ì–´ (íšŒì‚¬ì›, ê³µë¬´ì›, êµìœ¡ì§ ë“±)
                    {gender:'ë‚¨ì',job:'íšŒì‚¬ì›',tier:'B'},{gender:'ë‚¨ì',job:'ì‚¬ë¬´ì§',tier:'B'},{gender:'ë‚¨ì',job:'í”„ë¦¬ëœì„œ',tier:'B'},
                    {gender:'ë‚¨ì',job:'ìì˜ì—…/ì‚¬ì—…ê°€',tier:'B'},{gender:'ë‚¨ì',job:'ê³µë¬´ì›',tier:'B'},{gender:'ë‚¨ì',job:'ëŒ€í•™ì›ìƒ',tier:'B'},
                    {gender:'ë‚¨ì',job:'ì˜ˆì²´ëŠ¥',tier:'B'},{gender:'ë‚¨ì',job:'êµìœ¡ì§',tier:'B'},{gender:'ë‚¨ì',job:'ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´',tier:'B'},
                    {gender:'ë‚¨ì',job:'ë””ìì´ë„ˆ',tier:'B'},{gender:'ë‚¨ì',job:'ê°„í˜¸ì‚¬',tier:'B'},{gender:'ë‚¨ì',job:'ê¸°íƒ€',tier:'B'},
                    // ì—¬ì Sí‹°ì–´ (í•­ê³µì—…, í”¼íŠ¸ë‹ˆìŠ¤, ì „ë¬¸ì§, ì„œë¹„ìŠ¤/í˜¸í…”, ì—°ì˜ˆì¸)
                    {gender:'ì—¬ì',job:'í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)',tier:'S'},{gender:'ì—¬ì',job:'í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)',tier:'S'},
                    {gender:'ì—¬ì',job:'ì „ë¬¸ì§(ë¬¸ê³¼ê³„ì—´)',tier:'S'},{gender:'ì—¬ì',job:'ì „ë¬¸ì§(ì´ê³¼ê³„ì—´)',tier:'S'},
                    {gender:'ì—¬ì',job:'ì„œë¹„ìŠ¤/í˜¸í…”',tier:'S'},{gender:'ì—¬ì',job:'ì—°ì˜ˆì¸/ì¸í”Œë£¨ì–¸ì„œ',tier:'S'},
                    // ì—¬ì Aí‹°ì–´ (ëŒ€ê¸°ì—…, ì™¸êµ­ê³„, ê¸ˆìœµê¶Œ, ë””ìì´ë„ˆ, ë§ˆì¼€íŒ…)
                    {gender:'ì—¬ì',job:'ëŒ€ê¸°ì—…',tier:'A'},{gender:'ì—¬ì',job:'ì™¸êµ­ê³„',tier:'A'},{gender:'ì—¬ì',job:'ê¸ˆìœµê¶Œ',tier:'A'},
                    {gender:'ì—¬ì',job:'ë””ìì´ë„ˆ',tier:'A'},{gender:'ì—¬ì',job:'ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´',tier:'A'},{gender:'ì—¬ì',job:'ì˜ˆì²´ëŠ¥',tier:'A'},
                    {gender:'ì—¬ì',job:'IT/ê°œë°œì',tier:'A'},
                    // ì—¬ì Bí‹°ì–´ (íšŒì‚¬ì›, ì˜ë£Œì§, êµìœ¡ì§, ê³µë¬´ì› ë“±)
                    {gender:'ì—¬ì',job:'íšŒì‚¬ì›',tier:'B'},{gender:'ì—¬ì',job:'ì‚¬ë¬´ì§',tier:'B'},{gender:'ì—¬ì',job:'ì˜ë£Œì§',tier:'B'},
                    {gender:'ì—¬ì',job:'ê°„í˜¸ì‚¬',tier:'B'},{gender:'ì—¬ì',job:'êµìœ¡ì§',tier:'B'},{gender:'ì—¬ì',job:'ì—°êµ¬ì§',tier:'B'},
                    {gender:'ì—¬ì',job:'í”„ë¦¬ëœì„œ',tier:'B'},{gender:'ì—¬ì',job:'ìì˜ì—…/ì‚¬ì—…ê°€',tier:'B'},{gender:'ì—¬ì',job:'ê³µê¸°ì—…',tier:'B'},
                    {gender:'ì—¬ì',job:'ê³µë¬´ì›',tier:'B'},{gender:'ì—¬ì',job:'ëŒ€í•™ì›ìƒ',tier:'B'},{gender:'ì—¬ì',job:'ê¸°íƒ€',tier:'B'}
                ];
                
                // ê°€ìƒì°¸ì—¬ì ê¸°ë³¸ ë°ì´í„° (ìƒˆ ì§ì—… ë¶„ë¥˜ ì ìš©)
                const virtualData = [
                    // ë‚¨ì (ì´ 100%)
                    {gender:'ë‚¨ì',job:'ëŒ€ê¸°ì—…',ratio:25,minBirthYear:1990,maxBirthYear:2000,minHeight:175,maxHeight:183},
                    {gender:'ë‚¨ì',job:'íšŒì‚¬ì›',ratio:20,minBirthYear:1990,maxBirthYear:2000,minHeight:173,maxHeight:180},
                    {gender:'ë‚¨ì',job:'ê¸ˆìœµê¶Œ',ratio:12,minBirthYear:1992,maxBirthYear:1999,minHeight:175,maxHeight:182},
                    {gender:'ë‚¨ì',job:'IT/ê°œë°œì',ratio:12,minBirthYear:1992,maxBirthYear:2001,minHeight:173,maxHeight:181},
                    {gender:'ë‚¨ì',job:'ê³µê¸°ì—…',ratio:10,minBirthYear:1990,maxBirthYear:1998,minHeight:174,maxHeight:180},
                    {gender:'ë‚¨ì',job:'ì™¸êµ­ê³„',ratio:8,minBirthYear:1993,maxBirthYear:1999,minHeight:176,maxHeight:183},
                    {gender:'ë‚¨ì',job:'ì—°êµ¬ì§',ratio:5,minBirthYear:1990,maxBirthYear:1998,minHeight:174,maxHeight:180},
                    {gender:'ë‚¨ì',job:'ê³µë¬´ì›',ratio:4,minBirthYear:1990,maxBirthYear:1998,minHeight:173,maxHeight:179},
                    {gender:'ë‚¨ì',job:'ìì˜ì—…/ì‚¬ì—…ê°€',ratio:4,minBirthYear:1988,maxBirthYear:1996,minHeight:174,maxHeight:181},
                    // ì—¬ì (ì´ 100%) - ì˜ˆìœ ì§ì—… ë¹„ìœ¨ ë†’ì„
                    {gender:'ì—¬ì',job:'íšŒì‚¬ì›',ratio:20,minBirthYear:1992,maxBirthYear:2001,minHeight:155,maxHeight:167},
                    {gender:'ì—¬ì',job:'í•­ê³µì—…(ìŠ¹ë¬´ì› ë“±)',ratio:12,minBirthYear:1995,maxBirthYear:2001,minHeight:165,maxHeight:172},
                    {gender:'ì—¬ì',job:'í”¼íŠ¸ë‹ˆìŠ¤(í•„ë¼í…ŒìŠ¤/ìš”ê°€ ê°•ì‚¬ ë“±)',ratio:12,minBirthYear:1994,maxBirthYear:2001,minHeight:160,maxHeight:170},
                    {gender:'ì—¬ì',job:'ì˜ë£Œì§',ratio:10,minBirthYear:1992,maxBirthYear:2002,minHeight:156,maxHeight:168},
                    {gender:'ì—¬ì',job:'ì„œë¹„ìŠ¤/í˜¸í…”',ratio:8,minBirthYear:1995,maxBirthYear:2001,minHeight:162,maxHeight:170},
                    {gender:'ì—¬ì',job:'ëŒ€ê¸°ì—…',ratio:8,minBirthYear:1993,maxBirthYear:2000,minHeight:157,maxHeight:170},
                    {gender:'ì—¬ì',job:'ë””ìì´ë„ˆ',ratio:7,minBirthYear:1994,maxBirthYear:2001,minHeight:156,maxHeight:168},
                    {gender:'ì—¬ì',job:'ë§ˆì¼€íŒ…/ê´‘ê³ /ë¯¸ë””ì–´',ratio:6,minBirthYear:1993,maxBirthYear:2000,minHeight:156,maxHeight:169},
                    {gender:'ì—¬ì',job:'ì™¸êµ­ê³„',ratio:5,minBirthYear:1993,maxBirthYear:1999,minHeight:158,maxHeight:170},
                    {gender:'ì—¬ì',job:'êµìœ¡ì§',ratio:5,minBirthYear:1992,maxBirthYear:1999,minHeight:155,maxHeight:167},
                    {gender:'ì—¬ì',job:'ê¸ˆìœµê¶Œ',ratio:4,minBirthYear:1993,maxBirthYear:1999,minHeight:157,maxHeight:170},
                    {gender:'ì—¬ì',job:'IT/ê°œë°œì',ratio:3,minBirthYear:1993,maxBirthYear:2000,minHeight:155,maxHeight:168}
                ];
                
                // ë°ì´í„° ì¶”ê°€ (ë³‘ë ¬ ì²˜ë¦¬)
                const tierPromises = tierData.map(t => 
                    fetch(`${API_BASE}/job_tiers`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(t)
                    }).then(res => res.ok ? 1 : 0).catch(() => 0)
                );
                const tierResults = await Promise.all(tierPromises);
                const tierCount = tierResults.reduce((a, b) => a + b, 0);
                
                const virtualPromises = virtualData.map(v => 
                    fetch(`${API_BASE}/virtual_participants`, {
                        method: 'POST',
                        headers: SUPABASE_HEADERS,
                        body: JSON.stringify(v)
                    }).then(res => res.ok ? 1 : 0).catch(() => 0)
                );
                const virtualResults = await Promise.all(virtualPromises);
                const virtualCount = virtualResults.reduce((a, b) => a + b, 0);
                
                statusEl.textContent = `âœ… ì´ˆê¸°í™” ì™„ë£Œ! (í‹°ì–´: ${tierCount}ê°œ, ê°€ìƒì°¸ì—¬ì: ${virtualCount}ê°œ)`;
                statusEl.style.color = 'var(--primary)';
                showToast('ê¸°ë³¸ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ!', 'success');
                await refreshAllData();
                
            } catch (error) {
                statusEl.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                statusEl.style.color = 'var(--danger)';
                showToast('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        async function createTestData() {
            const count = prompt('ìƒì„±í•  í…ŒìŠ¤íŠ¸ ë°ì´í„° ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '50');
            if (!count) return;
            
            const totalCount = parseInt(count);
            if (isNaN(totalCount) || totalCount < 1) {
                showToast('ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            if (!confirm(`í…ŒìŠ¤íŠ¸ ë°ì´í„° ${totalCount}ëª…ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            showToast(`í…ŒìŠ¤íŠ¸ ë°ì´í„° ${totalCount}ëª… ìƒì„± ì¤‘...`, 'info');
            
            // ëœë¤ ë°ì´í„° ìƒì„±ìš©
            const lastNames = ['ê¹€', 'ì´', 'ë°•', 'ìµœ', 'ì •', 'ê°•', 'ì¡°', 'ìœ¤', 'ì¥', 'ì„', 'í•œ', 'ì˜¤', 'ì„œ', 'ì‹ ', 'ê¶Œ', 'í™©', 'ì•ˆ', 'ì†¡', 'ë¥˜', 'í™'];
            const maleNames = ['ë¯¼ì¤€', 'ì„œì¤€', 'ë„ìœ¤', 'ì˜ˆì¤€', 'ì‹œìš°', 'í•˜ì¤€', 'ì£¼ì›', 'ì§€í˜¸', 'ì§€í›„', 'ì¤€ì„œ', 'ì¤€ìš°', 'í˜„ìš°', 'ë„í˜„', 'ê±´ìš°', 'ìš°ì§„', 'ì„ ìš°', 'ë¯¼ì¬', 'í˜„ì¤€', 'ì—°ìš°', 'ìœ ì¤€'];
            const femaleNames = ['ì„œì—°', 'ì„œìœ¤', 'ì§€ìš°', 'ì„œí˜„', 'ë¯¼ì„œ', 'í•˜ì€', 'í•˜ìœ¤', 'ìœ¤ì„œ', 'ì§€ë¯¼', 'ì§€ìœ ', 'ì±„ì›', 'ìˆ˜ì•„', 'ì§€ì•„', 'ì§€ìœ¤', 'ë‹¤ì€', 'ì€ì„œ', 'ì˜ˆì€', 'ìˆ˜ë¹ˆ', 'ì†Œìœ¨', 'ì˜ˆë¦°'];
            const nicknameParts = ['í–‰ë³µí•œ', 'ì¦ê±°ìš´', 'ë©‹ì§„', 'ì˜ˆìœ', 'ê·€ì—¬ìš´', 'ì¿¨í•œ', 'í™í•œ', 'ìŠ¤ë§ˆíŠ¸', 'ëŸ­í‚¤', 'í•´í”¼', 'ìŠ¤ìœ—', 'ëŸ¬ë¸”ë¦¬', 'ìƒ¤ì´ë‹ˆ', 'ë¸Œë¼ì´íŠ¸', 'í´ë¦°'];
            const nicknameEnds = ['ê³°ëŒì´', 'í† ë¼', 'ê³ ì–‘ì´', 'ê°•ì•„ì§€', 'í­ê·„', 'ë‹¤ëŒì¥', 'ì—¬ìš°', 'ì‚¬ì', 'í˜¸ë‘ì´', 'íŒë‹¤', 'ì½”ì•Œë¼', 'í–„ìŠ¤í„°', 'ëŒê³ ë˜', 'ë‚˜ë¹„', 'ë³„'];
            const jobCategories = ['ëŒ€ê¸°ì—…', 'ì „ë¬¸ì§', 'ì‚¬ì—…ê°€', 'ê¸ˆìœµ', 'ê³µë¬´ì›', 'IT', 'ì˜ë£Œ', 'ë²•ì¡°', 'êµìœ¡', 'ì˜ˆìˆ '];
            const jobDetails = {
                'ëŒ€ê¸°ì—…': ['ì‚¼ì„±ì „ì', 'LGí™”í•™', 'SKí•˜ì´ë‹‰ìŠ¤', 'í˜„ëŒ€ìë™ì°¨', 'ë„¤ì´ë²„', 'ì¹´ì¹´ì˜¤', 'CJì œì¼ì œë‹¹', 'í¬ìŠ¤ì½”', 'ë¡¯ë°ì¼€ë¯¸ì¹¼', 'KT'],
                'ì „ë¬¸ì§': ['ë³€í˜¸ì‚¬', 'ì˜ì‚¬', 'íšŒê³„ì‚¬', 'ì„¸ë¬´ì‚¬', 'ë³€ë¦¬ì‚¬', 'ì•½ì‚¬', 'ìˆ˜ì˜ì‚¬', 'ê±´ì¶•ì‚¬', 'ê°ì •í‰ê°€ì‚¬', 'ë…¸ë¬´ì‚¬'],
                'ì‚¬ì—…ê°€': ['ITìŠ¤íƒ€íŠ¸ì—… ëŒ€í‘œ', 'ë¬´ì—­íšŒì‚¬ ëŒ€í‘œ', 'ì™¸ì‹ì—… ëŒ€í‘œ', 'ì œì¡°ì—… ëŒ€í‘œ', 'ìœ í†µì—… ëŒ€í‘œ', 'ì»¨ì„¤íŒ… ëŒ€í‘œ', 'ë””ìì¸ ëŒ€í‘œ', 'êµìœ¡ì‚¬ì—… ëŒ€í‘œ'],
                'ê¸ˆìœµ': ['íˆ¬ìì€í–‰', 'ìì‚°ìš´ìš©', 'ì¦ê¶Œì‚¬', 'ë³´í—˜ì‚¬', 'PEì‹¬ì‚¬ì—­', 'VCì‹¬ì‚¬ì—­', 'ì€í–‰PB', 'ì• ë„ë¦¬ìŠ¤íŠ¸'],
                'ê³µë¬´ì›': ['5ê¸‰ì‚¬ë¬´ê´€', '7ê¸‰ì£¼ë¬´ê´€', 'ì™¸êµê´€', 'ê²€ì‚¬', 'íŒì‚¬', 'ê²½ì°°ê°„ë¶€', 'ì†Œë°©ê°„ë¶€', 'êµ­íšŒì‚¬ë¬´ì²˜'],
                'IT': ['ê°œë°œì', 'PM', 'ë°ì´í„°ì‚¬ì´ì–¸í‹°ìŠ¤íŠ¸', 'AIì—”ì§€ë‹ˆì–´', 'UXë””ìì´ë„ˆ', 'ë³´ì•ˆì „ë¬¸ê°€', 'í´ë¼ìš°ë“œì—”ì§€ë‹ˆì–´', 'DevOps'],
                'ì˜ë£Œ': ['ë‚´ê³¼ì „ë¬¸ì˜', 'ì™¸ê³¼ì „ë¬¸ì˜', 'í”¼ë¶€ê³¼ì „ë¬¸ì˜', 'ì •ì‹ ê³¼ì „ë¬¸ì˜', 'ì¹˜ê³¼ì˜ì‚¬', 'í•œì˜ì‚¬', 'ê°„í˜¸ì‚¬', 'ë¬¼ë¦¬ì¹˜ë£Œì‚¬'],
                'ë²•ì¡°': ['ë³€í˜¸ì‚¬', 'íŒì‚¬', 'ê²€ì‚¬', 'ë²•ë¬´ì‚¬', 'ë¡œíŒíŒŒíŠ¸ë„ˆ', 'ì‚¬ë‚´ë³€í˜¸ì‚¬', 'ë²•í•™êµìˆ˜'],
                'êµìœ¡': ['ëŒ€í•™êµìˆ˜', 'ê³ ë“±í•™êµêµì‚¬', 'í•™ì›ê°•ì‚¬', 'êµìœ¡ì»¨ì„¤í„´íŠ¸', 'ì—ë“€í…Œí¬', 'ì—°êµ¬ì›'],
                'ì˜ˆìˆ ': ['ë°°ìš°', 'ê°€ìˆ˜', 'í™”ê°€', 'ì‘ê°€', 'ê°ë…', 'PD', 'í¬í† ê·¸ë˜í¼', 'ë””ìì´ë„ˆ']
            };
            const qualificationsList = ['ì§ì—…', 'í•™ë ¥', 'ì—°ë´‰ìì‚°', 'ì™¸ëª¨', 'SNS', 'ìš´ë™', 'ë“í‘œ3í‘œ', 'ì§ì—…,í•™ë ¥', 'ì§ì—…,ë“í‘œ3í‘œ', 'ì™¸ëª¨,SNS'];
            const authTypes = ['upload', 'onsite'];
            const approvalStatuses = ['ìŠ¹ì¸ì™„ë£Œ', 'ì„œë¥˜ì œì¶œì™„ë£Œ', 'í˜„ì¥ì¸ì¦ì˜ˆì •', 'ì¸ì¦ëŒ€ê¸°'];
            
            // ìƒ˜í”Œ ì´ë¯¸ì§€ URL (ì‹¤ì œ ë³¼ ìˆ˜ ìˆëŠ” placeholder ì´ë¯¸ì§€)
            const sampleImages = {
                ëª…í•¨: 'https://via.placeholder.com/400x250/1a1a1a/FFD700?text=Business+Card',
                ì¡¸ì—…ì¦ëª…ì„œ: 'https://via.placeholder.com/400x550/1a1a1a/FFD700?text=Diploma',
                ìì‚°ì¦ë¹™: 'https://via.placeholder.com/400x300/1a1a1a/FFD700?text=Asset+Proof',
                íŒ”ë¡œì›Œ: 'https://via.placeholder.com/400x700/1a1a1a/FFD700?text=Followers+Screenshot',
                ì¸ë°”ë””: 'https://via.placeholder.com/400x600/1a1a1a/FFD700?text=Inbody+Result',
                í”„ë¡œí•„1: 'https://via.placeholder.com/400x500/1a1a1a/FFD700?text=Profile+Photo+1',
                í”„ë¡œí•„2: 'https://via.placeholder.com/400x500/1a1a1a/FFD700?text=Profile+Photo+2',
                ë“í‘œ: 'https://via.placeholder.com/400x300/1a1a1a/FFD700?text=Vote+Screenshot'
            };
            
            // ìê²©ë³„ ìƒ˜í”Œ fileLinks JSON ìƒì„± í•¨ìˆ˜ (ìƒˆ êµ¬ì¡°: authMethod + fields)
            function generateFileLinks(quals, idx, mixOnsite = false) {
                const partyNames = ['2024 í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŒŒí‹°', '2024 í• ë¡œìœˆ íŒŒí‹°', '2025 ì‹ ë…„ íŒŒí‹°', '2024 ì—¬ë¦„ ë¹„ì¹˜ íŒŒí‹°', '2024 ê°€ì„ ì™€ì¸ íŒŒí‹°'];
                const snsPlatforms = ['instagram', 'youtube', 'tiktok'];
                const snsAccounts = {
                    instagram: { id: `test_user_${idx}`, link: `https://instagram.com/test_user_${idx}` },
                    youtube: { id: `testchannel${idx}`, link: `https://youtube.com/@testchannel${idx}` },
                    tiktok: { id: `testuser${idx}`, link: `https://tiktok.com/@testuser${idx}` }
                };
                
                const onsiteDocsMap = {
                    'ì§ì—…': 'ëª…í•¨ ë˜ëŠ” ì‚¬ì›ì¦',
                    'í•™ë ¥': 'í•™ìƒì¦ ë˜ëŠ” ì¡¸ì—…ì¦ëª…ì„œ',
                    'ì—°ë´‰ìì‚°': 'ì†Œë“/ìì‚° ì¦ë¹™ ì„œë¥˜',
                    'SNS': 'SNS ê³„ì • í™”ë©´',
                    'ìš´ë™': 'ì™„ì£¼ ë©”ë‹¬ ë˜ëŠ” ì¸ë°”ë”” ê²°ê³¼ì§€',
                    'ì™¸ëª¨': 'ì‹ ë¶„ì¦ (í˜„ì¥ í™•ì¸)',
                    'ë“í‘œ3í‘œ': 'í˜¸ìŠ¤íŠ¸ì—ê²Œ í™•ì¸'
                };
                
                const fieldData = {};
                const qualList = quals.split(',');
                
                qualList.forEach((qual, qualIdx) => {
                    qual = qual.trim();
                    // mixOnsiteì¼ ë•Œ ì¼ë¶€ í•­ëª©ì€ í˜„ì¥ì¸ì¦ìœ¼ë¡œ (30% í™•ë¥ )
                    const isOnsite = mixOnsite && Math.random() < 0.3;
                    
                    const baseFields = {};
                    
                    switch(qual) {
                        case 'ì§ì—…':
                            if (!isOnsite) {
                                baseFields['job_cert'] = { type: 'file', url: sampleImages.ëª…í•¨, name: `ëª…í•¨_${idx}.jpg` };
                            }
                            break;
                        case 'í•™ë ¥':
                            if (!isOnsite) {
                                baseFields['edu_cert'] = { type: 'file', url: sampleImages.ì¡¸ì—…ì¦ëª…ì„œ, name: `ì¡¸ì—…ì¦ëª…ì„œ_${idx}.jpg` };
                            }
                            break;
                        case 'ì—°ë´‰ìì‚°':
                            // ì—°ë´‰ìì‚°ì€ ë¯¼ê°ì •ë³´ë¼ í˜„ì¥ì¸ì¦ ë¹„ìœ¨ ë†’ìŒ (70%)
                            if (!isOnsite && Math.random() > 0.7) {
                                baseFields['asset_cert'] = { type: 'file', url: sampleImages.ìì‚°ì¦ë¹™, name: `ìì‚°ì¦ë¹™_${idx}.pdf` };
                            }
                            break;
                        case 'SNS':
                            if (!isOnsite) {
                                const platform = snsPlatforms[qualIdx % 3];
                                baseFields['sns_platform'] = { type: 'text', value: platform };
                                baseFields['sns_account'] = { type: 'text', value: snsAccounts[platform].id, link: snsAccounts[platform].link };
                                if (Math.random() > 0.5) {
                                    baseFields['sns_screenshot'] = { type: 'file', url: sampleImages.íŒ”ë¡œì›Œ, name: `íŒ”ë¡œì›Œ_${idx}.jpg` };
                                }
                            }
                            break;
                        case 'ìš´ë™':
                            if (!isOnsite) {
                                baseFields['fitness_cert'] = { type: 'file', url: sampleImages.ì¸ë°”ë””, name: `ì¸ë°”ë””_${idx}.jpg` };
                            }
                            break;
                        case 'ì™¸ëª¨':
                            if (!isOnsite) {
                                baseFields['photo_1'] = { type: 'file', url: sampleImages.í”„ë¡œí•„1, name: `í”„ë¡œí•„1_${idx}.jpg` };
                                if (Math.random() > 0.3) {
                                    baseFields['photo_2'] = { type: 'file', url: sampleImages.í”„ë¡œí•„2, name: `í”„ë¡œí•„2_${idx}.jpg` };
                                }
                            }
                            break;
                        case 'ë“í‘œ3í‘œ':
                            if (!isOnsite) {
                                baseFields['party_name'] = { type: 'text', value: partyNames[idx % partyNames.length] };
                                if (Math.random() > 0.5) {
                                    baseFields['vote_screenshot'] = { type: 'file', url: sampleImages.ë“í‘œ, name: `ë“í‘œì¸ì¦_${idx}.jpg` };
                                }
                            }
                            break;
                    }
                    
                    // ìƒˆ êµ¬ì¡°: { authMethod, onsiteDocs, fields }
                    fieldData[qual] = {
                        authMethod: (isOnsite || (qual === 'ì—°ë´‰ìì‚°' && Object.keys(baseFields).length === 0)) ? 'onsite' : 'upload',
                        onsiteDocs: onsiteDocsMap[qual] || '',
                        fields: baseFields
                    };
                });
                
                return JSON.stringify(fieldData);
            }
            const eventDates = [
                '2026ë…„ 1ì›” 11ì¼ ì˜¤í›„ 12:00', '2026ë…„ 1ì›” 11ì¼ ì˜¤í›„ 15:00', '2026ë…„ 1ì›” 11ì¼ ì˜¤í›„ 19:00',
                '2026ë…„ 1ì›” 18ì¼ ì˜¤í›„ 12:00', '2026ë…„ 1ì›” 18ì¼ ì˜¤í›„ 15:00', '2026ë…„ 1ì›” 18ì¼ ì˜¤í›„ 19:00',
                '2026ë…„ 1ì›” 25ì¼ ì˜¤í›„ 12:00', '2026ë…„ 1ì›” 25ì¼ ì˜¤í›„ 15:00', '2026ë…„ 1ì›” 25ì¼ ì˜¤í›„ 19:00',
                '2026ë…„ 2ì›” 1ì¼ ì˜¤í›„ 12:00', '2026ë…„ 2ì›” 1ì¼ ì˜¤í›„ 15:00', '2026ë…„ 2ì›” 1ì¼ ì˜¤í›„ 19:00'
            ];
            
            const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            
            // ë‹¨ê³„ë³„ ë¹„ìœ¨: 4ë‹¨ê³„ 10%, 3ë‹¨ê³„ 30%, 2ë‹¨ê³„ 40%, 1ë‹¨ê³„ 20%
            const stage4Count = Math.round(totalCount * 0.10);
            const stage3Count = Math.round(totalCount * 0.30);
            const stage2Count = Math.round(totalCount * 0.40);
            const stage1Count = totalCount - stage4Count - stage3Count - stage2Count;
            
            const testCustomers = [];
            const testReservations = [];
            const testInvitations = [];
            const testSurveys = [];
            
            // ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤‘ ê°€ì¥ í° ë²ˆí˜¸ ì°¾ê¸°
            const existingTestCustomers = (data.customers || []).filter(c => c.id && c.id.startsWith('010-9999-'));
            let maxIdx = 0;
            existingTestCustomers.forEach(c => {
                const num = parseInt(c.id.replace('010-9999-', ''));
                if (num > maxIdx) maxIdx = num;
            });
            
            let idx = maxIdx + 1;
            
            // 4ë‹¨ê³„: ì°¸ì—¬ì™„ë£Œ (ì‚¬ì „ì¡°ì‚¬ ì™„ë£Œ + attended)
            for (let i = 0; i < stage4Count; i++, idx++) {
                const phone = `010-9999-${String(idx).padStart(4, '0')}`;
                const gender = Math.random() > 0.5 ? 'ë‚¨ì' : 'ì—¬ì';
                const lastName = rand(lastNames);
                const firstName = gender === 'ë‚¨ì' ? rand(maleNames) : rand(femaleNames);
                const name = `[í…ŒìŠ¤íŠ¸]${lastName}${firstName}`;
                const nickname = `${rand(nicknameParts)}${rand(nicknameEnds)}${randInt(1,99)}`;
                const jobCategory = rand(jobCategories);
                const jobDetail = rand(jobDetails[jobCategory]);
                const isInvitation = Math.random() > 0.4;
                const eventDate = rand(eventDates);
                const eventPart = eventDate.includes('12:00') ? '1ë¶€' : eventDate.includes('15:00') ? '2ë¶€' : '3ë¶€';
                
                const birthYear = randInt(1985, 2000);
                const height = gender === 'ë‚¨ì' ? randInt(170, 188) : randInt(155, 172);
                
                testCustomers.push({
                    id: phone, name, gender, birthYear, height,
                    jobCategory, jobDetail,
                    source: isInvitation ? 'invitation' : 'organic'
                });
                
                testReservations.push({
                    id: `test-res-${idx}`, phone, crewName: nickname,
                    eventDate, eventPart,
                    option: `[${eventPart} ${eventPart === '3ë¶€' ? 'ì™€ì¸' : 'ì»¤í”¼'}]${isInvitation ? ' ì¸ë¹„í…Œì´ì…˜' : ''}`,
                    isInvitation, status: 'ì˜ˆì•½ì™„ë£Œ', attended: true
                });
                
                // 4ë‹¨ê³„ëŠ” ì‚¬ì „ì¡°ì‚¬ ì™„ë£Œ â†’ surveys í…Œì´ë¸”ì—ë„ ì¶”ê°€
                testSurveys.push({
                    id: `survey-test-${idx}`, phone, name, gender, birthYear, height,
                    jobCategory, jobDetail,
                    jobCertFile: `https://drive.google.com/test-cert-${idx}`,
                    termsAgreed: true, marketingAgreed: Math.random() > 0.5,
                    submittedAt: new Date().toISOString()
                });
                
                if (isInvitation) {
                    const quals = rand(qualificationsList);
                    testInvitations.push({
                        id: `inv-test-${idx}`, phone,
                        qualifications: quals,
                        groups: 'career', wineBonus: quals.includes(','),
                        authType: 'upload',
                        snsLink: quals.includes('SNS') ? `https://instagram.com/test${idx}` : '',
                        fileLinks: generateFileLinks(quals, idx),
                        approvalStatus: 'ìŠ¹ì¸ì™„ë£Œ'
                    });
                }
            }
            
            // 3ë‹¨ê³„: ì‚¬ì „ì¡°ì‚¬ì™„ë£Œ (ì‚¬ì „ì¡°ì‚¬ ì™„ë£Œ, attended ì—†ìŒ)
            for (let i = 0; i < stage3Count; i++, idx++) {
                const phone = `010-9999-${String(idx).padStart(4, '0')}`;
                const gender = Math.random() > 0.5 ? 'ë‚¨ì' : 'ì—¬ì';
                const lastName = rand(lastNames);
                const firstName = gender === 'ë‚¨ì' ? rand(maleNames) : rand(femaleNames);
                const name = `[í…ŒìŠ¤íŠ¸]${lastName}${firstName}`;
                const nickname = `${rand(nicknameParts)}${rand(nicknameEnds)}${randInt(1,99)}`;
                const jobCategory = rand(jobCategories);
                const jobDetail = rand(jobDetails[jobCategory]);
                const isInvitation = Math.random() > 0.5;
                const eventDate = rand(eventDates);
                const eventPart = eventDate.includes('12:00') ? '1ë¶€' : eventDate.includes('15:00') ? '2ë¶€' : '3ë¶€';
                
                const birthYear = randInt(1985, 2000);
                const height = gender === 'ë‚¨ì' ? randInt(170, 188) : randInt(155, 172);
                
                testCustomers.push({
                    id: phone, name, gender, birthYear, height,
                    jobCategory, jobDetail,
                    source: isInvitation ? 'invitation' : 'organic'
                });
                
                testReservations.push({
                    id: `test-res-${idx}`, phone, crewName: nickname,
                    eventDate, eventPart,
                    option: `[${eventPart} ${eventPart === '3ë¶€' ? 'ì™€ì¸' : 'ì»¤í”¼'}]${isInvitation ? ' ì¸ë¹„í…Œì´ì…˜' : ''}`,
                    isInvitation, status: 'ì˜ˆì•½ì™„ë£Œ'
                });
                
                // 3ë‹¨ê³„ë„ ì‚¬ì „ì¡°ì‚¬ ì™„ë£Œ â†’ surveys í…Œì´ë¸”ì—ë„ ì¶”ê°€
                testSurveys.push({
                    id: `survey-test-${idx}`, phone, name, gender, birthYear, height,
                    jobCategory, jobDetail,
                    jobCertFile: `https://drive.google.com/test-cert-${idx}`,
                    termsAgreed: true, marketingAgreed: Math.random() > 0.5,
                    submittedAt: new Date().toISOString()
                });
                
                if (isInvitation) {
                    const quals = rand(qualificationsList);
                    testInvitations.push({
                        id: `inv-test-${idx}`, phone,
                        qualifications: quals,
                        groups: 'career', wineBonus: quals.includes(','),
                        authType: 'upload',
                        snsLink: quals.includes('SNS') ? `https://instagram.com/test${idx}` : '',
                        fileLinks: generateFileLinks(quals, idx),
                        approvalStatus: 'ìŠ¹ì¸ì™„ë£Œ'
                    });
                }
            }
            
            // 2ë‹¨ê³„: ê²°ì œì™„ë£Œ (ì˜ˆì•½ë§Œ, ì‚¬ì „ì¡°ì‚¬ ì•ˆí•¨)
            for (let i = 0; i < stage2Count; i++, idx++) {
                const phone = `010-9999-${String(idx).padStart(4, '0')}`;
                const gender = Math.random() > 0.5 ? 'ë‚¨ì' : 'ì—¬ì';
                const nickname = `${rand(nicknameParts)}${rand(nicknameEnds)}${randInt(1,99)}`;
                const isInvitation = Math.random() > 0.5;
                const eventDate = rand(eventDates);
                const eventPart = eventDate.includes('12:00') ? '1ë¶€' : eventDate.includes('15:00') ? '2ë¶€' : '3ë¶€';
                
                // 2ë‹¨ê³„ëŠ” customersì— ì´ë¦„ë§Œ (ì‚¬ì „ì¡°ì‚¬ ì•ˆí•´ì„œ ìƒì„¸ì •ë³´ ì—†ìŒ)
                testCustomers.push({
                    id: phone,
                    source: isInvitation ? 'invitation' : 'organic'
                });
                
                testReservations.push({
                    id: `test-res-${idx}`, phone, crewName: nickname,
                    eventDate, eventPart,
                    option: `[${eventPart} ${eventPart === '3ë¶€' ? 'ì™€ì¸' : 'ì»¤í”¼'}]${isInvitation ? ' ì¸ë¹„í…Œì´ì…˜' : ''}`,
                    isInvitation, status: 'ì˜ˆì•½ì™„ë£Œ'
                });
                
                if (isInvitation) {
                    const quals = rand(qualificationsList);
                    // ì¼ë¶€ëŠ” í˜¼í•© (ì§€ê¸ˆì²¨ë¶€ + í˜„ì¥ì¸ì¦)
                    const mixOnsite = Math.random() > 0.6;
                    const fileLinksJson = generateFileLinks(quals, idx, mixOnsite);
                    const parsedLinks = JSON.parse(fileLinksJson);
                    
                    // authType ê²°ì • (ëª¨ë‘ í˜„ì¥/ëª¨ë‘ ì—…ë¡œë“œ/í˜¼í•©)
                    const authMethods = Object.values(parsedLinks).map(v => v.authMethod);
                    const hasUpload = authMethods.includes('upload');
                    const hasOnsite = authMethods.includes('onsite');
                    let authType = hasUpload && hasOnsite ? 'mixed' : (hasOnsite ? 'onsite' : 'upload');
                    
                    // SNS ë§í¬ ì¶”ì¶œ
                    const snsData = parsedLinks['SNS']?.fields?.sns_account;
                    const snsLink = snsData?.link || '';
                    
                    testInvitations.push({
                        id: `inv-test-${idx}`, phone,
                        qualifications: quals,
                        groups: 'career', wineBonus: quals.includes(','),
                        authType: authType,
                        snsLink: snsLink,
                        fileLinks: fileLinksJson,
                        approvalStatus: authType === 'onsite' ? 'í˜„ì¥ì¸ì¦ì˜ˆì •' : (authType === 'mixed' ? 'ì„œë¥˜ì œì¶œì™„ë£Œ(ì¼ë¶€í˜„ì¥)' : 'ì„œë¥˜ì œì¶œì™„ë£Œ')
                    });
                }
            }
            
            // 1ë‹¨ê³„: ì´ˆëŒ€ì¥ì‹ ì²­ë§Œ (customersì— ì•ˆë„£ìŒ, invitationsë§Œ)
            for (let i = 0; i < stage1Count; i++, idx++) {
                const phone = `010-9999-${String(idx).padStart(4, '0')}`;
                const quals = rand(qualificationsList);
                const mixOnsite = Math.random() > 0.5;
                const fileLinksJson = generateFileLinks(quals, idx, mixOnsite);
                const parsedLinks = JSON.parse(fileLinksJson);
                
                const authMethods = Object.values(parsedLinks).map(v => v.authMethod);
                const hasUpload = authMethods.includes('upload');
                const hasOnsite = authMethods.includes('onsite');
                let authType = hasUpload && hasOnsite ? 'mixed' : (hasOnsite ? 'onsite' : 'upload');
                
                const snsData = parsedLinks['SNS']?.fields?.sns_account;
                const snsLink = snsData?.link || '';
                
                testInvitations.push({
                    id: `inv-test-${idx}`, phone,
                    qualifications: quals,
                    groups: 'career', wineBonus: quals.includes(','),
                    authType: authType,
                    snsLink: snsLink,
                    fileLinks: fileLinksJson,
                    approvalStatus: rand(approvalStatuses)
                });
            }
            
            try {
                let progress = 0;
                const total = testCustomers.length + testReservations.length + testInvitations.length + testSurveys.length;
                
                for (const c of testCustomers) {
                    await fetch(`${API_BASE}/${TB.CUSTOMERS}`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(c)});
                    progress++;
                    if (progress % 10 === 0) showToast(`ìƒì„± ì¤‘... ${Math.round(progress/total*100)}%`, 'info');
                }
                for (const r of testReservations) {
                    await fetch(`${API_BASE}/${TB.RESERVATIONS}`, {method: 'POST', headers: SUPABASE_HEADERS, body: JSON.stringify(r)});
                    progress++;
                    if (progress % 10 === 0) showToast(`ìƒì„± ì¤‘... ${Math.round(progress/total*100)}%`, 'info');
                }
                for (const i of testInvitations) {
                    await fetch(`${API_BASE}/${TB.INVITATIONS}`, {method: 'POST', headers: SUPABASE_HEADERS, body: JSON.stringify(i)});
                    progress++;
                    if (progress % 10 === 0) showToast(`ìƒì„± ì¤‘... ${Math.round(progress/total*100)}%`, 'info');
                }
                for (const s of testSurveys) {
                    await fetch(`${API_BASE}/${TB.SURVEYS}`, {method: 'POST', headers: SUPABASE_HEADERS, body: JSON.stringify(s)});
                    progress++;
                    if (progress % 10 === 0) showToast(`ìƒì„± ì¤‘... ${Math.round(progress/total*100)}%`, 'info');
                }
                
                showToast(`âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ${totalCount}ëª… ìƒì„± ì™„ë£Œ!`, 'success');
                await refreshAllData();
            } catch (error) {
                showToast('âŒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
        
        async function deleteTestData() {
            if (!confirm('ëª¨ë“  í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(010-9999-xxxx í˜•ì‹ì˜ ë°ì´í„°)')) return;
            
            showToast('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì¤‘...', 'info');
            
            try {
                // 010-9999-xxxx í˜•ì‹ì˜ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì°¾ê¸°
                const testCustomers = (data.customers || []).filter(c => c.id && c.id.startsWith('010-9999-'));
                const testReservations = (data.reservations || []).filter(r => r.id && r.id.startsWith('test-res-'));
                const testInvitations = (data.invitations || []).filter(i => i.id && i.id.startsWith('inv-test-'));
                const testSurveys = (data.surveys || []).filter(s => s.id && s.id.startsWith('survey-test-'));
                
                const total = testCustomers.length + testReservations.length + testInvitations.length + testSurveys.length;
                if (total === 0) {
                    showToast('ì‚­ì œí•  í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'info');
                    return;
                }
                
                let progress = 0;
                
                for (const c of testCustomers) {
                    await fetch(`${API_BASE}/${TB.CUSTOMERS}/${c.id}`, {method: 'DELETE'});
                    progress++;
                    if (progress % 10 === 0) showToast(`ì‚­ì œ ì¤‘... ${Math.round(progress/total*100)}%`, 'info');
                }
                for (const r of testReservations) {
                    await fetch(`${API_BASE}/${TB.RESERVATIONS}?id=eq.${encodeURIComponent(r.id)}`, {method: 'DELETE', headers: SUPABASE_HEADERS});
                    progress++;
                    if (progress % 10 === 0) showToast(`ì‚­ì œ ì¤‘... ${Math.round(progress/total*100)}%`, 'info');
                }
                for (const i of testInvitations) {
                    await fetch(`${API_BASE}/${TB.INVITATIONS}?id=eq.${encodeURIComponent(i.id)}`, {method: 'DELETE', headers: SUPABASE_HEADERS});
                    progress++;
                    if (progress % 10 === 0) showToast(`ì‚­ì œ ì¤‘... ${Math.round(progress/total*100)}%`, 'info');
                }
                for (const s of testSurveys) {
                    await fetch(`${API_BASE}/${TB.SURVEYS}?id=eq.${encodeURIComponent(s.id)}`, {method: 'DELETE', headers: SUPABASE_HEADERS});
                    progress++;
                    if (progress % 10 === 0) showToast(`ì‚­ì œ ì¤‘... ${Math.round(progress/total*100)}%`, 'info');
                }
                
                showToast(`âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ${total}ê±´ ì‚­ì œ ì™„ë£Œ!`, 'success');
                await refreshAllData();
            } catch (error) {
                showToast('âŒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
        
    </script>
</body>
</html>
