<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매칭 제출 | 뭘 좀 아는 사람들</title>
    <link href="https://cdn.jsdelivr.net/npm/pretendard@1.3.9/dist/web/variable/pretendardvariable.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #00E676;
            --primary-dark: #00C853;
            --bg: #0a0a0a;
            --card-bg: #141414;
            --border: #2a2a2a;
            --text: #fff;
            --text-muted: #888;
            --danger: #ff4757;
            --pink: #ff6b9d;
            --blue: #4a9eff;
        }
        body {
            font-family: 'Pretendard Variable', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 480px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 24px; padding-top: 20px; }
        .header-logo { font-size: 14px; color: var(--text-muted); margin-bottom: 12px; }
        .header h1 { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .header h1 span { color: var(--primary); }
        .header-desc { font-size: 14px; color: var(--text-muted); }
        .form-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }
        .form-group label .required { color: var(--danger); }
        .form-control {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .form-control:focus { outline: none; border-color: var(--primary); }
        .form-control::placeholder { color: var(--text-muted); }
        select.form-control {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }
        .radio-group { display: flex; gap: 12px; flex-wrap: wrap; }
        .radio-option {
            flex: 1;
            min-width: 80px;
            padding: 14px 12px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .radio-option:hover { border-color: #444; }
        .radio-option.selected {
            border-color: var(--primary);
            background: rgba(0, 230, 118, 0.1);
        }
        .radio-option.male.selected {
            border-color: var(--blue);
            background: rgba(74, 158, 255, 0.1);
        }
        .radio-option.female.selected {
            border-color: var(--pink);
            background: rgba(255, 107, 157, 0.1);
        }
        .number-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .number-input input {
            width: 70px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            padding: 12px 8px;
        }
        .number-input span {
            font-size: 16px;
            color: var(--text-muted);
        }
        .target-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .target-numbers input {
            width: 70px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            padding: 12px 8px;
        }
        .target-numbers .add-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--primary);
            border: none;
            color: #000;
            font-size: 20px;
            cursor: pointer;
        }
        .target-numbers .remove-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--danger);
            border: none;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            margin-left: -4px;
        }
        .selection-info {
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-muted);
        }
        .selection-info .count {
            color: var(--primary);
            font-weight: 700;
        }
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }
        .submit-btn:hover { background: var(--primary-dark); }
        .submit-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        .success-card {
            background: var(--card-bg);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 40px 24px;
            text-align: center;
            display: none;
        }
        .success-card.show { display: block; }
        .success-icon { font-size: 48px; margin-bottom: 16px; }
        .success-card h2 { font-size: 20px; margin-bottom: 12px; }
        .success-card p { color: var(--text-muted); font-size: 14px; line-height: 1.6; }
        .result-box {
            background: var(--bg);
            border-radius: 10px;
            padding: 16px;
            margin: 20px 0;
        }
        .result-box .label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .result-box .value { font-size: 18px; color: var(--primary); font-weight: 700; }
        .hidden { display: none !important; }
        .footer { text-align: center; margin-top: 24px; padding-bottom: 40px; }
        .footer a { color: var(--text-muted); text-decoration: none; font-size: 13px; }
        .footer a:hover { color: var(--primary); }
        .error-msg { color: var(--danger); font-size: 13px; margin-top: 8px; display: none; }
        .hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        .my-info-box {
            background: linear-gradient(135deg, rgba(0, 230, 118, 0.1), rgba(255, 215, 0, 0.05));
            border: 1px solid rgba(0, 230, 118, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .my-info-box .num {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            min-width: 60px;
        }
        .my-info-box .name { font-size: 18px; color: var(--text); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">뭘 좀 아는 사람들</div>
            <h1><span>매칭</span> 제출</h1>
            <p class="header-desc">마음에 드는 상대를 선택해주세요</p>
        </div>

        <form id="matchForm" class="form-card">
            <!-- 날짜 선택 -->
            <div class="form-group">
                <label>파티 날짜 <span class="required">*</span></label>
                <select id="eventDate" class="form-control" required>
                    <option value="">선택하세요</option>
                </select>
            </div>

            <!-- 세션 선택 (시간 + 파티타입) -->
            <div class="form-group">
                <label>세션 <span class="required">*</span></label>
                <div class="radio-group" id="sessionGroup">
                    <div class="radio-option" style="color: var(--text-muted);">날짜를 먼저 선택하세요</div>
                </div>
            </div>

            <!-- 성별 선택 -->
            <div class="form-group">
                <label>성별 <span class="required">*</span></label>
                <div class="radio-group" id="genderGroup">
                    <div class="radio-option male" data-value="남자" onclick="selectGender('남자')">남자</div>
                    <div class="radio-option female" data-value="여자" onclick="selectGender('여자')">여자</div>
                </div>
            </div>

            <!-- 내 번호 -->
            <div class="form-group">
                <label>내 번호 <span class="required">*</span></label>
                <div class="number-input">
                    <input type="text" id="myNumber" class="form-control" placeholder="0" maxlength="2" inputmode="numeric">
                    <span>번</span>
                </div>
                <p class="hint">명찰에 적힌 번호를 입력하세요</p>
            </div>

            <!-- 이름 -->
            <div class="form-group">
                <label>이름 <span class="required">*</span></label>
                <input type="text" id="myName" class="form-control" placeholder="본인 이름" required>
            </div>

            <!-- 연락처 타입 -->
            <div class="form-group">
                <label>연락 방법 <span class="required">*</span></label>
                <div class="radio-group" id="contactTypeGroup">
                    <div class="radio-option" data-value="phone" onclick="selectContactType('phone')">전화</div>
                    <div class="radio-option" data-value="kakao" onclick="selectContactType('kakao')">카톡</div>
                    <div class="radio-option" data-value="instagram" onclick="selectContactType('instagram')">인스타</div>
                </div>
            </div>

            <!-- 연락처 -->
            <div class="form-group">
                <label>연락처 <span class="required">*</span></label>
                <input type="text" id="contactValue" class="form-control" placeholder="연락처 입력" required>
            </div>

            <!-- 상대 번호 선택 -->
            <div class="form-group">
                <label>마음에 드는 상대 번호 <span class="required">*</span></label>
                <p class="selection-info">최대 <span class="count" id="maxCount">3</span>명까지 선택 가능</p>
                <div class="target-numbers" id="targetNumbersWrap">
                    <input type="text" class="form-control target-input" placeholder="0" maxlength="2" inputmode="numeric">
                    <input type="text" class="form-control target-input" placeholder="0" maxlength="2" inputmode="numeric">
                    <input type="text" class="form-control target-input" placeholder="0" maxlength="2" inputmode="numeric">
                </div>
                <p class="hint">상대방 번호를 입력하세요 (빈칸은 무시됩니다)</p>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">제출하기</button>
            <p class="error-msg" id="errorMsg"></p>
        </form>

        <div class="success-card" id="successCard">
            <div class="success-icon">✅</div>
            <h2>제출 완료!</h2>
            <div class="result-box">
                <div class="label">내가 선택한 번호</div>
                <div class="value" id="submittedNumbers">-</div>
            </div>
            <p>매칭 결과는 파티 종료 후<br>관리자가 개별 연락드립니다.</p>
            <button onclick="location.reload()" class="submit-btn" style="margin-top: 20px;">다시 제출하기</button>
        </div>

        <div class="footer">
            <a href="https://instagram.com/svvy.s" target="_blank">@svvy.s</a>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bqpxdxsgxoapguknxwul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcHhkeHNneG9hcGd1a254d3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjUyNDAsImV4cCI6MjA4MzEwMTI0MH0.v_r3wIIIe024k-H-9dyHH-LJj73kP9iU_eYgHZX7CGA';
        const API_BASE = `${SUPABASE_URL}/rest/v1`;
        const HEADERS = {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
        };

        let allSchedules = [];
        let selectedDate = '';
        let selectedSession = null;  // { part, time, party_type }
        let selectedGender = '';
        let selectedContactType = '';
        let selectionLimit = 3;

        // 한글 날짜에서 요일 계산
        function getWeekdayFromKoreanDate(koreanDate) {
            // "2026년 1월 25일" -> Date 객체
            const match = koreanDate.match(/(\d+)년\s*(\d+)월\s*(\d+)일/);
            if (!match) return '';
            const year = parseInt(match[1]);
            const month = parseInt(match[2]) - 1;
            const day = parseInt(match[3]);
            const d = new Date(year, month, day);
            const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
            return weekdays[d.getDay()];
        }

        // 파티 타입 한글
        function getPartyTypeName(type) {
            const map = { 'coffee': '커피', 'wine': '와인', 'soju': '소주' };
            return map[type] || type;
        }

        async function init() {
            await loadSchedules();

            // 숫자만 입력
            document.getElementById('myNumber').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
            document.querySelectorAll('.target-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
            });

            document.getElementById('eventDate').addEventListener('change', onDateChange);
            document.getElementById('matchForm').addEventListener('submit', handleSubmit);
        }

        async function loadSchedules() {
            try {
                const res = await fetch(
                    `${API_BASE}/party_schedules?select=*&is_active=eq.true&order=date.asc,time.asc`,
                    { headers: HEADERS }
                );
                allSchedules = await res.json();

                // 날짜 드롭다운
                const dateSelect = document.getElementById('eventDate');
                const uniqueDates = [...new Set(allSchedules.map(s => s.date))];

                uniqueDates.forEach(date => {
                    const weekday = getWeekdayFromKoreanDate(date);
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = `${date} (${weekday})`;
                    dateSelect.appendChild(option);
                });
            } catch (e) {
                console.error('스케줄 로드 실패:', e);
            }
        }

        function onDateChange() {
            selectedDate = document.getElementById('eventDate').value;
            selectedSession = null;

            const sessionGroup = document.getElementById('sessionGroup');
            sessionGroup.innerHTML = '';

            if (!selectedDate) {
                sessionGroup.innerHTML = '<div class="radio-option" style="color: var(--text-muted);">날짜를 먼저 선택하세요</div>';
                return;
            }

            // 해당 날짜의 세션들
            const sessions = allSchedules.filter(s => s.date === selectedDate);

            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = 'radio-option';
                div.dataset.part = s.part;
                div.textContent = `${s.time} ${getPartyTypeName(s.party_type)}`;
                div.onclick = () => selectSession(s, div);
                sessionGroup.appendChild(div);
            });
        }

        function selectSession(session, el) {
            selectedSession = session;
            selectionLimit = selectedGender === '남자'
                ? (session.male_selection_limit || 3)
                : (session.female_selection_limit || 3);
            document.getElementById('maxCount').textContent = selectionLimit;
            updateTargetInputs();

            document.querySelectorAll('#sessionGroup .radio-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }

        function selectGender(gender) {
            selectedGender = gender;
            document.querySelectorAll('#genderGroup .radio-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.value === gender);
            });

            if (selectedSession) {
                selectionLimit = gender === '남자'
                    ? (selectedSession.male_selection_limit || 3)
                    : (selectedSession.female_selection_limit || 3);
                document.getElementById('maxCount').textContent = selectionLimit;
                updateTargetInputs();
            }
        }

        function updateTargetInputs() {
            const wrap = document.getElementById('targetNumbersWrap');
            wrap.innerHTML = '';
            for (let i = 0; i < selectionLimit; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control target-input';
                input.placeholder = '0';
                input.maxLength = 2;
                input.inputMode = 'numeric';
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
                wrap.appendChild(input);
            }
        }

        function selectContactType(type) {
            selectedContactType = type;
            document.querySelectorAll('#contactTypeGroup .radio-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.value === type);
            });

            const input = document.getElementById('contactValue');
            switch(type) {
                case 'phone': input.placeholder = '010-0000-0000'; break;
                case 'kakao': input.placeholder = '카카오톡 ID'; break;
                case 'instagram': input.placeholder = '@username'; break;
            }
        }

        function getSelectedTargets() {
            const inputs = document.querySelectorAll('.target-input');
            const numbers = [];
            inputs.forEach(input => {
                const val = parseInt(input.value);
                if (val > 0 && !numbers.includes(val)) {
                    numbers.push(val);
                }
            });
            return numbers;
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const myNumber = parseInt(document.getElementById('myNumber').value);
            const myName = document.getElementById('myName').value.trim();
            const contactValue = document.getElementById('contactValue').value.trim();
            const targets = getSelectedTargets();

            // 검증
            if (!selectedDate || !selectedSession) {
                alert('날짜와 세션을 선택해주세요');
                return;
            }
            if (!selectedGender) {
                alert('성별을 선택해주세요');
                return;
            }
            if (!myNumber || myNumber < 1) {
                alert('내 번호를 입력해주세요');
                return;
            }
            if (!myName) {
                alert('이름을 입력해주세요');
                return;
            }
            if (!selectedContactType || !contactValue) {
                alert('연락처를 입력해주세요');
                return;
            }
            if (targets.length === 0) {
                alert('상대 번호를 최소 1개 이상 입력해주세요');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '제출 중...';

            try {
                // 기존 제출 비활성화
                await fetch(
                    `${API_BASE}/match_submissions?event_date=eq.${encodeURIComponent(selectedDate)}&event_part=eq.${encodeURIComponent(selectedSession.part)}&lineup_number=eq.${myNumber}&gender=eq.${encodeURIComponent(selectedGender)}`,
                    {
                        method: 'PATCH',
                        headers: { ...HEADERS, 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ is_latest: false })
                    }
                );

                // 새 제출
                const submission = {
                    event_date: selectedDate,
                    event_part: selectedSession.part,
                    party_type: selectedSession.party_type,
                    gender: selectedGender,
                    lineup_number: myNumber,
                    name: myName,
                    contact_type: selectedContactType,
                    contact_value: contactValue,
                    selected_numbers: targets,
                    is_latest: true
                };

                const res = await fetch(`${API_BASE}/match_submissions`, {
                    method: 'POST',
                    headers: { ...HEADERS, 'Prefer': 'return=minimal' },
                    body: JSON.stringify(submission)
                });

                if (!res.ok) throw new Error('제출 실패');

                document.getElementById('submittedNumbers').textContent = targets.join(', ') + '번';
                document.getElementById('matchForm').classList.add('hidden');
                document.getElementById('successCard').classList.add('show');

            } catch (error) {
                console.error('제출 오류:', error);
                alert('제출 중 오류가 발생했습니다. 다시 시도해주세요.');
                submitBtn.disabled = false;
                submitBtn.textContent = '제출하기';
            }
        }

        init();
    </script>
</body>
</html>
